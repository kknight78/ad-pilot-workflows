{
  "updatedAt": "2025-12-13T17:25:34.288Z",
  "createdAt": "2025-12-13T13:57:23.566Z",
  "id": "GmqYJoJN7YUGmF3z",
  "name": "Inventory & Lead Management",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "errorMessage": "Inventory sync failed - fewer than 20 vehicles or missing required fields. Check email for details."
      },
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        1344,
        192
      ],
      "id": "f692c97d-1e57-4408-b7a8-4b40145a8ae8",
      "name": "Stop and Error"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.limit",
      "typeVersion": 1,
      "position": [
        688,
        192
      ],
      "id": "f26962cc-33aa-4545-9344-643f63230ef7",
      "name": "Limit"
    },
    {
      "parameters": {
        "fromEmail": "kelly@ad-pilot.ai",
        "toEmail": "kellyraeknight78@gmail.com",
        "subject": "AdPilot Alerts",
        "html": "=The inventory sync failed - FTP data didn't pass validation.\n\nIssue: Either no data received or fewer than 20 vehicles\nTime: {{ $now.toISO() }}\nRows received: {{ $('Extract from File').all().length }}\n\nCheck Promax FTP: ftp.dealermarketingservices.com\n\n---\nAutomated alert from n8n",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        1120,
        192
      ],
      "id": "5062284d-e28d-4f70-8594-e2117ec23ab5",
      "name": "Send email",
      "webhookId": "78b0049d-461e-4116-b742-d8837d8c0346",
      "credentials": {
        "smtp": {
          "id": "shUPF7kLrXLXWHPo",
          "name": "SMTP account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c9a8d7bb-6e76-4dd7-bb35-649eed2dc7d6",
              "leftValue": "={{$input.all().length}}",
              "rightValue": 20,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            },
            {
              "id": "ef7f0c70-ec4a-4a9c-ac70-19d44d023130",
              "leftValue": "={{ $input.first().json.Vin}}",
              "rightValue": 0,
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "0ca5ee1a-6271-411b-8820-ce88fc0d9c04",
              "leftValue": "= {{$input.first().json.Make}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        464,
        -96
      ],
      "id": "47b33b64-cfb2-4ec8-ac39-d3dfb98f9106",
      "name": "If",
      "executeOnce": false
    },
    {
      "parameters": {
        "content": "**Inventory management**",
        "height": 80,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -224,
        -144
      ],
      "typeVersion": 1,
      "id": "2cfbda23-d08d-43c4-9b8b-d0d57bd7c553",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "jsCode": "// ================== CONFIG ==================\nconst DEALER_ID = 9199;\nconst SITE_ORIGIN = 'https://www.ccrantoul.com';\nconst SPECIALS_BASES = [\n  `${SITE_ORIGIN}/used-vehicle-specials`,\n  `${SITE_ORIGIN}/used-vehicle-specials?sorton=2`, // price low‚Üíhigh\n  `${SITE_ORIGIN}/used-vehicle-specials?sorton=1`  // price high‚Üílow\n];\nconst MAX_SPECIALS_PAGES = 8;         // per base, hard stop\nconst PAGE_SIZES = [10];              // for start= pagination guesses\nconst DEBUG_SCRAPE = true;            // flip to false to silence logs\nconst SKIP_ROWS_WITHOUT_IMAGE = true; // drop rows with no acceptable image\n\n// IMPORTANT: We intentionally DO NOT upscale or proxy any images.\n// TikTok requires direct .jpg/.jpeg/.png URLs with no query-string resizing.\n\n// Optional VDP-level fallback tagging if crawl returns too few\nconst VDP_SPECIAL_FALLBACK = true;\nconst VDP_FALLBACK_MAX_CHECKS = 6;      // keep tiny to avoid timeouts\nconst VDP_SPECIAL_RE = /(Used Vehicle Specials|Vehicle Specials|Specials?\\s*Price|Manager'?s Special|Internet Special)/i;\n\n\n// ================== HELPERS ==================\nconst clean = v => (v == null ? '' : String(v).trim());\nconst first = (...vals) => { for (const v of vals) if (v != null && String(v).trim() !== '') return v; return ''; };\nconst toInt = v => { const n = Number(String(v ?? '').replace(/[^\\d]/g, '')); return Number.isFinite(n) ? n : ''; };\nconst moneyUSD = (...vals) => { const n = toInt(first(...vals)); return n === '' || n <= 0 ? '' : `${n} USD`; };\n\n// Stock normalization + matching\nfunction normStock(s) { return String(s ?? '').toUpperCase().replace(/[^A-Z0-9_-]/g, '').trim(); }\nfunction isPlausibleStock(s) {\n  const n = normStock(s);\n  return !!(n && n.length >= 4 && n.length <= 20 && /\\d{3,}/.test(n));\n}\nfunction addCandidate(set, val) { const n = normStock(val); if (isPlausibleStock(n)) set.add(n); }\nfunction stockVariants(s) {\n  const n = normStock(s);\n  const digits = n.replace(/[^0-9]/g, '');\n  const vars = new Set([n]);\n  if (digits) vars.add(digits);\n  if (/^\\d+$/.test(digits)) ['S','U','N'].forEach(p => vars.add(p + digits));\n  if (/^[A-Z]\\d+$/.test(n)) vars.add(digits);\n  return vars;\n}\nfunction isSpecialStock(feedStockNorm, specialsSet) {\n  for (const v of stockVariants(feedStockNorm)) if (specialsSet.has(v)) return true;\n  return false;\n}\n\n// ---- HTTP helpers ----\nconst HTTP_TIMEOUT = 4000;\nasync function httpGet(url)    { return await this.helpers.httpRequest({ method:'GET', url, json:true,  timeout:HTTP_TIMEOUT }); }\nasync function httpGetRaw(url) { return await this.helpers.httpRequest({ method:'GET', url, json:false, timeout:HTTP_TIMEOUT }); }\n\n// ---- Image sanitation & acceptance rules ----\n\n// TikTok wants a direct file URL and no query params.\nfunction sanitizeImageUrl(u) {\n  const s = String(u || '').trim();\n  if (!/^https?:\\/\\//i.test(s)) return '';\n  // Strip query/fragment/params\n  const base = s.split(/[?#]/)[0];\n  if (!/\\.(?:jpe?g|png)$/i.test(base)) return '';\n  return base;\n}\n\n// Treat ChromeData stock photos as <500x500 and reject them.\nfunction isChromeData(url) {\n  return /(^https?:\\/\\/)?media\\.chromedata\\.com\\/autoBuilderData\\/stockPhotos\\//i.test(String(url || ''));\n}\n\n// Try to detect obvious thumbnails/small images by filename/path hints\nfunction looksLikeSmallByName(url) {\n  const p = String(url || '').toLowerCase();\n\n  // Common ‚Äúsmall/thumbnail‚Äù hints in path or filename\n  if (/(^|\\/)(thumb|thumbnail|thumbnails|small|sm|xs|tiny)(\\/|[-_.])/i.test(p)) return true;\n  if (/(?:_|-)(tn|sm|small|thumb)(?:\\.|[-_])/i.test(p)) return true;\n\n  // Filenames with WxH patterns: 320x240, 400x300, etc.\n  const m = p.match(/(?:^|[^\\d])(\\d{2,4})x(\\d{2,4})(?:[^\\d]|$)/i);\n  if (m) {\n    const w = parseInt(m[1], 10), h = parseInt(m[2], 10);\n    if (Number.isFinite(w) && Number.isFinite(h) && (w < 500 || h < 500)) return true;\n  }\n\n  return false;\n}\n\n// Final acceptance check for image URLs\nfunction acceptImageUrl(u) {\n  const s = sanitizeImageUrl(u);\n  if (!s) return '';\n  if (isChromeData(s)) return '';           // reject stock photos (typically <500x500)\n  if (looksLikeSmallByName(s)) return '';   // reject obvious thumbnails\n  return s;\n}\n\n\n// ============== vPIC (VIN‚ÜíBody) ==============\nfunction mapBodyToTikTok(s = '') {\n  const t = String(s || '').toLowerCase();\n  if (!t) return 'OTHER';\n  if (t.includes('crossover') || t.includes('cuv')) return 'CROSSOVER';\n  if (t.includes('suv')) return 'SUV';\n  if (t.includes('convertible') || t.includes('cabrio')) return 'CONVERTIBLE';\n  if (t.includes('coupe')) return 'COUPE';\n  if (t.includes('hatch')) return 'HATCHBACK';\n  if (t.includes('minivan')) return 'MINIVAN';\n  if (t.includes('pickup') || t.includes('truck')) return 'TRUCK';\n  if (t.includes('wagon')) return 'WAGON';\n  if (t.includes('van')) return 'VAN';\n  if (t.includes('sedan') || t.includes('saloon')) return 'SEDAN';\n  if (t.includes('subcompact') || t.includes('compact') || t.includes('small')) return 'SMALL_CAR';\n  return 'OTHER';\n}\nasync function bodyFromVPIC(vin, year) {\n  const url = `https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValues/${encodeURIComponent(vin)}?format=json${year ? `&modelyear=${year}` : ''}`;\n  const data = await httpGet.call(this, url);\n  const raw = Array.isArray(data?.Results) ? (data.Results[0]?.BodyClass || '') : '';\n  return raw ? mapBodyToTikTok(raw) : 'OTHER';\n}\nasync function resolveBodyStyle(row) {\n  const localHint = first(row.BodyStyle, row.Body, row.Class, row.Body_Class, row.BodyType);\n  if (clean(localHint)) return mapBodyToTikTok(localHint);\n  const vin = clean(first(row.VIN, row.Vin));\n  if (vin && vin.length === 17) { try { return await bodyFromVPIC.call(this, vin, row.Year); } catch {} }\n  return 'OTHER';\n}\n\n// ============== URLs & VDP helpers ==============\nfunction buildVDP(stockNumberRaw) { return `${SITE_ORIGIN}/VehicleDetails/${DEALER_ID}/${stockNumberRaw}`; }\nfunction extractChromeDataUrl(html) {\n  const re = /https?:\\/\\/media\\.chromedata\\.com\\/autoBuilderData\\/stockPhotos\\/(\\d+)\\.(?:jpe?g|png)/i;\n  const m = re.exec(String(html||'')); return m ? m[0] : '';\n}\n\n// Prefer ProMax image; else common columns; DO NOT use ChromeData VDP fallback (treated as <500x500)\nasync function pickImageWithVDPFallback(row) {\n  // A) ProMax pipe-delimited\n  const delimited = (row.ImageUrlsDelimited ?? row.ImageURLsDelimited ?? row.ImageUrls_PipeDelimited ?? '');\n  if (delimited) {\n    const urls = String(delimited).split('|').map(s => acceptImageUrl(s));\n    const u = urls.find(Boolean);\n    if (u) return u;\n  }\n\n  // B) Common columns\n  const cand = [\n    row.PrimaryPhoto, row.PhotoURL1, row.PhotoUrl1, row.Photo1,\n    row.Image1, row.ImageURL, row.ImageUrl, row.Image,\n    row.PhotoURL, row.MainImage, row.DefaultImage,\n    row.Photos, row.PhotoUrls, row.Images, row.ImageList,\n    row.photo_1, row.photoUrl\n  ].filter(Boolean);\n\n  const pieces = [];\n  for (const c of cand) {\n    if (Array.isArray(c)) pieces.push(...c);\n    else if (typeof c === 'string') pieces.push(...c.split(/[\\s,;|]+/));\n    else pieces.push(String(c));\n  }\n  for (const raw of pieces) {\n    const u = acceptImageUrl(raw);\n    if (u) return u;\n  }\n\n  // C) VDP ‚Üí ChromeData (DISABLED: we reject stock photos)\n  // const stockRaw = String(row.StockNumber || '').trim();\n  // if (stockRaw) {\n  //   try {\n  //     const html = await httpGetRaw.call(this, buildVDP(stockRaw));\n  //     const cdn = extractChromeDataUrl(html);\n  //     const u = acceptImageUrl(cdn);\n  //     if (u) return u;\n  //   } catch {}\n  // }\n\n  return '';\n}\n\n\n// ============== Specials extractor (robust) ==============\nfunction extractSpecialStocksFromHtml(html) {\n  const src = String(html || '');\n  const set = new Set();\n  let m;\n\n  // A) Label/Content block\n  const reBlock = /<div[^>]*class=[\"']label[\"'][^>]*>\\s*Stock\\s*#\\s*:?<\\/div>\\s*<div[^>]*class=[\"']content[\"'][^>]*>([\\s\\S]*?)<\\/div>/gi;\n  while ((m = reBlock.exec(src)) !== null) addCandidate(set, m[1]);\n\n  // B) Any element with ‚Äústock‚Äù in class\n  const reClass = /<[^>]*class=[\"'][^\"']*stock[^\"']*[\"'][^>]*>([\\s\\S]*?)<\\/[^>]*>/gi;\n  while ((m = reClass.exec(src)) !== null) addCandidate(set, m[1]);\n\n  // C) data-* attributes (expanded)\n  const reDataAttr = /data-(?:vehicle-)?(?:stock|stockno|stock-number|stock_num|stocknumber|stock-id|stockid)\\s*=\\s*[\"']?([^\"' >]+)[\"']?/gi;\n  while ((m = reDataAttr.exec(src)) !== null) addCandidate(set, m[1]);\n\n  // D) JSON hints\n  const reJson = /\"stock(?:Number|_number|_no|No|Id|ID)\"\\s*:\\s*\"?([^\",<>{}\\s]+)\"?/gi;\n  while ((m = reJson.exec(src)) !== null) addCandidate(set, m[1]);\n\n  // E) VDP links\n  const reLink = new RegExp(`/VehicleDetails/${DEALER_ID}/([A-Za-z0-9_-]+)`, 'gi');\n  while ((m = reLink.exec(src)) !== null) addCandidate(set, m[1]);\n\n  // F) Plain text fallback\n  const reText = /Stock\\s*#\\s*[:#]?\\s*([A-Za-z0-9_\\-\\/]+)/gi;\n  while ((m = reText.exec(src)) !== null) addCandidate(set, m[1]);\n\n  return set;\n}\n\nfunction variantsForBase(baseUrl) {\n  const urls = new Set([baseUrl]);\n\n  // Big page sizes to force \"show more\"\n  const sizeKeys = ['pagesize', 'size', 'limit', 'resultsperpage', 'rpp', 'perpage', 'rows', 'count'];\n  [50, 100, 200].forEach(sz => {\n    sizeKeys.forEach(k => {\n      const sep = baseUrl.includes('?') ? '&' : '?';\n      urls.add(`${baseUrl}${sep}${k}=${sz}`);\n    });\n  });\n\n  // Numbered pages\n  for (let i = 2; i <= MAX_SPECIALS_PAGES; i++) {\n    const sep = baseUrl.includes('?') ? '&' : '?';\n    urls.add(`${baseUrl}${sep}page=${i}`);\n    urls.add(`${baseUrl}${sep}p=${i}`);\n  }\n\n  // Offset-style paging (lots of common keys)\n  const offsetKeys = ['start', 'offset', 'from', 'startrow', 'skip'];\n  PAGE_SIZES.forEach(sz => {\n    for (let k = 1; k < MAX_SPECIALS_PAGES; k++) {\n      const sep = baseUrl.includes('?') ? '&' : '?';\n      offsetKeys.forEach(key => { urls.add(`${baseUrl}${sep}${key}=${k * sz}`); });\n    }\n  });\n\n  // Combine size + offset for sites that need both\n  [50, 100, 200].forEach(szVal => {\n    ['pagesize','size','limit','resultsperpage','rpp','perpage','rows','count'].forEach(sk => {\n      ['start','offset','from','startrow','skip'].forEach(ok => {\n        for (let k = 1; k < MAX_SPECIALS_PAGES; k++) {\n          const sep = baseUrl.includes('?') ? '&' : '?';\n          urls.add(`${baseUrl}${sep}${sk}=${szVal}&${ok}=${k*12}`);\n        }\n      });\n    });\n  });\n\n  return Array.from(urls);\n}\n\nfunction absolutize(href) {\n  if (!href) return '';\n  if (/^https?:\\/\\//i.test(href)) return href;\n  if (href.startsWith('/')) return `${SITE_ORIGIN}${href}`;\n  return `${SITE_ORIGIN}/${href}`;\n}\n\nconst SIMPLE_SPECIALS_URLS = [\n  `${SITE_ORIGIN}/used-vehicle-specials`,\n  `${SITE_ORIGIN}/used-vehicle-specials?sorton=1`,\n  `${SITE_ORIGIN}/used-vehicle-specials?sorton=2`,\n];\n\n// Crawl all bases + variants; also follow discovered page links / data-* urls\nasync function fetchAllSpecialStocks() {\n  const stocks = new Set();\n  for (const url of SIMPLE_SPECIALS_URLS) {\n    let html = '';\n    try { html = await httpGetRaw.call(this, url); } catch { continue; }\n    const found = extractSpecialStocksFromHtml(html);\n    if (DEBUG_SCRAPE) console.log(`[specials] ${url} -> +${found.size}`);\n    for (const s of found) stocks.add(s);\n  }\n  if (DEBUG_SCRAPE) console.log(`[specials] total unique stocks (normalized): ${stocks.size}`);\n  return stocks;\n}\n\n// ============== Normalizers ==============\nfunction normalizeTransmission(s) {\n  const t = clean(s).toLowerCase();\n  if (!t) return '';\n  if (t.includes('man')) return 'Manual';\n  if (t.includes('auto') || t.includes('cvt') || t.includes('spd') || t.includes('dct')) return 'Automatic';\n  return clean(s);\n}\nfunction normalizeDrivetrain(s) {\n  const t = clean(s).toUpperCase();\n  if (!t) return '';\n  if (t.includes('AWD')) return 'AWD';\n  if (t.includes('4X4') || t.includes('4WD')) return '4X4';\n  if (t.includes('4X2') || t.includes('2WD')) return '4X2';\n  if (t.includes('FWD')) return 'FWD';\n  if (t.includes('RWD')) return 'RWD';\n  return 'Other';\n}\n\n// ============== Description & Address ==============\nconst lotAddress = { addr1:'125 N Century Blvd', city:'Rantoul', region:'Illinois', postal_code:'61866', country:'US' };\nconst LOT_LAT = 40.31207024, LOT_LON = -88.15616225;\n\nfunction buildDescription(v) {\n  const parts = [\n    `${clean(v.Year)} ${clean(v.Make)} ${clean(v.Model)}`.trim(),\n    clean(first(v.Style, v.Trim)) || null,\n    clean(first(v.ExteriorColor, v.exterior_color, v.Color, v.Exterior)) || null,\n    clean(v.Engine) || null,\n    clean(v.Transmission) || null,\n    toInt(first(v.Mileage, v.Odometer, v.odometer)) !== '' ? `${toInt(first(v.Mileage, v.Odometer, v.odometer))} miles` : null,\n    (clean(v.CityMPG) && clean(v.HighwayMPG)) ? `${clean(v.CityMPG)} city / ${clean(v.HighwayMPG)} hwy` : null\n  ].filter(Boolean);\n  const structured = parts.join(', ');\n  const comments = clean(first(v.Comments, v.Description));\n  return comments ? `${structured}. ${comments}` : structured;\n}\n\n// ---------- VDP fallback helpers ----------\nasync function vdpIndicatesSpecial(stockRaw) {\n  try {\n    const html = await httpGetRaw.call(this, buildVDP(stockRaw));\n    return VDP_SPECIAL_RE.test(String(html || ''));\n  } catch { return false; }\n}\nasync function augmentSpecialsFromVDP(rows, specialsSet) {\n  let checks = 0;\n  for (const r of rows) {\n    if (checks >= VDP_FALLBACK_MAX_CHECKS) break;\n    const raw = r.StockNumber == null ? '' : String(r.StockNumber);\n    const norm = normStock(raw);\n    if (!norm || specialsSet.has(norm)) continue;\n    checks++;\n    if (await vdpIndicatesSpecial.call(this, raw)) {\n      stockVariants(norm).forEach(v => specialsSet.add(v));\n    }\n  }\n  if (DEBUG_SCRAPE) console.log(`[specials] VDP fallback added; now ${specialsSet.size} specials`);\n  return specialsSet;\n}\n\n// ================== MAIN ==================\nasync function main() {\n  const rows = $input.all().map(i => i.json);\n\n  let specialsSet = await fetchAllSpecialStocks.call(this); // normalized stocks\n\n  // If crawl under-delivers, try VDP fallback (capped)\n  if (VDP_SPECIAL_FALLBACK && specialsSet.size < 14) {\n    specialsSet = await augmentSpecialsFromVDP.call(this, rows, specialsSet);\n  }\n\n  // Build feed stock sets (normalized + variants) for debug only\n  const feedStocksNormalized = new Set(rows.map(r => normStock(r.StockNumber)));\n  const feedVariantSet = new Set();\n  feedStocksNormalized.forEach(s => stockVariants(s).forEach(v => feedVariantSet.add(v)));\n\n  const skippedNoImage = [];\n  const skippedStockOrSmall = [];\n\n  const out = await Promise.all(rows.map(async (r) => {\n    const body_style = await resolveBodyStyle.call(this, r);\n\n    const conditionFlag = clean(first(r.NewUsedCert, r.Condition, r.NewUsedFlag)).toUpperCase();\n    const stateOfVehicle =\n      conditionFlag === 'N' || conditionFlag === 'NEW' ? 'New' :\n      conditionFlag === 'U' || conditionFlag === 'USED' ? 'Used' : 'CPO';\n\n    const year  = clean(r.Year);\n    const make  = clean(r.Make);\n    const model = clean(r.Model);\n    const trim  = clean(first(r.Style, r.Trim, r.TrimLevel));\n\n    const transmission = normalizeTransmission(first(r.Transmission, r.Trans, r.TransType));\n    const drivetrain   = normalizeDrivetrain(first(r.Drivetrain, r.DriveType, r.DriveTrain, r.Drive));\n    const extColor     = clean(first(r.ExteriorColor, r.exterior_color, r.Color, r.Exterior));\n\n    const vinRaw = clean(first(r.Vin, r.VIN));\n    const vin17  = vinRaw && vinRaw.length === 17 ? vinRaw : '';\n\n    const rawStock  = r.StockNumber == null ? '' : String(r.StockNumber);\n    const stockNorm = normStock(rawStock);\n\n    const mileageRaw = toInt(first(r.Mileage, r.Odometer, r.odometer));\n    const mileageVal = stateOfVehicle === 'New' ? 0 : (mileageRaw === '' ? '' : mileageRaw);\n\n    const priceUSD = moneyUSD(r.SellingPrice, r.InternetPrice, r.Price, r.RetailPrice, r.MSRP, r.Pricing, r.Cost);\n\n    // Image selection (no proxies, no query params, no stock/thumbnail)\n    const image = await pickImageWithVDPFallback.call(this, r);\n    if (!image) { // either missing or rejected as stock/small\n      if (SKIP_ROWS_WITHOUT_IMAGE) {\n        skippedNoImage.push(stockNorm || rawStock || '(unknown)');\n        return null;\n      }\n    } else if (isChromeData(image) || looksLikeSmallByName(image)) {\n      // Defensive double-check (shouldn't happen due to acceptImageUrl)\n      skippedStockOrSmall.push(stockNorm || rawStock || '(unknown)');\n      if (SKIP_ROWS_WITHOUT_IMAGE) return null;\n    }\n\n    const title = `${year} ${make} ${model} ${trim}`.replace(/\\s+/g, ' ').trim();\n\n    // Prefix-tolerant specials flag (includes VDP fallback set)\n    const isSpecial = isSpecialStock(stockNorm, specialsSet) ? '1' : '0';\n\n    const base = {\n      vehicle_id: vin17 || stockNorm,\n      vin: vin17 || undefined,\n      title,\n      description: buildDescription(r),\n      make, model, year,\n      'mileage.value': mileageVal === '' ? undefined : mileageVal,\n      'mileage.unit' : mileageVal === '' ? undefined : 'MI',\n      exterior_color: extColor || undefined,\n      body_style,\n      transmission: transmission || undefined,\n      drivetrain: drivetrain || undefined,\n      trim: trim || undefined,\n      price: priceUSD || undefined,\n      url: buildVDP(rawStock),           // raw stock for live VDP URL\n      image_link: image || undefined,    // guaranteed direct file URL, no params\n      address: lotAddress,\n      latitude: LOT_LAT,\n      longitude: LOT_LON,\n      state_of_vehicle: stateOfVehicle,\n      custom_label_0: isSpecial         // Product Set filter: equals 1\n    };\n\n    Object.keys(base).forEach(k => {\n      if (base[k] === '' || base[k] === undefined || base[k] === null) delete base[k];\n    });\n\n    return { json: base };\n  }));\n\n  // ---- one-time debug (not per row) ----\n  if (DEBUG_SCRAPE) {\n    const scrapedButNotInFeed = [...specialsSet].filter(s => !feedVariantSet.has(s));\n    console.log(`[specials] scraped uniques: ${specialsSet.size}`);\n    console.log(`[specials] feed uniques (normalized): ${feedStocksNormalized.size}`);\n    console.log(`[specials] scraped but NOT in feed (${scrapedButNotInFeed.length}): ${scrapedButNotInFeed.join(', ') || '(none)'}`);\n    console.log(`[specials] skipped due to no image (${skippedNoImage.length}): ${skippedNoImage.join(', ') || '(none)'}`);\n    console.log(`[specials] skipped stock/small (${skippedStockOrSmall.length}): ${skippedStockOrSmall.join(', ') || '(none)'}`);\n  }\n\n  return out.filter(Boolean);\n}\n\nreturn main.call(this);\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        688,
        0
      ],
      "id": "5bfa1232-fa6b-4444-8cb6-8a6539039941",
      "name": "Transform csv to TikTok format"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 4
            },
            {
              "triggerAtHour": 12
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -208,
        -96
      ],
      "id": "9e3b58e6-2c7c-4183-8b8a-ec61c28620a8",
      "name": "Schedule Inventory Trigger"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        240,
        -96
      ],
      "id": "e4603488-0f5d-43cd-8acc-781baf635a8e",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "path": "/carmackcarcap.csv",
        "options": {}
      },
      "type": "n8n-nodes-base.ftp",
      "typeVersion": 1,
      "position": [
        16,
        -96
      ],
      "id": "5074af99-c163-4cd0-b174-a11dbfffc0e2",
      "name": "FTP",
      "credentials": {
        "ftp": {
          "id": "d0S8cuMjop38k2Bj",
          "name": "ProMax FTP feed"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all().map(i => i.json);\n\nconst COLUMNS = [\n  'vehicle_id','vin','title','description','make','model','year',\n  'mileage.value','mileage.unit','exterior_color','body_style',\n  'transmission','drivetrain','trim','price','url','image_link',\n  'address.addr1','address.city','address.region','address.postal_code',\n  'address.country','latitude','longitude','state_of_vehicle','custom_label_0'\n];\n\n// Build 2D array: [header row, ...data rows]\nconst sheetData = [];\n\n// Row 1: Headers\nsheetData.push(COLUMNS);\n\n// Row 2+: Data\nitems.forEach(item => {\n  const row = COLUMNS.map(col => {\n    if (col.startsWith('address.')) {\n      const addrKey = col.split('.')[1];\n      const value = item.address?.[addrKey];\n      return value != null ? String(value).replace(/\"/g, \"'\") : '';\n    }\n    const value = item[col];\n    return value != null ? String(value).replace(/\"/g, \"'\") : '';\n  });\n  sheetData.push(row);\n});\n\nconsole.log(`Built sheet with ${sheetData.length} rows (including header)`);\n\nreturn [{ json: { values: sheetData } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        912,
        0
      ],
      "id": "58917077-30b4-4b37-9747-badc40f0feb6",
      "name": "Build Sheet Data"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json.values;\n\nif (!data || !Array.isArray(data)) {\n  throw new Error('Invalid data format');\n}\n\nconst rowCount = data.length - 1; // minus header\n\nif (rowCount < 30) {\n  throw new Error(`Only ${rowCount} items found. Expected at least 30. Aborting to prevent data loss.`);\n}\n\n// Check that we have the header row and at least one data row\nif (data.length < 2) {\n  throw new Error('No data rows found');\n}\n\n// Basic check that first data row has values\nconst firstDataRow = data[1];\nif (!firstDataRow || firstDataRow.length < 10) {\n  throw new Error('First data row appears incomplete');\n}\n\nconsole.log(`‚úÖ Validation passed: ${rowCount} vehicles`);\n\nreturn [$input.first()];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1136,
        0
      ],
      "id": "f1e9babc-17c3-49d0-8dfb-7c82e3b4a4e0",
      "name": "Validate Data"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://sheets.googleapis.com/v4/spreadsheets/1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4:batchUpdate",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleSheetsOAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1584,
        0
      ],
      "id": "c15f7b86-1f0e-4b1b-9372-284cf278bc9a",
      "name": "Update Feed_Staging",
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "9WK1ZemzeOSj1j4A",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://sheets.googleapis.com/v4/spreadsheets/1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4:batchUpdate",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleSheetsOAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2032,
        0
      ],
      "id": "e194df79-3367-43fa-ae8b-11929d11b804",
      "name": "Update Feed",
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "9WK1ZemzeOSj1j4A",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const sheetData = $input.first().json.values;\n\n// Build the API request body\nconst apiBody = {\n  \"requests\": [{\n    \"updateCells\": {\n      \"range\": {\n        \"sheetId\": 1780571651,  // Feed_Staging sheet ID\n        \"startRowIndex\": 0,\n        \"startColumnIndex\": 0\n      },\n      \"rows\": sheetData.map(row => ({\n        \"values\": row.map(cell => ({\n          \"userEnteredValue\": {\n            \"stringValue\": String(cell)\n          }\n        }))\n      })),\n      \"fields\": \"userEnteredValue\"\n    }\n  }]\n};\n\nreturn [{ json: apiBody }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1360,
        0
      ],
      "id": "8aa37798-df7a-4ea1-b4ed-a28cb8cb2682",
      "name": "Prepare API Request"
    },
    {
      "parameters": {
        "jsCode": "// Instead of reading from input, reference the original Build Sheet Data node\nconst sheetData = $('Build Sheet Data').first().json.values;\n\n// Rest stays the same\nconst apiBody = {\n  \"requests\": [{\n    \"updateCells\": {\n      \"range\": {\n        \"sheetId\": 0,  // Feed sheet ID\n        \"startRowIndex\": 0,\n        \"startColumnIndex\": 0\n      },\n      \"rows\": sheetData.map(row => ({\n        \"values\": row.map(cell => ({\n          \"userEnteredValue\": {\n            \"stringValue\": String(cell)\n          }\n        }))\n      })),\n      \"fields\": \"userEnteredValue\"\n    }\n  }]\n};\n\nreturn [{ json: apiBody }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1808,
        0
      ],
      "id": "5f4a8893-f49a-40e9-b670-e7118058eca7",
      "name": "Prepare API Request 2"
    },
    {
      "parameters": {
        "jsCode": "// Get the transformed rows from Extract from File\nconst rows = $input.all().map(i => i.json);\n\nconsole.log(`Building Spotlight_Data for ${rows.length} vehicles`);\n\n// Build 2D array: [header row, ...data rows]\nconst sheetData = [];\n\n// Row 1: Headers\nconst COLUMNS = [\n  'VIN',\n  'Stock_Number', \n  'Year',\n  'Make',\n  'Model',\n  'Trim',\n  'Price',\n  'Mileage',\n  'Engine',\n  'Transmission',\n  'Drivetrain',\n  'Exterior_Color',\n  'All_Images', // Pipe-delimited, full URLs\n  'Equipment',\n  'VDP_URL',\n  'Last_Updated'\n];\n\nsheetData.push(COLUMNS);\n\n// Row 2+: Data\nconst now = new Date().toISOString();\n\nrows.forEach(item => {\n  // Get ALL images from the raw CSV data (before TikTok transform)\n  // Check multiple possible field names from Promax\n  const imageField = item.ImageUrlsDelimited \n                  || item.ImageURLsDelimited \n                  || item.ImageUrls_PipeDelimited\n                  || item.image_link\n                  || '';\n  \n  // If it's already pipe-delimited, keep it\n  // If it's comma-separated, convert to pipe\n  let allImagesStr = '';\n  if (imageField) {\n    if (imageField.includes('|')) {\n      allImagesStr = imageField; // Already pipe-delimited\n    } else if (imageField.includes(',')) {\n      allImagesStr = imageField.split(',').map(s => s.trim()).join('|');\n    } else {\n      allImagesStr = imageField; // Single image\n    }\n    \n    // Remove /thumb/ from all URLs for full resolution\n    allImagesStr = allImagesStr.split('|')\n      .map(url => url.trim().replace('/thumb/', '/'))\n      .filter(url => url.length > 0)\n      .join('|');\n  }\n  \n  const row = [\n    item.VIN || item.Vin || '',\n    item.StockNumber || item.Stock_Number || '',\n    item.Year || '',\n    item.Make || '',\n    item.Model || '',\n    item.Style || '',\n    item.SellingPrice || item.InternetPrice || item.Pricing || '',\n    item.Mileage || '',\n    item.Engine || '',\n    item.Transmission || '',\n    item.Drivetrain || '',\n    item.ExteriorColor || item.Color || '',\n    allImagesStr, // ALL images, pipe-delimited, full size\n    item.Equipment || '',\n    item.url || `https://www.ccrantoul.com/VehicleDetails/9199/${item.StockNumber || ''}`,\n    now\n  ];\n  \n  sheetData.push(row);\n});\n\nconsole.log(`‚úÖ Built Spotlight_Data with ${sheetData.length} rows (including header)`);\nconsole.log(`Sample images for first car: ${sheetData[1]?.[12]?.substring(0, 200)}...`);\n\nreturn [{\n  json: {\n    values: sheetData\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        688,
        -192
      ],
      "id": "aad62a60-ad9b-4a7d-8da7-a78cda18399e",
      "name": "Build Spotlight Data"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "https://sheets.googleapis.com/v4/spreadsheets/1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4/values/Spotlight_Data!A1:Z?valueInputOption=USER_ENTERED",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleSheetsOAuth2Api",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "values",
              "value": "={{ $json.values }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1136,
        -192
      ],
      "id": "963cd7d9-eaff-4fb0-967c-79c4272b3b25",
      "name": "Update Spotlight_Data via API",
      "credentials": {
        "httpHeaderAuth": {
          "id": "LQZygyOyKZ5tikRW",
          "name": "VideoBGRemover"
        },
        "googleSheetsOAuth2Api": {
          "id": "9WK1ZemzeOSj1j4A",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4",
          "mode": "list",
          "cachedResultName": "Inventory",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 467345130,
          "mode": "list",
          "cachedResultName": "Spotlight_Data",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4/edit#gid=467345130"
        },
        "clear": "specificRange",
        "range": "A:Z"
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        912,
        -192
      ],
      "id": "005ae4d0-171e-435d-88a4-0e90212aacca",
      "name": "Clear sheet",
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "9WK1ZemzeOSj1j4A",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// TRANSFORM CSV TO META FORMAT\n// Converts ProMax raw data to Meta catalog format\n// Pattern matches Transform csv to TikTok format node\n\n// ================== CONFIG ==================\nconst DEALER_ID = '9199';\nconst DEALER_NAME = 'Capitol Car Credit';\nconst SITE_ORIGIN = 'https://www.ccrantoul.com';\n\n// ================== HELPERS ==================\nconst clean = v => (v == null ? '' : String(v).trim());\nconst first = (...vals) => { for (const v of vals) if (v != null && String(v).trim() !== '') return v; return ''; };\nconst toInt = v => { const n = Number(String(v ?? '').replace(/[^\\d]/g, '')); return Number.isFinite(n) ? n : ''; };\nconst moneyUSD = (...vals) => { const n = toInt(first(...vals)); return n === '' || n <= 0 ? '' : `${n} USD`; };\n\n// ================== NORMALIZERS ==================\nfunction normalizeBodyStyle(s) {\n  const t = String(s || '').toUpperCase();\n  if (!t) return 'SEDAN';\n  const map = {\n    'SEDAN': 'SEDAN', '4DR': 'SEDAN', 'SALOON': 'SEDAN',\n    'COUPE': 'COUPE', '2DR': 'COUPE',\n    'SUV': 'SUV', 'CROSSOVER': 'SUV',\n    'TRUCK': 'TRUCK', 'PICKUP': 'TRUCK',\n    'VAN': 'VAN', 'MINIVAN': 'VAN',\n    'WAGON': 'WAGON',\n    'CONVERTIBLE': 'CONVERTIBLE',\n    'HATCHBACK': 'HATCHBACK'\n  };\n  for (const [key, val] of Object.entries(map)) {\n    if (t.includes(key)) return val;\n  }\n  return 'SEDAN';\n}\n\nfunction normalizeFuelType(s) {\n  const t = clean(s).toUpperCase();\n  if (!t) return 'GASOLINE';\n  if (t.includes('DIESEL')) return 'DIESEL';\n  if (t.includes('HYBRID')) return 'HYBRID';\n  if (t.includes('ELECTRIC') || t.includes('EV')) return 'ELECTRIC';\n  if (t.includes('FLEX') || t.includes('E85')) return 'FLEX_FUEL';\n  return 'GASOLINE';\n}\n\nfunction normalizeTransmission(s) {\n  const t = clean(s).toLowerCase();\n  if (!t) return '';\n  if (t.includes('man')) return 'Manual';\n  if (t.includes('auto') || t.includes('cvt') || t.includes('spd') || t.includes('dct')) return 'Automatic';\n  return clean(s);\n}\n\nfunction normalizeDrivetrain(s) {\n  const t = clean(s).toUpperCase();\n  if (!t) return '';\n  if (t.includes('AWD')) return 'AWD';\n  if (t.includes('4X4') || t.includes('4WD')) return '4WD';\n  if (t.includes('4X2') || t.includes('2WD')) return '2WD';\n  if (t.includes('FWD')) return 'FWD';\n  if (t.includes('RWD')) return 'RWD';\n  return '';\n}\n\nfunction getCondition(mileage, year) {\n  const age = 2025 - parseInt(year);\n  const milesPerYear = mileage / (age || 1);\n  \n  if (milesPerYear < 10000 && age < 3) return 'EXCELLENT';\n  if (milesPerYear < 12000) return 'GOOD';\n  return 'FAIR';\n}\n\n// Parse features from Equipment field\nfunction parseFeatures(equipment) {\n  if (!equipment) return [];\n  \n  const features = [];\n  const text = equipment.toUpperCase();\n  \n  const featureMap = {\n    'LEATHER': { type: 'leather_seats', value: 'Leather Seats' },\n    'SUNROOF': { type: 'sunroof', value: 'Sunroof' },\n    'MOONROOF': { type: 'sunroof', value: 'Moonroof' },\n    'NAVIGATION': { type: 'navigation', value: 'Navigation System' },\n    'NAV': { type: 'navigation', value: 'Navigation System' },\n    'BACKUP CAMERA': { type: 'backup_camera', value: 'Backup Camera' },\n    'REAR VIEW': { type: 'backup_camera', value: 'Backup Camera' },\n    'HEATED SEATS': { type: 'heated_seats', value: 'Heated Seats' },\n    'COOLED SEATS': { type: 'cooled_seats', value: 'Cooled Seats' },\n    'VENTILATED': { type: 'cooled_seats', value: 'Ventilated Seats' },\n    'BLUETOOTH': { type: 'bluetooth', value: 'Bluetooth' },\n    'REMOTE START': { type: 'remote_start', value: 'Remote Start' },\n    'KEYLESS': { type: 'keyless_entry', value: 'Keyless Entry' },\n    'ADAPTIVE CRUISE': { type: 'adaptive_cruise', value: 'Adaptive Cruise Control' },\n    'BLIND SPOT': { type: 'blind_spot', value: 'Blind Spot Monitoring' },\n    'LANE': { type: 'lane_assist', value: 'Lane Assist' }\n  };\n  \n  for (const [keyword, feature] of Object.entries(featureMap)) {\n    if (text.includes(keyword)) {\n      features.push(feature);\n      if (features.length >= 6) break;\n    }\n  }\n  \n  return features;\n}\n\n// ================== ADDRESS ==================\nconst lotAddress = {\n  addr1: '125 N Century Blvd',\n  city: 'Rantoul',\n  region: 'IL',\n  postal_code: '61866',\n  country: 'US'\n};\n\n// ================== BUILD VDP ==================\nfunction buildVDP(stockNumber) {\n  return `${SITE_ORIGIN}/VehicleDetails/${DEALER_ID}/${stockNumber}`;\n}\n\n// ================== MAIN ==================\nconst rows = $input.all().map(i => i.json);\n\nconst out = rows.map(r => {\n  const conditionFlag = clean(first(r.NewUsedCert, r.Condition, r.NewUsedFlag)).toUpperCase();\n  const stateOfVehicle =\n    conditionFlag === 'N' || conditionFlag === 'NEW' ? 'NEW' : 'USED';\n  \n  const year = clean(r.Year);\n  const make = clean(r.Make);\n  const model = clean(r.Model);\n  const trim = clean(first(r.Style, r.Trim, r.TrimLevel));\n  \n  const transmission = normalizeTransmission(first(r.Transmission, r.Trans, r.TransType));\n  const drivetrain = normalizeDrivetrain(first(r.Drivetrain, r.DriveType, r.DriveTrain, r.Drive));\n  const extColor = clean(first(r.ExteriorColor, r.exterior_color, r.Color, r.Exterior));\n  const intColor = clean(first(r.InteriorColor, r.interior_color, r.Interior));\n  \n  const vinRaw = clean(first(r.Vin, r.VIN));\n  const vin17 = vinRaw && vinRaw.length === 17 ? vinRaw : '';\n  \n  const stockNumber = clean(r.StockNumber);\n  \n  const mileageRaw = toInt(first(r.Mileage, r.Odometer, r.odometer));\n  const mileageVal = stateOfVehicle === 'NEW' ? 0 : (mileageRaw === '' ? '' : mileageRaw);\n  \n  const priceUSD = moneyUSD(r.SellingPrice, r.InternetPrice, r.Price, r.RetailPrice, r.MSRP, r.Pricing, r.Cost);\n  const msrp = moneyUSD(r.MSRP);\n  \n  // Images - up to 5\n  const delimited = clean(first(r.ImageUrlsDelimited, r.ImageURLsDelimited, r.ImageUrls_PipeDelimited));\n  const images = delimited ? delimited.split('|').map(s => s.trim()).filter(Boolean) : [];\n  \n  // Body style\n  const bodyStyle = normalizeBodyStyle(first(r.Style, r.BodyStyle, r.Body, r.Class, r.BodyType));\n  \n  // Fuel type\n  const fuelType = normalizeFuelType(first(r.EngineType, r.FuelType, r.Fuel));\n  \n  // Engine\n  const engine = clean(r.Engine);\n  \n  // Description\n  const equipment = clean(r.Equipment);\n  const comments = clean(first(r.Comments, r.Description));\n  let description = `${year} ${make} ${model}`;\n  if (trim) description += ` ${trim}`;\n  if (engine) description += `, ${engine}`;\n  if (transmission) description += `, ${transmission}`;\n  if (mileageVal) description += `, ${mileageVal} miles`;\n  if (comments) description += `. ${comments}`;\n  if (description.length > 4900) description = description.substring(0, 4900) + '...';\n  \n  // Parse features\n  const features = parseFeatures(equipment);\n  \n  // Condition\n  const condition = mileageVal ? getCondition(mileageVal, year) : 'GOOD';\n  \n  // Days on lot\n  let daysOnLot = '';\n  if (r.DateReceived) {\n    try {\n      const dateReceived = new Date(r.DateReceived);\n      const today = new Date();\n      daysOnLot = Math.floor((today - dateReceived) / (1000 * 60 * 60 * 24));\n    } catch {}\n  }\n  \n  const title = `${year} ${make} ${model} ${trim}`.replace(/\\s+/g, ' ').trim();\n  \n  const base = {\n    vehicle_id: vin17 || stockNumber,\n    title,\n    description,\n    price: priceUSD || undefined,\n    year,\n    make,\n    model,\n    trim: trim || undefined,\n    vin: vin17 || undefined,\n    url: buildVDP(stockNumber),\n    stock_number: stockNumber || undefined,\n    \n    // Images\n    'image[0].url': images[0] || undefined,\n    'image[1].url': images[1] || undefined,\n    'image[2].url': images[2] || undefined,\n    'image[3].url': images[3] || undefined,\n    'image[4].url': images[4] || undefined,\n    \n    // Mileage\n    'mileage.value': mileageVal === '' ? undefined : mileageVal,\n    'mileage.unit': mileageVal === '' ? undefined : 'MI',\n    \n    // Address (as JSON string)\n    address: JSON.stringify(lotAddress),\n    \n    // Vehicle details\n    state_of_vehicle: stateOfVehicle,\n    body_style: bodyStyle,\n    exterior_color: extColor || undefined,\n    interior_color: intColor || undefined,\n    transmission: transmission || undefined,\n    drivetrain: drivetrain || undefined,\n    fuel_type: fuelType,\n    \n    // Condition & availability\n    condition,\n    availability: 'AVAILABLE',\n    \n    // Dealer info\n    dealer_id: DEALER_ID,\n    dealer_name: DEALER_NAME,\n    \n    // Optional\n    days_on_lot: daysOnLot || undefined,\n    msrp: msrp || undefined\n  };\n  \n  // Add features (up to 6)\n  features.forEach((feature, index) => {\n    if (index < 6) {\n      base[`features[${index}].value`] = feature.value;\n      base[`features[${index}].type`] = feature.type;\n    }\n  });\n  \n  // Clean up undefined values\n  Object.keys(base).forEach(k => {\n    if (base[k] === '' || base[k] === undefined || base[k] === null) delete base[k];\n  });\n  \n  return { json: base };\n});\n\n// Filter out vehicles without images (Meta requirement)\nconst withImages = out.filter(item => {\n  const hasImage = item.json['image[0].url'] && item.json['image[0].url'].trim() !== '';\n  if (!hasImage) {\n    console.log(`‚ö†Ô∏è Filtered out: ${item.json.title} (${item.json.stock_number}) - no image`);\n  }\n  return hasImage;\n});\n\nconsole.log(`‚úÖ Transformed ${out.length} vehicles to Meta format`);\nconsole.log(`   With images: ${withImages.length}`);\nconsole.log(`   Filtered out (no image): ${out.length - withImages.length}`);\n\nreturn withImages;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        688,
        -384
      ],
      "id": "8a47eceb-5fb3-49b5-8dc4-1bd7084e4e09",
      "name": "Transform to Meta Format"
    },
    {
      "parameters": {
        "jsCode": "// BUILD SHEET DATA META\n// Converts transformed JSON to 2D array for Google Sheets\n// Pattern matches Build Sheet Data (TikTok) node\n\nconst items = $input.all().map(i => i.json);\n\nconst COLUMNS = [\n  'vehicle_id',\n  'title',\n  'description',\n  'price',\n  'year',\n  'make',\n  'model',\n  'trim',\n  'vin',\n  'url',\n  'stock_number',\n  'image[0].url',\n  'image[1].url',\n  'image[2].url',\n  'image[3].url',\n  'image[4].url',\n  'mileage.value',\n  'mileage.unit',\n  'address',\n  'state_of_vehicle',\n  'body_style',\n  'exterior_color',\n  'interior_color',\n  'transmission',\n  'drivetrain',\n  'fuel_type',\n  'condition',\n  'availability',\n  'dealer_id',\n  'dealer_name',\n  'days_on_lot',\n  'features[0].value',\n  'features[0].type',\n  'features[1].value',\n  'features[1].type',\n  'features[2].value',\n  'features[2].type',\n  'features[3].value',\n  'features[3].type',\n  'features[4].value',\n  'features[4].type',\n  'features[5].value',\n  'features[5].type'\n];\n\n// Build 2D array: [header row, ...data rows]\nconst sheetData = [];\n\n// Row 1: Headers\nsheetData.push(COLUMNS);\n\n// Row 2+: Data\nitems.forEach(item => {\n  const row = COLUMNS.map(col => {\n    const value = item[col];\n    return value != null ? String(value).replace(/\"/g, \"'\") : '';\n  });\n  sheetData.push(row);\n});\n\nconsole.log(`‚úÖ Built Meta sheet with ${sheetData.length} rows (including header)`);\nconsole.log(`   Columns: ${COLUMNS.length}`);\nconsole.log(`   Vehicles: ${items.length}`);\n\nreturn [{ json: { values: sheetData } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        912,
        -384
      ],
      "id": "dab2b38e-a7ae-48f4-b20c-863ad7e96193",
      "name": "Build Sheet Data Meta"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json.values;\n\nif (!data || !Array.isArray(data)) {\n  throw new Error('Invalid data format');\n}\n\nconst rowCount = data.length - 1; // minus header\n\nif (rowCount < 30) {\n  throw new Error(`Only ${rowCount} items found. Expected at least 30. Aborting to prevent data loss.`);\n}\n\n// Check that we have the header row and at least one data row\nif (data.length < 2) {\n  throw new Error('No data rows found');\n}\n\n// Basic check that first data row has values\nconst firstDataRow = data[1];\nif (!firstDataRow || firstDataRow.length < 10) {\n  throw new Error('First data row appears incomplete');\n}\n\nconsole.log(`‚úÖ Validation passed: ${rowCount} vehicles`);\n\nreturn [$input.first()];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1136,
        -384
      ],
      "id": "56b8b20a-ac71-4a89-b6b0-fd38b4897eba",
      "name": "Validate Data Meta"
    },
    {
      "parameters": {
        "jsCode": "const sheetData = $input.first().json.values;\n\n// DEBUG: Check data dimensions\nconsole.log(`üìä Sheet data dimensions:`);\nconsole.log(`   Total rows: ${sheetData.length}`);\nconsole.log(`   Header row columns: ${sheetData[0]?.length || 0}`);\nconsole.log(`   First data row columns: ${sheetData[1]?.length || 0}`);\nconsole.log(`   Header preview: ${JSON.stringify(sheetData[0]?.slice(0, 5))}`);\n\n// Build the API request body\nconst apiBody = {\n  \"requests\": [{\n    \"updateCells\": {\n      \"range\": {\n        \"sheetId\": 1551555819,  // Meta_Feed_Staging sheet ID\n        \"startRowIndex\": 0,\n        \"startColumnIndex\": 0\n      },\n      \"rows\": sheetData.map(row => ({\n        \"values\": row.map(cell => ({\n          \"userEnteredValue\": {\n            \"stringValue\": String(cell)\n          }\n        }))\n      })),\n      \"fields\": \"userEnteredValue\"\n    }\n  }]\n};\n\nconsole.log(`üì§ Sending ${apiBody.requests[0].updateCells.rows.length} rows`);\nconsole.log(`üì§ First row has ${apiBody.requests[0].updateCells.rows[0].values.length} columns`);\n\nreturn [{ json: apiBody }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1360,
        -384
      ],
      "id": "f5eb027a-7170-4adf-9e26-94e8490e5c1f",
      "name": "Prepare API Request Meta"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://sheets.googleapis.com/v4/spreadsheets/1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4:batchUpdate",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleSheetsOAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1584,
        -384
      ],
      "id": "32187144-624c-4925-bf1b-667bf4ba65f2",
      "name": "Update Meta_Feed_Staging",
      "executeOnce": true,
      "credentials": {
        "httpHeaderAuth": {
          "id": "LQZygyOyKZ5tikRW",
          "name": "VideoBGRemover"
        },
        "googleSheetsOAuth2Api": {
          "id": "9WK1ZemzeOSj1j4A",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Instead of reading from input, reference the original Build Sheet Data node\nconst sheetData = $('Build Sheet Data Meta').first().json.values;\n\n// Rest stays the same\nconst apiBody = {\n  \"requests\": [{\n    \"updateCells\": {\n      \"range\": {\n        \"sheetId\": 13582147,  // Feed sheet ID\n        \"startRowIndex\": 0,\n        \"startColumnIndex\": 0\n      },\n      \"rows\": sheetData.map(row => ({\n        \"values\": row.map(cell => ({\n          \"userEnteredValue\": {\n            \"stringValue\": String(cell)\n          }\n        }))\n      })),\n      \"fields\": \"userEnteredValue\"\n    }\n  }]\n};\n\nreturn [{ json: apiBody }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1808,
        -384
      ],
      "id": "6d571336-dfad-4352-a391-f15faf34ee70",
      "name": "Prepare API Request 2 Meta"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://sheets.googleapis.com/v4/spreadsheets/1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4:batchUpdate",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleSheetsOAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2032,
        -384
      ],
      "id": "96eeb2af-d2c6-4d9c-bcc8-659d653f2316",
      "name": "Update Meta_Feed",
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "9WK1ZemzeOSj1j4A",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.resend.com/emails",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"from\": \"onboarding@resend.dev\",\n  \"to\": \"kellyraeknight78@gmail.com\", \n  \"subject\": \"AdPilot Alerts\",\n  \"html\": \"The inventory sync failed - FTP data didn't pass validation.<br><br>Issue: Either no data received or fewer than 20 vehicles<br>Time: {{ $now.toISO() }}<br>Rows received: {{ $('Extract from File').all().length }}<br><br>Check Promax FTP: ftp.dealermarketingservices.com<br><br>---<br>Automated alert from n8n\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        896,
        192
      ],
      "id": "a4420d69-678f-4e1b-bfe2-7a520027a403",
      "name": "Send Error Email",
      "credentials": {
        "httpBearerAuth": {
          "id": "vdxOfyrKMfWKSmAH",
          "name": "Resend"
        }
      }
    }
  ],
  "connections": {
    "Limit": {
      "main": [
        [
          {
            "node": "Send Error Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send email": {
      "main": [
        [
          {
            "node": "Stop and Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Transform to Meta Format",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build Spotlight Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Transform csv to TikTok format",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Limit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform csv to TikTok format": {
      "main": [
        [
          {
            "node": "Build Sheet Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Inventory Trigger": {
      "main": [
        [
          {
            "node": "FTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FTP": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Sheet Data": {
      "main": [
        [
          {
            "node": "Validate Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Data": {
      "main": [
        [
          {
            "node": "Prepare API Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Feed_Staging": {
      "main": [
        [
          {
            "node": "Prepare API Request 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare API Request": {
      "main": [
        [
          {
            "node": "Update Feed_Staging",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare API Request 2": {
      "main": [
        [
          {
            "node": "Update Feed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Spotlight Data": {
      "main": [
        [
          {
            "node": "Clear sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clear sheet": {
      "main": [
        [
          {
            "node": "Update Spotlight_Data via API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform to Meta Format": {
      "main": [
        [
          {
            "node": "Build Sheet Data Meta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Sheet Data Meta": {
      "main": [
        [
          {
            "node": "Validate Data Meta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Data Meta": {
      "main": [
        [
          {
            "node": "Prepare API Request Meta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare API Request Meta": {
      "main": [
        [
          {
            "node": "Update Meta_Feed_Staging",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Meta_Feed_Staging": {
      "main": [
        [
          {
            "node": "Prepare API Request 2 Meta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare API Request 2 Meta": {
      "main": [
        [
          {
            "node": "Update Meta_Feed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Error Email": {
      "main": [
        [
          {
            "node": "Send email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "DIT1A5BsEUock2GH",
    "availableInMCP": true
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "2cdbdf3b-a7f0-4749-84a0-ae5b8026a38f",
  "activeVersionId": null,
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-12-13T13:57:23.566Z",
      "createdAt": "2025-12-13T13:57:23.566Z",
      "role": "workflow:owner",
      "workflowId": "GmqYJoJN7YUGmF3z",
      "projectId": "VF66NQc9R74tCdyG"
    }
  ],
  "activeVersion": null,
  "tags": []
}