{
  "updatedAt": "2025-11-12T15:39:31.000Z",
  "createdAt": "2025-10-20T22:01:06.178Z",
  "id": "q4Zl5Zk3nMUOK62m",
  "name": "Create avatar video",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "url": "https://api.heygen.com/v1/video_status.get",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "video_id",
              "value": "={{$node[\"Create avatar video\"].json.data?.video_id || $node[\"Create avatar video\"].json.video_id}}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Api-Key",
              "value": "OWQxZDRjZmUxMmI4NDIzMDg2NjI3NTRmYWJlNTdmMTgtMTc1OTM0MjExNQ=="
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1648,
        960
      ],
      "id": "59d57e12-2869-4b1b-9b47-e2ef7fb28a47",
      "name": "Check status"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7e530ea0-2545-43a0-a589-1b816442e116",
              "leftValue": "={{$json.data?.status}}",
              "rightValue": "completed",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1872,
        896
      ],
      "id": "10951510-89ba-4dfe-b384-6cae9615ef3a",
      "name": "Is complete?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "59716ae0-ecf9-4fe0-88a4-3f9a071c6a2a",
              "leftValue": "={{$json.data?.status}}",
              "rightValue": "failed",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2096,
        992
      ],
      "id": "c48e102f-bc2c-4551-b6e3-d315c8fe04d3",
      "name": "If"
    },
    {
      "parameters": {
        "amount": 20
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2320,
        1152
      ],
      "id": "b98787f4-73c6-4546-97d8-fca086b196ca",
      "name": "Wait",
      "webhookId": "23584160-bf62-4e01-9168-1e72a4e1a8d3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cf7e3768-35ef-4fa4-bc25-f0e4303db083",
              "name": "error_code",
              "value": "={{$json.data?.error?.code}}",
              "type": "string"
            },
            {
              "id": "7a523df6-cf02-4a31-b65d-5492bbf192d0",
              "name": "error_message",
              "value": "={{$json.data?.error?.message}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2320,
        944
      ],
      "id": "0c16acff-68f3-4e49-9032-bd51b218ca56",
      "name": "If error, show message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.videobgremover.com/v1/jobs",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"video_url\": \"{{ $node['Upload to Cloudinary'].item.json[0].secure_url }}\n  \n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1264,
        576
      ],
      "id": "7ba1d200-d8be-4c42-954c-7bfa68a22b02",
      "name": "VBR - Create job",
      "credentials": {
        "httpHeaderAuth": {
          "id": "LQZygyOyKZ5tikRW",
          "name": "VideoBGRemover"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.videobgremover.com/v1/jobs/{{$node[\"VBR - Create job\"].json.id}}/start",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"background\": {\n    \"type\": \"transparent\",\n    \"transparent_format\": \"stacked_video\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1040,
        576
      ],
      "id": "127173d7-97ee-480d-8fc2-8054454eb07a",
      "name": "VBR - Start job",
      "credentials": {
        "httpHeaderAuth": {
          "id": "LQZygyOyKZ5tikRW",
          "name": "VideoBGRemover"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "url": "=https://api.videobgremover.com/v1/jobs/{{ $json.id }}/status",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -816,
        576
      ],
      "id": "c8eda217-9b73-4a92-8ba4-0da6778a6630",
      "name": "VBR - Check job",
      "credentials": {
        "httpHeaderAuth": {
          "id": "LQZygyOyKZ5tikRW",
          "name": "VideoBGRemover"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "cf83b0e8-3358-4922-be97-f3b573e02b6e",
              "leftValue": "={{$json.status}}",
              "rightValue": "completed",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -592,
        496
      ],
      "id": "81c7ccd6-6b66-4552-b0ae-73e0ee6947a4",
      "name": "VBR - Is done?",
      "disabled": true
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -368,
        576
      ],
      "id": "15a82659-66ef-4353-a803-a56b54adf733",
      "name": "Wait - back to check job",
      "webhookId": "3c46b3af-5b8b-4d5b-a3c4-215974899179",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cloudinary.com/v1_1/dtpqxuwby/video/upload",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "file",
              "value": "=data:audio/mpeg;base64,{{ $json.outputs.audio_base64 }}"
            },
            {
              "name": "upload_preset",
              "value": "n8n_unsigned"
            },
            {
              "name": "resource_type",
              "value": "auto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        976,
        960
      ],
      "id": "86e7f433-8bab-41d5-86fa-6ca9cddbd28c",
      "name": "Upload audio to Cloudinary"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.heygen.com/v2/video/generate",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "OWQxZDRjZmUxMmI4NDIzMDg2NjI3NTRmYWJlNTdmMTgtMTc1OTM0MjExNQ=="
            },
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"title\": \"Shad ad draft\",\n  \"video_inputs\": [\n    {\n      \"character\": {\n        \"type\": \"talking_photo\",\n        \"talking_photo_id\": \"{{ $json.avatar_id }}\"\n      },\n      \"voice\": {\n        \"type\": \"audio\",\n        \"audio_url\": \"{{ $json.audio_url }}\"\n      }\n    }\n  ],\n  \"dimension\": { \"width\": 720, \"height\": 1250 }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1424,
        960
      ],
      "id": "66d77d6b-6352-4f3a-89f7-1bef5dbc9232",
      "name": "Create avatar video",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1264,
        1008
      ],
      "id": "b7578533-059b-4ee5-98d5-bc736150cdb0",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9052e83e-ca78-4cd8-be52-e165e8053e8f",
              "name": "",
              "value": "",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -816,
        1008
      ],
      "id": "75bf5e8a-d479-443d-9463-a4b4c80327b0",
      "name": "Normalize Input"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"platform\": \"TikTok\",\n  \"theme\": \"Turkey day specials\",\n  \"email\": \"kelly@kellyrae.net\",\n  \"avatar_id\": \"229bfc03d4d24d5ab7a5c71ce4b10d4b\",\n  \"voice_id\": \"bWI0w7QVOZiBvlJQahML\",\n  \"chromakey_color\": \"#89be5a\",\n  \"chromakey_sensitivity\": \"22\",\n  \"template_id\": \"TEMP_001\",\n  \"template_name\": \"3-Car-Showcase-Vertical\",\n  \"duration_seconds\": 35,\n  \"aspect_ratio\": \"9:16\",\n  \"vehicles\": [\n    {\n      \"vin\": \"2C3CDXHG2PH583306\",\n      \"year\": \"2023\",\n      \"make\": \"Dodge\",\n      \"model\": \"Charger\",\n      \"price\": \"28995 USD\",\n      \"mileage\": \"63339\",\n      \"image_url\": \"https://imageserver.promaxinventory.com/9199/image/d2996d18b9094c75048264b550abf730.jpg\",\n      \"url\": \"https://www.ccrantoul.com/VehicleDetails/9199/91116\",\n      \"features\": [\"Automatic\", \"RWD\", \"BLACK\"]\n    },\n    {\n      \"vin\": \"KL7CJPSBXGB697190\",\n      \"year\": \"2016\",\n      \"make\": \"Chevrolet\",\n      \"model\": \"Trax\",\n      \"price\": \"10995 USD\",\n      \"mileage\": \"81766\",\n      \"image_url\": \"https://imageserver.promaxinventory.com/9199/image/b7bf8f799f827c43a03a964d91965520.jpg\",\n      \"url\": \"https://www.ccrantoul.com/VehicleDetails/9199/91151\",\n      \"features\": [\"Automatic\", \"AWD\", \"BLACK\"]\n    },\n    {\n      \"vin\": \"1GTU9DED5LZ182661\",\n      \"year\": \"2020\",\n      \"make\": \"GMC\",\n      \"model\": \"Sierra 1500 4WD\",\n      \"price\": \"34995 USD\",\n      \"mileage\": \"84655\",\n      \"image_url\": \"https://imageserver.promaxinventory.com/9199/image/647932d99ec5fae8e35c9c3095f7d238.jpg\",\n      \"url\": \"https://www.ccrantoul.com/VehicleDetails/9199/91185\",\n      \"features\": [\"Automatic\", \"4X4\", \"BROWN\"]\n    }\n  ],\n  \"script\": {\n    \"hook\": \"The hook is the most important part!\",\n    \"cars\": [\n      \"car 1 is the best car in the world!\",\n      \"car 2 is the second best car in the world!\",\n      \"car 3 is the turd most best car in the world!\"\n    ],\n    \"cta\": \"This is the cta! wow that is amazing!\",\n    \"full_script\": \"Forget the turkey - we've got the deals that'll make you thankful! Capitol Car Credit's Turkey Day Specials are here! First up - twenty-eight thousand nine hundred ninety-five dollars gets you this twenty twenty-three Dodge Charger with sixty-three thousand miles, automatic transmission, and rear-wheel drive power in sleek black! Next - ten thousand nine hundred ninety-five dollars for this twenty sixteen Shevra-lay Trax with eighty-one thousand miles, automatic, all-wheel drive, perfect for winter in black! And finally - thirty-four thousand nine hundred ninety-five dollars for this twenty twenty G M C Sierra fifteen hundred with eighty-four thousand miles, automatic four by four capability in rugged brown! Amazing selection, unbeatable prices, and financing available for qualified buyers! Don't wait - these Turkey Day deals won't last! Call Capitol Car Credit at two one seven, eight nine three, eight two three two or visit us at one twenty-five North Century Boulevard in Rantoul!\",\n    \"notes\": \"Used Thanksgiving theme in hook. Separated each car into individual array entries for precise audio timing generation.\"\n  },\n  \"media\": {\n    \"music_url\": null,\n    \"background_video_url\": null,\n    \"background_image_url\": null,\n    \"theme_overlay_url\": null,\n    \"logo_url\": \"https://res.cloudinary.com/dtpqxuwby/image/upload/v1759260627/logo_small_334x179.jpg\"\n  },\n  \"outputs\": {\n    \"avatar_video_url\": null,\n    \"creatomate_video_url\": null,\n    \"final_video_url\": null\n  }\n}",
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1040,
        1008
      ],
      "id": "97b9864c-fdd2-4f31-9cd0-71319f20b6ac",
      "name": "Stubs",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// This node runs after Cloudinary upload with the avatar video\nconst videoUrl = $json.data.video_url;\nconst duration = Number($json.data.duration);\n\n// Get the original videoConfig that was passed in\nconst updatedConfig = $('Add audio to config').first().json;\n\nreturn [{\n  json: {\n    ...updatedConfig,  // Keep the entire videoConfig\n    \n    // Update the outputs section\n    outputs: {\n      ...updatedConfig.outputs,\n      avatar_video_url: videoUrl,\n      avatar_duration: duration\n    },\n    \n    // Also add these at root level for backward compatibility\n    video_url: videoUrl,\n    heygen_video_url: videoUrl,\n    duration: duration,\n    video_duration: duration\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2096,
        800
      ],
      "id": "7727b59a-08cf-4ce5-8cae-91fa73a340a9",
      "name": "Add video data to config"
    },
    {
      "parameters": {
        "jsCode": "// Get the Cloudinary upload response\nconst audioUrl = $json.secure_url;\nconst audioId = $json.public_id;\n\n// Get the config with updated vehicle timings from Calculate Car Timings\nconst configWithTimings = $('Concatenate Audio Files').first().json;\n\n// Get the original config for any fields not in the timings version\nconst originalConfig = $('Normalize Input').first().json;\n\nreturn [{\n  json: {\n    ...configWithTimings,  // Use the version with updated vehicle timings!\n    \n    // Update the outputs section\n    outputs: {\n      ...configWithTimings.outputs,\n      audio_url: audioUrl,\n      audio_cloudinary_id: audioId,\n      audio_base64: undefined,  // ← Remove the heavy base64 data\n    },\n    \n    // Also add these at root level for backward compatibility\n    audio_url: audioUrl,\n    audio_cloudinary_id: audioId,\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        960
      ],
      "id": "e2f1e2b3-0d06-40e3-8632-0e68f979259f",
      "name": "Add audio to config"
    },
    {
      "parameters": {
        "jsCode": "const config = $json;\nconst script = config.script;\nconst vehicles = config.vehicles;\n\nif (!script.hook || !script.segments || !script.cta) {\n  throw new Error('Script missing required sections');\n}\n\n// Build minimal sections array - ONLY what ElevenLabs needs\nconst sections = [\n  { \n    name: 'hook',\n    text: script.hook,\n    index: 0\n  },\n  ...script.segments.map((segmentText, index) => ({\n    name: vehicles[index]?.vin || \"feature_\"+index,\n    text: segmentText,\n    index: index + 1\n  })),\n  { \n    name: 'cta',\n    text: script.cta,\n    index: script.segments.length + 1\n  }\n];\n\nconsole.log('Sections:', sections.map(s => s.name).join(', '));\n\n// Return JUST the section data - clean and simple\nreturn sections.map(section => ({\n  json: {\n    name: section.name,\n    text: section.text,\n    index: section.index,\n    voice_id: config.voice_id\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        1184
      ],
      "id": "4385325e-dbc9-4247-af93-51a2b841da45",
      "name": "Prepare Sections"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -368,
        1184
      ],
      "id": "400de794-3abe-4f44-879f-cd1802549b80",
      "name": "Split in Batches"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.elevenlabs.io/v1/text-to-speech/{{ $('Normalize Input').item.json.voice_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"text\": \"{{ $json.text}}\",\n  \"model_id\": \"eleven_v3\",\n  \"voice_settings\": {\n    \"stability\": 0.5,\n    \"similarity_boost\": 0.75,\n    \"style\": 0,\n    \"use_speaker_boost\": true\n  },\n  \"output_format\": \"mp3_44100_128\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -144,
        1232
      ],
      "id": "52dd07f5-3636-4be1-ae06-e583b44b02b1",
      "name": "Generate Section Audio",
      "credentials": {
        "httpHeaderAuth": {
          "id": "rF8Db64Xo3IjoeOL",
          "name": "ElevenLabs API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const config = $json;\nconst audioSections = config._audio_sections;\n\nif (!audioSections || audioSections.length === 0) {\n  throw new Error('No audio sections to concatenate!');\n}\n\nconsole.log(`Concatenating ${audioSections.length} audio sections...`);\n\n// Convert all base64 audio to buffers\nconst audioBuffers = audioSections.map(section => {\n  if (!section.audio_base64) {\n    throw new Error(`Section ${section.section_name} missing audio_base64!`);\n  }\n  return Buffer.from(section.audio_base64, 'base64');\n});\n\nconsole.log('Audio buffers created:', audioBuffers.map((buf, i) => \n  `${audioSections[i].section_name}: ${(buf.length / 1024).toFixed(2)}KB`\n).join(', '));\n\n// Simple concatenation: MP3 files can be concatenated by joining the data\n// This works because MP3 frames are self-contained\nconst concatenatedBuffer = Buffer.concat(audioBuffers);\n\n// Convert back to base64\nconst concatenatedBase64 = concatenatedBuffer.toString('base64');\n\nconst totalSize = concatenatedBuffer.length;\nconsole.log(`✅ Concatenated audio size: ${(totalSize / 1024).toFixed(2)} KB`);\n\n// Remove huge individual base64 chunks\nconst cleanedAudioSections = (config._audio_sections || []).map(section => ({\n  section_name: section.section_name,\n  section_index: section.section_index,\n  section_text: section.section_text,\n  // audio_base64 intentionally omitted\n}));\n\nreturn [{\n  json: {\n    ...config,\n    // Replace with cleaned version (no base64)\n    _audio_sections: cleanedAudioSections,\n    outputs: {\n      ...(config.outputs || {}),\n      audio_base64: concatenatedBase64\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        752,
        960
      ],
      "id": "bc48dee2-6b1d-46a2-9eb5-def150e0d273",
      "name": "Concatenate Audio Files"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "includeUnpaired": true
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        304,
        960
      ],
      "id": "9e070df5-6d1c-4eff-93cb-f13c88aed9fa",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "const config = $json;\nconst audioSections = $input.first().json._audio_sections;\n\nif (!audioSections || audioSections.length === 0) {\n  throw new Error('No audio sections found!');\n}\n\nconsole.log('Calculating timings for', audioSections.length, 'sections');\n\n// Calculate cumulative timings\nlet currentTime = 0;\nconst timings = [];\n\nfor (const section of audioSections) {\n  const startTime = currentTime;\n  const endTime = currentTime + section.duration_seconds;\n  \n  timings.push({\n    section_name: section.section_name,\n    start_time: Math.round(startTime),\n    end_time: Math.round(endTime),\n    duration: Math.round(section.duration_seconds)\n  });\n  \n  currentTime = endTime;\n  \n  console.log(`${section.section_name}: ${Math.round(startTime)}s - ${Math.round(endTime)}s`);\n}\n\n// Extract car timings specifically (sections with VINs)\nconst carTimings = timings.filter(t => \n  t.section_name !== 'hook' && t.section_name !== 'cta'\n);\n\nconsole.log('Car sections found:', carTimings.length);\n\n// Update vehicles with accurate timings\nconst updatedVehicles = config.vehicles.map((vehicle, index) => {\n  const carTiming = carTimings[index];\n  \n  if (!carTiming) {\n    console.warn(`No timing found for vehicle ${index + 1} (${vehicle.vin})`);\n    return vehicle;\n  }\n  \n  console.log(`Vehicle ${vehicle.vin}: ${carTiming.start_time}s - ${carTiming.end_time}s`);\n  \n  return {\n    ...vehicle,\n    start_time: carTiming.start_time,\n    end_time: carTiming.end_time\n  };\n});\n\nconst totalDuration = Math.round(currentTime);\n\nconsole.log(`✅ Total audio duration: ${totalDuration}s`);\nconsole.log(`✅ Updated ${updatedVehicles.length} vehicles with timings`);\n\nreturn [{\n  json: {\n    ...config,\n    vehicles: updatedVehicles,\n    _audio_sections: audioSections,\n    _section_timings: timings,\n    outputs: {\n      ...(config.outputs || {}),\n      audio_duration: totalDuration\n    }\n  }\n}];\n\n// ... existing code ...\n\nconst fileSizeBytes = binaryData.length;\nconst BITRATE_KBPS = 128;\nconst durationSeconds = (fileSizeBytes * 8) / (BITRATE_KBPS * 1000);\nconst roundedDuration = Math.round(durationSeconds * 100) / 100;\n\nconsole.log(`File size: ${fileSizeBytes} bytes`);\nconsole.log(`Calculated duration: ${durationSeconds}s`);\nconsole.log(`Rounded duration: ${roundedDuration}s`);\n\nif (roundedDuration === 0 || !roundedDuration) {\n  console.warn('⚠️ Duration is 0 or null! File might be too small.');\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        960
      ],
      "id": "5debe798-d3ab-4422-9e97-29b25bfd078b",
      "name": "Calculate Car Timings from Durations1"
    },
    {
      "parameters": {
        "jsCode": "const inputData = $json;\nconst binaryItems = inputData.items || [];\n\nconsole.log('Processing', binaryItems.length, 'binary items');\n\nconst audioSections = [];\n\nfor (let i = 0; i < binaryItems.length; i++) {\n  const item = binaryItems[i];\n  \n  const name = item.name;\n  const text = item.text;\n  const index = item.index;\n  const audioBase64 = item.audio_base64; // Already provided by Combine!\n  \n  if (!audioBase64) {\n    console.warn(`No audio_base64 for ${name}`);\n    continue;\n  }\n  \n  // Parse file size from the file_size field\n  const fileSizeStr = item.file_size;\n  let fileSizeBytes;\n  \n  if (fileSizeStr && fileSizeStr.includes('kB')) {\n    const kb = parseFloat(fileSizeStr.replace(' kB', ''));\n    fileSizeBytes = Math.round(kb * 1024);\n  } else if (fileSizeStr && fileSizeStr.includes('MB')) {\n    const mb = parseFloat(fileSizeStr.replace(' MB', ''));\n    fileSizeBytes = Math.round(mb * 1024 * 1024);\n  } else {\n    // Calculate from base64 length as fallback\n    fileSizeBytes = Math.round((audioBase64.length * 3) / 4);\n  }\n  \n  const BITRATE_KBPS = 128;\n  const durationSeconds = (fileSizeBytes * 8) / (BITRATE_KBPS * 1000);\n  const roundedDuration = Math.round(durationSeconds * 100) / 100;\n  \n  console.log(`Section \"${name}\": ${fileSizeBytes} bytes = ${roundedDuration}s`);\n  \n  audioSections.push({\n    section_name: name,\n    section_index: index,\n    section_text: text,\n    audio_base64: audioBase64,\n    duration_seconds: roundedDuration,\n    file_size_bytes: fileSizeBytes\n  });\n}\n\naudioSections.sort((a, b) => a.section_index - b.section_index);\n\nconsole.log('Extracted durations for', audioSections.length, 'sections');\n\nreturn [{\n  json: {\n    _audio_sections: audioSections\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        1040
      ],
      "id": "da2f5534-ca6b-4c83-b087-1e81d37fce9d",
      "name": "Extract All Durations"
    },
    {
      "parameters": {
        "jsCode": "const allItems = $input.all();\n\nconsole.log('Combining', allItems.length, 'binary items');\n\nconst binaryItems = [];\n\nfor (let i = 0; i < allItems.length; i++) {\n  const item = allItems[i];\n  \n  // Get the actual binary buffer while we still have access\n  let binaryBuffer = null;\n  \n  try {\n    binaryBuffer = await this.helpers.getBinaryDataBuffer(i, 'data');\n    console.log(`✅ Got buffer ${i} (${item.json.name}): ${binaryBuffer.length} bytes`);\n  } catch (error) {\n    console.warn(`❌ Failed buffer ${i}:`, error.message);\n  }\n  \n  // Convert to base64 NOW while we have the buffer\n  const audioBase64 = binaryBuffer ? binaryBuffer.toString('base64') : null;\n  \n  binaryItems.push({\n    name: item.json.name,\n    text: item.json.text,\n    index: item.json.index,\n    audio_base64: audioBase64, // Store base64 here!\n    file_size: item.binary?.data?.fileSize\n  });\n}\n\nreturn [{\n  json: {\n    items: binaryItems\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -144,
        1040
      ],
      "id": "53f3cb48-b7ce-4ed3-a4f5-b07ec57ebbf0",
      "name": "Combine Binary Items"
    }
  ],
  "connections": {
    "Check status": {
      "main": [
        [
          {
            "node": "Is complete?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is complete?": {
      "main": [
        [
          {
            "node": "Add video data to config",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "If error, show message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Check status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VBR - Create job": {
      "main": [
        [
          {
            "node": "VBR - Start job",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VBR - Start job": {
      "main": [
        [
          {
            "node": "VBR - Check job",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VBR - Check job": {
      "main": [
        [
          {
            "node": "VBR - Is done?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VBR - Is done?": {
      "main": [
        [],
        [
          {
            "node": "Wait - back to check job",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait - back to check job": {
      "main": [
        [
          {
            "node": "VBR - Check job",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload audio to Cloudinary": {
      "main": [
        [
          {
            "node": "Add audio to config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create avatar video": {
      "main": [
        [
          {
            "node": "Check status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Stubs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Input": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare Sections",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stubs": {
      "main": [
        [
          {
            "node": "Normalize Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add video data to config": {
      "main": [
        []
      ]
    },
    "Add audio to config": {
      "main": [
        [
          {
            "node": "Create avatar video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Sections": {
      "main": [
        [
          {
            "node": "Split in Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split in Batches": {
      "main": [
        [
          {
            "node": "Combine Binary Items",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate Section Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Section Audio": {
      "main": [
        [
          {
            "node": "Split in Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Concatenate Audio Files": {
      "main": [
        [
          {
            "node": "Upload audio to Cloudinary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Calculate Car Timings from Durations1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Car Timings from Durations1": {
      "main": [
        [
          {
            "node": "Concatenate Audio Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract All Durations": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Combine Binary Items": {
      "main": [
        [
          {
            "node": "Extract All Durations",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "e0679758-279a-495e-be31-1d66af034a23",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-10-20T22:01:06.181Z",
      "createdAt": "2025-10-20T22:01:06.181Z",
      "role": "workflow:owner",
      "workflowId": "q4Zl5Zk3nMUOK62m",
      "projectId": "bll44iFOa92qb20Q"
    }
  ],
  "tags": [
    {
      "updatedAt": "2025-10-20T22:01:51.760Z",
      "createdAt": "2025-10-20T22:01:51.760Z",
      "id": "4o01JEB63Qahv9wy",
      "name": "PROD"
    }
  ]
}