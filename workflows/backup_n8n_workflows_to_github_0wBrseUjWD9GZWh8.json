{
  "updatedAt": "2025-12-10T16:08:41.847Z",
  "createdAt": "2025-11-15T21:59:07.648Z",
  "id": "0wBrseUjWD9GZWh8",
  "name": "Backup n8n Workflows to GitHub",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 2 * * *"
            }
          ]
        }
      },
      "id": "699bce1e-bba0-4099-9243-5dfae52faca1",
      "name": "Daily Backup at 2 AM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1536,
        96
      ]
    },
    {
      "parameters": {
        "url": "https://kelly-ads.app.n8n.cloud/api/v1/workflows",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "39ec583e-87f1-4f3c-8d15-d257e505bd16",
      "name": "Get All Workflows",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1312,
        96
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "LCCBNzyoX2dEJyEA",
          "name": "N8N"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json.data || $input.first().json;\nlet workflows = Array.isArray(data) ? data : [data];\n\n// Filter out any items that don't have an 'id' and 'name' (real workflows)\nworkflows = workflows.filter(wf => wf && wf.id && wf.name);\n\nconsole.log(`Processing ${workflows.length} valid workflows`);\n\nconst formattedWorkflows = workflows.map(wf => {\n  const safeName = wf.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();\n  const filename = `${safeName}_${wf.id}.json`;\n  \n  return {\n    name: wf.name,\n    id: wf.id,\n    filename: filename,\n    content: JSON.stringify(wf, null, 2),\n    contentBase64: Buffer.from(JSON.stringify(wf, null, 2)).toString('base64')\n  };\n});\n\nreturn formattedWorkflows.map(wf => ({ json: wf }));"
      },
      "id": "2e55ff74-e041-4839-8319-39f5be8b3017",
      "name": "Format for GitHub",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1088,
        96
      ]
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://api.github.com/repos/kknight78/ad-pilot-workflows/contents/workflows/{{ $json.filename }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"message\": \"{{ 'Backup: ' + $json.name + ' - ' + $now.toISO() }}\",\n  \"content\": \"{{ $json.contentBase64 }}\",\n  \"branch\": \"main\"\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "90fdb52a-0db0-4d5d-8dbb-40a6c84f58dc",
      "name": "Try Create File",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -864,
        96
      ],
      "retryOnFail": false,
      "waitBetweenTries": 2000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "04C2CxsFzc1VS9wa",
          "name": "Github Token"
        }
      },
      "continueOnFail": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const response = $json;\nconst workflowData = $('Format for GitHub').item.json;\n\n// Check response structure - error case has error.message and error.status\nconst isError = response.error || response.name === 'AxiosError';\nconst statusCode = response.status || response.statusCode || 0;\n\nconsole.log(`Checking ${workflowData.name}: isError=${isError}, status=${statusCode}`);\n\nif (isError || statusCode === 422) {\n  // File exists, needs SHA to update - route to update path\n  console.log(`ðŸ“ File exists, routing to update: ${workflowData.name}`);\n  return { json: { \n    success: false, \n    needs_update: true,\n    workflow: workflowData,\n    filename: workflowData.filename\n  } };\n} else if (statusCode === 201) {\n  // New file created successfully\n  console.log(`âœ… Created new file: ${workflowData.name}`);\n  return { json: { \n    success: true,\n    needs_update: false,\n    workflow: workflowData.name,\n    action: 'created'\n  } };\n} else {\n  // Unexpected response - log and route to update to be safe\n  console.log(`âš ï¸ Unexpected response for ${workflowData.name}, routing to update`);\n  return { json: { \n    success: false, \n    needs_update: true,\n    workflow: workflowData,\n    filename: workflowData.filename\n  } };\n}"
      },
      "id": "91831251-4e97-4150-a12f-ef0d830b28b5",
      "name": "Check Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -640,
        96
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_update }}",
              "value2": true
            }
          ]
        }
      },
      "id": "3754192f-5991-4263-b83b-a48202bd5a87",
      "name": "Needs Update?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -416,
        96
      ]
    },
    {
      "parameters": {
        "url": "=https://api.github.com/repos/kknight78/ad-pilot-workflows/contents/workflows/{{ $json.filename }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1,
              "batchInterval": 100
            }
          }
        }
      },
      "id": "0764e992-7444-40cc-832e-4cdb916e5952",
      "name": "Get Current SHA",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -192,
        32
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "04C2CxsFzc1VS9wa",
          "name": "Github Token"
        }
      }
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://api.github.com/repos/kknight78/ad-pilot-workflows/contents/workflows/{{ $json.filename }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"message\": \"{{ 'Update: ' + $json.workflow.name + ' - ' + $now.toISO() }}\",\n  \"content\": \"{{ $json.workflow.contentBase64 }}\",\n  \"sha\": \"{{ $json.sha }}\",\n  \"branch\": \"main\"\n}",
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1,
              "batchInterval": 500
            }
          }
        }
      },
      "id": "94041267-12ca-455e-9a09-e5f529953d08",
      "name": "Update File",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        480,
        -48
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "04C2CxsFzc1VS9wa",
          "name": "Github Token"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const workflow = $('Needs Update?').item.json.workflow;\nconsole.log(`âœ… Updated: ${workflow.name}`);\nreturn [{ json: { success: true, action: 'updated', workflow: workflow.name } }];"
      },
      "id": "886687ce-7bc4-405b-a3bc-0d5dabb18b41",
      "name": "Log Update",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        704,
        -48
      ]
    },
    {
      "parameters": {
        "jsCode": "// Collect all the execution results\nconst allItems = $input.all();\n\nlet successes = 0;\nlet failures = 0;\nlet failedWorkflows = [];\n\nallItems.forEach(item => {\n  if (item.json.success) {\n    successes++;\n  } else if (item.json.error || item.json.needs_update === undefined) {\n    failures++;\n    failedWorkflows.push(item.json.workflow?.name || item.json.workflow || 'Unknown');\n  }\n});\n\nconsole.log(`âœ… Successes: ${successes}, âŒ Failures: ${failures}`);\n\nreturn [{\n  json: {\n    total: allItems.length,\n    successes: successes,\n    failures: failures,\n    failedWorkflows: failedWorkflows,\n    hasFailures: failures > 0\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        928,
        96
      ],
      "id": "5d9bea72-51b4-4ee0-9267-a6c57301477a",
      "name": "Aggregate Results"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "b2928d61-9cef-4c3a-9b03-c01a26891370",
              "leftValue": "={{ $json.hasFailures }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1152,
        96
      ],
      "id": "7940083a-972c-4589-becf-7da2615885d9",
      "name": "If"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1376,
        192
      ],
      "id": "ec514100-f164-46dd-866d-424a59b5f24c",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "fromEmail": "errors@ad-pilot.ai",
        "toEmail": "kelly@ad-pilot.ai",
        "subject": "âš ï¸ n8n GitHub Backup Failed",
        "html": "={{ \"GitHub backup workflow encountered errors:\\n\\nTotal workflows: \" + $json.total + \"\\nSuccessful: \" + $json.successes + \"\\nFailed: \" + $json.failures + \"\\n\\nFailed workflows:\\n\" + $json.failedWorkflows.join('\\n') + \"\\n\\nCheck n8n executions: https://kelly-ads.app.n8n.cloud/\" }}",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        1376,
        0
      ],
      "id": "c9c6bb97-4443-4b0a-bef8-b404f342acb8",
      "name": "Send email",
      "webhookId": "97015b61-1940-4d68-8f6c-a0e246b9abb4",
      "credentials": {
        "smtp": {
          "id": "5HPC3NyTgaxCbH6e",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// DEBUG: Log exactly what we're getting\nconsole.log('=== Compare Content Debug ===');\nconsole.log('Input $json keys:', Object.keys($json));\nconsole.log('Input $json.sha:', $json.sha);\nconsole.log('Input $json.name:', $json.name);\n\nconst sha = $json.sha;\nconst filename = $json.name;\n\n// Validate SHA looks like a blob SHA (40 hex chars)\nif (!sha || sha.length !== 40) {\n  console.log('ERROR: Invalid SHA:', sha);\n}\n\n// Find matching workflow from Needs Update?\nconst needsUpdateItems = $('Needs Update?').all();\nconsole.log('Needs Update items count:', needsUpdateItems.length);\n\nconst match = needsUpdateItems.find(i => i.json.filename === filename);\n\nif (!match) {\n  console.log('Available filenames:', needsUpdateItems.map(i => i.json.filename).join(', '));\n  throw new Error('No match for ' + filename);\n}\n\n// Check if match has a sha property (it shouldn't!)\nif (match.json.sha) {\n  console.log('WARNING: match.json has sha property:', match.json.sha);\n}\n\nconsole.log('Matched workflow:', match.json.workflow?.name);\nconsole.log('Output sha:', sha);\nconsole.log('Output filename:', filename);\n\nreturn {\n  json: {\n    sha: sha,\n    filename: filename,\n    workflow: match.json.workflow,\n    needs_update: true\n  }\n};",
        "mode": "runOnceForEachItem"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32,
        32
      ],
      "id": "compare-content-node",
      "name": "Compare Content"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_update }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        256,
        32
      ],
      "id": "if-content-changed",
      "name": "Content Changed?"
    }
  ],
  "connections": {
    "Daily Backup at 2 AM": {
      "main": [
        [
          {
            "node": "Get All Workflows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All Workflows": {
      "main": [
        [
          {
            "node": "Format for GitHub",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for GitHub": {
      "main": [
        [
          {
            "node": "Try Create File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Try Create File": {
      "main": [
        [
          {
            "node": "Check Result",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Result": {
      "main": [
        [
          {
            "node": "Needs Update?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Update?": {
      "main": [
        [
          {
            "node": "Get Current SHA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Current SHA": {
      "main": [
        [
          {
            "node": "Compare Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compare Content": {
      "main": [
        [
          {
            "node": "Update File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update File": {
      "main": [
        [
          {
            "node": "Log Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Update": {
      "main": [
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Results": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Send email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {
    "node:Daily Backup at 2 AM": {
      "recurrenceRules": []
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "20c5da5b-14e4-41f8-bb43-4ca2d6265673",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-11-15T21:59:07.654Z",
      "createdAt": "2025-11-15T21:59:07.654Z",
      "role": "workflow:owner",
      "workflowId": "0wBrseUjWD9GZWh8",
      "projectId": "bll44iFOa92qb20Q"
    }
  ],
  "tags": []
}