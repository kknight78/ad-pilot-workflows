{
  "updatedAt": "2025-11-17T14:42:27.000Z",
  "createdAt": "2025-11-15T21:59:07.648Z",
  "id": "0wBrseUjWD9GZWh8",
  "name": "Backup n8n Workflows to GitHub",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 2 * * *"
            }
          ]
        }
      },
      "id": "699bce1e-bba0-4099-9243-5dfae52faca1",
      "name": "Daily Backup at 2 AM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1536,
        112
      ]
    },
    {
      "parameters": {
        "url": "https://kelly-ads.app.n8n.cloud/api/v1/workflows",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "39ec583e-87f1-4f3c-8d15-d257e505bd16",
      "name": "Get All Workflows",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1328,
        112
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "LCCBNzyoX2dEJyEA",
          "name": "N8N"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json.data || $input.item.json;\nlet workflows = Array.isArray(data) ? data : [data];\n\n// Filter out any items that don't have an 'id' and 'name' (real workflows)\nworkflows = workflows.filter(wf => wf && wf.id && wf.name);\n\nconsole.log(`Processing ${workflows.length} valid workflows`);\n\nconst formattedWorkflows = workflows.map(wf => {\n  const safeName = wf.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();\n  const filename = `${safeName}_${wf.id}.json`;\n  \n  return {\n    name: wf.name,\n    id: wf.id,\n    filename: filename,\n    content: JSON.stringify(wf, null, 2),\n    contentBase64: Buffer.from(JSON.stringify(wf, null, 2)).toString('base64')\n  };\n});\n\nreturn formattedWorkflows.map(wf => ({ json: wf }));"
      },
      "id": "2e55ff74-e041-4839-8319-39f5be8b3017",
      "name": "Format for GitHub",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1104,
        112
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "6d8f58ad-7bbc-46f0-b098-4398961b9b4c",
      "name": "Process One at a Time",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -880,
        112
      ]
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://api.github.com/repos/kknight78/ad-pilot-workflows/contents/workflows/{{ $json.filename }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"message\": \"{{ 'Backup: ' + $json.name + ' - ' + $now.toISO() }}\",\n  \"content\": \"{{ $json.contentBase64 }}\",\n  \"branch\": \"main\"\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "90fdb52a-0db0-4d5d-8dbb-40a6c84f58dc",
      "name": "Try Create File",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -656,
        112
      ],
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "04C2CxsFzc1VS9wa",
          "name": "Github Token"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const inputData = $input.first();\nconst response = inputData.json;\nconst workflowData = $('Process One at a Time').item.json;\n\n// Check for error in multiple places\nconst hasError = response.error || response.message?.includes('sha') || response.message?.includes('Invalid');\n\nconsole.log(`Checking ${workflowData.name}:`, { hasError, message: response.message });\n\nif (hasError) {\n  // Any error means file exists and needs update\n  console.log(`üìù Needs update: ${workflowData.name}`);\n  return [{ json: { \n    success: false, \n    needs_update: true,\n    workflow: workflowData,\n    filename: workflowData.filename\n  } }];\n} else {\n  // No error = success\n  console.log(`‚úÖ Success: ${workflowData.name}`);\n  return [{ json: { \n    success: true,\n    needs_update: false,\n    workflow: workflowData.name\n  } }];\n}"
      },
      "id": "91831251-4e97-4150-a12f-ef0d830b28b5",
      "name": "Check Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -448,
        112
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_update }}",
              "value2": true
            }
          ]
        }
      },
      "id": "3754192f-5991-4263-b83b-a48202bd5a87",
      "name": "Needs Update?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -224,
        112
      ]
    },
    {
      "parameters": {
        "url": "=https://api.github.com/repos/kknight78/ad-pilot-workflows/contents/workflows/{{ $json.filename }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "options": {}
      },
      "id": "0764e992-7444-40cc-832e-4cdb916e5952",
      "name": "Get Current SHA",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        208,
        0
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "04C2CxsFzc1VS9wa",
          "name": "Github Token"
        }
      }
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://api.github.com/repos/kknight78/ad-pilot-workflows/contents/workflows/{{ $('Needs Update?').item.json.filename }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/vnd.github.v3+json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"message\": \"{{ 'Update: ' + $('Needs Update?').item.json.workflow.name + ' - ' + $now.toISO() }}\",\n  \"content\": \"{{ $('Needs Update?').item.json.workflow.contentBase64 }}\",\n  \"sha\": \"{{ $json.sha }}\",\n  \"branch\": \"main\"\n}",
        "options": {}
      },
      "id": "94041267-12ca-455e-9a09-e5f529953d08",
      "name": "Update File",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        432,
        0
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "04C2CxsFzc1VS9wa",
          "name": "Github Token"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const workflow = $('Needs Update?').item.json.workflow;\nconsole.log(`‚úÖ Updated: ${workflow.name}`);\nreturn [{ json: { success: true, action: 'updated', workflow: workflow.name } }];"
      },
      "id": "886687ce-7bc4-405b-a3bc-0d5dabb18b41",
      "name": "Log Update",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        656,
        0
      ]
    },
    {
      "parameters": {},
      "id": "77c1c47b-72db-48a6-b7c3-5315e6366f61",
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        656,
        208
      ]
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -16,
        16
      ],
      "id": "fcf3d34b-26d3-4041-a359-fc150fae36f5",
      "name": "Wait",
      "webhookId": "b83fc6ef-5128-499f-bc89-03cd9a6d573d"
    },
    {
      "parameters": {
        "jsCode": "// Collect all the execution results\nconst allItems = $input.all();\n\nlet successes = 0;\nlet failures = 0;\nlet failedWorkflows = [];\n\nallItems.forEach(item => {\n  if (item.json.success) {\n    successes++;\n  } else if (item.json.error || item.json.needs_update === undefined) {\n    failures++;\n    failedWorkflows.push(item.json.workflow?.name || item.json.workflow || 'Unknown');\n  }\n});\n\nconsole.log(`‚úÖ Successes: ${successes}, ‚ùå Failures: ${failures}`);\n\nreturn [{\n  json: {\n    total: allItems.length,\n    successes: successes,\n    failures: failures,\n    failedWorkflows: failedWorkflows,\n    hasFailures: failures > 0\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        864,
        208
      ],
      "id": "5d9bea72-51b4-4ee0-9267-a6c57301477a",
      "name": "Aggregate Results"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "b2928d61-9cef-4c3a-9b03-c01a26891370",
              "leftValue": "={{ $json.hasFailures }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1072,
        208
      ],
      "id": "7940083a-972c-4589-becf-7da2615885d9",
      "name": "If"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1280,
        304
      ],
      "id": "ec514100-f164-46dd-866d-424a59b5f24c",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "fromEmail": "errors@ad-pilot.ai",
        "toEmail": "kelly@ad-pilot.ai",
        "subject": "‚ö†Ô∏è n8n GitHub Backup Failed",
        "html": "={{ \"GitHub backup workflow encountered errors:\\n\\nTotal workflows: \" + $json.total + \"\\nSuccessful: \" + $json.successes + \"\\nFailed: \" + $json.failures + \"\\n\\nFailed workflows:\\n\" + $json.failedWorkflows.join('\\n') + \"\\n\\nCheck n8n executions: https://kelly-ads.app.n8n.cloud/\" }}",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        1280,
        112
      ],
      "id": "c9c6bb97-4443-4b0a-bef8-b404f342acb8",
      "name": "Send email",
      "webhookId": "97015b61-1940-4d68-8f6c-a0e246b9abb4",
      "credentials": {
        "smtp": {
          "id": "5HPC3NyTgaxCbH6e",
          "name": "SMTP account"
        }
      }
    }
  ],
  "connections": {
    "Daily Backup at 2 AM": {
      "main": [
        [
          {
            "node": "Get All Workflows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All Workflows": {
      "main": [
        [
          {
            "node": "Format for GitHub",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for GitHub": {
      "main": [
        [
          {
            "node": "Process One at a Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process One at a Time": {
      "main": [
        [
          {
            "node": "Try Create File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process One at a Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Try Create File": {
      "main": [
        [
          {
            "node": "Check Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Result": {
      "main": [
        [
          {
            "node": "Needs Update?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Update?": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Get Current SHA": {
      "main": [
        [
          {
            "node": "Update File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update File": {
      "main": [
        [
          {
            "node": "Log Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Update": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Get Current SHA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Results": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Send email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": {
    "node:Daily Backup at 2 AM": {
      "recurrenceRules": []
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "0a8abea8-dc94-4371-8a5c-09acb41feeb8",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-11-15T21:59:07.654Z",
      "createdAt": "2025-11-15T21:59:07.654Z",
      "role": "workflow:owner",
      "workflowId": "0wBrseUjWD9GZWh8",
      "projectId": "bll44iFOa92qb20Q"
    }
  ],
  "tags": []
}