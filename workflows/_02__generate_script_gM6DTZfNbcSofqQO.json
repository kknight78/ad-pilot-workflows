{
  "updatedAt": "2026-01-23T18:48:43.983Z",
  "createdAt": "2025-12-13T13:57:36.843Z",
  "id": "gM6DTZfNbcSofqQO",
  "name": "[02] Generate Script",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "jsCode": "const config = $json;\n\nconst selectedPhotos = config.selected_photos || {};\n\n// Get VIN from vehicles array\nconst vin = config.vehicles?.[0]?.vin;\n\n// Validate we have required data\nif (!vin) {\n  throw new Error('VIN missing - needed for Cloudinary lookup');\n}\n\nif (!selectedPhotos.hero_exterior) {\n  throw new Error('No hero_exterior photo found in selected_photos!');\n}\n\nconst heroPhoto = selectedPhotos.hero_exterior;\n\n// Check if BG-removed version exists in Cloudinary\nconst bgRemovedUrl = `https://res.cloudinary.com/dtpqxuwby/image/upload/${vin}.png`;\nconsole.log(`ğŸ” Checking Cloudinary: ${bgRemovedUrl}`);\n\nlet heroBackgroundRemoved = null;\nlet needsProcessing = false;\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'HEAD',\n    url: bgRemovedUrl,\n    returnFullResponse: true,\n    ignoreHttpStatusErrors: true,\n    timeout: 5000\n  });\n  \n  if (response.statusCode === 200) {\n    console.log('âœ… BG-removed hero found in Cloudinary!');\n    heroBackgroundRemoved = bgRemovedUrl;\n    needsProcessing = false;\n    \n    selectedPhotos.hero_exterior.photo_url = bgRemovedUrl;\n  } else {\n    console.log(`Status code: ${response.statusCode}`);\n    needsProcessing = true;\n  }\n} catch (error) {\n  needsProcessing = true;\n}\n\nreturn [{\n  json: {\n    ...config,\n    \n    selected_photos: selectedPhotos,\n    hero_photo_url: heroPhoto.photo_url,\n    hero_photo_index: heroPhoto.photo_index,\n    hero_bg_removed_url: heroBackgroundRemoved,\n    needs_bg_removal: needsProcessing,\n    cloudinary_checked: true\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5616,
        416
      ],
      "id": "d6093e73-d482-410c-8930-d1aa5178d0b1",
      "name": "Process Hero Photo for Animation"
    },
    {
      "parameters": {
        "jsCode": "const config = $json;\nconst vehicle = config.vehicles[0];\nconst equipment = vehicle.equipment;\n\n// Split equipment into individual features\nconst features = equipment.split('|').map(f => f.trim()).filter(f => f);\n\n// Initialize category arrays\nconst categories = {\n  enginePower: [],\n  transmission: [],\n  drivetrain: [],\n  brakingStability: [],\n  safetyAirbags: [],\n  driverAssist: [],\n  exteriorLighting: [],\n  roofsGlass: [],\n  interiorComfort: [],\n  seatingConfig: [],\n  infotainmentAudio: [],\n  navigationDisplay: [],\n  securityAntiTheft: [],\n  towingOffRoad: [],\n  packages: [],\n  wheelsTires: []\n};\n\n// Helper function to categorize features\nconst categorizeFeature = (feature) => {\n  const f = feature.toLowerCase();\n  \n  // 1. Engine & Power\n  if (/^(v6|v8|4-cyl|3-cyl|i4|i6)/.test(f) || \n      /(ecoboost|ecotec|hybrid|turbo|hemi|gdi|vtec|multiair|liter|electric)/i.test(f)) {\n    categories.enginePower.push(feature);\n  }\n  \n  // 2. Transmission\n  if (/(automatic|auto|manual|cvt|spd|drive unit|shiftronic|selshft|xtronic|overdrive)/i.test(f)) {\n    categories.transmission.push(feature);\n  }\n  \n  // 3. Drivetrain\n  if (/^(fwd|rwd|awd|4wd|2wd)$/i.test(f) || /wheel drive/i.test(f)) {\n    categories.drivetrain.push(feature);\n  }\n  \n  // 4. Braking & Stability\n  if (/(abs|stability|stabilitrak|advancetrac|rollover|hill start|hill descent|traction|vehicle dynamic)/i.test(f)) {\n    categories.brakingStability.push(feature);\n  }\n  \n  // 5. Safety - Airbags\n  if (/air bags|airbag|tire pressure monitoring/i.test(f)) {\n    categories.safetyAirbags.push(feature);\n  }\n  \n  // 6. Driver Assist / ADAS\n  if (/(camera|park assist|parksense|parking sensor|distance warning|sonar|blind|lane|collision|propilot|safety shield|adaptive cruise|intelligent cruise)/i.test(f)) {\n    categories.driverAssist.push(feature);\n  }\n  \n  // 7. Exterior & Lighting\n  if (/(headlamp|headlight|xenon|hid|led|fog lamp|daytime running|bed liner|tailgate|spoiler|roof rack|running board|tonneau|shell|cap|sliding rear window)/i.test(f)) {\n    categories.exteriorLighting.push(feature);\n  }\n  \n  // 8. Roofs & Glass\n  if (/(roof:|moonroof|sunroof|panoramic|skylight|privacy glass)/i.test(f)) {\n    categories.roofsGlass.push(feature);\n  }\n  \n  // 9. Interior Comfort\n  if (/(air conditioning|climate|keyless|remote start|power door|power window|power liftgate|power tailgate|power trunk|tilt|telescoping|steering wheel: heated|garage door)/i.test(f)) {\n    categories.interiorComfort.push(feature);\n  }\n  \n  // 10. Seating & Configuration\n  if (/(seat|passenger seating|leather)/i.test(f) && !/steering/i.test(f)) {\n    categories.seatingConfig.push(feature);\n  }\n  \n  // 11. Infotainment & Audio\n  if (/(am\\/fm|radio|stereo|sound|bose|harman|revel|premium sound|infotainment|onstar|sync|uconnect|connect|link|bluetooth|usb|auxiliary|siriusxm|cd|mp3)/i.test(f)) {\n    categories.infotainmentAudio.push(feature);\n  }\n  \n  // 12. Navigation & Display\n  if (/(navigation|head-up display)/i.test(f)) {\n    categories.navigationDisplay.push(feature);\n  }\n  \n  // 13. Security & Anti-Theft\n  if (/(alarm|anti-theft|theft|security system)/i.test(f)) {\n    categories.securityAntiTheft.push(feature);\n  }\n  \n  // 14. Towing & Off-Road\n  if (/(towing|tow|off-road|z71)/i.test(f)) {\n    categories.towingOffRoad.push(feature);\n  }\n  \n  // 15. Packages & Trims\n  if (/(pkg|package|big horn|technology|premium)/i.test(f) && !/sound|audio/i.test(f)) {\n    categories.packages.push(feature);\n  }\n  \n  // 16. Wheels & Tires\n  if (/wheels:|alloy|steel/i.test(f)) {\n    categories.wheelsTires.push(feature);\n  }\n};\n\n// Categorize all features\nfeatures.forEach(feature => {\n  if (feature) categorizeFeature(feature);\n});\n\n// Build allowed photo categories based on equipment\nconst allowedPhotoCategories = [\n  'hero_exterior',\n  'engine_bay',\n  'infotainment_other',\n  'instrument_cluster',\n  'steering_wheel',\n  'front_seats',\n  'second_row_seats',\n  'cargo_area'\n];\n\n// Add conditional categories based on equipment\nif (categories.infotainmentAudio.some(f => /carplay|android auto/i.test(f))) {\n  allowedPhotoCategories.push('infotainment_carplay');\n}\n\nif (categories.driverAssist.some(f => /360|multi-view|surround view|around view/i.test(f))) {\n  allowedPhotoCategories.push('infotainment_360_camera');\n}\n\nif (categories.roofsGlass.some(f => /moonroof|sunroof|panoramic/i.test(f))) {\n  allowedPhotoCategories.push('moonroof');\n}\n\nif (categories.seatingConfig.some(f => /third row|3rd row|7 passenger|8 passenger/i.test(f))) {\n  allowedPhotoCategories.push('third_row_seats');\n}\n\n// Always add special_feature category for unexpected finds\nallowedPhotoCategories.push('special_feature');\n\n// Build equipment context for each photo category\nconst equipmentContextByCategory = {\n  hero_exterior: {},\n  \n  engine_bay: {\n    engine_features: categories.enginePower,\n    transmission: categories.transmission[0] || null,\n    drivetrain: categories.drivetrain[0] || null\n  },\n  \n  front_seats: {\n    has_leather: categories.seatingConfig.some(f => /^leather$/i.test(f)),\n    has_heated: categories.seatingConfig.some(f => /heated/i.test(f) && /seat/i.test(f)),\n    has_cooled: categories.seatingConfig.some(f => /(cooled|ventilated)/i.test(f)),\n    has_power: categories.seatingConfig.some(f => /(power|dual power)/i.test(f) && /seat/i.test(f)),\n    has_memory: categories.seatingConfig.some(f => /memory/i.test(f)),\n    material_claim: categories.seatingConfig.some(f => /^leather$/i.test(f)) ? 'leather' : 'premium upholstery',\n    all_seat_features: categories.seatingConfig\n  },\n  \n  second_row_seats: {\n    seating_features: categories.seatingConfig.filter(f => /rear|second|passenger/i.test(f))\n  },\n  \n  third_row_seats: {\n    has_third_row: categories.seatingConfig.some(f => /third row|3rd row/i.test(f))\n  },\n  \n  steering_wheel: {\n    has_heated_wheel: categories.interiorComfort.some(f => /steering wheel.*heated/i.test(f)),\n    has_controls: categories.interiorComfort.some(f => /steering wheel control/i.test(f)),\n    tilt_telescoping: categories.interiorComfort.some(f => /tilt.*telescoping/i.test(f))\n  },\n  \n  infotainment_carplay: {\n    has_navigation: categories.navigationDisplay.length > 0,\n    audio_system: categories.infotainmentAudio.find(f => /sound|audio|bose|harman|revel/i.test(f)),\n    connectivity: categories.infotainmentAudio.filter(f => /bluetooth|usb|siriusxm/i.test(f))\n  },\n  \n  infotainment_360_camera: {\n    has_360: true,\n    parking_features: categories.driverAssist.filter(f => /parking|park assist/i.test(f))\n  },\n  \n  moonroof: {\n    moonroof_type: categories.roofsGlass.find(f => /panoramic/i.test(f)) ? 'Panoramic' : 'Moonroof',\n    all_roof_features: categories.roofsGlass\n  },\n  \n  cargo_area: {\n    power_liftgate: categories.interiorComfort.some(f => /power liftgate/i.test(f)),\n    truck_bed_features: categories.exteriorLighting.filter(f => /bed liner|tailgate|tonneau/i.test(f))\n  }\n};\n\n// Clean up baseConfig - remove equipment\nconst cleanBaseConfig = {\n  ...config,\n  equipment: undefined,  // Remove equipment string\n  vehicles: config.vehicles?.map(vehicle => {\n    const {equipment, ...cleanVehicle } = vehicle;\n    return cleanVehicle;\n  })\n};\n\nreturn [{\n  json: {\n    ...cleanBaseConfig,\n    equipment_categories: categories,\n    allowed_photo_categories: allowedPhotoCategories,\n    equipment_context_by_category: equipmentContextByCategory,\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3600,
        480
      ],
      "id": "c8ded42c-3c2d-44b2-9bed-e66dd3c6f0f3",
      "name": "Parse Equipment & Build Categories"
    },
    {
      "parameters": {
        "jsCode": "const config = $json;\nconst vehicle = config.vehicles[0];\n// Use thumbnails for faster processing\nconst allImageUrls = vehicle.all_images\n  .filter(url => url && url.trim())\n  .map(url => url + '/thumb/');\n\nconst allowedCategories = config.allowed_photo_categories;\nconst totalPhotos = allImageUrls.length;\nconst maxIndex = totalPhotos - 1;\n\nconst systemPrompt = `You are categorizing ${totalPhotos} photos of a ${vehicle.year} ${vehicle.make} ${vehicle.model}.\n\nEQUIPMENT config CONFIRMS THIS VEHICLE HAS:\n${config.equipment_categories.seatingConfig.some(f => /third row|3rd row/i.test(f)) ? 'âœ“ Third row seating\\n' : ''}\n${config.equipment_categories.roofsGlass.some(f => /moonroof|sunroof|panoramic/i.test(f)) ? 'âœ“ ' + config.equipment_context_by_category.moonroof.moonroof_type + '\\n' : ''}\n${config.equipment_categories.driverAssist.some(f => /360|multi-view|surround/i.test(f)) ? 'âœ“ 360-degree camera\\n' : ''}\n${config.equipment_categories.seatingConfig.some(f => /heated/i.test(f) && /seat/i.test(f)) ? 'âœ“ Heated seats\\n' : ''}\n${config.equipment_categories.seatingConfig.some(f => /cooled|ventilated/i.test(f)) ? 'âœ“ Cooled/ventilated seats\\n' : ''}\n${config.equipment_categories.seatingConfig.some(f => /^leather$/i.test(f)) ? 'âœ“ Leather seats\\n' : ''}\n\nPhoto[0] is designated as hero_exterior (already selected).\n\nCATEGORIES TO LOOK FOR:\n${allowedCategories.filter(c => c !== 'hero_exterior').map(cat => `- ${cat}`).join('\\n')}\n\nDO NOT look for categories not listed above - they don't exist on this vehicle.\n\nRULES:\n1. Multiple photos CAN have the same category if showing DIFFERENT subcategories\n   Example: One photo shows CarPlay, another shows 360 camera â†’ both are infotainment\n2. If multiple photos show THE SAME THING, pick ONLY THE BEST (clearest, best lighting)\n3. Only assign categories from the list above\n4. Mark irrelevant photos as \"exclude\"\n\nEXCLUDE these categories entirely (never ad-worthy):\n- Center console storage compartments (close-ups)\n- Control button close-ups (seat controls, climate buttons)\n- Cup holder close-ups (showing just cupholders)\n- Key fobs\n- Window stickers / price labels\n- Door panels (unless showing special feature)\n- Random detail shots with no clear feature\n- Photos that are blurry or too dark to use\n\nQUALITY REQUIREMENTS:\n- Well-lit photos only (skip dark or blurry)\n- Clear view of features being highlighted\n- Professional appearance (avoid awkward angles)\n- Shows vehicle in good condition\n\nCATEGORY DEFINITIONS:\n\nENGINE BAY:\n- Clear shot of engine compartment\n- Well-lit, shows engine condition\n\nINFOTAINMENT (can have multiple):\n- infotainment_carplay: Screen showing Apple CarPlay OR Android Auto interface clearly\n- infotainment_360_camera: Screen showing 360-degree/bird's eye parking camera view\n- infotainment_other: Touchscreen showing other features (navigation, audio, settings)\n\nDASHBOARD:\n- instrument_cluster: Gauge cluster or digital instrument display\n- steering_wheel: Steering wheel (with or without controls visible)\n\nSEATING:\n- front_seats: Front seat view showing material, condition, and controls\n- second_row_seats: Back seat view\n- third_row_seats: Third row seating (only if equipment confirms it exists)\n\nCARGO:\n- cargo_area: Trunk or cargo space (or truck bed for pickups)\n\nSPECIAL:\n- moonroof: Moonroof open OR moonroof controls visible (only if equipment confirms)\n- special_feature: Anything else impressive (heads-up display, wireless charging, etc.)\n\nOUTPUT FORMAT (JSON only, no markdown):\n{\n  \"categorized_photos\": [\n    {\n      \"photo_index\": 1,\n      \"category\": \"engine_bay\",\n      \"reasoning\": \"Clear engine shot, well-lit\"\n    },\n    {\n      \"photo_index\": 12,\n      \"category\": \"infotainment_carplay\",\n      \"reasoning\": \"Shows Apple CarPlay interface clearly\"\n    },\n    {\n      \"photo_index\": 8,\n      \"category\": \"exclude\",\n      \"reasoning\": \"Center console storage - not ad-worthy\"\n    }\n  ],\n  \"summary\": {\n    \"engine_bay\": [1],\n    \"infotainment_carplay\": [12],\n    \"front_seats\": [20],\n    \"excluded\": [8, 9, 22]\n  }\n}`;\n\nconst userPrompt = `Categorize all ${totalPhotos} photos of this ${vehicle.year} ${vehicle.make} ${vehicle.model}.\n\nğŸš¨ CRITICAL - PHOTO INDICES ğŸš¨\nVALID INDICES: 0 through ${maxIndex}\nTOTAL PHOTOS: ${totalPhotos}\nDO NOT USE indices ${maxIndex + 1} or higher (they don't exist!)\n\nPhoto[0] is hero_exterior (skip this one).\nAnalyze photos 1 through ${maxIndex} and assign categories or mark as exclude.\n\nSelect the BEST photo for each category (quality over quantity).\nIf multiple photos show different features, keep both.\nIf multiple photos show the same feature, pick only the best one.`;\n\n// Build vision_content array for Claude API\nconst visionContent = [\n  {\n    type: \"text\",\n    text: `${systemPrompt}\\n\\n${userPrompt}\\n\\nPHOTOS (each labeled with its index):`\n  }\n];\n\n// Add all images with explicit index labels\nallImageUrls.forEach((url, index) => {\n  visionContent.push({\n    type: \"text\",\n    text: `[PHOTO INDEX ${index}]`\n  });\n  visionContent.push({\n    type: \"image\",\n    source: {\n      type: \"url\",\n      url: url\n    }\n  });\n});\n\nconsole.log(`âœ… Built vision content with ${allImageUrls.length} photos`);\n\nreturn [{\n  json: {\n    ...config,\n    \n    categorizer_vision_content: visionContent,\n    categorizer_system_prompt: systemPrompt,\n    categorizer_user_prompt: userPrompt,\n    all_image_urls: allImageUrls,\n    max_photo_index: maxIndex,\n    total_photos: totalPhotos,\n    \n    // Remove used data\n    equipment_categories: undefined,\n    allowed_photo_categories: undefined\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3824,
        480
      ],
      "id": "932c81fd-a4cf-4f85-b15e-7fe833c9ee7b",
      "name": "Build Photo Categorizer Prompt"
    },
    {
      "parameters": {
        "jsCode": "const config = $json;\nconst selectedPhotos = config.selected_photos;\nconst vehicle = config.vehicles[0];\n\n// Category-specific prompt templates\nconst categoryPrompts = {\n  front_seats: (equipCtx) => `\nAnalyze this front seat photo.\n\nEQUIPMENT DATA:\n${equipCtx.has_leather ? 'âœ“ Leather seats confirmed in equipment' : 'âœ— Leather NOT listed in equipment'}\n${equipCtx.has_heated ? 'âœ“ Heated seats' : ''}\n${equipCtx.has_cooled ? 'âœ“ Cooled/ventilated seats' : ''}\n${equipCtx.has_power ? 'âœ“ Power-adjustable seats' : ''}\n${equipCtx.has_memory ? 'âœ“ Memory seats' : ''}\n\nğŸš« CRITICAL RULE: DO NOT analyze or comment on seat material\nWe use equipment data ONLY for material claims (${equipCtx.material_claim}).\n\nYOUR TASK - Focus on what you CAN reliably identify:\n\n1. SEAT CONDITION (visual assessment):\n   - excellent (pristine, no wear)\n   - good (normal use, clean)\n   - fair (some wear visible)\n   - poor (stains, tears, heavy wear)\n\n2. CONTROLS VISIBLE (Yes/No for each):\n   - Heated seat buttons?\n   - Cooled/ventilated buttons?\n   - Power adjustment controls?\n   - Memory seat buttons?\n\n3. GENERAL FEATURES:\n   - Spacious/comfortable appearance?\n   - Center armrest present?\n\nOUTPUT JSON:\n{\n  \"condition\": \"excellent|good|fair|poor\",\n  \"controls_visible\": {\n    \"heated\": true/false,\n    \"cooled\": true/false,\n    \"power\": true/false,\n    \"memory\": true/false\n  },\n  \"spacious\": true/false,\n  \"additional_notes\": \"Brief notes on comfort features\"\n}`,\n\n  engine_bay: (equipCtx) => `\nAnalyze this engine bay photo.\n\nEQUIPMENT DATA:\n${equipCtx.engine_features && equipCtx.engine_features.length > 0 ? '- Engine: ' + equipCtx.engine_features.join(', ') : ''}\n${equipCtx.transmission ? '- Transmission: ' + equipCtx.transmission : ''}\n${equipCtx.drivetrain ? '- Drivetrain: ' + equipCtx.drivetrain : ''}\n\nYOUR TASK:\n\n1. ENGINE CONDITION:\n   - clean (well-maintained, no visible dirt/oil)\n   - average (normal condition)\n   - dirty (visible grime, neglect)\n\n2. VISIBLE BADGING/LABELS:\n   - Any engine badges or labels visible on engine cover?\n   - Specific text you can read?\n\n3. MAINTENANCE APPEARANCE:\n   - Does it appear well-maintained? (Yes/No)\n   - Any obvious issues visible? (leaks, damaged parts)\n\nOUTPUT JSON:\n{\n  \"condition\": \"clean|average|dirty\",\n  \"visible_badging\": \"Description of any badges/labels or null\",\n  \"appears_maintained\": true/false,\n  \"issues_visible\": \"Description or null\"\n}`,\n\n  infotainment_carplay: (equipCtx) => `\nAnalyze this infotainment screen photo.\n\nEQUIPMENT DATA:\n${equipCtx.has_navigation ? 'âœ“ Navigation system' : ''}\n${equipCtx.audio_system ? 'âœ“ Audio: ' + equipCtx.audio_system : ''}\n\nYOUR TASK - Be SPECIFIC about what you see:\n\nâš ï¸ CRITICAL: DO NOT assume both CarPlay and Android Auto unless you see BOTH logos clearly!\n\n1. SMARTPHONE INTEGRATION (look carefully):\n   - Apple CarPlay logo visible? (Yes/No)\n   - Android Auto logo visible? (Yes/No)\n   - If neither logo visible: Generic smartphone connectivity only\n\n2. SCREEN SIZE:\n   - small (less than 7 inches)\n   - medium (7-9 inches)\n   - large (10+ inches)\n\n3. SCREEN CONDITION:\n   - excellent (no scratches, clear)\n   - good (minor wear)\n   - scratched (visible damage)\n\n4. OTHER VISIBLE FEATURES:\n   - Navigation map visible?\n   - Premium brand logos (Bose, Harman Kardon)?\n   - Any other notable features?\n\nOUTPUT JSON:\n{\n  \"has_apple_carplay\": true/false/unclear,\n  \"has_android_auto\": true/false/unclear,\n  \"screen_size\": \"small|medium|large\",\n  \"screen_condition\": \"excellent|good|scratched\",\n  \"navigation_visible\": true/false,\n  \"other_features\": \"Description or null\"\n}`,\n\n  infotainment_360_camera: (equipCtx) => `\nAnalyze this 360 camera display photo.\n\nYOUR TASK:\n\n1. CONFIRM 360 CAMERA:\n   - Does this show multi-view/bird's eye parking camera? (Yes/No)\n   - How many camera angles visible? (top view, front, rear, sides?)\n\n2. DISPLAY QUALITY:\n   - clear (high resolution, easy to see)\n   - average (acceptable quality)\n   - poor (grainy, hard to see)\n\n3. ADDITIONAL FEATURES VISIBLE:\n   - Parking sensor indicators?\n   - Trajectory lines?\n   - Distance markers?\n\nOUTPUT JSON:\n{\n  \"is_360_camera\": true/false,\n  \"camera_angles_visible\": [\"top\", \"front\", \"rear\", \"left\", \"right\"],\n  \"display_quality\": \"clear|average|poor\",\n  \"parking_sensors_visible\": true/false,\n  \"additional_features\": \"Description or null\"\n}`,\n\n  moonroof: (equipCtx) => `\nAnalyze this moonroof photo.\n\nEQUIPMENT DATA: ${equipCtx.moonroof_type || 'Moonroof'}\n\nYOUR TASK:\n\n1. WHAT'S SHOWN:\n   - moonroof_open (showing open roof with sky visible)\n   - controls_visible (showing buttons/switches for moonroof)\n   - both (both open roof and controls visible)\n\n2. SIZE ASSESSMENT:\n   - small (compact opening)\n   - medium (standard size)\n   - large (extended opening)\n   - panoramic (very large, extends over passengers)\n\n3. CONDITION:\n   - Glass clean and clear? (Yes/No)\n   - Controls in good condition? (Yes/No)\n\nOUTPUT JSON:\n{\n  \"moonroof_shown\": \"moonroof_open|controls_visible|both\",\n  \"appears_panoramic\": true/false,\n  \"size_rating\": \"small|medium|large|panoramic\",\n  \"condition_notes\": \"Brief assessment\"\n}`,\n\n  cargo_area: (equipCtx) => `\nAnalyze this cargo/trunk space photo.\n\nEQUIPMENT DATA:\n${equipCtx.power_liftgate ? 'âœ“ Power liftgate' : ''}\n${equipCtx.truck_bed_features && equipCtx.truck_bed_features.length > 0 ? 'âœ“ Truck bed features: ' + equipCtx.truck_bed_features.join(', ') : ''}\n\nYOUR TASK:\n\n1. SPACE ASSESSMENT:\n   - compact (small trunk/bed)\n   - average (typical for vehicle class)\n   - spacious (above average)\n   - huge (exceptional cargo capacity)\n\n2. CONDITION:\n   - clean (well-maintained, no debris)\n   - average (normal use)\n   - cluttered (items present)\n\n3. NOTABLE FEATURES:\n   - Power liftgate button visible?\n   - Cargo cover present?\n   - Tie-down hooks/anchors?\n   - Bed liner visible (trucks)?\n   - Tonneau cover?\n\nOUTPUT JSON:\n{\n  \"space_rating\": \"compact|average|spacious|huge\",\n  \"condition\": \"clean|average|cluttered\",\n  \"notable_features\": [\"list\", \"of\", \"features\"],\n  \"additional_notes\": \"Brief notes\"\n}`,\n\n  steering_wheel: (equipCtx) => `\nAnalyze this steering wheel photo.\n\nEQUIPMENT DATA:\n${equipCtx.has_heated_wheel ? 'âœ“ Heated steering wheel' : ''}\n${equipCtx.has_controls ? 'âœ“ Steering wheel controls' : ''}\n${equipCtx.tilt_telescoping ? 'âœ“ Tilt & telescoping wheel' : ''}\n\nYOUR TASK:\n\n1. CONTROLS VISIBLE:\n   - Audio controls? (Yes/No)\n   - Cruise control buttons? (Yes/No)\n   - Phone/voice controls? (Yes/No)\n   - Heated wheel button/indicator? (Yes/No)\n\n2. MATERIAL/CONDITION:\n   - Leather/wrapped? (Yes/No/Unclear)\n   - Condition: excellent/good/worn\n\n3. OTHER FEATURES:\n   - Paddle shifters visible?\n   - Multifunction display visible behind wheel?\n\nOUTPUT JSON:\n{\n  \"controls_visible\": {\n    \"audio\": true/false,\n    \"cruise\": true/false,\n    \"phone_voice\": true/false,\n    \"heated\": true/false\n  },\n  \"appears_leather_wrapped\": true/false/unclear,\n  \"condition\": \"excellent|good|worn\",\n  \"paddle_shifters\": true/false,\n  \"other_notes\": \"Brief notes\"\n}`,\n\n  instrument_cluster: (equipCtx) => `\nAnalyze this instrument cluster / gauge display photo.\n\nYOUR TASK:\n\n1. CLUSTER TYPE:\n   - traditional_analog (physical gauges with needles)\n   - digital (full digital/LCD display)\n   - hybrid (mix of analog and digital)\n\n2. FEATURES VISIBLE:\n   - Speedometer clearly visible?\n   - Tachometer (RPM gauge) visible?\n   - Fuel gauge visible?\n   - Trip computer/info display?\n   - Navigation display in cluster?\n\n3. CONDITION & QUALITY:\n   - Display condition: excellent/good/worn\n   - Easy to read? (Yes/No)\n\nOUTPUT JSON:\n{\n  \"cluster_type\": \"traditional_analog|digital|hybrid\",\n  \"features_visible\": [\"speedometer\", \"tachometer\", \"fuel\", \"trip_computer\"],\n  \"display_condition\": \"excellent|good|worn\",\n  \"easy_to_read\": true/false,\n  \"notes\": \"Brief assessment\"\n}`,\n\n  second_row_seats: (equipCtx) => `\nAnalyze this second row / back seat photo.\n\nYOUR TASK:\n\n1. SPACE ASSESSMENT:\n   - cramped (limited legroom)\n   - adequate (acceptable for adults)\n   - spacious (comfortable for adults)\n   - generous (exceptional rear space)\n\n2. SEATING CONFIGURATION:\n   - bench (traditional bench seat)\n   - captain_chairs (individual bucket seats)\n   - split_bench (can fold separately)\n\n3. CONDITION:\n   - excellent (pristine, no wear)\n   - good (clean, normal use)\n   - fair (some wear visible)\n\n4. FEATURES VISIBLE:\n   - Rear climate vents?\n   - Cup holders?\n   - USB ports/charging?\n   - Armrest?\n\nOUTPUT JSON:\n{\n  \"space_rating\": \"cramped|adequate|spacious|generous\",\n  \"seating_config\": \"bench|captain_chairs|split_bench\",\n  \"condition\": \"excellent|good|fair\",\n  \"features_visible\": [\"list\", \"of\", \"features\"],\n  \"notes\": \"Brief assessment\"\n}`,\n\n  third_row_seats: (equipCtx) => `\nAnalyze this third row seating photo.\n\nYOUR TASK:\n\n1. SPACE ASSESSMENT:\n   - tight (kids only)\n   - adequate (short adults okay)\n   - comfortable (adults can fit)\n\n2. ACCESS:\n   - How do passengers access third row?\n   - Easy entry visible? (fold-flat second row, etc.)\n\n3. CONDITION:\n   - excellent/good/fair\n\n4. FEATURES:\n   - Cup holders?\n   - Climate vents?\n   - Storage compartments?\n\nOUTPUT JSON:\n{\n  \"space_rating\": \"tight|adequate|comfortable\",\n  \"condition\": \"excellent|good|fair\",\n  \"easy_access\": true/false,\n  \"features_visible\": [\"list\"],\n  \"notes\": \"Brief assessment\"\n}`,\n\n  special_feature: (equipCtx) => `\nAnalyze this special feature photo.\n\nYOUR TASK:\n\nIdentify what special feature is being shown. This could be:\n- Heads-up display\n- Wireless charging pad\n- Advanced climate controls\n- Unique storage solutions\n- Premium materials/trim\n- Technology features\n- Or anything else noteworthy\n\nDescribe what you see and assess its condition/functionality.\n\nOUTPUT JSON:\n{\n  \"feature_identified\": \"Name/description of feature\",\n  \"condition\": \"excellent|good|fair\",\n  \"notable_aspects\": \"What makes this feature special\",\n  \"likely_appeal\": \"Why customers would value this\"\n}`,\n\n  infotainment_other: (equipCtx) => `\nAnalyze this infotainment screen photo.\n\nYOUR TASK:\n\nThis screen is NOT showing CarPlay/Android Auto or 360 camera.\nWhat IS it showing?\n\n1. SCREEN CONTENT:\n   - Navigation system?\n   - Audio/radio interface?\n   - Vehicle settings?\n   - Other?\n\n2. SCREEN QUALITY:\n   - Size: small/medium/large\n   - Condition: excellent/good/scratched\n   - Touchscreen? (Yes/No/Unclear)\n\n3. FEATURES VISIBLE:\n   - Premium audio branding?\n   - Climate controls integrated?\n   - Other notable features?\n\nOUTPUT JSON:\n{\n  \"showing\": \"navigation|audio|settings|other\",\n  \"screen_size\": \"small|medium|large\",\n  \"condition\": \"excellent|good|scratched\",\n  \"appears_touchscreen\": true/false/unclear,\n  \"features_visible\": [\"list\"],\n  \"notes\": \"Brief description\"\n}`\n};\n\n// Build feature identifier vision content\nconst featureIdentifierContent = [\n  {\n    type: \"text\",\n    text: `Analyze these vehicle feature photos from a ${vehicle.year} ${vehicle.make} ${vehicle.model}.\n\nFor each photo, identify visible features based on the category-specific instructions.\n\nIMPORTANT: Output ONLY valid JSON with no markdown formatting.\n\n`\n  }\n];\n\nlet categoriesProcessed = 0;\n\nObject.entries(selectedPhotos).forEach(([category, photoData]) => {\n  if (category === 'hero_exterior') return; // Skip hero\n\n  const promptGenerator = categoryPrompts[category];\n  if (!promptGenerator) {\n    console.log(`âš ï¸ No prompt template for category: ${category}`);\n    return;\n  }\n\n  const categoryPrompt = promptGenerator(photoData.equipment_context);\n  \n  featureIdentifierContent.push({\n    type: \"text\",\n    text: `\\nâ•â•â• CATEGORY: ${category.toUpperCase()} â•â•â•\\n${categoryPrompt}\\n`\n  });\n  \n  featureIdentifierContent.push({\n    type: \"image\",\n    source: {\n      type: \"url\",\n      url: photoData.photo_url\n    }\n  });\n\n  categoriesProcessed++;\n});\n\n// Add final instruction\nconst categoryKeys = Object.keys(selectedPhotos).filter(k => k !== 'hero_exterior');\nfeatureIdentifierContent.push({\n  type: \"text\",\n  text: `\\n\\nProvide analysis for each category in this JSON format (no markdown, no backticks):\n{\n  \"${categoryKeys[0] || 'category_name'}\": { ... your analysis ... },\n  \"${categoryKeys[1] || 'category_name'}\": { ... your analysis ... }\n}\n\nOutput ONLY the JSON object, nothing else.`\n});\n\nconsole.log(`âœ… Built feature identifier prompts for ${categoriesProcessed} categories`);\n\nreturn [{\n  json: {\n    ...config,\n    \n    feature_identifier_content: featureIdentifierContent,\n    categories_to_identify: categoriesProcessed\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4720,
        480
      ],
      "id": "f156f084-80ef-48c5-a7cd-53f8544ecab1",
      "name": "Build Feature Identifier Prompts"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUILD SCRIPT PROMPT â€” TEMP_001 (multi-item)\n// Pure formatting â€” features already enriched, timing from DB\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $json;\nconst vehicles = config.vehicles || config.items;\nconst timing = config.timing;\nconst themeSection = config.theme_section;\nconst themePack = config.theme_pack;\nconst themeModeRules = config.theme_mode_rules;\n\n// Client info (from asset path)\nconst clientName = config.client_name || 'the dealership';\nconst clientLocation = config.client_location || '';\n\n// Check if we have system prompt from main path, otherwise build minimal one\nlet systemPrompt = '';\ntry {\n  systemPrompt = $('Assemble System Prompt').first()?.json?.system_prompt || '';\n} catch (e) {\n  // Coming from asset path - no Assemble System Prompt node\n  systemPrompt = '';\n}\n\nif (!vehicles || vehicles.length === 0) {\n  throw new Error('Missing vehicle data');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUILD SYSTEM PROMPT FOR ASSET PATH (if not from main path)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nif (!systemPrompt) {\n  const sections = [];\n\n  // Identity section with client info\n  sections.push(`You are a professional automotive video ad copywriter for ${clientName}${clientLocation ? ' in ' + clientLocation : ''}.`);\n\n  // Template description\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“‹ TEMPLATE: MULTI-ITEM (Multi-Car Showcase)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCreate a fast-paced, punchy multi-vehicle showcase ad. Each vehicle gets a quick highlight before moving to the next.`);\n\n  // Word limits\n  if (timing) {\n    sections.push(`\nâš ï¸ WORD LIMITS:\n- Hook: ${timing.hook_words} words max\n- Segment: ${timing.segment_words} words max\n- CTA: ${timing.cta_words} words max`);\n  }\n\n  // Theme rules from theme_modes\n  if (themeModeRules && themeModeRules.length > 0) {\n    const rules = Array.isArray(themeModeRules) ? themeModeRules : [];\n    if (rules.length > 0) {\n      sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¨ THEME PACK USAGE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${rules.map((r, i) => `${i + 1}) ${r}`).join('\\n')}\n\nIf theme_pack missing: Use generic value/deals hook`);\n    }\n  }\n\n  // Hook rules\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸª HOOK RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nLead with intrigue, NOT inventory-speak.\n\nGOOD EXAMPLES:\nâœ… \"Tax season just hit different this year\"\nâœ… \"When gas prices make you rethink everything\"\n\nBAD EXAMPLES:\nâŒ \"Check out these three vehicles\"\nâŒ \"We have cars for sale\"`);\n\n  // Segment rules\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“ SEGMENT RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nEach vehicle gets ONE standout feature. Be specific, not generic.\n\nGOOD: \"heated seats for those 5am commutes\"\nBAD: \"great features\"`);\n\n  // CTA with client info\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“¢ CTA REQUIREMENTS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n- MUST mention: ${clientName}\n- Location context: ${clientLocation || 'local area'}\n- Keep it punchy and actionable`);\n\n  // Legal\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâš–ï¸ LEGAL (CRITICAL)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâŒ NEVER promise specific financing terms\nâŒ NEVER guarantee approval\nâŒ NEVER use \"best\" or \"lowest\" without qualification`);\n\n  systemPrompt = sections.join('\\n');\n  console.log(`Built system prompt for asset path (client: ${clientName})`);\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CALCULATE WORD LIMITS (from DB timing)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst hookWords = timing?.hook_words || 12;\nconst segmentWords = timing?.segment_words || 15;\nconst ctaWords = timing?.cta_words || 12;\nconst totalWords = hookWords + (segmentWords * vehicles.length) + ctaWords;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FORMAT VEHICLES SECTION\n// Features come pre-enriched from processing phase\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst vehiclesSection = vehicles.map((v, i) => {\n  const features = v.features?.slice(0, 5).join(', ') || v.equipment_summary || 'Great Condition';\n  return `${i + 1}. ${v.year} ${v.make} ${v.model}\n   Features: ${features}`;\n}).join('\\n');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUILD USER PROMPT\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst scriptLength = config.script_length || 'standard';\n\nlet userPrompt = `Generate a ${scriptLength.toUpperCase()} multi-car ad script for ${clientName}.\n\n${themeSection || ''}\n\nVEHICLES (${vehicles.length}):\n${vehiclesSection}\n\nWORD LIMITS:\n- Hook: ${hookWords} words max\n- Each segment: ${segmentWords} words max\n- CTA: ${ctaWords} words max (MUST mention ${clientName})\n- TOTAL: ${totalWords} words max\n\nOUTPUT JSON:\n{\n  \"hook\": \"Punchy opener (${hookWords} words max)\",\n  \"segments\": [${vehicles.map(v => `\"${v.year} ${v.make} â€” feature\"`).join(', ')}],\n  \"cta\": \"${clientName} + contact (${ctaWords} words max)\",\n  \"full_script\": \"Complete script\",\n  \"notes\": \"Brief notes\"\n}`;\n\n// Add theme pack to user prompt if available\nif (themePack) {\n  userPrompt = `Generate a ${scriptLength.toUpperCase()} multi-car ad script for ${clientName}${clientLocation ? ' in ' + clientLocation : ''}.\n\nTHEME PACK:\n- Theme: ${themePack.theme_name} ${themePack.emoji || ''}\n- Core tension: ${themePack.core_tension}\n- Ad angle: ${themePack.ad_angle}\n- Local micro-moments: ${JSON.stringify(themePack.local_micro_moments)}\n- Banned phrases: ${JSON.stringify(themePack.banned_phrases)}\n\nVEHICLES (${vehicles.length}):\n${vehiclesSection}\n\nWORD LIMITS:\n- Hook: ${hookWords} words max\n- Each segment: ${segmentWords} words max\n- CTA: ${ctaWords} words max (MUST mention ${clientName})\n- TOTAL: ${totalWords} words max\n\nSEGMENT RULES:\n- REQUIRED: Year + Make + Model (e.g., \"2017 GMC Canyon\")\n- FLEXIBLE: Feature description (trim this if needed to hit word limit)\n- Each segment highlights ONE standout feature\n- Sound conversational, not like reading a list\n\n\nOUTPUT JSON:\n{\n  \"hook\": \"Punchy opener (${hookWords} words max)\",\n  \"segments\": [${vehicles.map(v => `\"${v.year} ${v.make} ${v.model} â€” ONE standout feature\"`).join(', ')}],\n  \"cta\": \"${clientName} + call to action (${ctaWords} words max)\",\n  \"full_script\": \"Complete script\",\n  \"notes\": \"Brief notes\"\n}`;\n}\n\nconsole.log(`âœ… Multi-item prompt built for ${vehicles.length} vehicles`);\nconsole.log(`ğŸ“ Word limits: hook=${hookWords}, segment=${segmentWords}, cta=${ctaWords}, total=${totalWords}`);\nconsole.log(`ğŸ¢ Client: ${clientName}`);\n\nreturn [{\n  json: {\n    ...config,\n    vehicles,\n    system_prompt: systemPrompt,\n    user_prompt: userPrompt,\n    word_limits: {\n      total: totalWords,\n      hook: hookWords,\n      segment: segmentWords,\n      cta: ctaWords\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7184,
        48
      ],
      "id": "ad226bad-f815-4a28-80c1-bd19c2d3f6de",
      "name": "Build Script Prompt TEMP_001"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUILD SCRIPT PROMPT â€” TEMP_002 (spotlight)\n// Pure formatting â€” timing from DB, theme instructions in system prompt\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $json;\nconst vehicle = config.vehicles[0];\nconst verifiedFeatures = config.verified_features || {};\nconst selectedPhotosObject = config.selected_photos || {};\nconst scriptLength = config.script_length || 'standard';\nconst timing = config.timing;\nconst themePack = config.theme_pack || null;\n\n// Helper function to remove /thumb/ suffix\nconst getFullResUrl = (url) => {\n  return url.replace('/thumb/', '/');\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// TRANSFORM SELECTED PHOTOS TO ARRAY FORMAT\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst selectedPhotosArray = [];\n\n// Add hero first\nif (selectedPhotosObject.hero_exterior) {\n  selectedPhotosArray.push({\n    photo_url: getFullResUrl(selectedPhotosObject.hero_exterior.photo_url),\n    photo_index: selectedPhotosObject.hero_exterior.photo_index,\n    category: \"exterior_hero\",\n    feature_callout: \"\",\n    display_order: 1\n  });\n}\n\n// Priority order for features (most important first)\nconst priorityOrder = [\n  'engine_bay',\n  'moonroof',\n  'infotainment_360_camera',\n  'infotainment_carplay',\n  'front_seats',\n  'steering_wheel',\n  'instrument_cluster',\n  'cargo_area',\n  'second_row_seats',\n  'third_row_seats',\n  'special_feature',\n  'infotainment_other'\n];\n\n// Add features in priority order\nlet displayOrder = 2;\npriorityOrder.forEach(category => {\n  const featureData = verifiedFeatures[category];\n  const photoData = selectedPhotosObject[category];\n\n  if (featureData?.script_features && photoData) {\n    selectedPhotosArray.push({\n      photo_url: getFullResUrl(photoData.photo_url),\n      photo_index: photoData.photo_index,\n      category: category,\n      feature_callout: featureData.script_features,\n      display_order: displayOrder++\n    });\n  }\n});\n\n// Limit to top 5 features (plus hero = 6 total)\nconst finalPhotos = selectedPhotosArray.slice(0, 6);\nconst featureCount = finalPhotos.length - 1;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// GET SYSTEM PROMPT (from Assemble System Prompt)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst systemPrompt = $('Assemble System Prompt').first()?.json?.system_prompt || '';\n\nif (!systemPrompt) {\n  throw new Error('No system prompt from Assemble System Prompt node');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// WORD LIMITS (from DB timing)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst hookWords = timing.hook_words;\nconst segmentWords = timing.segment_words;\nconst ctaWords = timing.cta_words;\nconst totalWords = hookWords + (segmentWords * finalPhotos.length) + ctaWords;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// THEME SECTION (pure data â€” no instructions)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet themeSection = '';\nif (themePack) {\n  themeSection = `THEME PACK:\n- Theme: ${themePack.theme_name} ${themePack.emoji || ''}\n- Core tension: ${themePack.core_tension}\n- Ad angle: ${themePack.ad_angle}\n- Local micro-moments: ${JSON.stringify(themePack.local_micro_moments)}\n- Banned phrases: ${JSON.stringify(themePack.banned_phrases)}`;\n} else if (config.theme && config.theme !== 'none') {\n  themeSection = `THEME: ${config.theme}`;\n} else {\n  themeSection = `THEME: None provided`;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUILD FEATURE LIST FOR USER PROMPT\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst featureSegments = finalPhotos\n  .map((photo, index) => {\n    if (index === 0) {\n      return `1. HERO: \"${vehicle.year} ${vehicle.make} ${vehicle.model}\" + one standout vibe`;\n    }\n    return `${index + 1}. \"${photo.feature_callout}\"`;\n  })\n  .join('\\n');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// USER PROMPT\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst userPrompt = `Write a ${scriptLength.toUpperCase()} single-car spotlight script.\n\nVEHICLE: ${vehicle.year} ${vehicle.make} ${vehicle.model}\n\n${themeSection}\n\nSEGMENTS (${finalPhotos.length} total):\n${featureSegments}\n\nWORD LIMITS:\n- Hook: ${hookWords} words max\n- Each segment: ${segmentWords} words max\n- CTA: ${ctaWords} words max\n- TOTAL: ${totalWords} words max\n\nOUTPUT JSON:\n{\n  \"hook\": \"Scroll-stopping opener (${hookWords} words max)\",\n  \"segments\": [\n    ${finalPhotos.map((p, i) => {\n      if (i === 0) return `\"Hero: ${vehicle.year} ${vehicle.make}...\"`;\n      return `\"${p.feature_callout}\"`;\n    }).join(',\\n    ')}\n  ],\n  \"cta\": \"Contact + financing (${ctaWords} words max)\",\n  \"full_script\": \"Hook + all segments + cta\",\n  \"notes\": \"Brief notes\"\n}`;\n\nconsole.log(`âœ… Spotlight prompt built for ${vehicle.year} ${vehicle.make} ${vehicle.model}`);\nconsole.log(`ğŸ“¸ ${finalPhotos.length} photos (1 hero + ${featureCount} features)`);\nconsole.log(`ğŸ“ Word limits: hook=${hookWords}, segment=${segmentWords}, cta=${ctaWords}, total=${totalWords}`);\n\nreturn [{\n  json: {\n    ...config,\n    selected_photos: finalPhotos,\n    system_prompt: systemPrompt,\n    user_prompt: userPrompt,\n    word_limits: {\n      total: totalWords,\n      hook: hookWords,\n      perSegment: segmentWords,\n      cta: ctaWords\n    },\n    photos_selected: finalPhotos.length,\n    total_photos_analyzed: config.total_photos || 0,\n    rationale: `Selected ${featureCount} features: ${finalPhotos.slice(1).map(p => p.category).join(', ')}.`\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7232,
        256
      ],
      "id": "71098943-07f6-42e5-b720-c456d85b47d8",
      "name": "Build Script Prompt TEMP_002"
    },
    {
      "parameters": {
        "errorMessage": "Script gen errored out."
      },
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        8928,
        608
      ],
      "id": "bf56da31-0f0a-4eb3-8c4c-4c50ace36add",
      "name": "Stop and Error"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUILD SCRIPT PROMPT â€” TEMP_003 (educational)\n// Educational uses seconds, not words â€” different timing model\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $json;\nconst timing = config.timing;\nconst themePack = config.theme_pack || null;\n\n// Get assembled system prompt (REQUIRED - no fallback)\nconst systemPrompt = $('Assemble System Prompt').first()?.json?.system_prompt;\n\nif (!systemPrompt) {\n  throw new Error('System prompt is required. Check Assemble System Prompt node.');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EDU-SPECIFIC TIMING (seconds, not words)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst eduTimings = {\n  quick: { hook: 3, value: 25, authority: 7, cta: 5, total: 40 },\n  standard: { hook: 3, value: 35, authority: 7, cta: 10, total: 55 },\n  detailed: { hook: 3, value: 50, authority: 10, cta: 12, total: 75 }\n};\n\nconst scriptLength = config.script_length || 'standard';\nconst eduTiming = eduTimings[scriptLength];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// THEME SECTION WITH FALLBACKS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst avatarName = config.avatar_name || config.person_display_name || 'Shad';\n\n// Normalize theme pack (handle both seed and pack formats)\nlet normalizedThemePack = null;\nif (themePack) {\n  normalizedThemePack = {\n    theme_name: themePack.theme_name || themePack.theme_seed || 'Car Buying Tips',\n    emoji: themePack.emoji || 'ğŸš—',\n    core_tension: themePack.core_tension || themePack.direction || 'Common car problems people ignore until they become expensive',\n    education_angle: themePack.education_angle || themePack.direction || 'Practical tips to save money and avoid costly mistakes',\n    lifestyle_moments: themePack.lifestyle_moments || themePack.local_micro_moments || ['Dashboard warning lights', 'Weird car noises', 'Unexpected repair bills'],\n    banned_phrases: themePack.banned_phrases || ['guaranteed approval', 'no credit no problem', 'your next chapter', 'fresh start']\n  };\n}\n\nlet topicSection = '';\nif (normalizedThemePack) {\n  topicSection = `THEME PACK:\n- Theme: ${normalizedThemePack.theme_name} ${normalizedThemePack.emoji}\n- Core tension: ${normalizedThemePack.core_tension}\n- Education angle: ${normalizedThemePack.education_angle}\n- Problem scenarios: ${JSON.stringify(normalizedThemePack.lifestyle_moments)}\n- Banned phrases: ${JSON.stringify(normalizedThemePack.banned_phrases)}\n\nTOPIC: Teach to the core tension above. Start with a PROBLEM-based hook that makes viewers recognize themselves.`;\n} else if (config.topic) {\n  topicSection = `TOPIC: ${config.topic}\n\nStart with a PROBLEM-based hook. What mistake or myth can you address?`;\n} else if (config.theme) {\n  topicSection = `TOPIC: ${config.theme}\n\nStart with a PROBLEM-based hook. What mistake or myth can you address?`;\n} else {\n  topicSection = `TOPIC: Practical car buying or ownership advice.\n\nStart with a PROBLEM-based hook. What common mistake do car buyers make?`;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// USER PROMPT (DATA ONLY - instructions are in system prompt)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst userPrompt = `Generate a ${scriptLength.toUpperCase()} educational script for ${avatarName}.\n\n${topicSection}\n\nTIMING:\n- Hook: ${eduTiming.hook} seconds\n- Value: ${eduTiming.value} seconds\n- Authority: ${eduTiming.authority} seconds\n- CTA: ${eduTiming.cta} seconds\n- Total: ~${eduTiming.total} seconds\n\nWrite now.`;\n\nconsole.log(`âœ… Edu prompt built for ${avatarName}`);\nconsole.log(`ğŸ¨ Theme: ${normalizedThemePack ? normalizedThemePack.theme_name : config.topic || 'seasonal default'}`);\nconsole.log(`â±ï¸ Timing: ${scriptLength} (~${eduTiming.total}s)`);\n\nreturn [{\n  json: {\n    ...config,\n    system_prompt: systemPrompt,\n    user_prompt: userPrompt,\n    timing: eduTiming\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7184,
        1008
      ],
      "id": "336bf8bd-795b-4072-8928-7cd0cbf88e62",
      "name": "Build Script Prompt TEMP_003"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2704,
        384
      ],
      "id": "0d4af0b1-1d94-4f7f-93f5-b2ef0583deee",
      "name": "Merge: Config with Inventory"
    },
    {
      "parameters": {
        "content": "# #1 Script Generation\n\nUse Claude API to generate scripts for Avatar videos based\non the Template chosen by the user.",
        "height": 880,
        "width": 3856,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2736,
        0
      ],
      "typeVersion": 1,
      "id": "2f256773-2f39-4e40-adf8-cbe2350ab2d0",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        240,
        720
      ],
      "id": "922249e2-7fd3-4244-8775-3e140eb6cf1d",
      "name": "When Executed by Orchestrate Video Creation"
    },
    {
      "parameters": {
        "content": "## Error Path",
        "height": 80,
        "width": 448,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        8416,
        832
      ],
      "typeVersion": 1,
      "id": "b0c08557-ed72-45bb-9dc7-addbbd10892d",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "jsCode": "// Single error - format it for the email\nconst error = $input.first().json;\nconst nodeName = error.node?.name || 'Unknown node';\n\n// Handle different error formats from different APIs\nlet errorMsg = 'Unknown error';\n\n// Claude error format: { \"error\": { \"type\": \"...\", \"message\": \"...\" }, \"request_id\": \"...\" }\nif (error.error?.type && error.error?.message) {\n  errorMsg = `[${error.error.type}] ${error.error.message}`;\n  if (error.request_id) {\n    errorMsg += ` (Request ID: ${error.request_id})`;\n  }\n}\n// Cloudinary error format: { \"error\": { \"message\": \"...\" } }\nelse if (error.error?.message && !error.error?.type) {\n  errorMsg = error.error.message;\n}\n// Remove.bg error format: { \"errors\": [{ \"code\": \"...\", \"title\": \"...\" }] }\nelse if (error.errors && Array.isArray(error.errors) && error.errors.length > 0) {\n  const firstError = error.errors[0];\n  // Include code if present, otherwise just title\n  errorMsg = firstError.code \n    ? `${firstError.code}: ${firstError.title}` \n    : firstError.title;\n}\n// Generic message fallback\nelse if (error.message) {\n  errorMsg = error.message;\n}\n\nreturn [{\n  json: {\n    nodeName: nodeName,\n    errorMessage: errorMsg,\n    timestamp: new Date().toISOString(),\n    rawError: JSON.stringify(error, null, 2) // Include full error for debugging\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8304,
        608
      ],
      "id": "74e1d4fe-8f00-469c-9431-335022e1a2f5",
      "name": "Format Script Creation Errors"
    },
    {
      "parameters": {
        "content": "## Success Path",
        "height": 80,
        "width": 192,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        8384,
        0
      ],
      "typeVersion": 1,
      "id": "3584c832-f7dc-43c3-9671-4513f4c3e371",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "aff49ee5-5b0c-432a-ac08-d40a2b35df22",
              "leftValue": "={{ $json.template_id }}",
              "rightValue": "organic-educational-1",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "or"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1984,
        720
      ],
      "id": "64391fd8-17dd-42a7-916c-df995f8fe030",
      "name": "If: Template ID"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ac771c69-0a99-49c2-93ca-db4bf58ffab9",
              "leftValue": "={{$json.template_id}}",
              "rightValue": "ad-single-item-spotlight-1",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3376,
        384
      ],
      "id": "f079a106-b70a-4b76-847e-afcda07ee5ab",
      "name": "If: Feature Photos"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "9451dada-8f16-4dff-ba00-ab2aabc49185",
              "leftValue": "={{ $json.api_claude_categorize_photos }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4048,
        480
      ],
      "id": "f336e118-e90b-4a2d-889d-ecb42175adf3",
      "name": "If: Test, Skip Categorization"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "0a330d1c-bcb6-470a-88be-3dab4273101a",
              "leftValue": "={{ $json.api_claude_feature_identification }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4944,
        480
      ],
      "id": "94b5114b-6559-4c22-bf5d-fdd5bfbe25fe",
      "name": "If: Test, Skip Feature Identification"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "50cf43b0-eb78-4a88-be36-f13549c7b8fc",
              "leftValue": "={{ $json.needs_bg_removal }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5840,
        416
      ],
      "id": "b5e859ce-c0b1-4718-89ca-088f60a9435f",
      "name": "If: Needs Background Removed"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    spreadsheet_data: $input.all().map(item => item.json)\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2368,
        368
      ],
      "id": "c814151d-0bc4-4253-a0c8-11d92029f90d",
      "name": "Combine Spreadsheet Data"
    },
    {
      "parameters": {
        "jsCode": "const allItems = $input.all();\nconst allVehicles = allItems[0].json.spreadsheet_data;\nconst config = allItems[1].json;\nconst requestedVins = config.vins;\nconst matchedVehicles = [];\n\n// Get template type from new format\nconst template = config.template_id || '';\n\nfor (const vehicle of allVehicles) {\n\n  if (vehicle.VIN && requestedVins.includes(vehicle.VIN)) {\n    console.log('âœ… Match found:', vehicle.VIN);\n\n    // ad-multi-item-1 (was TEMP_001) - basic vehicle info\n    if(template === \"ad-multi-item-1\") {\n      matchedVehicles.push({\n        vin: vehicle.VIN,\n        year: vehicle.Year,\n        make: vehicle.Make,\n        model: vehicle.Model,\n        price: vehicle.Price,\n        mileage: vehicle.Mileage,\n        image_url: vehicle.All_Images.split(\"|\")[0],\n        url: vehicle.VDP_URL,\n        features: [vehicle.Engine, vehicle.Drivetrain, vehicle.Exterior_Color].filter(Boolean)\n      });\n    }\n    // ad-single-item-spotlight-1 (was TEMP_002) - detailed vehicle info with all images\n    else if(template === \"ad-single-item-spotlight-1\"){\n      matchedVehicles.push({\n        vin: vehicle.VIN,\n        year: vehicle.Year,\n        make: vehicle.Make,\n        model: vehicle.Model,\n        trim: vehicle.Trim,\n        price: vehicle.Price,\n        mileage: vehicle.Mileage,\n        drivetrain: vehicle.Drivetrain,\n        transmission: vehicle.Transmission,\n        engine: vehicle.Engine,\n        exterior_color: vehicle.Exterior_Color,\n        equipment: vehicle.Equipment,\n        all_images: vehicle.All_Images.split(\"|\"),\n        image_url: vehicle.All_Images.split(\"|\")[0],\n        url: vehicle.VDP_URL\n      });\n    }\n    // social-educational-1 (was TEMP_003) - no vehicles needed, but include basic info if present\n    else if(template === \"social-educational-1\") {\n      matchedVehicles.push({\n        vin: vehicle.VIN,\n        year: vehicle.Year,\n        make: vehicle.Make,\n        model: vehicle.Model,\n        price: vehicle.Price,\n        mileage: vehicle.Mileage,\n        image_url: vehicle.All_Images.split(\"|\")[0],\n        url: vehicle.VDP_URL\n      });\n    }\n    // Default fallback - basic vehicle info\n    else {\n      console.log(`âš ï¸ Unknown template \"${template}\", using basic vehicle info`);\n      matchedVehicles.push({\n        vin: vehicle.VIN,\n        year: vehicle.Year,\n        make: vehicle.Make,\n        model: vehicle.Model,\n        price: vehicle.Price,\n        mileage: vehicle.Mileage,\n        image_url: vehicle.All_Images.split(\"|\")[0],\n        url: vehicle.VDP_URL,\n        features: [vehicle.Engine, vehicle.Drivetrain, vehicle.Exterior_Color].filter(Boolean)\n      });\n    }\n  }\n}\n\nconsole.log('ğŸ¯ Matched vehicles:', matchedVehicles.length);\n\nif (matchedVehicles.length === 0) {\n  throw new Error(`No vehicles found matching VINs: ${requestedVins.join(', ')}`);\n}\n\nreturn [{\n  json: {\n    ...config,\n    vehicles: matchedVehicles\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2928,
        384
      ],
      "id": "0fb932eb-3dee-4079-b0b0-7374acadec24",
      "name": "Fetch Car Info from VINs"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    ...$json,\n    \"content\": [{\n      \"text\": $json.api_claude_categorize_photos\n    }]\n  }\n}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4272,
        224
      ],
      "id": "6d44a5df-2346-4ce7-ad89-fad5aa113439",
      "name": "Skip Categorization"
    },
    {
      "parameters": {
        "jsCode": "const config = $('Build Photo Categorizer Prompt').first().json;\nconst apiResponse = $json.content[0].text;\n\nlet responseText = apiResponse;\nconst jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\nif (jsonMatch) {\n  responseText = jsonMatch[0];\n} else {\n  throw new Error(\"Could not find valid JSON object in response\");\n}\n\nconst categorizedResult = JSON.parse(responseText.trim());\n\n// Get data from previous node\nconst allImageUrls = config.all_image_urls;\nconst equipmentContextByCategory = config.equipment_context_by_category;\nconst vehicle = config.vehicles[0];\n\n// Build selected photos object\nconst selectedPhotos = {};\n\ncategorizedResult.categorized_photos.forEach(photo => {\n  const category = photo.category;\n  if (category !== 'exclude') {\n    const photoIndex = photo.photo_index;\n    \n    // Get equipment context for this category\n    const equipmentContext = equipmentContextByCategory[category] || {};\n    \n    selectedPhotos[category] = {\n      photo_index: photoIndex,\n      photo_url: allImageUrls[photoIndex],\n      reasoning: photo.reasoning,\n      equipment_context: equipmentContext\n    };\n  }\n});\n\n// Always include hero exterior (photo 0)\nselectedPhotos.hero_exterior = {\n  photo_index: 0,\n  photo_url: vehicle.all_images[0],\n  reasoning: \"Hero exterior shot\",\n  equipment_context: {}\n};\n\n// Clean up baseConfig - remove all_images\nconst cleanBaseConfig = {\n  ...config,\n  all_images: undefined,  // Remove all_images array\n  vehicles: config.vehicles?.map(vehicle => {\n    const {all_images, ...cleanVehicle } = vehicle;\n    return cleanVehicle;\n  })\n};\n\nreturn [{\n  json: {\n    ...cleanBaseConfig,\n\n    selected_photos: selectedPhotos,\n\n    // Remove used data\n    equipment_context_by_category: undefined,\n    categorizer_vision_content: undefined,\n    categorizer_system_prompt: undefined,\n    categorizer_user_prompt: undefined,\n    all_image_urls: undefined,\n    max_photo_index: undefined,\n    total_photos: undefined,\n    \n    // Testing API Response\n    ...(config.test_mode && { api_claude_categorize_photos: apiResponse })\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4496,
        480
      ],
      "id": "433c72d7-dcc7-4e22-836b-222aef450043",
      "name": "Parse Catagorization Response"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\n  \"anthropic-version\": \"2023-06-01\",\n  \"content-type\": \"application/json\"\n}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"claude-sonnet-4-20250514\",\n  \"max_tokens\": 4000,\n  \"messages\": [\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($json.categorizer_vision_content) }}\n    }\n  ]\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4272,
        720
      ],
      "id": "752295fe-7598-4b8e-b64a-98d3359b6d66",
      "name": "API: Claude, Categorize Photos",
      "credentials": {
        "httpHeaderAuth": {
          "id": "LQZygyOyKZ5tikRW",
          "name": "VideoBGRemover"
        },
        "anthropicApi": {
          "id": "lw8bFQVznfoHFIjD",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4",
          "mode": "list",
          "cachedResultName": "Inventory",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 467345130,
          "mode": "list",
          "cachedResultName": "Spotlight_Data",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4/edit#gid=467345130"
        },
        "options": {}
      },
      "id": "a0f82a94-8a1a-4b68-9d06-862507fe4e9f",
      "name": "API: Sheets, Fetch Inventory",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        2192,
        368
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "9WK1ZemzeOSj1j4A",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    ...$json,\n    \"content\": [{\n      \"text\": $json.api_claude_feature_identification\n    }]\n  }\n}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5168,
        224
      ],
      "id": "cf9a49be-f418-4e32-97cc-125258af5f13",
      "name": "Skip Feature Identification"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\n  \"anthropic-version\": \"2023-06-01\",\n  \"content-type\": \"application/json\"\n}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"claude-sonnet-4-20250514\",\n  \"max_tokens\": 4000,\n  \"messages\": [\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($json.feature_identifier_content) }}\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        5168,
        720
      ],
      "id": "6c0a8ff6-289e-44d4-a686-fc29e533014a",
      "name": "API: Claude, Feature Identification",
      "credentials": {
        "anthropicApi": {
          "id": "lw8bFQVznfoHFIjD",
          "name": "Anthropic account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// Get all items at once\nconst result = $input.all();\n\nfor (const item of result) {\n  // VIN is now in context from the service response\n  const vin = item.json.context?.vins?.[0] || item.json.vins?.[0] || 'unknown'; \n\n  if (item.binary && item.binary.data) {\n    item.binary.data.fileName = `${vin}.png`;\n  }\n  \n  // Flatten context back to top level for downstream nodes\n  if (item.json.context) {\n    item.json = { ...item.json.context, ...item.json };\n    delete item.json.context;\n  }\n}\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6512,
        432
      ],
      "id": "45a01157-ebc3-4fc6-9675-7405ce66b01c",
      "name": "Rename Binary"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cloudinary.com/v1_1/dtpqxuwby/image/upload",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            },
            {
              "name": "upload_preset",
              "value": "n8n_unsigned"
            },
            {
              "name": "public_id",
              "value": "={{ $json.VIN }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6736,
        432
      ],
      "id": "2a89fee3-72bf-4e01-ac5d-ad25a99f1da4",
      "name": "API: Coudinary, Upload",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "const currentData = $json;\nconst config = $('Process Hero Photo for Animation').first().json;\n\n// Get VIN - might be in different places depending on the path\nconst vin = currentData.vehicles?.[0]?.vin || config.vehicles?.[0]?.vin;\n\nif (!vin) {\n  throw new Error('VIN missing - cannot update hero URL');\n}\n\n// Cloudinary response gives us the URL\nconst cloudinaryUrl = currentData.secure_url || `https://res.cloudinary.com/dtpqxuwby/image/upload/${vin}.png`;\n\n// Update the hero_bg_removed_url and selected_photos\n// const updatedData = {\n//   ...config,  // Use data from BEFORE the HTTP requests\n//   hero_bg_removed_url: cloudinaryUrl,\n//   needs_bg_removal: false,\n//   cloudinary_uploaded: true\n// };\n\n// Update the hero photo URL in selected_photos\nif (config.selected_photos?.hero_exterior) {\n  config.selected_photos.hero_exterior.photo_url = cloudinaryUrl;\n}\n\nreturn [{\n  json: {\n    ...config,\n    hero_bg_removed_url: cloudinaryUrl,\n    needs_bg_removal: false,\n    cloudinary_uploaded: true\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6960,
        336
      ],
      "id": "64da0924-589c-4fa7-85e3-c625cdd26fce",
      "name": "Update Hero URL"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            },
            {
              "name": "content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "claude-sonnet-4-20250514"
            },
            {
              "name": "max_tokens",
              "value": "={{2000}}"
            },
            {
              "name": "system",
              "value": "={{$json.system_prompt || \"\"}}"
            },
            {
              "name": "messages",
              "value": "={{ [{\"role\": \"user\", \"content\": $json.user_prompt}] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "e0cff8df-84c5-4220-b6fe-5a46fa8ebdfd",
      "name": "API: Claude, Script Generation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8080,
        320
      ],
      "credentials": {
        "anthropicApi": {
          "id": "lw8bFQVznfoHFIjD",
          "name": "Anthropic account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "f641b7b8-0575-475f-b438-bf090d44e7e0",
              "leftValue": "={{ $json.api_claude_script_generation }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "c1654ac2-d893-4717-86a4-b997027540b9",
              "leftValue": "={{$json.script_edited}}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7856,
        272
      ],
      "id": "1dc60f41-78d4-48ad-bdf0-9d1392292905",
      "name": "If: Test, Skip Script Generation"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    ...$json,\n    \"content\": [{\n      \"text\": $json.api_claude_script_generation\n    }]\n  }\n}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8080,
        96
      ],
      "id": "f1d0ded6-7c9b-4e9b-8939-dba10e9f4552",
      "name": "Skip Script Generation"
    },
    {
      "parameters": {
        "jsCode": "const config = $('Post Agg Parse').first().json\n// If script was edited in UI, skip parsing - use existing script\nif (config.script_edited && config.script) {\n  return [{ json: config }];\n}\n\n// Extract and parse the script\nconst apiResponse = $json.content[0].text;\nconst cleanText = apiResponse\n  .replace(/```json\\n?/g, '')\n  .replace(/```\\n?/g, '')\n  .trim();\nlet parsedResponse;\ntry {\n  parsedResponse = JSON.parse(cleanText);\n} catch (error) {\n  throw new Error(`Failed to parse script response: ${error.message}`);\n}\nconst script = parsedResponse;\n// Validate required fields\nif (!script.hook || !script.segments || !script.cta) {\n  throw new Error('Script missing required section(s): hook, segments, or cta');\n}\nconst finalOutput = {\n  ...config,\n  script: script,\n  \n  // Remove prompts and processing data\n  shared_system_prompt: undefined,\n  system_prompt: undefined,\n  user_prompt: undefined,\n  claude_prompt: undefined,\n  script_user_prompt: undefined,\n  categorizer_vision_content: undefined,\n  feature_identifier_content: undefined,\n  categories_to_identify: undefined,\n  photos_selected: undefined,\n  total_photos_analyzed: undefined,\n  rationale: undefined,\n  categorizer_raw_response: undefined,\n  feature_identifier_raw: undefined,\n  verified_features: undefined,\n  equipment_categories: undefined,\n  hero_photo_index: undefined,\n  allowed_photo_categories: undefined,\n  equipment_context_by_category: undefined,\n  all_image_urls: undefined,\n  max_photo_index: undefined,\n  total_photos: undefined,\n  needs_bg_removal: undefined,\n  cloudinary_checked: undefined,\n  notes: undefined,\n  shared_prompt_ready: undefined\n};\n\n// Testing API Response - more explicit assignment\nif (config.test_mode) {\n  finalOutput.api_claude_script_generation = apiResponse;\n}\n\nreturn [{\n  json: finalOutput\n}];"
      },
      "id": "441e020e-6c92-49c3-a0e3-82aa486b1847",
      "name": "Parse Script Generation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8304,
        192
      ]
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        7408,
        272
      ],
      "id": "e1b7324f-d614-4a72-a661-be6c5cfb1dfb",
      "name": "Aggregate: All Configs"
    },
    {
      "parameters": {
        "jsCode": "const config = $('Build Feature Identifier Prompts').first().json;\nconst apiResponse = $json.content[0].text;\nconst vehicle = config.vehicles[0];\n\n// Parse JSON response (strip markdown if present)\nlet responseText = apiResponse.replace(/```json\\n?/g, \"\").replace(/```\\n?/g, \"\").trim();\n\n// Try to extract JSON object\nconst jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\nif (jsonMatch) {\n  responseText = jsonMatch[0];\n}\n\nconst identifiedFeatures = JSON.parse(responseText);\n\n// Combine equipment context + visual verification\nconst verifiedFeatures = {};\n\nObject.entries(identifiedFeatures).forEach(([category, features]) => {\n  const photoData = config.selected_photos[category];\n  if (!photoData) {\n    console.log(`âš ï¸ No photo data found for category: ${category}`);\n    return;\n  }\n\n  verifiedFeatures[category] = {\n    photo_index: photoData.photo_index,\n    photo_url: photoData.photo_url,\n    equipment_context: photoData.equipment_context,\n    visual_verification: features,\n    \n    // Build final feature list for script generation\n    script_features: buildScriptFeatures(category, photoData.equipment_context, features, vehicle)\n  };\n});\n\n// Function to build script-ready feature descriptions\nfunction buildScriptFeatures(category, equipment, visual, vehicle) {\n  switch(category) {\n    case 'front_seats':\n      const seatFeatures = [];\n      \n      // Add condition if excellent\n      if (visual.condition === 'excellent') {\n        seatFeatures.push('pristine');\n      }\n      \n      // Add material from equipment ONLY\n      seatFeatures.push(equipment.material_claim || 'comfortable seating');\n      \n      // Add climate features\n      if (equipment.has_heated && equipment.has_cooled) {\n        seatFeatures.push('heated and ventilated');\n      } else if (equipment.has_heated) {\n        seatFeatures.push('heated');\n      } else if (equipment.has_cooled) {\n        seatFeatures.push('ventilated');\n      }\n      \n      // Add power if present\n      if (equipment.has_power) {\n        seatFeatures.push('power-adjustable');\n      }\n      \n      // Add memory if present\n      if (equipment.has_memory) {\n        seatFeatures.push('with memory');\n      }\n      \n      return seatFeatures.join(' ');\n      \n    case 'engine_bay':\n      const engineFeatures = [];\n      \n      // Add engine details from equipment\n      if (equipment.engine_features && equipment.engine_features.length > 0) {\n        const engineInfo = equipment.engine_features[0];\n        // Extract key parts (e.g., \"V6 i-VTEC 3.5 Liter\")\n        const match = engineInfo.match(/(V\\d+|4-Cyl|3-Cyl|I\\d+).*?(\\d+\\.\\d+)\\s*Liter/i);\n        if (match) {\n          const cylinders = match[1];\n          const displacement = match[2];\n          engineFeatures.push(`${displacement}L ${cylinders}`);\n        } else {\n          engineFeatures.push(engineInfo);\n        }\n      }\n      \n      // Add turbo/special tech\n      if (equipment.engine_features && equipment.engine_features.some(e => /turbo/i.test(e))) {\n        engineFeatures.push('turbocharged');\n      }\n      if (equipment.engine_features && equipment.engine_features.some(e => /hemi/i.test(e))) {\n        engineFeatures.push('HEMI power');\n      }\n      \n      // Add condition note\n      if (visual.condition === 'clean') {\n        engineFeatures.push('well-maintained');\n      }\n      \n      return engineFeatures.join(', ');\n      \n    case 'infotainment_carplay':\n      const infoFeatures = [];\n      \n      // Smartphone integration\n      if (visual.has_apple_carplay && visual.has_android_auto) {\n        infoFeatures.push('Apple CarPlay and Android Auto');\n      } else if (visual.has_apple_carplay) {\n        infoFeatures.push('Apple CarPlay');\n      } else if (visual.has_android_auto) {\n        infoFeatures.push('Android Auto');\n      } else {\n        infoFeatures.push('smartphone connectivity');\n      }\n      \n      // Premium audio\n      if (equipment.audio_system && /bose|harman|revel|premium/i.test(equipment.audio_system)) {\n        infoFeatures.push(equipment.audio_system);\n      }\n      \n      // Navigation\n      if (equipment.has_navigation || visual.navigation_visible) {\n        infoFeatures.push('navigation');\n      }\n      \n      return infoFeatures.join(' with ');\n      \n    case 'infotainment_360_camera':\n      const cameraFeatures = ['360-degree camera'];\n      \n      if (visual.parking_sensors_visible) {\n        cameraFeatures.push('with parking sensors');\n      }\n      \n      return cameraFeatures.join(' ');\n      \n    case 'moonroof':\n      const roofFeatures = [];\n      \n      // Type from equipment\n      if (equipment.moonroof_type === 'Panoramic' || visual.appears_panoramic) {\n        roofFeatures.push('panoramic moonroof');\n      } else {\n        roofFeatures.push('power moonroof');\n      }\n      \n      return roofFeatures.join(' ');\n      \n    case 'cargo_area':\n      const cargoFeatures = [];\n      \n      // Space rating\n      if (visual.space_rating === 'spacious' || visual.space_rating === 'huge') {\n        cargoFeatures.push('spacious cargo area');\n      } else {\n        cargoFeatures.push('cargo space');\n      }\n      \n      // Power liftgate\n      if (equipment.power_liftgate) {\n        cargoFeatures.push('with power liftgate');\n      }\n      \n      // Truck bed features\n      if (equipment.truck_bed_features && equipment.truck_bed_features.length > 0) {\n        if (equipment.truck_bed_features.some(f => /bed liner/i.test(f))) {\n          cargoFeatures.push('spray-in bed liner');\n        }\n        if (equipment.truck_bed_features.some(f => /multipro/i.test(f))) {\n          cargoFeatures.push('MultiPro tailgate');\n        }\n      }\n      \n      return cargoFeatures.join(', ');\n      \n    case 'steering_wheel':\n      const wheelFeatures = [];\n      \n      if (equipment.has_heated_wheel || visual.controls_visible?.heated) {\n        wheelFeatures.push('heated steering wheel');\n      }\n      \n      if (visual.controls_visible?.audio || visual.controls_visible?.cruise) {\n        wheelFeatures.push('with steering wheel controls');\n      }\n      \n      if (visual.paddle_shifters) {\n        wheelFeatures.push('and paddle shifters');\n      }\n      \n      return wheelFeatures.length > 0 ? wheelFeatures.join(' ') : 'multifunction steering wheel';\n      \n    case 'second_row_seats':\n      const secondRowFeatures = [];\n      \n      if (visual.space_rating === 'spacious' || visual.space_rating === 'generous') {\n        secondRowFeatures.push('spacious rear seating');\n      } else {\n        secondRowFeatures.push('rear seating');\n      }\n      \n      if (visual.features_visible && visual.features_visible.length > 0) {\n        if (visual.features_visible.some(f => /climate/i.test(f))) {\n          secondRowFeatures.push('with rear climate control');\n        }\n      }\n      \n      return secondRowFeatures.join(' ');\n      \n    case 'third_row_seats':\n      return 'third row seating for seven passengers';\n      \n    case 'instrument_cluster':\n      if (visual.cluster_type === 'digital') {\n        return 'digital instrument cluster';\n      } else if (visual.cluster_type === 'hybrid') {\n        return 'advanced gauge cluster with digital display';\n      }\n      return null; // Don't highlight basic analog clusters\n      \n    case 'special_feature':\n      if (visual.feature_identified) {\n        return visual.feature_identified;\n      }\n      return null;\n      \n    case 'infotainment_other':\n      const otherFeatures = [];\n      \n      if (visual.showing === 'navigation' || equipment.has_navigation) {\n        otherFeatures.push('navigation system');\n      }\n      \n      if (equipment.audio_system && /bose|harman|revel|premium/i.test(equipment.audio_system)) {\n        otherFeatures.push(equipment.audio_system);\n      }\n      \n      if (otherFeatures.length === 0) {\n        otherFeatures.push('touchscreen infotainment');\n      }\n      \n      return otherFeatures.join(' with ');\n      \n    default:\n      return null;\n  }\n}\n\nconsole.log(`ğŸ“‹ Built script features for ${Object.keys(verifiedFeatures).length} categories`);\n\n// Log feature summary for debugging\nObject.entries(verifiedFeatures).forEach(([category, data]) => {\n  if (data.script_features) {\n    console.log(`  ${category}: \"${data.script_features}\"`);\n  }\n});\n\nreturn [{\n  json: {\n    ...config,\n    \n    verified_features: verifiedFeatures,\n    \n    // Testing API Response\n    ...(config.test_mode && { api_claude_feature_identification: apiResponse })\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5392,
        416
      ],
      "id": "5fb2621e-973e-439c-8afe-4ee7ed2c8603",
      "name": "Parse Feature Identification Response"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: $json.data[0]\n}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7632,
        272
      ],
      "id": "9b593a38-46e0-4170-bc3c-3bb1a2645f8a",
      "name": "Post Agg Parse"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        464,
        720
      ],
      "id": "2925906e-f154-4670-9716-aabfdc9ce42f",
      "name": "Pass Config"
    },
    {
      "parameters": {
        "jsCode": "// Map existing error format to service format\nconst input = $json;\n\nreturn [{\n  json: {\n    workflow_name: \"[02] Generate Script\",\n    error: input.errorMessage || \"Unknown error\",\n    details: input.rawError || JSON.stringify(input, null, 2),\n    job_id: null,\n    to_email: \"kelly@ad-pilot.ai\"\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8528,
        608
      ],
      "id": "prep-error-email",
      "name": "Prep: Error Email"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "mBVi9C0eRoq1xTeb",
          "mode": "list",
          "cachedResultUrl": "/workflow/mBVi9C0eRoq1xTeb",
          "cachedResultName": "[Service] Email Error Notification"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        8752,
        608
      ],
      "id": "call-email-error",
      "name": "Call: Email Error"
    },
    {
      "parameters": {
        "jsCode": "// Prepare input for Remove Background service\nconst input = $json;\n\nreturn [{\n  json: {\n    image_url: input.hero_photo_url,\n    size: \"auto\",\n    format: \"png\",\n    crop: true,\n    crop_margin: \"10%\",\n    context: {\n      vins: input.vins\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6064,
        528
      ],
      "id": "prep-remove-bg",
      "name": "Prep: Remove BG"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "pbHuh1HdmZxbFX0M",
          "mode": "list",
          "cachedResultUrl": "/workflow/pbHuh1HdmZxbFX0M",
          "cachedResultName": "[Service] Remove Background"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        6288,
        528
      ],
      "id": "call-remove-bg",
      "name": "Call: Remove Background",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT prompt_type, template_code, prompt_content\nFROM client_prompts\nWHERE client_id = '{{ $json.client_id }}'\nAND (\n  prompt_type = 'base'\n  OR prompt_type = 'rules'\n  OR (prompt_type = 'override' AND template_code = UPPER(REPLACE(REPLACE('{{ $json.template_id }}', 'ad-', ''), 'organic-', '')))\n)\nAND is_active = true",
        "options": {}
      },
      "id": "fetch-client-prompts-001",
      "name": "Fetch Client Prompts",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        688,
        720
      ],
      "credentials": {
        "postgres": {
          "id": "3XsWrPuEddwVYbGS",
          "name": "Railway Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT i.pronunciations, i.legal, i.feature_enrichment, i.template_guidance, i.global_rules\nFROM industries i\nJOIN clients c ON c.industry_id = i.id\nWHERE c.id = '{{ $('Pass Config').first().json.client_id }}'",
        "options": {}
      },
      "id": "fetch-industry-config-001",
      "name": "Fetch Industry Config",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        912,
        720
      ],
      "credentials": {
        "postgres": {
          "id": "3XsWrPuEddwVYbGS",
          "name": "Railway Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const config = $('Pass Config').first().json;\nconst promptRows = $('Fetch Client Prompts').all().map(r => r.json);\nconst industryPromptRaw = $('Fetch Industry Prompts').first()?.json?.prompt_content || {};\nconst industryConfig = $('Fetch Industry Config').first().json;\nconst timingDefaults = $('Fetch Timing Defaults').first().json;\nconst templateConfig = $('Fetch Template Config').first().json;\n\n// Parse industry prompt if string\nconst industryPrompt = typeof industryPromptRaw === 'string' \n  ? JSON.parse(industryPromptRaw) \n  : industryPromptRaw;\n\n// Get client-level data\nconst basePrompt = promptRows.find(r => r.prompt_type === 'base')?.prompt_content || {};\nconst rulesPrompt = promptRows.find(r => r.prompt_type === 'rules')?.prompt_content || [];\nconst overridePromptRaw = promptRows.find(r => r.prompt_type === 'override')?.prompt_content || {};\nconst overridePrompt = typeof overridePromptRaw === 'string' ? JSON.parse(overridePromptRaw) : overridePromptRaw;\n\n// Deep merge helper - client overrides win\nfunction deepMerge(base, override) {\n  if (!override || Object.keys(override).length === 0) return base;\n  \n  const result = { ...base };\n  for (const key of Object.keys(override)) {\n    if (typeof override[key] === 'object' && !Array.isArray(override[key]) && base[key]) {\n      result[key] = deepMerge(base[key], override[key]);\n    } else {\n      result[key] = override[key];\n    }\n  }\n  return result;\n}\n\n// MERGE: industry_prompts + client overrides\nconst templatePrompt = deepMerge(industryPrompt, overridePrompt);\n\n// Check template flags\nconst isStandalone = templatePrompt.standalone === true;\nconst usesBase = templatePrompt.uses_base === true;\nconst usesFromBase = templatePrompt.uses_from_base || [];\nconst respectsRules = templatePrompt.respects_rules !== false; // default true\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUILD SYSTEM PROMPT (14 SECTIONS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst sections = [];\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 1: IDENTITY (from base)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (usesBase || usesFromBase.includes('identity')) {\n  const identity = basePrompt.identity || {};\n  sections.push(`You are a ${identity.platform_voice || 'video ad copywriter'} for ${identity.business_name || 'our client'} in ${identity.location || 'their area'}.`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 2: TEMPLATE DEFINITION (from template prompt)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.description) {\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“‹ TEMPLATE: ${templateConfig.template_code || config.template_id}\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${templatePrompt.description}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 3: WORD LIMITS (from timing_defaults DB)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (timingDefaults) {\n  sections.push(`\nâš ï¸ WORD LIMITS (${timingDefaults.name} - ${timingDefaults.style || ''}):\n- Hook: ${timingDefaults.hook_words} words max\n- Segment: ${timingDefaults.segment_words} words max\n- CTA: ${timingDefaults.cta_words} words max`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 4: STRUCTURE (from template prompt)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.structure) {\n  sections.push(`\nSTRUCTURE:\n${templatePrompt.structure.map((s, i) => `${i + 1}. ${s}`).join('\\n')}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 5: HOOK RULES (from merged template prompt)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.hook_rules) {\n  const hr = templatePrompt.hook_rules;\n  let hookSection = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸª HOOK RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${hr.principle}`;\n\n  if (hr.format) {\n    hookSection += `\\n\\nFORMAT: ${hr.format}`;\n  }\n\n  // Handle both old (good_examples) and new (examples) schemas\n  const goodExamples = hr.examples || hr.good_examples || [];\n  if (goodExamples.length > 0) {\n    hookSection += `\\n\\nGOOD EXAMPLES:\\n${goodExamples.map(e => `âœ… \"${e}\"`).join('\\n')}`;\n  }\n\n  // Handle both old (bad_examples) and new (avoid) schemas  \n  const badExamples = hr.avoid || hr.bad_examples || [];\n  if (badExamples.length > 0) {\n    hookSection += `\\n\\nAVOID:\\n${badExamples.map(e => `âŒ \"${e}\"`).join('\\n')}`;\n  }\n\n  sections.push(hookSection);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 6: VALUE SECTION (for educational templates)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.value_section) {\n  const vs = templatePrompt.value_section;\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ’¡ VALUE SECTION\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${vs.principle}\n\nRULES:\n${(vs.rules || []).map(r => `â€¢ ${r}`).join('\\n')}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 7: AUTHORITY SECTION (for educational templates)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.authority_section) {\n  const as = templatePrompt.authority_section;\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ† AUTHORITY SECTION\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${as.principle}\n\nEXAMPLE FRAMING:\n${(as.example_framing || []).map(f => `â€¢ \"${f}\"`).join('\\n')}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 8: CTA RULES (from template prompt)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.cta_rules) {\n  const cr = templatePrompt.cta_rules;\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“£ CTA RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${cr.principle}\n\nORDER:\n${(cr.order || []).map((o, i) => `${i + 1}. ${o}`).join('\\n')}\n\nAVOID: ${(cr.avoid || []).join(', ')}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 9: DELIVERY RULES (for educational templates)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.delivery_rules) {\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¤ DELIVERY RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${templatePrompt.delivery_rules.map(r => `â€¢ ${r}`).join('\\n')}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 10: SEGMENT RULES (from template prompt)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.segment_rules) {\n  const sr = templatePrompt.segment_rules;\n  let segSection = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“ SEGMENT RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;\n\n  // Handle both nested structure (MULTI-ITEM) and flat structure (SINGLE-ITEM)\n  if (sr.segment_1_hero) {\n    segSection += `\\nSEGMENT 1 (HERO):\n${sr.segment_1_hero.principle}\nPattern: ${sr.segment_1_hero.pattern}\nExample: \"${sr.segment_1_hero.example}\"`;\n  }\n\n  if (sr.segments_2_plus) {\n    segSection += `\\n\\nSEGMENTS 2+:\n${sr.segments_2_plus.principle}\nStyle: ${sr.segments_2_plus.style}\n\nGOOD:\n${(sr.segments_2_plus.good_patterns || []).map(p => `âœ… \"${p}\"`).join('\\n')}\n\nBAD:\n${(sr.segments_2_plus.bad_patterns || []).map(p => `âŒ \"${p}\"`).join('\\n')}`;\n  }\n\n  // Flat structure (SINGLE-ITEM-SPOTLIGHT)\n  if (sr.principle && !sr.segment_1_hero) {\n    segSection += `\\n${sr.principle}\nFlow: ${sr.flow || ''}\n\nEXAMPLE ARC:\n${(sr.example_arc || []).map(e => `â€¢ ${e}`).join('\\n')}`;\n  }\n\n  sections.push(segSection);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 11: NATURAL FLOW (for multi-item templates)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.natural_flow) {\n  const nf = templatePrompt.natural_flow;\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ—£ï¸ NATURAL FLOW\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${nf.principle}\n\nLEAD-IN VARIETY:\n${(nf.lead_in_variety || []).map(l => `- \"${l}\"`).join('\\n')}\n\nCONNECT FEATURES:\n${nf.connect_features?.principle || ''}\nGOOD: ${(nf.connect_features?.good || []).map(g => `\"${g}\"`).join(', ')}\nBAD: ${(nf.connect_features?.bad || []).map(b => `\"${b}\"`).join(', ')}`);\n}\n\n// Feature diversity\nif (templatePrompt.feature_diversity) {\n  sections.push(`\nFEATURE DIVERSITY: ${templatePrompt.feature_diversity}`);\n}\n\n// Tone\nif (templatePrompt.tone) {\n  sections.push(`\nTONE: ${templatePrompt.tone}`);\n}\n\n// Hard fails\nif (templatePrompt.hard_fails) {\n  sections.push(`\nâŒ HARD FAILS (avoid at all costs):\n${templatePrompt.hard_fails.map(f => `â€¢ ${f}`).join('\\n')}`);\n}\n\n// TTS rules\nif (templatePrompt.tts_rules) {\n  const tts = templatePrompt.tts_rules;\n  sections.push(`\nğŸ”Š TTS RULES: ${tts.principle}\nNo emojis in: ${(tts.no_emojis_in || []).join(', ')}\nEmojis allowed in: ${(tts.emojis_allowed_in || []).join(', ')}`);\n}\n\n// Output format\nif (templatePrompt.output_format) {\n  const of = templatePrompt.output_format;\n  let formatSection = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“¤ OUTPUT FORMAT\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;\n  for (const [key, val] of Object.entries(of)) {\n    if (Array.isArray(val)) {\n      formatSection += `\\n${key}: ${val.join(', ')}`;\n    } else {\n      formatSection += `\\n${key}: ${val}`;\n    }\n  }\n  sections.push(formatSection);\n}\n\n// Examples from template\nif (templatePrompt.examples) {\n  sections.push(`\nEXAMPLES:\nGOOD:\n${(templatePrompt.examples.good || []).map(e => `âœ… \"${e}\"`).join('\\n')}\n\nBAD:\n${(templatePrompt.examples.bad || []).map(e => `âŒ \"${e}\"`).join('\\n')}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 12: THEME PACK USAGE (from theme_modes DB)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templateConfig.theme_mode_rules) {\n  const rules = typeof templateConfig.theme_mode_rules === 'string'\n    ? JSON.parse(templateConfig.theme_mode_rules)\n    : templateConfig.theme_mode_rules;\n\n  if (rules && rules.length > 0) {\n    sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¨ THEME PACK USAGE (${templateConfig.theme_mode_name || templateConfig.theme_mode})\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${rules.map((r, i) => `${i + 1}) ${r}`).join('\\n')}\n\nIf theme_pack missing: Use generic value/deals hook`);\n  }\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 13: GLOBAL RULES (from industry)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (industryConfig?.global_rules?.length) {\n  const globalLines = industryConfig.global_rules.map(rule => `âš ï¸ ${rule}`).join('\\n');\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸŒ GLOBAL RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${globalLines}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 14: BANNED PHRASE CHECK (from template prompt)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.banned_phrase_check) {\n  sections.push(`\nâš ï¸ ${templatePrompt.banned_phrase_check}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 15: BASE PROMPT SECTIONS (if uses_base)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (usesBase) {\n  // Priorities\n  if (basePrompt.priorities?.length) {\n    const priorityLines = basePrompt.priorities\n      .map((p, i) => `${i + 1}. ${p.name.toUpperCase()} - ${p.description}`)\n      .join('\\n');\n    sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¯ PRIORITIES (IN ORDER)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${priorityLines}`);\n  }\n\n  // Contact info\n  if (basePrompt.contact_tts) {\n    const ct = basePrompt.contact_tts;\n    sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“ CONTACT INFO (FOR TTS)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n- Address: \"${ct.address_short}\"\n- Full address: \"${ct.address_full}\"\n- Phone: \"${ct.phone}\"\n- Website: \"${ct.website}\"`);\n  }\n\n  // CTA patterns\n  if (basePrompt.cta_patterns?.length) {\n    sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“¢ CTA PATTERNS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${basePrompt.cta_patterns.map(c => `âœ… \"${c}\"`).join('\\n')}`);\n  }\n\n  // Tone\n  if (basePrompt.tone_and_style) {\n    sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¨ TONE & STYLE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${basePrompt.tone_and_style}`);\n  }\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 16: PRONUNCIATIONS (merged: industry library + client custom)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst industryPronunciations = industryConfig?.pronunciations || {};\nconst clientPronunciations = basePrompt.pronunciations || {};\nconst mergedPronunciations = { ...industryPronunciations, ...clientPronunciations };\n\nif (Object.keys(mergedPronunciations).length > 0) {\n  const pronLines = Object.entries(mergedPronunciations)\n    .map(([word, say]) => `- ${word} â†’ \"${say}\"`)\n    .join('\\n');\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ—£ï¸ PRONUNCIATIONS (NEVER DEVIATE)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${pronLines}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 17: LEGAL RULES (from industry - NON-NEGOTIABLE)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (industryConfig?.legal?.length) {\n  const legalLines = industryConfig.legal.map(rule => `âŒ ${rule}`).join('\\n');\n\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâš–ï¸ LEGAL (CRITICAL - NON-NEGOTIABLE)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${legalLines}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 18: CLIENT RULES (LAST - HIGHEST PRIORITY)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (respectsRules && rulesPrompt?.length) {\n  const ruleLines = rulesPrompt.map(r => {\n    const icon = r.type === 'style' ? 'â›”' : 'ğŸ“Œ';\n    return `${icon} ${r.rule}`;\n  }).join('\\n');\n\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸš¨ CLIENT RULES â€” OVERRIDE EVERYTHING ABOVE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nThese rules are CLIENT-SPECIFIC and take ABSOLUTE PRIORITY.\nIf ANY rule above conflicts with these, THESE WIN.\n\n${ruleLines}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// ASSEMBLE FINAL PROMPT\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst systemPrompt = sections.join('\\n');\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('ASSEMBLED SYSTEM PROMPT');\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log(`Template: ${templateConfig.template_code || config.template_id}`);\nconsole.log(`Theme Mode: ${templateConfig.theme_mode || 'none'}`);\nconsole.log(`Timing: ${timingDefaults?.code || 'standard'}`);\nconsole.log(`Standalone: ${isStandalone}`);\nconsole.log(`Uses Base: ${usesBase}`);\nconsole.log(`Respects Rules: ${respectsRules}`);\nconsole.log(`Industry Prompt Found: ${Object.keys(industryPrompt).length > 0}`);\nconsole.log(`Client Override Found: ${Object.keys(overridePrompt).length > 0}`);\nconsole.log(`Prompt length: ${systemPrompt.length} chars`);\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\nreturn [{\n  json: {\n    ...config,\n    system_prompt: systemPrompt,\n    timing_config: timingDefaults,\n    template_config: templateConfig,\n    industry_config: industryConfig,\n    _prompt_meta: {\n      standalone: isStandalone,\n      uses_base: usesBase,\n      respects_rules: respectsRules,\n      template_code: templateConfig.template_code || config.template_id,\n      theme_mode: templateConfig.theme_mode,\n      industry_prompt_found: Object.keys(industryPrompt).length > 0,\n      client_override_found: Object.keys(overridePrompt).length > 0\n    }\n  }\n}];"
      },
      "id": "assemble-system-prompt-001",
      "name": "Assemble System Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1808,
        720
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PREPARE SCRIPT CONTEXT\n// Pure data fetcher â€” no business logic, no instructions\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $json;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// TIMING (from timing_config - fetched from DB)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst timingConfig = config.timing_config || {};\nconst timing = {\n  hook_words: timingConfig.hook_words || 12,\n  segment_words: timingConfig.segment_words || 15,\n  cta_words: timingConfig.cta_words || 12,\n  style: timingConfig.style || 'Standard timing',\n  code: timingConfig.code || 'standard'\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// THEME PACK (pure data â€” NO instructions)\n// Handle both full pack format AND seed format from UI\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nlet themePack = config.theme_pack || null;\nlet themeSection = '';\n\nif (themePack) {\n  // Normalize: handle both seed format (theme_seed) and pack format (theme_name)\n  const themeName = themePack.theme_name || themePack.theme_seed;\n  const coreTension = themePack.core_tension || themePack.direction || '';\n  const emoji = themePack.emoji || '';\n  \n  // Check if this is educational template\n  const isEducational = (config.template_id || '').toLowerCase().includes('educational') ||\n                        (config.template_code || '').toLowerCase().includes('educational') ||\n                        (config.template || '').toLowerCase().includes('educational');\n  \n  if (themeName) {\n    if (isEducational) {\n      // Educational: use education_angle and problem scenarios\n      const educationAngle = themePack.education_angle || themePack.direction || '';\n      const problemScenarios = themePack.lifestyle_moments || themePack.problem_scenarios || \n                               ['Dashboard warning lights', 'Weird car noises', 'Unexpected repair bills'];\n      const bannedPhrases = themePack.banned_phrases || \n                            ['guaranteed approval', 'no credit no problem', 'your next chapter', 'fresh start'];\n      \n      themeSection = `THEME PACK:\n- Theme: ${themeName} ${emoji}\n- Core tension: ${coreTension}\n- Education angle: ${educationAngle}\n- Problem scenarios: ${JSON.stringify(problemScenarios)}\n- Banned phrases: ${JSON.stringify(bannedPhrases)}`;\n\n      // Normalize the theme_pack object for downstream use\n      themePack = {\n        ...themePack,\n        theme_name: themeName,\n        core_tension: coreTension,\n        education_angle: educationAngle,\n        problem_scenarios: problemScenarios,\n        banned_phrases: bannedPhrases,\n        emoji: emoji\n      };\n    } else {\n      // Ads: use ad_angle and lifestyle_moments\n      const adAngle = themePack.ad_angle || themePack.direction || '';\n      \n      themeSection = `THEME PACK:\n- Theme: ${themeName} ${emoji}\n- Core tension: ${coreTension}\n- Ad angle: ${adAngle}`;\n\n      // Add optional fields if present (full pack mode)\n      if (themePack.local_micro_moments) {\n        themeSection += `\\n- Local micro-moments: ${JSON.stringify(themePack.local_micro_moments)}`;\n      }\n      if (themePack.lifestyle_moments) {\n        themeSection += `\\n- Lifestyle moments: ${JSON.stringify(themePack.lifestyle_moments)}`;\n      }\n      if (themePack.banned_phrases) {\n        themeSection += `\\n- Banned phrases: ${JSON.stringify(themePack.banned_phrases)}`;\n      }\n\n      // Normalize the theme_pack object for downstream use\n      themePack = {\n        ...themePack,\n        theme_name: themeName,\n        core_tension: coreTension,\n        ad_angle: adAngle,\n        emoji: emoji\n      };\n    }\n  } else {\n    themeSection = 'THEME: None provided';\n    themePack = null;\n  }\n} else if (config.theme) {\n  // Simple theme string (legacy)\n  themeSection = `THEME: ${config.theme}`;\n} else {\n  themeSection = 'THEME: None provided';\n}\n\nconsole.log(`ğŸ“ Timing: ${timing.code} (hook: ${timing.hook_words}, segment: ${timing.segment_words}, cta: ${timing.cta_words})`);\nconsole.log(`ğŸ¨ Theme: ${themePack ? (themePack.theme_name || themePack.theme_seed) : 'none'}`);\n\nreturn [{\n  json: {\n    ...config,\n    timing,\n    theme_section: themeSection,\n    theme_pack: themePack\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1808,
        720
      ],
      "id": "43d9026d-8fad-41ac-a50a-a283cb30f122",
      "name": "Prepare Script Context"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT code, name, hook_words, segment_words, cta_words, style\nFROM timing_defaults\nWHERE code = COALESCE('{{ $('Pass Config').first().json.script_length }}', 'standard')",
        "options": {}
      },
      "id": "fetch-timing-defaults-001",
      "name": "Fetch Timing Defaults",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1136,
        720
      ],
      "credentials": {
        "postgres": {
          "id": "3XsWrPuEddwVYbGS",
          "name": "Railway Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT\n  t.code as template_code,\n  t.name as template_name,\n  t.theme_mode,\n  t.data_requirements,\n  tm.code as theme_mode_code,\n  tm.name as theme_mode_name,\n  tm.rules as theme_mode_rules\nFROM templates t\nLEFT JOIN theme_modes tm ON tm.code = t.theme_mode\nWHERE t.code = UPPER(REPLACE(REPLACE('{{ $('Pass Config').first().json.template_id }}', 'ad-', ''), 'organic-', ''))",
        "options": {}
      },
      "id": "fetch-template-config-001",
      "name": "Fetch Template Config",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1360,
        720
      ],
      "credentials": {
        "postgres": {
          "id": "3XsWrPuEddwVYbGS",
          "name": "Railway Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ENRICH VEHICLE FEATURES\n// Apply industry-specific feature enrichment from DB\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $json;\nlet vehicles = config.vehicles || [];\n\n// Get industry feature enrichment config\nconst industryConfig = config.industry_config || {};\nconst featureEnrichment = industryConfig.feature_enrichment || {};\n\n// Parse if string (JSONB from Postgres)\nconst enrichmentConfig = typeof featureEnrichment === 'string'\n  ? JSON.parse(featureEnrichment)\n  : featureEnrichment;\n\n// Get reliable brands from industry config (or empty array)\nconst reliableBrands = enrichmentConfig.reliable_brands || [];\n\nconsole.log('ğŸ”§ Feature enrichment config:', JSON.stringify(enrichmentConfig));\nconsole.log('ğŸš— Reliable brands:', reliableBrands.join(', ') || 'none configured');\n\n// Enrich each vehicle\nvehicles = vehicles.map(vehicle => {\n  let features = [...(vehicle.features || [])];\n\n  const mileage = parseInt(vehicle.mileage) || 0;\n  const year = parseInt(vehicle.year) || 2020;\n  const currentYear = new Date().getFullYear();\n  const age = currentYear - year;\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // LOW MILEAGE (relative to age)\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const expectedMileage = age * 12000;\n  if (mileage > 0 && mileage < expectedMileage * 0.6) {\n    features.unshift('Low Mileage');\n  }\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // HYBRID/ELECTRIC POWER\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const engine = (vehicle.engine || '').toLowerCase();\n  if (engine.includes('hybrid') || engine.includes('electric')) {\n    features.unshift('Hybrid Power');\n  } else if (engine.includes('4-cyl') || engine.includes('turbo')) {\n    // Only add if not already there\n    if (!features.includes('Great Gas Mileage')) {\n      features.push('Great Gas Mileage');\n    }\n  }\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // AWD/4WD\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const drivetrain = (vehicle.drivetrain || '').toLowerCase();\n  if (drivetrain.includes('awd') || drivetrain.includes('4wd') || drivetrain.includes('4x4')) {\n    if (!features.includes('All-Wheel Drive')) {\n      features.push('All-Wheel Drive');\n    }\n  }\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // RELIABLE BRANDS (from industry.feature_enrichment.reliable_brands)\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const make = (vehicle.make || '').toLowerCase();\n  if (reliableBrands.length > 0 && reliableBrands.includes(make)) {\n    if (!features.includes('Reliable Brand')) {\n      features.push('Reliable Brand');\n    }\n  }\n\n  // Ensure at least one feature\n  if (features.length === 0) {\n    features.push('Great Condition');\n  }\n\n  return {\n    ...vehicle,\n    features: features\n  };\n});\n\nconsole.log('âœ… Enriched features for', vehicles.length, 'vehicles');\nvehicles.forEach((v, i) => {\n  console.log(`  ${i + 1}. ${v.year} ${v.make} ${v.model}: ${v.features.join(', ')}`);\n});\n\nreturn [{\n  json: {\n    ...config,\n    vehicles\n  }\n}];"
      },
      "id": "enrich-vehicle-features-001",
      "name": "Enrich Vehicle Features",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3152,
        384
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "generate-script-from-asset",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "asset-webhook-001",
      "name": "Webhook: Generate from Asset",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        6064,
        1056
      ],
      "webhookId": "generate-from-asset-001"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT\n  a.*,\n  t.code as template_code,\n  t.theme_mode,\n  tm.rules as theme_mode_rules,\n  c.id as client_id,\n  c.name as client_name\nFROM assets a\nJOIN templates t ON a.template_id = t.id\nLEFT JOIN theme_modes tm ON t.theme_mode = tm.code\nJOIN weekly_plans p ON a.plan_id = p.id\nJOIN clients c ON p.client_id = c.id\nWHERE a.id = '{{ $json.body.asset_id }}'",
        "options": {}
      },
      "id": "fetch-processed-asset-001",
      "name": "Fetch Processed Asset",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        6288,
        1056
      ],
      "credentials": {
        "postgres": {
          "id": "3XsWrPuEddwVYbGS",
          "name": "Railway Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM timing_defaults\nWHERE code = '{{ $json.target_length }}'\nUNION ALL\nSELECT * FROM timing_defaults WHERE code = 'standard'\nLIMIT 1",
        "options": {}
      },
      "id": "fetch-timing-asset-001",
      "name": "Fetch Timing for Asset",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        6512,
        1056
      ],
      "credentials": {
        "postgres": {
          "id": "3XsWrPuEddwVYbGS",
          "name": "Railway Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PREPARE SCRIPT CONTEXT (FROM PROCESSED ASSET)\n// Pure data fetcher â€” asset already has processed_items + theme_pack\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst asset = $('Fetch Processed Asset').first().json;\nconst timingRow = $('Fetch Timing for Asset').first().json;\n\n// Parse JSONB fields if needed\nconst processedItems = typeof asset.processed_items === 'string'\n  ? JSON.parse(asset.processed_items)\n  : (asset.processed_items || []);\n\nconst themePack = typeof asset.theme_pack === 'string'\n  ? JSON.parse(asset.theme_pack)\n  : asset.theme_pack;\n\nconst themeModeRules = typeof asset.theme_mode_rules === 'string'\n  ? JSON.parse(asset.theme_mode_rules)\n  : asset.theme_mode_rules;\n\n// Build timing object\nconst timing = {\n  hook_words: timingRow?.hook_words || 12,\n  segment_words: timingRow?.segment_words || 15,\n  cta_words: timingRow?.cta_words || 12,\n  style: timingRow?.style || 'Standard timing',\n  code: timingRow?.code || 'standard'\n};\n\n// Build theme section (pure data, no instructions)\nlet themeSection = '';\nif (themePack) {\n  themeSection = `THEME PACK:\n- Theme: ${themePack.theme_name} ${themePack.emoji || ''}\n- Core tension: ${themePack.core_tension}\n- Ad angle: ${themePack.ad_angle}\n- Local micro-moments: ${JSON.stringify(themePack.local_micro_moments)}\n- Banned phrases: ${JSON.stringify(themePack.banned_phrases)}`;\n} else {\n  themeSection = 'THEME: None provided';\n}\n\n// Map processed_items to vehicles format (for compatibility with TEMP_001)\nconst vehicles = processedItems.map(item => ({\n  vin: item.vin,\n  year: item.year,\n  make: item.make,\n  model: item.model,\n  trim: item.trim,\n  mileage: item.mileage,\n  price: item.price,\n  image_url: item.photo_url,\n  features: item.equipment_highlights || [],\n  // Additional processed data\n  mileage_category: item.mileage_category,\n  equipment_summary: item.equipment_summary,\n  days_on_lot: item.days_on_lot\n}));\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('PREPARE SCRIPT CONTEXT (FROM ASSET)');\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log(`Asset ID: ${asset.id}`);\nconsole.log(`Template: ${asset.template_code}`);\nconsole.log(`Theme Mode: ${asset.theme_mode}`);\nconsole.log(`Items: ${processedItems.length}`);\nconsole.log(`Theme Pack: ${themePack ? themePack.theme_name : 'none'}`);\nconsole.log(`Timing: ${timing.code}`);\nconsole.log(`Client: ${asset.client_name}`);\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\nreturn [{\n  json: {\n    // Asset info\n    asset_id: asset.id,\n    template_id: asset.template_id,\n    template_code: asset.template_code,\n    theme_mode: asset.theme_mode,\n\n    // Timing\n    timing,\n    script_length: asset.target_length || 'standard',\n\n    // Theme\n    theme_pack: themePack,\n    theme_section: themeSection,\n    theme_mode_rules: themeModeRules,\n\n    // Items (processed)\n    vehicles,\n    items: processedItems,\n    item_count: processedItems.length,\n\n    // Client info\n    client_id: asset.client_id,\n    client_name: asset.client_name,\n    client_location: asset.client_location || '',\n\n    // Other asset data\n    avatars: asset.avatars,\n    music_id: asset.music_id,\n    background_id: asset.background_id\n  }\n}];"
      },
      "id": "prepare-asset-context-001",
      "name": "Prepare Script Context (Asset)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6736,
        1056
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "multi-item",
              "leftValue": "={{ $json.template_code }}",
              "rightValue": "MULTI-ITEM",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "spotlight",
              "leftValue": "={{ $json.template_code }}",
              "rightValue": "SPOTLIGHT",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "asset-router-001",
      "name": "Route by Template (Asset)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6960,
        1056
      ]
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "id": "respond-webhook-001",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        8528,
        192
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT prompt_content\nFROM industry_prompts ip\nJOIN industries i ON ip.industry_id = i.id\nJOIN clients c ON c.industry_id = i.id\nWHERE c.id = '{{ $('Pass Config').first().json.client_id }}'\nAND ip.template_code = UPPER(REPLACE(REPLACE('{{ $('Pass Config').first().json.template_id }}', 'ad-', ''), 'organic-', ''))",
        "options": {}
      },
      "id": "fetch-industry-prompts-001",
      "name": "Fetch Industry Prompts",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1584,
        720
      ],
      "credentials": {
        "postgres": {
          "id": "3XsWrPuEddwVYbGS",
          "name": "Railway Postgres"
        }
      }
    }
  ],
  "connections": {
    "Process Hero Photo for Animation": {
      "main": [
        [
          {
            "node": "If: Needs Background Removed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Equipment & Build Categories": {
      "main": [
        [
          {
            "node": "Build Photo Categorizer Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Photo Categorizer Prompt": {
      "main": [
        [
          {
            "node": "If: Test, Skip Categorization",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Feature Identifier Prompts": {
      "main": [
        [
          {
            "node": "If: Test, Skip Feature Identification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Script Prompt TEMP_001": {
      "main": [
        [
          {
            "node": "Aggregate: All Configs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Script Prompt TEMP_002": {
      "main": [
        [
          {
            "node": "Aggregate: All Configs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Script Prompt TEMP_003": {
      "main": [
        [
          {
            "node": "Aggregate: All Configs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge: Config with Inventory": {
      "main": [
        [
          {
            "node": "Fetch Car Info from VINs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Orchestrate Video Creation": {
      "main": [
        [
          {
            "node": "Pass Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Script Creation Errors": {
      "main": [
        [
          {
            "node": "Prep: Error Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: Template ID": {
      "main": [
        [
          {
            "node": "API: Sheets, Fetch Inventory",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge: Config with Inventory",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Build Script Prompt TEMP_003",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: Feature Photos": {
      "main": [
        [
          {
            "node": "Parse Equipment & Build Categories",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Script Prompt TEMP_001",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: Test, Skip Categorization": {
      "main": [
        [
          {
            "node": "Skip Categorization",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API: Claude, Categorize Photos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: Test, Skip Feature Identification": {
      "main": [
        [
          {
            "node": "Skip Feature Identification",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API: Claude, Feature Identification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: Needs Background Removed": {
      "main": [
        [
          {
            "node": "Prep: Remove BG",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Script Prompt TEMP_002",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine Spreadsheet Data": {
      "main": [
        [
          {
            "node": "Merge: Config with Inventory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Car Info from VINs": {
      "main": [
        [
          {
            "node": "Enrich Vehicle Features",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip Categorization": {
      "main": [
        [
          {
            "node": "Parse Catagorization Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Catagorization Response": {
      "main": [
        [
          {
            "node": "Build Feature Identifier Prompts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Claude, Categorize Photos": {
      "main": [
        [
          {
            "node": "Parse Catagorization Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Sheets, Fetch Inventory": {
      "main": [
        [
          {
            "node": "Combine Spreadsheet Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip Feature Identification": {
      "main": [
        [
          {
            "node": "Parse Feature Identification Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Claude, Feature Identification": {
      "main": [
        [
          {
            "node": "Parse Feature Identification Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Script Creation Errors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rename Binary": {
      "main": [
        [
          {
            "node": "API: Coudinary, Upload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Coudinary, Upload": {
      "main": [
        [
          {
            "node": "Update Hero URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Script Creation Errors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Hero URL": {
      "main": [
        [
          {
            "node": "Build Script Prompt TEMP_002",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Claude, Script Generation": {
      "main": [
        [
          {
            "node": "Parse Script Generation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Script Creation Errors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: Test, Skip Script Generation": {
      "main": [
        [
          {
            "node": "Skip Script Generation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API: Claude, Script Generation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip Script Generation": {
      "main": [
        [
          {
            "node": "Parse Script Generation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Script Generation": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate: All Configs": {
      "main": [
        [
          {
            "node": "Post Agg Parse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Feature Identification Response": {
      "main": [
        [
          {
            "node": "Process Hero Photo for Animation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Post Agg Parse": {
      "main": [
        [
          {
            "node": "If: Test, Skip Script Generation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pass Config": {
      "main": [
        [
          {
            "node": "Fetch Client Prompts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep: Error Email": {
      "main": [
        [
          {
            "node": "Call: Email Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call: Email Error": {
      "main": [
        [
          {
            "node": "Stop and Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep: Remove BG": {
      "main": [
        [
          {
            "node": "Call: Remove Background",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call: Remove Background": {
      "main": [
        [
          {
            "node": "Rename Binary",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Script Creation Errors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Client Prompts": {
      "main": [
        [
          {
            "node": "Fetch Industry Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Assemble System Prompt": {
      "main": [
        [
          {
            "node": "Prepare Script Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Script Context": {
      "main": [
        [
          {
            "node": "If: Template ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Industry Config": {
      "main": [
        [
          {
            "node": "Fetch Timing Defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Timing Defaults": {
      "main": [
        [
          {
            "node": "Fetch Template Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Template Config": {
      "main": [
        [
          {
            "node": "Fetch Industry Prompts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enrich Vehicle Features": {
      "main": [
        [
          {
            "node": "If: Feature Photos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook: Generate from Asset": {
      "main": [
        [
          {
            "node": "Fetch Processed Asset",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Processed Asset": {
      "main": [
        [
          {
            "node": "Fetch Timing for Asset",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Timing for Asset": {
      "main": [
        [
          {
            "node": "Prepare Script Context (Asset)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Script Context (Asset)": {
      "main": [
        [
          {
            "node": "Route by Template (Asset)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route by Template (Asset)": {
      "main": [
        [
          {
            "node": "Build Script Prompt TEMP_001",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Script Prompt TEMP_003",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Industry Prompts": {
      "main": [
        [
          {
            "node": "Assemble System Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "7ff2478c-86a7-4384-811a-fa937994529d",
  "activeVersionId": "7ff2478c-86a7-4384-811a-fa937994529d",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-12-13T13:57:36.843Z",
      "createdAt": "2025-12-13T13:57:36.843Z",
      "role": "workflow:owner",
      "workflowId": "gM6DTZfNbcSofqQO",
      "projectId": "VF66NQc9R74tCdyG"
    }
  ],
  "activeVersion": {
    "updatedAt": "2026-01-23T18:48:48.204Z",
    "createdAt": "2026-01-23T18:48:43.987Z",
    "versionId": "7ff2478c-86a7-4384-811a-fa937994529d",
    "workflowId": "gM6DTZfNbcSofqQO",
    "nodes": [
      {
        "parameters": {
          "jsCode": "const config = $json;\n\nconst selectedPhotos = config.selected_photos || {};\n\n// Get VIN from vehicles array\nconst vin = config.vehicles?.[0]?.vin;\n\n// Validate we have required data\nif (!vin) {\n  throw new Error('VIN missing - needed for Cloudinary lookup');\n}\n\nif (!selectedPhotos.hero_exterior) {\n  throw new Error('No hero_exterior photo found in selected_photos!');\n}\n\nconst heroPhoto = selectedPhotos.hero_exterior;\n\n// Check if BG-removed version exists in Cloudinary\nconst bgRemovedUrl = `https://res.cloudinary.com/dtpqxuwby/image/upload/${vin}.png`;\nconsole.log(`ğŸ” Checking Cloudinary: ${bgRemovedUrl}`);\n\nlet heroBackgroundRemoved = null;\nlet needsProcessing = false;\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'HEAD',\n    url: bgRemovedUrl,\n    returnFullResponse: true,\n    ignoreHttpStatusErrors: true,\n    timeout: 5000\n  });\n  \n  if (response.statusCode === 200) {\n    console.log('âœ… BG-removed hero found in Cloudinary!');\n    heroBackgroundRemoved = bgRemovedUrl;\n    needsProcessing = false;\n    \n    selectedPhotos.hero_exterior.photo_url = bgRemovedUrl;\n  } else {\n    console.log(`Status code: ${response.statusCode}`);\n    needsProcessing = true;\n  }\n} catch (error) {\n  needsProcessing = true;\n}\n\nreturn [{\n  json: {\n    ...config,\n    \n    selected_photos: selectedPhotos,\n    hero_photo_url: heroPhoto.photo_url,\n    hero_photo_index: heroPhoto.photo_index,\n    hero_bg_removed_url: heroBackgroundRemoved,\n    needs_bg_removal: needsProcessing,\n    cloudinary_checked: true\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          5616,
          416
        ],
        "id": "d6093e73-d482-410c-8930-d1aa5178d0b1",
        "name": "Process Hero Photo for Animation"
      },
      {
        "parameters": {
          "jsCode": "const config = $json;\nconst vehicle = config.vehicles[0];\nconst equipment = vehicle.equipment;\n\n// Split equipment into individual features\nconst features = equipment.split('|').map(f => f.trim()).filter(f => f);\n\n// Initialize category arrays\nconst categories = {\n  enginePower: [],\n  transmission: [],\n  drivetrain: [],\n  brakingStability: [],\n  safetyAirbags: [],\n  driverAssist: [],\n  exteriorLighting: [],\n  roofsGlass: [],\n  interiorComfort: [],\n  seatingConfig: [],\n  infotainmentAudio: [],\n  navigationDisplay: [],\n  securityAntiTheft: [],\n  towingOffRoad: [],\n  packages: [],\n  wheelsTires: []\n};\n\n// Helper function to categorize features\nconst categorizeFeature = (feature) => {\n  const f = feature.toLowerCase();\n  \n  // 1. Engine & Power\n  if (/^(v6|v8|4-cyl|3-cyl|i4|i6)/.test(f) || \n      /(ecoboost|ecotec|hybrid|turbo|hemi|gdi|vtec|multiair|liter|electric)/i.test(f)) {\n    categories.enginePower.push(feature);\n  }\n  \n  // 2. Transmission\n  if (/(automatic|auto|manual|cvt|spd|drive unit|shiftronic|selshft|xtronic|overdrive)/i.test(f)) {\n    categories.transmission.push(feature);\n  }\n  \n  // 3. Drivetrain\n  if (/^(fwd|rwd|awd|4wd|2wd)$/i.test(f) || /wheel drive/i.test(f)) {\n    categories.drivetrain.push(feature);\n  }\n  \n  // 4. Braking & Stability\n  if (/(abs|stability|stabilitrak|advancetrac|rollover|hill start|hill descent|traction|vehicle dynamic)/i.test(f)) {\n    categories.brakingStability.push(feature);\n  }\n  \n  // 5. Safety - Airbags\n  if (/air bags|airbag|tire pressure monitoring/i.test(f)) {\n    categories.safetyAirbags.push(feature);\n  }\n  \n  // 6. Driver Assist / ADAS\n  if (/(camera|park assist|parksense|parking sensor|distance warning|sonar|blind|lane|collision|propilot|safety shield|adaptive cruise|intelligent cruise)/i.test(f)) {\n    categories.driverAssist.push(feature);\n  }\n  \n  // 7. Exterior & Lighting\n  if (/(headlamp|headlight|xenon|hid|led|fog lamp|daytime running|bed liner|tailgate|spoiler|roof rack|running board|tonneau|shell|cap|sliding rear window)/i.test(f)) {\n    categories.exteriorLighting.push(feature);\n  }\n  \n  // 8. Roofs & Glass\n  if (/(roof:|moonroof|sunroof|panoramic|skylight|privacy glass)/i.test(f)) {\n    categories.roofsGlass.push(feature);\n  }\n  \n  // 9. Interior Comfort\n  if (/(air conditioning|climate|keyless|remote start|power door|power window|power liftgate|power tailgate|power trunk|tilt|telescoping|steering wheel: heated|garage door)/i.test(f)) {\n    categories.interiorComfort.push(feature);\n  }\n  \n  // 10. Seating & Configuration\n  if (/(seat|passenger seating|leather)/i.test(f) && !/steering/i.test(f)) {\n    categories.seatingConfig.push(feature);\n  }\n  \n  // 11. Infotainment & Audio\n  if (/(am\\/fm|radio|stereo|sound|bose|harman|revel|premium sound|infotainment|onstar|sync|uconnect|connect|link|bluetooth|usb|auxiliary|siriusxm|cd|mp3)/i.test(f)) {\n    categories.infotainmentAudio.push(feature);\n  }\n  \n  // 12. Navigation & Display\n  if (/(navigation|head-up display)/i.test(f)) {\n    categories.navigationDisplay.push(feature);\n  }\n  \n  // 13. Security & Anti-Theft\n  if (/(alarm|anti-theft|theft|security system)/i.test(f)) {\n    categories.securityAntiTheft.push(feature);\n  }\n  \n  // 14. Towing & Off-Road\n  if (/(towing|tow|off-road|z71)/i.test(f)) {\n    categories.towingOffRoad.push(feature);\n  }\n  \n  // 15. Packages & Trims\n  if (/(pkg|package|big horn|technology|premium)/i.test(f) && !/sound|audio/i.test(f)) {\n    categories.packages.push(feature);\n  }\n  \n  // 16. Wheels & Tires\n  if (/wheels:|alloy|steel/i.test(f)) {\n    categories.wheelsTires.push(feature);\n  }\n};\n\n// Categorize all features\nfeatures.forEach(feature => {\n  if (feature) categorizeFeature(feature);\n});\n\n// Build allowed photo categories based on equipment\nconst allowedPhotoCategories = [\n  'hero_exterior',\n  'engine_bay',\n  'infotainment_other',\n  'instrument_cluster',\n  'steering_wheel',\n  'front_seats',\n  'second_row_seats',\n  'cargo_area'\n];\n\n// Add conditional categories based on equipment\nif (categories.infotainmentAudio.some(f => /carplay|android auto/i.test(f))) {\n  allowedPhotoCategories.push('infotainment_carplay');\n}\n\nif (categories.driverAssist.some(f => /360|multi-view|surround view|around view/i.test(f))) {\n  allowedPhotoCategories.push('infotainment_360_camera');\n}\n\nif (categories.roofsGlass.some(f => /moonroof|sunroof|panoramic/i.test(f))) {\n  allowedPhotoCategories.push('moonroof');\n}\n\nif (categories.seatingConfig.some(f => /third row|3rd row|7 passenger|8 passenger/i.test(f))) {\n  allowedPhotoCategories.push('third_row_seats');\n}\n\n// Always add special_feature category for unexpected finds\nallowedPhotoCategories.push('special_feature');\n\n// Build equipment context for each photo category\nconst equipmentContextByCategory = {\n  hero_exterior: {},\n  \n  engine_bay: {\n    engine_features: categories.enginePower,\n    transmission: categories.transmission[0] || null,\n    drivetrain: categories.drivetrain[0] || null\n  },\n  \n  front_seats: {\n    has_leather: categories.seatingConfig.some(f => /^leather$/i.test(f)),\n    has_heated: categories.seatingConfig.some(f => /heated/i.test(f) && /seat/i.test(f)),\n    has_cooled: categories.seatingConfig.some(f => /(cooled|ventilated)/i.test(f)),\n    has_power: categories.seatingConfig.some(f => /(power|dual power)/i.test(f) && /seat/i.test(f)),\n    has_memory: categories.seatingConfig.some(f => /memory/i.test(f)),\n    material_claim: categories.seatingConfig.some(f => /^leather$/i.test(f)) ? 'leather' : 'premium upholstery',\n    all_seat_features: categories.seatingConfig\n  },\n  \n  second_row_seats: {\n    seating_features: categories.seatingConfig.filter(f => /rear|second|passenger/i.test(f))\n  },\n  \n  third_row_seats: {\n    has_third_row: categories.seatingConfig.some(f => /third row|3rd row/i.test(f))\n  },\n  \n  steering_wheel: {\n    has_heated_wheel: categories.interiorComfort.some(f => /steering wheel.*heated/i.test(f)),\n    has_controls: categories.interiorComfort.some(f => /steering wheel control/i.test(f)),\n    tilt_telescoping: categories.interiorComfort.some(f => /tilt.*telescoping/i.test(f))\n  },\n  \n  infotainment_carplay: {\n    has_navigation: categories.navigationDisplay.length > 0,\n    audio_system: categories.infotainmentAudio.find(f => /sound|audio|bose|harman|revel/i.test(f)),\n    connectivity: categories.infotainmentAudio.filter(f => /bluetooth|usb|siriusxm/i.test(f))\n  },\n  \n  infotainment_360_camera: {\n    has_360: true,\n    parking_features: categories.driverAssist.filter(f => /parking|park assist/i.test(f))\n  },\n  \n  moonroof: {\n    moonroof_type: categories.roofsGlass.find(f => /panoramic/i.test(f)) ? 'Panoramic' : 'Moonroof',\n    all_roof_features: categories.roofsGlass\n  },\n  \n  cargo_area: {\n    power_liftgate: categories.interiorComfort.some(f => /power liftgate/i.test(f)),\n    truck_bed_features: categories.exteriorLighting.filter(f => /bed liner|tailgate|tonneau/i.test(f))\n  }\n};\n\n// Clean up baseConfig - remove equipment\nconst cleanBaseConfig = {\n  ...config,\n  equipment: undefined,  // Remove equipment string\n  vehicles: config.vehicles?.map(vehicle => {\n    const {equipment, ...cleanVehicle } = vehicle;\n    return cleanVehicle;\n  })\n};\n\nreturn [{\n  json: {\n    ...cleanBaseConfig,\n    equipment_categories: categories,\n    allowed_photo_categories: allowedPhotoCategories,\n    equipment_context_by_category: equipmentContextByCategory,\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3600,
          480
        ],
        "id": "c8ded42c-3c2d-44b2-9bed-e66dd3c6f0f3",
        "name": "Parse Equipment & Build Categories"
      },
      {
        "parameters": {
          "jsCode": "const config = $json;\nconst vehicle = config.vehicles[0];\n// Use thumbnails for faster processing\nconst allImageUrls = vehicle.all_images\n  .filter(url => url && url.trim())\n  .map(url => url + '/thumb/');\n\nconst allowedCategories = config.allowed_photo_categories;\nconst totalPhotos = allImageUrls.length;\nconst maxIndex = totalPhotos - 1;\n\nconst systemPrompt = `You are categorizing ${totalPhotos} photos of a ${vehicle.year} ${vehicle.make} ${vehicle.model}.\n\nEQUIPMENT config CONFIRMS THIS VEHICLE HAS:\n${config.equipment_categories.seatingConfig.some(f => /third row|3rd row/i.test(f)) ? 'âœ“ Third row seating\\n' : ''}\n${config.equipment_categories.roofsGlass.some(f => /moonroof|sunroof|panoramic/i.test(f)) ? 'âœ“ ' + config.equipment_context_by_category.moonroof.moonroof_type + '\\n' : ''}\n${config.equipment_categories.driverAssist.some(f => /360|multi-view|surround/i.test(f)) ? 'âœ“ 360-degree camera\\n' : ''}\n${config.equipment_categories.seatingConfig.some(f => /heated/i.test(f) && /seat/i.test(f)) ? 'âœ“ Heated seats\\n' : ''}\n${config.equipment_categories.seatingConfig.some(f => /cooled|ventilated/i.test(f)) ? 'âœ“ Cooled/ventilated seats\\n' : ''}\n${config.equipment_categories.seatingConfig.some(f => /^leather$/i.test(f)) ? 'âœ“ Leather seats\\n' : ''}\n\nPhoto[0] is designated as hero_exterior (already selected).\n\nCATEGORIES TO LOOK FOR:\n${allowedCategories.filter(c => c !== 'hero_exterior').map(cat => `- ${cat}`).join('\\n')}\n\nDO NOT look for categories not listed above - they don't exist on this vehicle.\n\nRULES:\n1. Multiple photos CAN have the same category if showing DIFFERENT subcategories\n   Example: One photo shows CarPlay, another shows 360 camera â†’ both are infotainment\n2. If multiple photos show THE SAME THING, pick ONLY THE BEST (clearest, best lighting)\n3. Only assign categories from the list above\n4. Mark irrelevant photos as \"exclude\"\n\nEXCLUDE these categories entirely (never ad-worthy):\n- Center console storage compartments (close-ups)\n- Control button close-ups (seat controls, climate buttons)\n- Cup holder close-ups (showing just cupholders)\n- Key fobs\n- Window stickers / price labels\n- Door panels (unless showing special feature)\n- Random detail shots with no clear feature\n- Photos that are blurry or too dark to use\n\nQUALITY REQUIREMENTS:\n- Well-lit photos only (skip dark or blurry)\n- Clear view of features being highlighted\n- Professional appearance (avoid awkward angles)\n- Shows vehicle in good condition\n\nCATEGORY DEFINITIONS:\n\nENGINE BAY:\n- Clear shot of engine compartment\n- Well-lit, shows engine condition\n\nINFOTAINMENT (can have multiple):\n- infotainment_carplay: Screen showing Apple CarPlay OR Android Auto interface clearly\n- infotainment_360_camera: Screen showing 360-degree/bird's eye parking camera view\n- infotainment_other: Touchscreen showing other features (navigation, audio, settings)\n\nDASHBOARD:\n- instrument_cluster: Gauge cluster or digital instrument display\n- steering_wheel: Steering wheel (with or without controls visible)\n\nSEATING:\n- front_seats: Front seat view showing material, condition, and controls\n- second_row_seats: Back seat view\n- third_row_seats: Third row seating (only if equipment confirms it exists)\n\nCARGO:\n- cargo_area: Trunk or cargo space (or truck bed for pickups)\n\nSPECIAL:\n- moonroof: Moonroof open OR moonroof controls visible (only if equipment confirms)\n- special_feature: Anything else impressive (heads-up display, wireless charging, etc.)\n\nOUTPUT FORMAT (JSON only, no markdown):\n{\n  \"categorized_photos\": [\n    {\n      \"photo_index\": 1,\n      \"category\": \"engine_bay\",\n      \"reasoning\": \"Clear engine shot, well-lit\"\n    },\n    {\n      \"photo_index\": 12,\n      \"category\": \"infotainment_carplay\",\n      \"reasoning\": \"Shows Apple CarPlay interface clearly\"\n    },\n    {\n      \"photo_index\": 8,\n      \"category\": \"exclude\",\n      \"reasoning\": \"Center console storage - not ad-worthy\"\n    }\n  ],\n  \"summary\": {\n    \"engine_bay\": [1],\n    \"infotainment_carplay\": [12],\n    \"front_seats\": [20],\n    \"excluded\": [8, 9, 22]\n  }\n}`;\n\nconst userPrompt = `Categorize all ${totalPhotos} photos of this ${vehicle.year} ${vehicle.make} ${vehicle.model}.\n\nğŸš¨ CRITICAL - PHOTO INDICES ğŸš¨\nVALID INDICES: 0 through ${maxIndex}\nTOTAL PHOTOS: ${totalPhotos}\nDO NOT USE indices ${maxIndex + 1} or higher (they don't exist!)\n\nPhoto[0] is hero_exterior (skip this one).\nAnalyze photos 1 through ${maxIndex} and assign categories or mark as exclude.\n\nSelect the BEST photo for each category (quality over quantity).\nIf multiple photos show different features, keep both.\nIf multiple photos show the same feature, pick only the best one.`;\n\n// Build vision_content array for Claude API\nconst visionContent = [\n  {\n    type: \"text\",\n    text: `${systemPrompt}\\n\\n${userPrompt}\\n\\nPHOTOS (each labeled with its index):`\n  }\n];\n\n// Add all images with explicit index labels\nallImageUrls.forEach((url, index) => {\n  visionContent.push({\n    type: \"text\",\n    text: `[PHOTO INDEX ${index}]`\n  });\n  visionContent.push({\n    type: \"image\",\n    source: {\n      type: \"url\",\n      url: url\n    }\n  });\n});\n\nconsole.log(`âœ… Built vision content with ${allImageUrls.length} photos`);\n\nreturn [{\n  json: {\n    ...config,\n    \n    categorizer_vision_content: visionContent,\n    categorizer_system_prompt: systemPrompt,\n    categorizer_user_prompt: userPrompt,\n    all_image_urls: allImageUrls,\n    max_photo_index: maxIndex,\n    total_photos: totalPhotos,\n    \n    // Remove used data\n    equipment_categories: undefined,\n    allowed_photo_categories: undefined\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3824,
          480
        ],
        "id": "932c81fd-a4cf-4f85-b15e-7fe833c9ee7b",
        "name": "Build Photo Categorizer Prompt"
      },
      {
        "parameters": {
          "jsCode": "const config = $json;\nconst selectedPhotos = config.selected_photos;\nconst vehicle = config.vehicles[0];\n\n// Category-specific prompt templates\nconst categoryPrompts = {\n  front_seats: (equipCtx) => `\nAnalyze this front seat photo.\n\nEQUIPMENT DATA:\n${equipCtx.has_leather ? 'âœ“ Leather seats confirmed in equipment' : 'âœ— Leather NOT listed in equipment'}\n${equipCtx.has_heated ? 'âœ“ Heated seats' : ''}\n${equipCtx.has_cooled ? 'âœ“ Cooled/ventilated seats' : ''}\n${equipCtx.has_power ? 'âœ“ Power-adjustable seats' : ''}\n${equipCtx.has_memory ? 'âœ“ Memory seats' : ''}\n\nğŸš« CRITICAL RULE: DO NOT analyze or comment on seat material\nWe use equipment data ONLY for material claims (${equipCtx.material_claim}).\n\nYOUR TASK - Focus on what you CAN reliably identify:\n\n1. SEAT CONDITION (visual assessment):\n   - excellent (pristine, no wear)\n   - good (normal use, clean)\n   - fair (some wear visible)\n   - poor (stains, tears, heavy wear)\n\n2. CONTROLS VISIBLE (Yes/No for each):\n   - Heated seat buttons?\n   - Cooled/ventilated buttons?\n   - Power adjustment controls?\n   - Memory seat buttons?\n\n3. GENERAL FEATURES:\n   - Spacious/comfortable appearance?\n   - Center armrest present?\n\nOUTPUT JSON:\n{\n  \"condition\": \"excellent|good|fair|poor\",\n  \"controls_visible\": {\n    \"heated\": true/false,\n    \"cooled\": true/false,\n    \"power\": true/false,\n    \"memory\": true/false\n  },\n  \"spacious\": true/false,\n  \"additional_notes\": \"Brief notes on comfort features\"\n}`,\n\n  engine_bay: (equipCtx) => `\nAnalyze this engine bay photo.\n\nEQUIPMENT DATA:\n${equipCtx.engine_features && equipCtx.engine_features.length > 0 ? '- Engine: ' + equipCtx.engine_features.join(', ') : ''}\n${equipCtx.transmission ? '- Transmission: ' + equipCtx.transmission : ''}\n${equipCtx.drivetrain ? '- Drivetrain: ' + equipCtx.drivetrain : ''}\n\nYOUR TASK:\n\n1. ENGINE CONDITION:\n   - clean (well-maintained, no visible dirt/oil)\n   - average (normal condition)\n   - dirty (visible grime, neglect)\n\n2. VISIBLE BADGING/LABELS:\n   - Any engine badges or labels visible on engine cover?\n   - Specific text you can read?\n\n3. MAINTENANCE APPEARANCE:\n   - Does it appear well-maintained? (Yes/No)\n   - Any obvious issues visible? (leaks, damaged parts)\n\nOUTPUT JSON:\n{\n  \"condition\": \"clean|average|dirty\",\n  \"visible_badging\": \"Description of any badges/labels or null\",\n  \"appears_maintained\": true/false,\n  \"issues_visible\": \"Description or null\"\n}`,\n\n  infotainment_carplay: (equipCtx) => `\nAnalyze this infotainment screen photo.\n\nEQUIPMENT DATA:\n${equipCtx.has_navigation ? 'âœ“ Navigation system' : ''}\n${equipCtx.audio_system ? 'âœ“ Audio: ' + equipCtx.audio_system : ''}\n\nYOUR TASK - Be SPECIFIC about what you see:\n\nâš ï¸ CRITICAL: DO NOT assume both CarPlay and Android Auto unless you see BOTH logos clearly!\n\n1. SMARTPHONE INTEGRATION (look carefully):\n   - Apple CarPlay logo visible? (Yes/No)\n   - Android Auto logo visible? (Yes/No)\n   - If neither logo visible: Generic smartphone connectivity only\n\n2. SCREEN SIZE:\n   - small (less than 7 inches)\n   - medium (7-9 inches)\n   - large (10+ inches)\n\n3. SCREEN CONDITION:\n   - excellent (no scratches, clear)\n   - good (minor wear)\n   - scratched (visible damage)\n\n4. OTHER VISIBLE FEATURES:\n   - Navigation map visible?\n   - Premium brand logos (Bose, Harman Kardon)?\n   - Any other notable features?\n\nOUTPUT JSON:\n{\n  \"has_apple_carplay\": true/false/unclear,\n  \"has_android_auto\": true/false/unclear,\n  \"screen_size\": \"small|medium|large\",\n  \"screen_condition\": \"excellent|good|scratched\",\n  \"navigation_visible\": true/false,\n  \"other_features\": \"Description or null\"\n}`,\n\n  infotainment_360_camera: (equipCtx) => `\nAnalyze this 360 camera display photo.\n\nYOUR TASK:\n\n1. CONFIRM 360 CAMERA:\n   - Does this show multi-view/bird's eye parking camera? (Yes/No)\n   - How many camera angles visible? (top view, front, rear, sides?)\n\n2. DISPLAY QUALITY:\n   - clear (high resolution, easy to see)\n   - average (acceptable quality)\n   - poor (grainy, hard to see)\n\n3. ADDITIONAL FEATURES VISIBLE:\n   - Parking sensor indicators?\n   - Trajectory lines?\n   - Distance markers?\n\nOUTPUT JSON:\n{\n  \"is_360_camera\": true/false,\n  \"camera_angles_visible\": [\"top\", \"front\", \"rear\", \"left\", \"right\"],\n  \"display_quality\": \"clear|average|poor\",\n  \"parking_sensors_visible\": true/false,\n  \"additional_features\": \"Description or null\"\n}`,\n\n  moonroof: (equipCtx) => `\nAnalyze this moonroof photo.\n\nEQUIPMENT DATA: ${equipCtx.moonroof_type || 'Moonroof'}\n\nYOUR TASK:\n\n1. WHAT'S SHOWN:\n   - moonroof_open (showing open roof with sky visible)\n   - controls_visible (showing buttons/switches for moonroof)\n   - both (both open roof and controls visible)\n\n2. SIZE ASSESSMENT:\n   - small (compact opening)\n   - medium (standard size)\n   - large (extended opening)\n   - panoramic (very large, extends over passengers)\n\n3. CONDITION:\n   - Glass clean and clear? (Yes/No)\n   - Controls in good condition? (Yes/No)\n\nOUTPUT JSON:\n{\n  \"moonroof_shown\": \"moonroof_open|controls_visible|both\",\n  \"appears_panoramic\": true/false,\n  \"size_rating\": \"small|medium|large|panoramic\",\n  \"condition_notes\": \"Brief assessment\"\n}`,\n\n  cargo_area: (equipCtx) => `\nAnalyze this cargo/trunk space photo.\n\nEQUIPMENT DATA:\n${equipCtx.power_liftgate ? 'âœ“ Power liftgate' : ''}\n${equipCtx.truck_bed_features && equipCtx.truck_bed_features.length > 0 ? 'âœ“ Truck bed features: ' + equipCtx.truck_bed_features.join(', ') : ''}\n\nYOUR TASK:\n\n1. SPACE ASSESSMENT:\n   - compact (small trunk/bed)\n   - average (typical for vehicle class)\n   - spacious (above average)\n   - huge (exceptional cargo capacity)\n\n2. CONDITION:\n   - clean (well-maintained, no debris)\n   - average (normal use)\n   - cluttered (items present)\n\n3. NOTABLE FEATURES:\n   - Power liftgate button visible?\n   - Cargo cover present?\n   - Tie-down hooks/anchors?\n   - Bed liner visible (trucks)?\n   - Tonneau cover?\n\nOUTPUT JSON:\n{\n  \"space_rating\": \"compact|average|spacious|huge\",\n  \"condition\": \"clean|average|cluttered\",\n  \"notable_features\": [\"list\", \"of\", \"features\"],\n  \"additional_notes\": \"Brief notes\"\n}`,\n\n  steering_wheel: (equipCtx) => `\nAnalyze this steering wheel photo.\n\nEQUIPMENT DATA:\n${equipCtx.has_heated_wheel ? 'âœ“ Heated steering wheel' : ''}\n${equipCtx.has_controls ? 'âœ“ Steering wheel controls' : ''}\n${equipCtx.tilt_telescoping ? 'âœ“ Tilt & telescoping wheel' : ''}\n\nYOUR TASK:\n\n1. CONTROLS VISIBLE:\n   - Audio controls? (Yes/No)\n   - Cruise control buttons? (Yes/No)\n   - Phone/voice controls? (Yes/No)\n   - Heated wheel button/indicator? (Yes/No)\n\n2. MATERIAL/CONDITION:\n   - Leather/wrapped? (Yes/No/Unclear)\n   - Condition: excellent/good/worn\n\n3. OTHER FEATURES:\n   - Paddle shifters visible?\n   - Multifunction display visible behind wheel?\n\nOUTPUT JSON:\n{\n  \"controls_visible\": {\n    \"audio\": true/false,\n    \"cruise\": true/false,\n    \"phone_voice\": true/false,\n    \"heated\": true/false\n  },\n  \"appears_leather_wrapped\": true/false/unclear,\n  \"condition\": \"excellent|good|worn\",\n  \"paddle_shifters\": true/false,\n  \"other_notes\": \"Brief notes\"\n}`,\n\n  instrument_cluster: (equipCtx) => `\nAnalyze this instrument cluster / gauge display photo.\n\nYOUR TASK:\n\n1. CLUSTER TYPE:\n   - traditional_analog (physical gauges with needles)\n   - digital (full digital/LCD display)\n   - hybrid (mix of analog and digital)\n\n2. FEATURES VISIBLE:\n   - Speedometer clearly visible?\n   - Tachometer (RPM gauge) visible?\n   - Fuel gauge visible?\n   - Trip computer/info display?\n   - Navigation display in cluster?\n\n3. CONDITION & QUALITY:\n   - Display condition: excellent/good/worn\n   - Easy to read? (Yes/No)\n\nOUTPUT JSON:\n{\n  \"cluster_type\": \"traditional_analog|digital|hybrid\",\n  \"features_visible\": [\"speedometer\", \"tachometer\", \"fuel\", \"trip_computer\"],\n  \"display_condition\": \"excellent|good|worn\",\n  \"easy_to_read\": true/false,\n  \"notes\": \"Brief assessment\"\n}`,\n\n  second_row_seats: (equipCtx) => `\nAnalyze this second row / back seat photo.\n\nYOUR TASK:\n\n1. SPACE ASSESSMENT:\n   - cramped (limited legroom)\n   - adequate (acceptable for adults)\n   - spacious (comfortable for adults)\n   - generous (exceptional rear space)\n\n2. SEATING CONFIGURATION:\n   - bench (traditional bench seat)\n   - captain_chairs (individual bucket seats)\n   - split_bench (can fold separately)\n\n3. CONDITION:\n   - excellent (pristine, no wear)\n   - good (clean, normal use)\n   - fair (some wear visible)\n\n4. FEATURES VISIBLE:\n   - Rear climate vents?\n   - Cup holders?\n   - USB ports/charging?\n   - Armrest?\n\nOUTPUT JSON:\n{\n  \"space_rating\": \"cramped|adequate|spacious|generous\",\n  \"seating_config\": \"bench|captain_chairs|split_bench\",\n  \"condition\": \"excellent|good|fair\",\n  \"features_visible\": [\"list\", \"of\", \"features\"],\n  \"notes\": \"Brief assessment\"\n}`,\n\n  third_row_seats: (equipCtx) => `\nAnalyze this third row seating photo.\n\nYOUR TASK:\n\n1. SPACE ASSESSMENT:\n   - tight (kids only)\n   - adequate (short adults okay)\n   - comfortable (adults can fit)\n\n2. ACCESS:\n   - How do passengers access third row?\n   - Easy entry visible? (fold-flat second row, etc.)\n\n3. CONDITION:\n   - excellent/good/fair\n\n4. FEATURES:\n   - Cup holders?\n   - Climate vents?\n   - Storage compartments?\n\nOUTPUT JSON:\n{\n  \"space_rating\": \"tight|adequate|comfortable\",\n  \"condition\": \"excellent|good|fair\",\n  \"easy_access\": true/false,\n  \"features_visible\": [\"list\"],\n  \"notes\": \"Brief assessment\"\n}`,\n\n  special_feature: (equipCtx) => `\nAnalyze this special feature photo.\n\nYOUR TASK:\n\nIdentify what special feature is being shown. This could be:\n- Heads-up display\n- Wireless charging pad\n- Advanced climate controls\n- Unique storage solutions\n- Premium materials/trim\n- Technology features\n- Or anything else noteworthy\n\nDescribe what you see and assess its condition/functionality.\n\nOUTPUT JSON:\n{\n  \"feature_identified\": \"Name/description of feature\",\n  \"condition\": \"excellent|good|fair\",\n  \"notable_aspects\": \"What makes this feature special\",\n  \"likely_appeal\": \"Why customers would value this\"\n}`,\n\n  infotainment_other: (equipCtx) => `\nAnalyze this infotainment screen photo.\n\nYOUR TASK:\n\nThis screen is NOT showing CarPlay/Android Auto or 360 camera.\nWhat IS it showing?\n\n1. SCREEN CONTENT:\n   - Navigation system?\n   - Audio/radio interface?\n   - Vehicle settings?\n   - Other?\n\n2. SCREEN QUALITY:\n   - Size: small/medium/large\n   - Condition: excellent/good/scratched\n   - Touchscreen? (Yes/No/Unclear)\n\n3. FEATURES VISIBLE:\n   - Premium audio branding?\n   - Climate controls integrated?\n   - Other notable features?\n\nOUTPUT JSON:\n{\n  \"showing\": \"navigation|audio|settings|other\",\n  \"screen_size\": \"small|medium|large\",\n  \"condition\": \"excellent|good|scratched\",\n  \"appears_touchscreen\": true/false/unclear,\n  \"features_visible\": [\"list\"],\n  \"notes\": \"Brief description\"\n}`\n};\n\n// Build feature identifier vision content\nconst featureIdentifierContent = [\n  {\n    type: \"text\",\n    text: `Analyze these vehicle feature photos from a ${vehicle.year} ${vehicle.make} ${vehicle.model}.\n\nFor each photo, identify visible features based on the category-specific instructions.\n\nIMPORTANT: Output ONLY valid JSON with no markdown formatting.\n\n`\n  }\n];\n\nlet categoriesProcessed = 0;\n\nObject.entries(selectedPhotos).forEach(([category, photoData]) => {\n  if (category === 'hero_exterior') return; // Skip hero\n\n  const promptGenerator = categoryPrompts[category];\n  if (!promptGenerator) {\n    console.log(`âš ï¸ No prompt template for category: ${category}`);\n    return;\n  }\n\n  const categoryPrompt = promptGenerator(photoData.equipment_context);\n  \n  featureIdentifierContent.push({\n    type: \"text\",\n    text: `\\nâ•â•â• CATEGORY: ${category.toUpperCase()} â•â•â•\\n${categoryPrompt}\\n`\n  });\n  \n  featureIdentifierContent.push({\n    type: \"image\",\n    source: {\n      type: \"url\",\n      url: photoData.photo_url\n    }\n  });\n\n  categoriesProcessed++;\n});\n\n// Add final instruction\nconst categoryKeys = Object.keys(selectedPhotos).filter(k => k !== 'hero_exterior');\nfeatureIdentifierContent.push({\n  type: \"text\",\n  text: `\\n\\nProvide analysis for each category in this JSON format (no markdown, no backticks):\n{\n  \"${categoryKeys[0] || 'category_name'}\": { ... your analysis ... },\n  \"${categoryKeys[1] || 'category_name'}\": { ... your analysis ... }\n}\n\nOutput ONLY the JSON object, nothing else.`\n});\n\nconsole.log(`âœ… Built feature identifier prompts for ${categoriesProcessed} categories`);\n\nreturn [{\n  json: {\n    ...config,\n    \n    feature_identifier_content: featureIdentifierContent,\n    categories_to_identify: categoriesProcessed\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          4720,
          480
        ],
        "id": "f156f084-80ef-48c5-a7cd-53f8544ecab1",
        "name": "Build Feature Identifier Prompts"
      },
      {
        "parameters": {
          "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUILD SCRIPT PROMPT â€” TEMP_001 (multi-item)\n// Pure formatting â€” features already enriched, timing from DB\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $json;\nconst vehicles = config.vehicles || config.items;\nconst timing = config.timing;\nconst themeSection = config.theme_section;\nconst themePack = config.theme_pack;\nconst themeModeRules = config.theme_mode_rules;\n\n// Client info (from asset path)\nconst clientName = config.client_name || 'the dealership';\nconst clientLocation = config.client_location || '';\n\n// Check if we have system prompt from main path, otherwise build minimal one\nlet systemPrompt = '';\ntry {\n  systemPrompt = $('Assemble System Prompt').first()?.json?.system_prompt || '';\n} catch (e) {\n  // Coming from asset path - no Assemble System Prompt node\n  systemPrompt = '';\n}\n\nif (!vehicles || vehicles.length === 0) {\n  throw new Error('Missing vehicle data');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUILD SYSTEM PROMPT FOR ASSET PATH (if not from main path)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nif (!systemPrompt) {\n  const sections = [];\n\n  // Identity section with client info\n  sections.push(`You are a professional automotive video ad copywriter for ${clientName}${clientLocation ? ' in ' + clientLocation : ''}.`);\n\n  // Template description\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“‹ TEMPLATE: MULTI-ITEM (Multi-Car Showcase)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCreate a fast-paced, punchy multi-vehicle showcase ad. Each vehicle gets a quick highlight before moving to the next.`);\n\n  // Word limits\n  if (timing) {\n    sections.push(`\nâš ï¸ WORD LIMITS:\n- Hook: ${timing.hook_words} words max\n- Segment: ${timing.segment_words} words max\n- CTA: ${timing.cta_words} words max`);\n  }\n\n  // Theme rules from theme_modes\n  if (themeModeRules && themeModeRules.length > 0) {\n    const rules = Array.isArray(themeModeRules) ? themeModeRules : [];\n    if (rules.length > 0) {\n      sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¨ THEME PACK USAGE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${rules.map((r, i) => `${i + 1}) ${r}`).join('\\n')}\n\nIf theme_pack missing: Use generic value/deals hook`);\n    }\n  }\n\n  // Hook rules\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸª HOOK RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nLead with intrigue, NOT inventory-speak.\n\nGOOD EXAMPLES:\nâœ… \"Tax season just hit different this year\"\nâœ… \"When gas prices make you rethink everything\"\n\nBAD EXAMPLES:\nâŒ \"Check out these three vehicles\"\nâŒ \"We have cars for sale\"`);\n\n  // Segment rules\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“ SEGMENT RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nEach vehicle gets ONE standout feature. Be specific, not generic.\n\nGOOD: \"heated seats for those 5am commutes\"\nBAD: \"great features\"`);\n\n  // CTA with client info\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“¢ CTA REQUIREMENTS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n- MUST mention: ${clientName}\n- Location context: ${clientLocation || 'local area'}\n- Keep it punchy and actionable`);\n\n  // Legal\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâš–ï¸ LEGAL (CRITICAL)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâŒ NEVER promise specific financing terms\nâŒ NEVER guarantee approval\nâŒ NEVER use \"best\" or \"lowest\" without qualification`);\n\n  systemPrompt = sections.join('\\n');\n  console.log(`Built system prompt for asset path (client: ${clientName})`);\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// CALCULATE WORD LIMITS (from DB timing)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst hookWords = timing?.hook_words || 12;\nconst segmentWords = timing?.segment_words || 15;\nconst ctaWords = timing?.cta_words || 12;\nconst totalWords = hookWords + (segmentWords * vehicles.length) + ctaWords;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// FORMAT VEHICLES SECTION\n// Features come pre-enriched from processing phase\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst vehiclesSection = vehicles.map((v, i) => {\n  const features = v.features?.slice(0, 5).join(', ') || v.equipment_summary || 'Great Condition';\n  return `${i + 1}. ${v.year} ${v.make} ${v.model}\n   Features: ${features}`;\n}).join('\\n');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUILD USER PROMPT\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst scriptLength = config.script_length || 'standard';\n\nlet userPrompt = `Generate a ${scriptLength.toUpperCase()} multi-car ad script for ${clientName}.\n\n${themeSection || ''}\n\nVEHICLES (${vehicles.length}):\n${vehiclesSection}\n\nWORD LIMITS:\n- Hook: ${hookWords} words max\n- Each segment: ${segmentWords} words max\n- CTA: ${ctaWords} words max (MUST mention ${clientName})\n- TOTAL: ${totalWords} words max\n\nOUTPUT JSON:\n{\n  \"hook\": \"Punchy opener (${hookWords} words max)\",\n  \"segments\": [${vehicles.map(v => `\"${v.year} ${v.make} â€” feature\"`).join(', ')}],\n  \"cta\": \"${clientName} + contact (${ctaWords} words max)\",\n  \"full_script\": \"Complete script\",\n  \"notes\": \"Brief notes\"\n}`;\n\n// Add theme pack to user prompt if available\nif (themePack) {\n  userPrompt = `Generate a ${scriptLength.toUpperCase()} multi-car ad script for ${clientName}${clientLocation ? ' in ' + clientLocation : ''}.\n\nTHEME PACK:\n- Theme: ${themePack.theme_name} ${themePack.emoji || ''}\n- Core tension: ${themePack.core_tension}\n- Ad angle: ${themePack.ad_angle}\n- Local micro-moments: ${JSON.stringify(themePack.local_micro_moments)}\n- Banned phrases: ${JSON.stringify(themePack.banned_phrases)}\n\nVEHICLES (${vehicles.length}):\n${vehiclesSection}\n\nWORD LIMITS:\n- Hook: ${hookWords} words max\n- Each segment: ${segmentWords} words max\n- CTA: ${ctaWords} words max (MUST mention ${clientName})\n- TOTAL: ${totalWords} words max\n\nSEGMENT RULES:\n- REQUIRED: Year + Make + Model (e.g., \"2017 GMC Canyon\")\n- FLEXIBLE: Feature description (trim this if needed to hit word limit)\n- Each segment highlights ONE standout feature\n- Sound conversational, not like reading a list\n\n\nOUTPUT JSON:\n{\n  \"hook\": \"Punchy opener (${hookWords} words max)\",\n  \"segments\": [${vehicles.map(v => `\"${v.year} ${v.make} ${v.model} â€” ONE standout feature\"`).join(', ')}],\n  \"cta\": \"${clientName} + call to action (${ctaWords} words max)\",\n  \"full_script\": \"Complete script\",\n  \"notes\": \"Brief notes\"\n}`;\n}\n\nconsole.log(`âœ… Multi-item prompt built for ${vehicles.length} vehicles`);\nconsole.log(`ğŸ“ Word limits: hook=${hookWords}, segment=${segmentWords}, cta=${ctaWords}, total=${totalWords}`);\nconsole.log(`ğŸ¢ Client: ${clientName}`);\n\nreturn [{\n  json: {\n    ...config,\n    vehicles,\n    system_prompt: systemPrompt,\n    user_prompt: userPrompt,\n    word_limits: {\n      total: totalWords,\n      hook: hookWords,\n      segment: segmentWords,\n      cta: ctaWords\n    }\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          7184,
          48
        ],
        "id": "ad226bad-f815-4a28-80c1-bd19c2d3f6de",
        "name": "Build Script Prompt TEMP_001"
      },
      {
        "parameters": {
          "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUILD SCRIPT PROMPT â€” TEMP_002 (spotlight)\n// Pure formatting â€” timing from DB, theme instructions in system prompt\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $json;\nconst vehicle = config.vehicles[0];\nconst verifiedFeatures = config.verified_features || {};\nconst selectedPhotosObject = config.selected_photos || {};\nconst scriptLength = config.script_length || 'standard';\nconst timing = config.timing;\nconst themePack = config.theme_pack || null;\n\n// Helper function to remove /thumb/ suffix\nconst getFullResUrl = (url) => {\n  return url.replace('/thumb/', '/');\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// TRANSFORM SELECTED PHOTOS TO ARRAY FORMAT\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst selectedPhotosArray = [];\n\n// Add hero first\nif (selectedPhotosObject.hero_exterior) {\n  selectedPhotosArray.push({\n    photo_url: getFullResUrl(selectedPhotosObject.hero_exterior.photo_url),\n    photo_index: selectedPhotosObject.hero_exterior.photo_index,\n    category: \"exterior_hero\",\n    feature_callout: \"\",\n    display_order: 1\n  });\n}\n\n// Priority order for features (most important first)\nconst priorityOrder = [\n  'engine_bay',\n  'moonroof',\n  'infotainment_360_camera',\n  'infotainment_carplay',\n  'front_seats',\n  'steering_wheel',\n  'instrument_cluster',\n  'cargo_area',\n  'second_row_seats',\n  'third_row_seats',\n  'special_feature',\n  'infotainment_other'\n];\n\n// Add features in priority order\nlet displayOrder = 2;\npriorityOrder.forEach(category => {\n  const featureData = verifiedFeatures[category];\n  const photoData = selectedPhotosObject[category];\n\n  if (featureData?.script_features && photoData) {\n    selectedPhotosArray.push({\n      photo_url: getFullResUrl(photoData.photo_url),\n      photo_index: photoData.photo_index,\n      category: category,\n      feature_callout: featureData.script_features,\n      display_order: displayOrder++\n    });\n  }\n});\n\n// Limit to top 5 features (plus hero = 6 total)\nconst finalPhotos = selectedPhotosArray.slice(0, 6);\nconst featureCount = finalPhotos.length - 1;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// GET SYSTEM PROMPT (from Assemble System Prompt)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst systemPrompt = $('Assemble System Prompt').first()?.json?.system_prompt || '';\n\nif (!systemPrompt) {\n  throw new Error('No system prompt from Assemble System Prompt node');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// WORD LIMITS (from DB timing)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst hookWords = timing.hook_words;\nconst segmentWords = timing.segment_words;\nconst ctaWords = timing.cta_words;\nconst totalWords = hookWords + (segmentWords * finalPhotos.length) + ctaWords;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// THEME SECTION (pure data â€” no instructions)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet themeSection = '';\nif (themePack) {\n  themeSection = `THEME PACK:\n- Theme: ${themePack.theme_name} ${themePack.emoji || ''}\n- Core tension: ${themePack.core_tension}\n- Ad angle: ${themePack.ad_angle}\n- Local micro-moments: ${JSON.stringify(themePack.local_micro_moments)}\n- Banned phrases: ${JSON.stringify(themePack.banned_phrases)}`;\n} else if (config.theme && config.theme !== 'none') {\n  themeSection = `THEME: ${config.theme}`;\n} else {\n  themeSection = `THEME: None provided`;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUILD FEATURE LIST FOR USER PROMPT\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst featureSegments = finalPhotos\n  .map((photo, index) => {\n    if (index === 0) {\n      return `1. HERO: \"${vehicle.year} ${vehicle.make} ${vehicle.model}\" + one standout vibe`;\n    }\n    return `${index + 1}. \"${photo.feature_callout}\"`;\n  })\n  .join('\\n');\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// USER PROMPT\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst userPrompt = `Write a ${scriptLength.toUpperCase()} single-car spotlight script.\n\nVEHICLE: ${vehicle.year} ${vehicle.make} ${vehicle.model}\n\n${themeSection}\n\nSEGMENTS (${finalPhotos.length} total):\n${featureSegments}\n\nWORD LIMITS:\n- Hook: ${hookWords} words max\n- Each segment: ${segmentWords} words max\n- CTA: ${ctaWords} words max\n- TOTAL: ${totalWords} words max\n\nOUTPUT JSON:\n{\n  \"hook\": \"Scroll-stopping opener (${hookWords} words max)\",\n  \"segments\": [\n    ${finalPhotos.map((p, i) => {\n      if (i === 0) return `\"Hero: ${vehicle.year} ${vehicle.make}...\"`;\n      return `\"${p.feature_callout}\"`;\n    }).join(',\\n    ')}\n  ],\n  \"cta\": \"Contact + financing (${ctaWords} words max)\",\n  \"full_script\": \"Hook + all segments + cta\",\n  \"notes\": \"Brief notes\"\n}`;\n\nconsole.log(`âœ… Spotlight prompt built for ${vehicle.year} ${vehicle.make} ${vehicle.model}`);\nconsole.log(`ğŸ“¸ ${finalPhotos.length} photos (1 hero + ${featureCount} features)`);\nconsole.log(`ğŸ“ Word limits: hook=${hookWords}, segment=${segmentWords}, cta=${ctaWords}, total=${totalWords}`);\n\nreturn [{\n  json: {\n    ...config,\n    selected_photos: finalPhotos,\n    system_prompt: systemPrompt,\n    user_prompt: userPrompt,\n    word_limits: {\n      total: totalWords,\n      hook: hookWords,\n      perSegment: segmentWords,\n      cta: ctaWords\n    },\n    photos_selected: finalPhotos.length,\n    total_photos_analyzed: config.total_photos || 0,\n    rationale: `Selected ${featureCount} features: ${finalPhotos.slice(1).map(p => p.category).join(', ')}.`\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          7232,
          256
        ],
        "id": "71098943-07f6-42e5-b720-c456d85b47d8",
        "name": "Build Script Prompt TEMP_002"
      },
      {
        "parameters": {
          "errorMessage": "Script gen errored out."
        },
        "type": "n8n-nodes-base.stopAndError",
        "typeVersion": 1,
        "position": [
          8928,
          608
        ],
        "id": "bf56da31-0f0a-4eb3-8c4c-4c50ace36add",
        "name": "Stop and Error"
      },
      {
        "parameters": {
          "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUILD SCRIPT PROMPT â€” TEMP_003 (educational)\n// Educational uses seconds, not words â€” different timing model\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $json;\nconst timing = config.timing;\nconst themePack = config.theme_pack || null;\n\n// Get assembled system prompt (REQUIRED - no fallback)\nconst systemPrompt = $('Assemble System Prompt').first()?.json?.system_prompt;\n\nif (!systemPrompt) {\n  throw new Error('System prompt is required. Check Assemble System Prompt node.');\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// EDU-SPECIFIC TIMING (seconds, not words)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst eduTimings = {\n  quick: { hook: 3, value: 25, authority: 7, cta: 5, total: 40 },\n  standard: { hook: 3, value: 35, authority: 7, cta: 10, total: 55 },\n  detailed: { hook: 3, value: 50, authority: 10, cta: 12, total: 75 }\n};\n\nconst scriptLength = config.script_length || 'standard';\nconst eduTiming = eduTimings[scriptLength];\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// THEME SECTION WITH FALLBACKS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst avatarName = config.avatar_name || config.person_display_name || 'Shad';\n\n// Normalize theme pack (handle both seed and pack formats)\nlet normalizedThemePack = null;\nif (themePack) {\n  normalizedThemePack = {\n    theme_name: themePack.theme_name || themePack.theme_seed || 'Car Buying Tips',\n    emoji: themePack.emoji || 'ğŸš—',\n    core_tension: themePack.core_tension || themePack.direction || 'Common car problems people ignore until they become expensive',\n    education_angle: themePack.education_angle || themePack.direction || 'Practical tips to save money and avoid costly mistakes',\n    lifestyle_moments: themePack.lifestyle_moments || themePack.local_micro_moments || ['Dashboard warning lights', 'Weird car noises', 'Unexpected repair bills'],\n    banned_phrases: themePack.banned_phrases || ['guaranteed approval', 'no credit no problem', 'your next chapter', 'fresh start']\n  };\n}\n\nlet topicSection = '';\nif (normalizedThemePack) {\n  topicSection = `THEME PACK:\n- Theme: ${normalizedThemePack.theme_name} ${normalizedThemePack.emoji}\n- Core tension: ${normalizedThemePack.core_tension}\n- Education angle: ${normalizedThemePack.education_angle}\n- Problem scenarios: ${JSON.stringify(normalizedThemePack.lifestyle_moments)}\n- Banned phrases: ${JSON.stringify(normalizedThemePack.banned_phrases)}\n\nTOPIC: Teach to the core tension above. Start with a PROBLEM-based hook that makes viewers recognize themselves.`;\n} else if (config.topic) {\n  topicSection = `TOPIC: ${config.topic}\n\nStart with a PROBLEM-based hook. What mistake or myth can you address?`;\n} else if (config.theme) {\n  topicSection = `TOPIC: ${config.theme}\n\nStart with a PROBLEM-based hook. What mistake or myth can you address?`;\n} else {\n  topicSection = `TOPIC: Practical car buying or ownership advice.\n\nStart with a PROBLEM-based hook. What common mistake do car buyers make?`;\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// USER PROMPT (DATA ONLY - instructions are in system prompt)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst userPrompt = `Generate a ${scriptLength.toUpperCase()} educational script for ${avatarName}.\n\n${topicSection}\n\nTIMING:\n- Hook: ${eduTiming.hook} seconds\n- Value: ${eduTiming.value} seconds\n- Authority: ${eduTiming.authority} seconds\n- CTA: ${eduTiming.cta} seconds\n- Total: ~${eduTiming.total} seconds\n\nWrite now.`;\n\nconsole.log(`âœ… Edu prompt built for ${avatarName}`);\nconsole.log(`ğŸ¨ Theme: ${normalizedThemePack ? normalizedThemePack.theme_name : config.topic || 'seasonal default'}`);\nconsole.log(`â±ï¸ Timing: ${scriptLength} (~${eduTiming.total}s)`);\n\nreturn [{\n  json: {\n    ...config,\n    system_prompt: systemPrompt,\n    user_prompt: userPrompt,\n    timing: eduTiming\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          7184,
          1008
        ],
        "id": "336bf8bd-795b-4072-8928-7cd0cbf88e62",
        "name": "Build Script Prompt TEMP_003"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3.2,
        "position": [
          2704,
          384
        ],
        "id": "0d4af0b1-1d94-4f7f-93f5-b2ef0583deee",
        "name": "Merge: Config with Inventory"
      },
      {
        "parameters": {
          "content": "# #1 Script Generation\n\nUse Claude API to generate scripts for Avatar videos based\non the Template chosen by the user.",
          "height": 880,
          "width": 3856,
          "color": 5
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          2736,
          0
        ],
        "typeVersion": 1,
        "id": "2f256773-2f39-4e40-adf8-cbe2350ab2d0",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "inputSource": "passthrough"
        },
        "type": "n8n-nodes-base.executeWorkflowTrigger",
        "typeVersion": 1.1,
        "position": [
          240,
          720
        ],
        "id": "922249e2-7fd3-4244-8775-3e140eb6cf1d",
        "name": "When Executed by Orchestrate Video Creation"
      },
      {
        "parameters": {
          "content": "## Error Path",
          "height": 80,
          "width": 448,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          8416,
          832
        ],
        "typeVersion": 1,
        "id": "b0c08557-ed72-45bb-9dc7-addbbd10892d",
        "name": "Sticky Note1"
      },
      {
        "parameters": {
          "jsCode": "// Single error - format it for the email\nconst error = $input.first().json;\nconst nodeName = error.node?.name || 'Unknown node';\n\n// Handle different error formats from different APIs\nlet errorMsg = 'Unknown error';\n\n// Claude error format: { \"error\": { \"type\": \"...\", \"message\": \"...\" }, \"request_id\": \"...\" }\nif (error.error?.type && error.error?.message) {\n  errorMsg = `[${error.error.type}] ${error.error.message}`;\n  if (error.request_id) {\n    errorMsg += ` (Request ID: ${error.request_id})`;\n  }\n}\n// Cloudinary error format: { \"error\": { \"message\": \"...\" } }\nelse if (error.error?.message && !error.error?.type) {\n  errorMsg = error.error.message;\n}\n// Remove.bg error format: { \"errors\": [{ \"code\": \"...\", \"title\": \"...\" }] }\nelse if (error.errors && Array.isArray(error.errors) && error.errors.length > 0) {\n  const firstError = error.errors[0];\n  // Include code if present, otherwise just title\n  errorMsg = firstError.code \n    ? `${firstError.code}: ${firstError.title}` \n    : firstError.title;\n}\n// Generic message fallback\nelse if (error.message) {\n  errorMsg = error.message;\n}\n\nreturn [{\n  json: {\n    nodeName: nodeName,\n    errorMessage: errorMsg,\n    timestamp: new Date().toISOString(),\n    rawError: JSON.stringify(error, null, 2) // Include full error for debugging\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          8304,
          608
        ],
        "id": "74e1d4fe-8f00-469c-9431-335022e1a2f5",
        "name": "Format Script Creation Errors"
      },
      {
        "parameters": {
          "content": "## Success Path",
          "height": 80,
          "width": 192,
          "color": 4
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          8384,
          0
        ],
        "typeVersion": 1,
        "id": "3584c832-f7dc-43c3-9671-4513f4c3e371",
        "name": "Sticky Note2"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "loose",
              "version": 2
            },
            "conditions": [
              {
                "id": "aff49ee5-5b0c-432a-ac08-d40a2b35df22",
                "leftValue": "={{ $json.template_id }}",
                "rightValue": "organic-educational-1",
                "operator": {
                  "type": "string",
                  "operation": "notEquals"
                }
              }
            ],
            "combinator": "or"
          },
          "looseTypeValidation": true,
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          1984,
          720
        ],
        "id": "64391fd8-17dd-42a7-916c-df995f8fe030",
        "name": "If: Template ID"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "ac771c69-0a99-49c2-93ca-db4bf58ffab9",
                "leftValue": "={{$json.template_id}}",
                "rightValue": "ad-single-item-spotlight-1",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          3376,
          384
        ],
        "id": "f079a106-b70a-4b76-847e-afcda07ee5ab",
        "name": "If: Feature Photos"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "loose",
              "version": 2
            },
            "conditions": [
              {
                "id": "9451dada-8f16-4dff-ba00-ab2aabc49185",
                "leftValue": "={{ $json.api_claude_categorize_photos }}",
                "rightValue": "true",
                "operator": {
                  "type": "string",
                  "operation": "exists",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "looseTypeValidation": true,
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          4048,
          480
        ],
        "id": "f336e118-e90b-4a2d-889d-ecb42175adf3",
        "name": "If: Test, Skip Categorization"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "loose",
              "version": 2
            },
            "conditions": [
              {
                "id": "0a330d1c-bcb6-470a-88be-3dab4273101a",
                "leftValue": "={{ $json.api_claude_feature_identification }}",
                "rightValue": "true",
                "operator": {
                  "type": "string",
                  "operation": "exists",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "looseTypeValidation": true,
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          4944,
          480
        ],
        "id": "94b5114b-6559-4c22-bf5d-fdd5bfbe25fe",
        "name": "If: Test, Skip Feature Identification"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "loose",
              "version": 2
            },
            "conditions": [
              {
                "id": "50cf43b0-eb78-4a88-be36-f13549c7b8fc",
                "leftValue": "={{ $json.needs_bg_removal }}",
                "rightValue": "true",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              }
            ],
            "combinator": "and"
          },
          "looseTypeValidation": true,
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          5840,
          416
        ],
        "id": "b5e859ce-c0b1-4718-89ca-088f60a9435f",
        "name": "If: Needs Background Removed"
      },
      {
        "parameters": {
          "jsCode": "return [{\n  json: {\n    spreadsheet_data: $input.all().map(item => item.json)\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2368,
          368
        ],
        "id": "c814151d-0bc4-4253-a0c8-11d92029f90d",
        "name": "Combine Spreadsheet Data"
      },
      {
        "parameters": {
          "jsCode": "const allItems = $input.all();\nconst allVehicles = allItems[0].json.spreadsheet_data;\nconst config = allItems[1].json;\nconst requestedVins = config.vins;\nconst matchedVehicles = [];\n\n// Get template type from new format\nconst template = config.template_id || '';\n\nfor (const vehicle of allVehicles) {\n\n  if (vehicle.VIN && requestedVins.includes(vehicle.VIN)) {\n    console.log('âœ… Match found:', vehicle.VIN);\n\n    // ad-multi-item-1 (was TEMP_001) - basic vehicle info\n    if(template === \"ad-multi-item-1\") {\n      matchedVehicles.push({\n        vin: vehicle.VIN,\n        year: vehicle.Year,\n        make: vehicle.Make,\n        model: vehicle.Model,\n        price: vehicle.Price,\n        mileage: vehicle.Mileage,\n        image_url: vehicle.All_Images.split(\"|\")[0],\n        url: vehicle.VDP_URL,\n        features: [vehicle.Engine, vehicle.Drivetrain, vehicle.Exterior_Color].filter(Boolean)\n      });\n    }\n    // ad-single-item-spotlight-1 (was TEMP_002) - detailed vehicle info with all images\n    else if(template === \"ad-single-item-spotlight-1\"){\n      matchedVehicles.push({\n        vin: vehicle.VIN,\n        year: vehicle.Year,\n        make: vehicle.Make,\n        model: vehicle.Model,\n        trim: vehicle.Trim,\n        price: vehicle.Price,\n        mileage: vehicle.Mileage,\n        drivetrain: vehicle.Drivetrain,\n        transmission: vehicle.Transmission,\n        engine: vehicle.Engine,\n        exterior_color: vehicle.Exterior_Color,\n        equipment: vehicle.Equipment,\n        all_images: vehicle.All_Images.split(\"|\"),\n        image_url: vehicle.All_Images.split(\"|\")[0],\n        url: vehicle.VDP_URL\n      });\n    }\n    // social-educational-1 (was TEMP_003) - no vehicles needed, but include basic info if present\n    else if(template === \"social-educational-1\") {\n      matchedVehicles.push({\n        vin: vehicle.VIN,\n        year: vehicle.Year,\n        make: vehicle.Make,\n        model: vehicle.Model,\n        price: vehicle.Price,\n        mileage: vehicle.Mileage,\n        image_url: vehicle.All_Images.split(\"|\")[0],\n        url: vehicle.VDP_URL\n      });\n    }\n    // Default fallback - basic vehicle info\n    else {\n      console.log(`âš ï¸ Unknown template \"${template}\", using basic vehicle info`);\n      matchedVehicles.push({\n        vin: vehicle.VIN,\n        year: vehicle.Year,\n        make: vehicle.Make,\n        model: vehicle.Model,\n        price: vehicle.Price,\n        mileage: vehicle.Mileage,\n        image_url: vehicle.All_Images.split(\"|\")[0],\n        url: vehicle.VDP_URL,\n        features: [vehicle.Engine, vehicle.Drivetrain, vehicle.Exterior_Color].filter(Boolean)\n      });\n    }\n  }\n}\n\nconsole.log('ğŸ¯ Matched vehicles:', matchedVehicles.length);\n\nif (matchedVehicles.length === 0) {\n  throw new Error(`No vehicles found matching VINs: ${requestedVins.join(', ')}`);\n}\n\nreturn [{\n  json: {\n    ...config,\n    vehicles: matchedVehicles\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2928,
          384
        ],
        "id": "0fb932eb-3dee-4079-b0b0-7374acadec24",
        "name": "Fetch Car Info from VINs"
      },
      {
        "parameters": {
          "jsCode": "return [{\n  json: {\n    ...$json,\n    \"content\": [{\n      \"text\": $json.api_claude_categorize_photos\n    }]\n  }\n}]"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          4272,
          224
        ],
        "id": "6d44a5df-2346-4ce7-ad89-fad5aa113439",
        "name": "Skip Categorization"
      },
      {
        "parameters": {
          "jsCode": "const config = $('Build Photo Categorizer Prompt').first().json;\nconst apiResponse = $json.content[0].text;\n\nlet responseText = apiResponse;\nconst jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\nif (jsonMatch) {\n  responseText = jsonMatch[0];\n} else {\n  throw new Error(\"Could not find valid JSON object in response\");\n}\n\nconst categorizedResult = JSON.parse(responseText.trim());\n\n// Get data from previous node\nconst allImageUrls = config.all_image_urls;\nconst equipmentContextByCategory = config.equipment_context_by_category;\nconst vehicle = config.vehicles[0];\n\n// Build selected photos object\nconst selectedPhotos = {};\n\ncategorizedResult.categorized_photos.forEach(photo => {\n  const category = photo.category;\n  if (category !== 'exclude') {\n    const photoIndex = photo.photo_index;\n    \n    // Get equipment context for this category\n    const equipmentContext = equipmentContextByCategory[category] || {};\n    \n    selectedPhotos[category] = {\n      photo_index: photoIndex,\n      photo_url: allImageUrls[photoIndex],\n      reasoning: photo.reasoning,\n      equipment_context: equipmentContext\n    };\n  }\n});\n\n// Always include hero exterior (photo 0)\nselectedPhotos.hero_exterior = {\n  photo_index: 0,\n  photo_url: vehicle.all_images[0],\n  reasoning: \"Hero exterior shot\",\n  equipment_context: {}\n};\n\n// Clean up baseConfig - remove all_images\nconst cleanBaseConfig = {\n  ...config,\n  all_images: undefined,  // Remove all_images array\n  vehicles: config.vehicles?.map(vehicle => {\n    const {all_images, ...cleanVehicle } = vehicle;\n    return cleanVehicle;\n  })\n};\n\nreturn [{\n  json: {\n    ...cleanBaseConfig,\n\n    selected_photos: selectedPhotos,\n\n    // Remove used data\n    equipment_context_by_category: undefined,\n    categorizer_vision_content: undefined,\n    categorizer_system_prompt: undefined,\n    categorizer_user_prompt: undefined,\n    all_image_urls: undefined,\n    max_photo_index: undefined,\n    total_photos: undefined,\n    \n    // Testing API Response\n    ...(config.test_mode && { api_claude_categorize_photos: apiResponse })\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          4496,
          480
        ],
        "id": "433c72d7-dcc7-4e22-836b-222aef450043",
        "name": "Parse Catagorization Response"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.anthropic.com/v1/messages",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "anthropicApi",
          "sendHeaders": true,
          "specifyHeaders": "json",
          "jsonHeaders": "{\n  \"anthropic-version\": \"2023-06-01\",\n  \"content-type\": \"application/json\"\n}",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"model\": \"claude-sonnet-4-20250514\",\n  \"max_tokens\": 4000,\n  \"messages\": [\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($json.categorizer_vision_content) }}\n    }\n  ]\n}",
          "options": {
            "response": {
              "response": {
                "responseFormat": "json"
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          4272,
          720
        ],
        "id": "752295fe-7598-4b8e-b64a-98d3359b6d66",
        "name": "API: Claude, Categorize Photos",
        "credentials": {
          "httpHeaderAuth": {
            "id": "LQZygyOyKZ5tikRW",
            "name": "VideoBGRemover"
          },
          "anthropicApi": {
            "id": "lw8bFQVznfoHFIjD",
            "name": "Anthropic account"
          }
        }
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4",
            "mode": "list",
            "cachedResultName": "Inventory",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 467345130,
            "mode": "list",
            "cachedResultName": "Spotlight_Data",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4/edit#gid=467345130"
          },
          "options": {}
        },
        "id": "a0f82a94-8a1a-4b68-9d06-862507fe4e9f",
        "name": "API: Sheets, Fetch Inventory",
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.4,
        "position": [
          2192,
          368
        ],
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "9WK1ZemzeOSj1j4A",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "return [{\n  json: {\n    ...$json,\n    \"content\": [{\n      \"text\": $json.api_claude_feature_identification\n    }]\n  }\n}]"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          5168,
          224
        ],
        "id": "cf9a49be-f418-4e32-97cc-125258af5f13",
        "name": "Skip Feature Identification"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.anthropic.com/v1/messages",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "anthropicApi",
          "sendHeaders": true,
          "specifyHeaders": "json",
          "jsonHeaders": "{\n  \"anthropic-version\": \"2023-06-01\",\n  \"content-type\": \"application/json\"\n}",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"model\": \"claude-sonnet-4-20250514\",\n  \"max_tokens\": 4000,\n  \"messages\": [\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($json.feature_identifier_content) }}\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          5168,
          720
        ],
        "id": "6c0a8ff6-289e-44d4-a686-fc29e533014a",
        "name": "API: Claude, Feature Identification",
        "credentials": {
          "anthropicApi": {
            "id": "lw8bFQVznfoHFIjD",
            "name": "Anthropic account"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "jsCode": "// Get all items at once\nconst result = $input.all();\n\nfor (const item of result) {\n  // VIN is now in context from the service response\n  const vin = item.json.context?.vins?.[0] || item.json.vins?.[0] || 'unknown'; \n\n  if (item.binary && item.binary.data) {\n    item.binary.data.fileName = `${vin}.png`;\n  }\n  \n  // Flatten context back to top level for downstream nodes\n  if (item.json.context) {\n    item.json = { ...item.json.context, ...item.json };\n    delete item.json.context;\n  }\n}\n\nreturn result;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          6512,
          432
        ],
        "id": "45a01157-ebc3-4fc6-9675-7405ce66b01c",
        "name": "Rename Binary"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.cloudinary.com/v1_1/dtpqxuwby/image/upload",
          "sendBody": true,
          "contentType": "multipart-form-data",
          "bodyParameters": {
            "parameters": [
              {
                "parameterType": "formBinaryData",
                "name": "file",
                "inputDataFieldName": "data"
              },
              {
                "name": "upload_preset",
                "value": "n8n_unsigned"
              },
              {
                "name": "public_id",
                "value": "={{ $json.VIN }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          6736,
          432
        ],
        "id": "2a89fee3-72bf-4e01-ac5d-ad25a99f1da4",
        "name": "API: Coudinary, Upload",
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "jsCode": "const currentData = $json;\nconst config = $('Process Hero Photo for Animation').first().json;\n\n// Get VIN - might be in different places depending on the path\nconst vin = currentData.vehicles?.[0]?.vin || config.vehicles?.[0]?.vin;\n\nif (!vin) {\n  throw new Error('VIN missing - cannot update hero URL');\n}\n\n// Cloudinary response gives us the URL\nconst cloudinaryUrl = currentData.secure_url || `https://res.cloudinary.com/dtpqxuwby/image/upload/${vin}.png`;\n\n// Update the hero_bg_removed_url and selected_photos\n// const updatedData = {\n//   ...config,  // Use data from BEFORE the HTTP requests\n//   hero_bg_removed_url: cloudinaryUrl,\n//   needs_bg_removal: false,\n//   cloudinary_uploaded: true\n// };\n\n// Update the hero photo URL in selected_photos\nif (config.selected_photos?.hero_exterior) {\n  config.selected_photos.hero_exterior.photo_url = cloudinaryUrl;\n}\n\nreturn [{\n  json: {\n    ...config,\n    hero_bg_removed_url: cloudinaryUrl,\n    needs_bg_removal: false,\n    cloudinary_uploaded: true\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          6960,
          336
        ],
        "id": "64da0924-589c-4fa7-85e3-c625cdd26fce",
        "name": "Update Hero URL"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.anthropic.com/v1/messages",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "anthropicApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "anthropic-version",
                "value": "2023-06-01"
              },
              {
                "name": "content-type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "model",
                "value": "claude-sonnet-4-20250514"
              },
              {
                "name": "max_tokens",
                "value": "={{2000}}"
              },
              {
                "name": "system",
                "value": "={{$json.system_prompt || \"\"}}"
              },
              {
                "name": "messages",
                "value": "={{ [{\"role\": \"user\", \"content\": $json.user_prompt}] }}"
              }
            ]
          },
          "options": {}
        },
        "id": "e0cff8df-84c5-4220-b6fe-5a46fa8ebdfd",
        "name": "API: Claude, Script Generation",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          8080,
          320
        ],
        "credentials": {
          "anthropicApi": {
            "id": "lw8bFQVznfoHFIjD",
            "name": "Anthropic account"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "loose",
              "version": 2
            },
            "conditions": [
              {
                "id": "f641b7b8-0575-475f-b438-bf090d44e7e0",
                "leftValue": "={{ $json.api_claude_script_generation }}",
                "rightValue": "true",
                "operator": {
                  "type": "string",
                  "operation": "exists",
                  "singleValue": true
                }
              },
              {
                "id": "c1654ac2-d893-4717-86a4-b997027540b9",
                "leftValue": "={{$json.script_edited}}",
                "rightValue": "true",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "name": "filter.operator.equals"
                }
              }
            ],
            "combinator": "or"
          },
          "looseTypeValidation": true,
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          7856,
          272
        ],
        "id": "1dc60f41-78d4-48ad-bdf0-9d1392292905",
        "name": "If: Test, Skip Script Generation"
      },
      {
        "parameters": {
          "jsCode": "return [{\n  json: {\n    ...$json,\n    \"content\": [{\n      \"text\": $json.api_claude_script_generation\n    }]\n  }\n}]"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          8080,
          96
        ],
        "id": "f1d0ded6-7c9b-4e9b-8939-dba10e9f4552",
        "name": "Skip Script Generation"
      },
      {
        "parameters": {
          "jsCode": "const config = $('Post Agg Parse').first().json\n// If script was edited in UI, skip parsing - use existing script\nif (config.script_edited && config.script) {\n  return [{ json: config }];\n}\n\n// Extract and parse the script\nconst apiResponse = $json.content[0].text;\nconst cleanText = apiResponse\n  .replace(/```json\\n?/g, '')\n  .replace(/```\\n?/g, '')\n  .trim();\nlet parsedResponse;\ntry {\n  parsedResponse = JSON.parse(cleanText);\n} catch (error) {\n  throw new Error(`Failed to parse script response: ${error.message}`);\n}\nconst script = parsedResponse;\n// Validate required fields\nif (!script.hook || !script.segments || !script.cta) {\n  throw new Error('Script missing required section(s): hook, segments, or cta');\n}\nconst finalOutput = {\n  ...config,\n  script: script,\n  \n  // Remove prompts and processing data\n  shared_system_prompt: undefined,\n  system_prompt: undefined,\n  user_prompt: undefined,\n  claude_prompt: undefined,\n  script_user_prompt: undefined,\n  categorizer_vision_content: undefined,\n  feature_identifier_content: undefined,\n  categories_to_identify: undefined,\n  photos_selected: undefined,\n  total_photos_analyzed: undefined,\n  rationale: undefined,\n  categorizer_raw_response: undefined,\n  feature_identifier_raw: undefined,\n  verified_features: undefined,\n  equipment_categories: undefined,\n  hero_photo_index: undefined,\n  allowed_photo_categories: undefined,\n  equipment_context_by_category: undefined,\n  all_image_urls: undefined,\n  max_photo_index: undefined,\n  total_photos: undefined,\n  needs_bg_removal: undefined,\n  cloudinary_checked: undefined,\n  notes: undefined,\n  shared_prompt_ready: undefined\n};\n\n// Testing API Response - more explicit assignment\nif (config.test_mode) {\n  finalOutput.api_claude_script_generation = apiResponse;\n}\n\nreturn [{\n  json: finalOutput\n}];"
        },
        "id": "441e020e-6c92-49c3-a0e3-82aa486b1847",
        "name": "Parse Script Generation",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          8304,
          192
        ]
      },
      {
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "options": {}
        },
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          7408,
          272
        ],
        "id": "e1b7324f-d614-4a72-a661-be6c5cfb1dfb",
        "name": "Aggregate: All Configs"
      },
      {
        "parameters": {
          "jsCode": "const config = $('Build Feature Identifier Prompts').first().json;\nconst apiResponse = $json.content[0].text;\nconst vehicle = config.vehicles[0];\n\n// Parse JSON response (strip markdown if present)\nlet responseText = apiResponse.replace(/```json\\n?/g, \"\").replace(/```\\n?/g, \"\").trim();\n\n// Try to extract JSON object\nconst jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\nif (jsonMatch) {\n  responseText = jsonMatch[0];\n}\n\nconst identifiedFeatures = JSON.parse(responseText);\n\n// Combine equipment context + visual verification\nconst verifiedFeatures = {};\n\nObject.entries(identifiedFeatures).forEach(([category, features]) => {\n  const photoData = config.selected_photos[category];\n  if (!photoData) {\n    console.log(`âš ï¸ No photo data found for category: ${category}`);\n    return;\n  }\n\n  verifiedFeatures[category] = {\n    photo_index: photoData.photo_index,\n    photo_url: photoData.photo_url,\n    equipment_context: photoData.equipment_context,\n    visual_verification: features,\n    \n    // Build final feature list for script generation\n    script_features: buildScriptFeatures(category, photoData.equipment_context, features, vehicle)\n  };\n});\n\n// Function to build script-ready feature descriptions\nfunction buildScriptFeatures(category, equipment, visual, vehicle) {\n  switch(category) {\n    case 'front_seats':\n      const seatFeatures = [];\n      \n      // Add condition if excellent\n      if (visual.condition === 'excellent') {\n        seatFeatures.push('pristine');\n      }\n      \n      // Add material from equipment ONLY\n      seatFeatures.push(equipment.material_claim || 'comfortable seating');\n      \n      // Add climate features\n      if (equipment.has_heated && equipment.has_cooled) {\n        seatFeatures.push('heated and ventilated');\n      } else if (equipment.has_heated) {\n        seatFeatures.push('heated');\n      } else if (equipment.has_cooled) {\n        seatFeatures.push('ventilated');\n      }\n      \n      // Add power if present\n      if (equipment.has_power) {\n        seatFeatures.push('power-adjustable');\n      }\n      \n      // Add memory if present\n      if (equipment.has_memory) {\n        seatFeatures.push('with memory');\n      }\n      \n      return seatFeatures.join(' ');\n      \n    case 'engine_bay':\n      const engineFeatures = [];\n      \n      // Add engine details from equipment\n      if (equipment.engine_features && equipment.engine_features.length > 0) {\n        const engineInfo = equipment.engine_features[0];\n        // Extract key parts (e.g., \"V6 i-VTEC 3.5 Liter\")\n        const match = engineInfo.match(/(V\\d+|4-Cyl|3-Cyl|I\\d+).*?(\\d+\\.\\d+)\\s*Liter/i);\n        if (match) {\n          const cylinders = match[1];\n          const displacement = match[2];\n          engineFeatures.push(`${displacement}L ${cylinders}`);\n        } else {\n          engineFeatures.push(engineInfo);\n        }\n      }\n      \n      // Add turbo/special tech\n      if (equipment.engine_features && equipment.engine_features.some(e => /turbo/i.test(e))) {\n        engineFeatures.push('turbocharged');\n      }\n      if (equipment.engine_features && equipment.engine_features.some(e => /hemi/i.test(e))) {\n        engineFeatures.push('HEMI power');\n      }\n      \n      // Add condition note\n      if (visual.condition === 'clean') {\n        engineFeatures.push('well-maintained');\n      }\n      \n      return engineFeatures.join(', ');\n      \n    case 'infotainment_carplay':\n      const infoFeatures = [];\n      \n      // Smartphone integration\n      if (visual.has_apple_carplay && visual.has_android_auto) {\n        infoFeatures.push('Apple CarPlay and Android Auto');\n      } else if (visual.has_apple_carplay) {\n        infoFeatures.push('Apple CarPlay');\n      } else if (visual.has_android_auto) {\n        infoFeatures.push('Android Auto');\n      } else {\n        infoFeatures.push('smartphone connectivity');\n      }\n      \n      // Premium audio\n      if (equipment.audio_system && /bose|harman|revel|premium/i.test(equipment.audio_system)) {\n        infoFeatures.push(equipment.audio_system);\n      }\n      \n      // Navigation\n      if (equipment.has_navigation || visual.navigation_visible) {\n        infoFeatures.push('navigation');\n      }\n      \n      return infoFeatures.join(' with ');\n      \n    case 'infotainment_360_camera':\n      const cameraFeatures = ['360-degree camera'];\n      \n      if (visual.parking_sensors_visible) {\n        cameraFeatures.push('with parking sensors');\n      }\n      \n      return cameraFeatures.join(' ');\n      \n    case 'moonroof':\n      const roofFeatures = [];\n      \n      // Type from equipment\n      if (equipment.moonroof_type === 'Panoramic' || visual.appears_panoramic) {\n        roofFeatures.push('panoramic moonroof');\n      } else {\n        roofFeatures.push('power moonroof');\n      }\n      \n      return roofFeatures.join(' ');\n      \n    case 'cargo_area':\n      const cargoFeatures = [];\n      \n      // Space rating\n      if (visual.space_rating === 'spacious' || visual.space_rating === 'huge') {\n        cargoFeatures.push('spacious cargo area');\n      } else {\n        cargoFeatures.push('cargo space');\n      }\n      \n      // Power liftgate\n      if (equipment.power_liftgate) {\n        cargoFeatures.push('with power liftgate');\n      }\n      \n      // Truck bed features\n      if (equipment.truck_bed_features && equipment.truck_bed_features.length > 0) {\n        if (equipment.truck_bed_features.some(f => /bed liner/i.test(f))) {\n          cargoFeatures.push('spray-in bed liner');\n        }\n        if (equipment.truck_bed_features.some(f => /multipro/i.test(f))) {\n          cargoFeatures.push('MultiPro tailgate');\n        }\n      }\n      \n      return cargoFeatures.join(', ');\n      \n    case 'steering_wheel':\n      const wheelFeatures = [];\n      \n      if (equipment.has_heated_wheel || visual.controls_visible?.heated) {\n        wheelFeatures.push('heated steering wheel');\n      }\n      \n      if (visual.controls_visible?.audio || visual.controls_visible?.cruise) {\n        wheelFeatures.push('with steering wheel controls');\n      }\n      \n      if (visual.paddle_shifters) {\n        wheelFeatures.push('and paddle shifters');\n      }\n      \n      return wheelFeatures.length > 0 ? wheelFeatures.join(' ') : 'multifunction steering wheel';\n      \n    case 'second_row_seats':\n      const secondRowFeatures = [];\n      \n      if (visual.space_rating === 'spacious' || visual.space_rating === 'generous') {\n        secondRowFeatures.push('spacious rear seating');\n      } else {\n        secondRowFeatures.push('rear seating');\n      }\n      \n      if (visual.features_visible && visual.features_visible.length > 0) {\n        if (visual.features_visible.some(f => /climate/i.test(f))) {\n          secondRowFeatures.push('with rear climate control');\n        }\n      }\n      \n      return secondRowFeatures.join(' ');\n      \n    case 'third_row_seats':\n      return 'third row seating for seven passengers';\n      \n    case 'instrument_cluster':\n      if (visual.cluster_type === 'digital') {\n        return 'digital instrument cluster';\n      } else if (visual.cluster_type === 'hybrid') {\n        return 'advanced gauge cluster with digital display';\n      }\n      return null; // Don't highlight basic analog clusters\n      \n    case 'special_feature':\n      if (visual.feature_identified) {\n        return visual.feature_identified;\n      }\n      return null;\n      \n    case 'infotainment_other':\n      const otherFeatures = [];\n      \n      if (visual.showing === 'navigation' || equipment.has_navigation) {\n        otherFeatures.push('navigation system');\n      }\n      \n      if (equipment.audio_system && /bose|harman|revel|premium/i.test(equipment.audio_system)) {\n        otherFeatures.push(equipment.audio_system);\n      }\n      \n      if (otherFeatures.length === 0) {\n        otherFeatures.push('touchscreen infotainment');\n      }\n      \n      return otherFeatures.join(' with ');\n      \n    default:\n      return null;\n  }\n}\n\nconsole.log(`ğŸ“‹ Built script features for ${Object.keys(verifiedFeatures).length} categories`);\n\n// Log feature summary for debugging\nObject.entries(verifiedFeatures).forEach(([category, data]) => {\n  if (data.script_features) {\n    console.log(`  ${category}: \"${data.script_features}\"`);\n  }\n});\n\nreturn [{\n  json: {\n    ...config,\n    \n    verified_features: verifiedFeatures,\n    \n    // Testing API Response\n    ...(config.test_mode && { api_claude_feature_identification: apiResponse })\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          5392,
          416
        ],
        "id": "5fb2621e-973e-439c-8afe-4ee7ed2c8603",
        "name": "Parse Feature Identification Response"
      },
      {
        "parameters": {
          "jsCode": "return [{\n  json: $json.data[0]\n}]"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          7632,
          272
        ],
        "id": "9b593a38-46e0-4170-bc3c-3bb1a2645f8a",
        "name": "Post Agg Parse"
      },
      {
        "parameters": {
          "mode": "raw",
          "jsonOutput": "={{ $json }}",
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          464,
          720
        ],
        "id": "2925906e-f154-4670-9716-aabfdc9ce42f",
        "name": "Pass Config"
      },
      {
        "parameters": {
          "jsCode": "// Map existing error format to service format\nconst input = $json;\n\nreturn [{\n  json: {\n    workflow_name: \"[02] Generate Script\",\n    error: input.errorMessage || \"Unknown error\",\n    details: input.rawError || JSON.stringify(input, null, 2),\n    job_id: null,\n    to_email: \"kelly@ad-pilot.ai\"\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          8528,
          608
        ],
        "id": "prep-error-email",
        "name": "Prep: Error Email"
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "mBVi9C0eRoq1xTeb",
            "mode": "list",
            "cachedResultUrl": "/workflow/mBVi9C0eRoq1xTeb",
            "cachedResultName": "[Service] Email Error Notification"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {},
            "matchingColumns": [],
            "schema": [],
            "attemptToConvertTypes": false,
            "convertFieldsToString": true
          },
          "options": {}
        },
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.2,
        "position": [
          8752,
          608
        ],
        "id": "call-email-error",
        "name": "Call: Email Error"
      },
      {
        "parameters": {
          "jsCode": "// Prepare input for Remove Background service\nconst input = $json;\n\nreturn [{\n  json: {\n    image_url: input.hero_photo_url,\n    size: \"auto\",\n    format: \"png\",\n    crop: true,\n    crop_margin: \"10%\",\n    context: {\n      vins: input.vins\n    }\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          6064,
          528
        ],
        "id": "prep-remove-bg",
        "name": "Prep: Remove BG"
      },
      {
        "parameters": {
          "workflowId": {
            "__rl": true,
            "value": "pbHuh1HdmZxbFX0M",
            "mode": "list",
            "cachedResultUrl": "/workflow/pbHuh1HdmZxbFX0M",
            "cachedResultName": "[Service] Remove Background"
          },
          "workflowInputs": {
            "mappingMode": "defineBelow",
            "value": {},
            "matchingColumns": [],
            "schema": [],
            "attemptToConvertTypes": false,
            "convertFieldsToString": true
          },
          "options": {}
        },
        "type": "n8n-nodes-base.executeWorkflow",
        "typeVersion": 1.2,
        "position": [
          6288,
          528
        ],
        "id": "call-remove-bg",
        "name": "Call: Remove Background",
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "=SELECT prompt_type, template_code, prompt_content\nFROM client_prompts\nWHERE client_id = '{{ $json.client_id }}'\nAND (\n  prompt_type = 'base'\n  OR prompt_type = 'rules'\n  OR (prompt_type = 'override' AND template_code = UPPER(REPLACE(REPLACE('{{ $json.template_id }}', 'ad-', ''), 'organic-', '')))\n)\nAND is_active = true",
          "options": {}
        },
        "id": "fetch-client-prompts-001",
        "name": "Fetch Client Prompts",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          688,
          720
        ],
        "credentials": {
          "postgres": {
            "id": "3XsWrPuEddwVYbGS",
            "name": "Railway Postgres"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "=SELECT i.pronunciations, i.legal, i.feature_enrichment, i.template_guidance, i.global_rules\nFROM industries i\nJOIN clients c ON c.industry_id = i.id\nWHERE c.id = '{{ $('Pass Config').first().json.client_id }}'",
          "options": {}
        },
        "id": "fetch-industry-config-001",
        "name": "Fetch Industry Config",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          912,
          720
        ],
        "credentials": {
          "postgres": {
            "id": "3XsWrPuEddwVYbGS",
            "name": "Railway Postgres"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const config = $('Pass Config').first().json;\nconst promptRows = $('Fetch Client Prompts').all().map(r => r.json);\nconst industryPromptRaw = $('Fetch Industry Prompts').first()?.json?.prompt_content || {};\nconst industryConfig = $('Fetch Industry Config').first().json;\nconst timingDefaults = $('Fetch Timing Defaults').first().json;\nconst templateConfig = $('Fetch Template Config').first().json;\n\n// Parse industry prompt if string\nconst industryPrompt = typeof industryPromptRaw === 'string' \n  ? JSON.parse(industryPromptRaw) \n  : industryPromptRaw;\n\n// Get client-level data\nconst basePrompt = promptRows.find(r => r.prompt_type === 'base')?.prompt_content || {};\nconst rulesPrompt = promptRows.find(r => r.prompt_type === 'rules')?.prompt_content || [];\nconst overridePromptRaw = promptRows.find(r => r.prompt_type === 'override')?.prompt_content || {};\nconst overridePrompt = typeof overridePromptRaw === 'string' ? JSON.parse(overridePromptRaw) : overridePromptRaw;\n\n// Deep merge helper - client overrides win\nfunction deepMerge(base, override) {\n  if (!override || Object.keys(override).length === 0) return base;\n  \n  const result = { ...base };\n  for (const key of Object.keys(override)) {\n    if (typeof override[key] === 'object' && !Array.isArray(override[key]) && base[key]) {\n      result[key] = deepMerge(base[key], override[key]);\n    } else {\n      result[key] = override[key];\n    }\n  }\n  return result;\n}\n\n// MERGE: industry_prompts + client overrides\nconst templatePrompt = deepMerge(industryPrompt, overridePrompt);\n\n// Check template flags\nconst isStandalone = templatePrompt.standalone === true;\nconst usesBase = templatePrompt.uses_base === true;\nconst usesFromBase = templatePrompt.uses_from_base || [];\nconst respectsRules = templatePrompt.respects_rules !== false; // default true\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// BUILD SYSTEM PROMPT (14 SECTIONS)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst sections = [];\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 1: IDENTITY (from base)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (usesBase || usesFromBase.includes('identity')) {\n  const identity = basePrompt.identity || {};\n  sections.push(`You are a ${identity.platform_voice || 'video ad copywriter'} for ${identity.business_name || 'our client'} in ${identity.location || 'their area'}.`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 2: TEMPLATE DEFINITION (from template prompt)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.description) {\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“‹ TEMPLATE: ${templateConfig.template_code || config.template_id}\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${templatePrompt.description}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 3: WORD LIMITS (from timing_defaults DB)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (timingDefaults) {\n  sections.push(`\nâš ï¸ WORD LIMITS (${timingDefaults.name} - ${timingDefaults.style || ''}):\n- Hook: ${timingDefaults.hook_words} words max\n- Segment: ${timingDefaults.segment_words} words max\n- CTA: ${timingDefaults.cta_words} words max`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 4: STRUCTURE (from template prompt)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.structure) {\n  sections.push(`\nSTRUCTURE:\n${templatePrompt.structure.map((s, i) => `${i + 1}. ${s}`).join('\\n')}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 5: HOOK RULES (from merged template prompt)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.hook_rules) {\n  const hr = templatePrompt.hook_rules;\n  let hookSection = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸª HOOK RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${hr.principle}`;\n\n  if (hr.format) {\n    hookSection += `\\n\\nFORMAT: ${hr.format}`;\n  }\n\n  // Handle both old (good_examples) and new (examples) schemas\n  const goodExamples = hr.examples || hr.good_examples || [];\n  if (goodExamples.length > 0) {\n    hookSection += `\\n\\nGOOD EXAMPLES:\\n${goodExamples.map(e => `âœ… \"${e}\"`).join('\\n')}`;\n  }\n\n  // Handle both old (bad_examples) and new (avoid) schemas  \n  const badExamples = hr.avoid || hr.bad_examples || [];\n  if (badExamples.length > 0) {\n    hookSection += `\\n\\nAVOID:\\n${badExamples.map(e => `âŒ \"${e}\"`).join('\\n')}`;\n  }\n\n  sections.push(hookSection);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 6: VALUE SECTION (for educational templates)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.value_section) {\n  const vs = templatePrompt.value_section;\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ’¡ VALUE SECTION\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${vs.principle}\n\nRULES:\n${(vs.rules || []).map(r => `â€¢ ${r}`).join('\\n')}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 7: AUTHORITY SECTION (for educational templates)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.authority_section) {\n  const as = templatePrompt.authority_section;\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ† AUTHORITY SECTION\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${as.principle}\n\nEXAMPLE FRAMING:\n${(as.example_framing || []).map(f => `â€¢ \"${f}\"`).join('\\n')}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 8: CTA RULES (from template prompt)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.cta_rules) {\n  const cr = templatePrompt.cta_rules;\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“£ CTA RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${cr.principle}\n\nORDER:\n${(cr.order || []).map((o, i) => `${i + 1}. ${o}`).join('\\n')}\n\nAVOID: ${(cr.avoid || []).join(', ')}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 9: DELIVERY RULES (for educational templates)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.delivery_rules) {\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¤ DELIVERY RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${templatePrompt.delivery_rules.map(r => `â€¢ ${r}`).join('\\n')}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 10: SEGMENT RULES (from template prompt)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.segment_rules) {\n  const sr = templatePrompt.segment_rules;\n  let segSection = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“ SEGMENT RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;\n\n  // Handle both nested structure (MULTI-ITEM) and flat structure (SINGLE-ITEM)\n  if (sr.segment_1_hero) {\n    segSection += `\\nSEGMENT 1 (HERO):\n${sr.segment_1_hero.principle}\nPattern: ${sr.segment_1_hero.pattern}\nExample: \"${sr.segment_1_hero.example}\"`;\n  }\n\n  if (sr.segments_2_plus) {\n    segSection += `\\n\\nSEGMENTS 2+:\n${sr.segments_2_plus.principle}\nStyle: ${sr.segments_2_plus.style}\n\nGOOD:\n${(sr.segments_2_plus.good_patterns || []).map(p => `âœ… \"${p}\"`).join('\\n')}\n\nBAD:\n${(sr.segments_2_plus.bad_patterns || []).map(p => `âŒ \"${p}\"`).join('\\n')}`;\n  }\n\n  // Flat structure (SINGLE-ITEM-SPOTLIGHT)\n  if (sr.principle && !sr.segment_1_hero) {\n    segSection += `\\n${sr.principle}\nFlow: ${sr.flow || ''}\n\nEXAMPLE ARC:\n${(sr.example_arc || []).map(e => `â€¢ ${e}`).join('\\n')}`;\n  }\n\n  sections.push(segSection);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 11: NATURAL FLOW (for multi-item templates)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.natural_flow) {\n  const nf = templatePrompt.natural_flow;\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ—£ï¸ NATURAL FLOW\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${nf.principle}\n\nLEAD-IN VARIETY:\n${(nf.lead_in_variety || []).map(l => `- \"${l}\"`).join('\\n')}\n\nCONNECT FEATURES:\n${nf.connect_features?.principle || ''}\nGOOD: ${(nf.connect_features?.good || []).map(g => `\"${g}\"`).join(', ')}\nBAD: ${(nf.connect_features?.bad || []).map(b => `\"${b}\"`).join(', ')}`);\n}\n\n// Feature diversity\nif (templatePrompt.feature_diversity) {\n  sections.push(`\nFEATURE DIVERSITY: ${templatePrompt.feature_diversity}`);\n}\n\n// Tone\nif (templatePrompt.tone) {\n  sections.push(`\nTONE: ${templatePrompt.tone}`);\n}\n\n// Hard fails\nif (templatePrompt.hard_fails) {\n  sections.push(`\nâŒ HARD FAILS (avoid at all costs):\n${templatePrompt.hard_fails.map(f => `â€¢ ${f}`).join('\\n')}`);\n}\n\n// TTS rules\nif (templatePrompt.tts_rules) {\n  const tts = templatePrompt.tts_rules;\n  sections.push(`\nğŸ”Š TTS RULES: ${tts.principle}\nNo emojis in: ${(tts.no_emojis_in || []).join(', ')}\nEmojis allowed in: ${(tts.emojis_allowed_in || []).join(', ')}`);\n}\n\n// Output format\nif (templatePrompt.output_format) {\n  const of = templatePrompt.output_format;\n  let formatSection = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“¤ OUTPUT FORMAT\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;\n  for (const [key, val] of Object.entries(of)) {\n    if (Array.isArray(val)) {\n      formatSection += `\\n${key}: ${val.join(', ')}`;\n    } else {\n      formatSection += `\\n${key}: ${val}`;\n    }\n  }\n  sections.push(formatSection);\n}\n\n// Examples from template\nif (templatePrompt.examples) {\n  sections.push(`\nEXAMPLES:\nGOOD:\n${(templatePrompt.examples.good || []).map(e => `âœ… \"${e}\"`).join('\\n')}\n\nBAD:\n${(templatePrompt.examples.bad || []).map(e => `âŒ \"${e}\"`).join('\\n')}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 12: THEME PACK USAGE (from theme_modes DB)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templateConfig.theme_mode_rules) {\n  const rules = typeof templateConfig.theme_mode_rules === 'string'\n    ? JSON.parse(templateConfig.theme_mode_rules)\n    : templateConfig.theme_mode_rules;\n\n  if (rules && rules.length > 0) {\n    sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¨ THEME PACK USAGE (${templateConfig.theme_mode_name || templateConfig.theme_mode})\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${rules.map((r, i) => `${i + 1}) ${r}`).join('\\n')}\n\nIf theme_pack missing: Use generic value/deals hook`);\n  }\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 13: GLOBAL RULES (from industry)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (industryConfig?.global_rules?.length) {\n  const globalLines = industryConfig.global_rules.map(rule => `âš ï¸ ${rule}`).join('\\n');\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸŒ GLOBAL RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${globalLines}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 14: BANNED PHRASE CHECK (from template prompt)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (templatePrompt.banned_phrase_check) {\n  sections.push(`\nâš ï¸ ${templatePrompt.banned_phrase_check}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 15: BASE PROMPT SECTIONS (if uses_base)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (usesBase) {\n  // Priorities\n  if (basePrompt.priorities?.length) {\n    const priorityLines = basePrompt.priorities\n      .map((p, i) => `${i + 1}. ${p.name.toUpperCase()} - ${p.description}`)\n      .join('\\n');\n    sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¯ PRIORITIES (IN ORDER)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${priorityLines}`);\n  }\n\n  // Contact info\n  if (basePrompt.contact_tts) {\n    const ct = basePrompt.contact_tts;\n    sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“ CONTACT INFO (FOR TTS)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n- Address: \"${ct.address_short}\"\n- Full address: \"${ct.address_full}\"\n- Phone: \"${ct.phone}\"\n- Website: \"${ct.website}\"`);\n  }\n\n  // CTA patterns\n  if (basePrompt.cta_patterns?.length) {\n    sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“¢ CTA PATTERNS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${basePrompt.cta_patterns.map(c => `âœ… \"${c}\"`).join('\\n')}`);\n  }\n\n  // Tone\n  if (basePrompt.tone_and_style) {\n    sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¨ TONE & STYLE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${basePrompt.tone_and_style}`);\n  }\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 16: PRONUNCIATIONS (merged: industry library + client custom)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst industryPronunciations = industryConfig?.pronunciations || {};\nconst clientPronunciations = basePrompt.pronunciations || {};\nconst mergedPronunciations = { ...industryPronunciations, ...clientPronunciations };\n\nif (Object.keys(mergedPronunciations).length > 0) {\n  const pronLines = Object.entries(mergedPronunciations)\n    .map(([word, say]) => `- ${word} â†’ \"${say}\"`)\n    .join('\\n');\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ—£ï¸ PRONUNCIATIONS (NEVER DEVIATE)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${pronLines}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 17: LEGAL RULES (from industry - NON-NEGOTIABLE)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (industryConfig?.legal?.length) {\n  const legalLines = industryConfig.legal.map(rule => `âŒ ${rule}`).join('\\n');\n\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâš–ï¸ LEGAL (CRITICAL - NON-NEGOTIABLE)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${legalLines}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// SECTION 18: CLIENT RULES (LAST - HIGHEST PRIORITY)\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nif (respectsRules && rulesPrompt?.length) {\n  const ruleLines = rulesPrompt.map(r => {\n    const icon = r.type === 'style' ? 'â›”' : 'ğŸ“Œ';\n    return `${icon} ${r.rule}`;\n  }).join('\\n');\n\n  sections.push(`\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸš¨ CLIENT RULES â€” OVERRIDE EVERYTHING ABOVE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nThese rules are CLIENT-SPECIFIC and take ABSOLUTE PRIORITY.\nIf ANY rule above conflicts with these, THESE WIN.\n\n${ruleLines}`);\n}\n\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// ASSEMBLE FINAL PROMPT\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst systemPrompt = sections.join('\\n');\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('ASSEMBLED SYSTEM PROMPT');\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log(`Template: ${templateConfig.template_code || config.template_id}`);\nconsole.log(`Theme Mode: ${templateConfig.theme_mode || 'none'}`);\nconsole.log(`Timing: ${timingDefaults?.code || 'standard'}`);\nconsole.log(`Standalone: ${isStandalone}`);\nconsole.log(`Uses Base: ${usesBase}`);\nconsole.log(`Respects Rules: ${respectsRules}`);\nconsole.log(`Industry Prompt Found: ${Object.keys(industryPrompt).length > 0}`);\nconsole.log(`Client Override Found: ${Object.keys(overridePrompt).length > 0}`);\nconsole.log(`Prompt length: ${systemPrompt.length} chars`);\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\nreturn [{\n  json: {\n    ...config,\n    system_prompt: systemPrompt,\n    timing_config: timingDefaults,\n    template_config: templateConfig,\n    industry_config: industryConfig,\n    _prompt_meta: {\n      standalone: isStandalone,\n      uses_base: usesBase,\n      respects_rules: respectsRules,\n      template_code: templateConfig.template_code || config.template_id,\n      theme_mode: templateConfig.theme_mode,\n      industry_prompt_found: Object.keys(industryPrompt).length > 0,\n      client_override_found: Object.keys(overridePrompt).length > 0\n    }\n  }\n}];"
        },
        "id": "assemble-system-prompt-001",
        "name": "Assemble System Prompt",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1808,
          720
        ]
      },
      {
        "parameters": {
          "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PREPARE SCRIPT CONTEXT\n// Pure data fetcher â€” no business logic, no instructions\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $json;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// TIMING (from timing_config - fetched from DB)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst timingConfig = config.timing_config || {};\nconst timing = {\n  hook_words: timingConfig.hook_words || 12,\n  segment_words: timingConfig.segment_words || 15,\n  cta_words: timingConfig.cta_words || 12,\n  style: timingConfig.style || 'Standard timing',\n  code: timingConfig.code || 'standard'\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// THEME PACK (pure data â€” NO instructions)\n// Handle both full pack format AND seed format from UI\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nlet themePack = config.theme_pack || null;\nlet themeSection = '';\n\nif (themePack) {\n  // Normalize: handle both seed format (theme_seed) and pack format (theme_name)\n  const themeName = themePack.theme_name || themePack.theme_seed;\n  const coreTension = themePack.core_tension || themePack.direction || '';\n  const emoji = themePack.emoji || '';\n  \n  // Check if this is educational template\n  const isEducational = (config.template_id || '').toLowerCase().includes('educational') ||\n                        (config.template_code || '').toLowerCase().includes('educational') ||\n                        (config.template || '').toLowerCase().includes('educational');\n  \n  if (themeName) {\n    if (isEducational) {\n      // Educational: use education_angle and problem scenarios\n      const educationAngle = themePack.education_angle || themePack.direction || '';\n      const problemScenarios = themePack.lifestyle_moments || themePack.problem_scenarios || \n                               ['Dashboard warning lights', 'Weird car noises', 'Unexpected repair bills'];\n      const bannedPhrases = themePack.banned_phrases || \n                            ['guaranteed approval', 'no credit no problem', 'your next chapter', 'fresh start'];\n      \n      themeSection = `THEME PACK:\n- Theme: ${themeName} ${emoji}\n- Core tension: ${coreTension}\n- Education angle: ${educationAngle}\n- Problem scenarios: ${JSON.stringify(problemScenarios)}\n- Banned phrases: ${JSON.stringify(bannedPhrases)}`;\n\n      // Normalize the theme_pack object for downstream use\n      themePack = {\n        ...themePack,\n        theme_name: themeName,\n        core_tension: coreTension,\n        education_angle: educationAngle,\n        problem_scenarios: problemScenarios,\n        banned_phrases: bannedPhrases,\n        emoji: emoji\n      };\n    } else {\n      // Ads: use ad_angle and lifestyle_moments\n      const adAngle = themePack.ad_angle || themePack.direction || '';\n      \n      themeSection = `THEME PACK:\n- Theme: ${themeName} ${emoji}\n- Core tension: ${coreTension}\n- Ad angle: ${adAngle}`;\n\n      // Add optional fields if present (full pack mode)\n      if (themePack.local_micro_moments) {\n        themeSection += `\\n- Local micro-moments: ${JSON.stringify(themePack.local_micro_moments)}`;\n      }\n      if (themePack.lifestyle_moments) {\n        themeSection += `\\n- Lifestyle moments: ${JSON.stringify(themePack.lifestyle_moments)}`;\n      }\n      if (themePack.banned_phrases) {\n        themeSection += `\\n- Banned phrases: ${JSON.stringify(themePack.banned_phrases)}`;\n      }\n\n      // Normalize the theme_pack object for downstream use\n      themePack = {\n        ...themePack,\n        theme_name: themeName,\n        core_tension: coreTension,\n        ad_angle: adAngle,\n        emoji: emoji\n      };\n    }\n  } else {\n    themeSection = 'THEME: None provided';\n    themePack = null;\n  }\n} else if (config.theme) {\n  // Simple theme string (legacy)\n  themeSection = `THEME: ${config.theme}`;\n} else {\n  themeSection = 'THEME: None provided';\n}\n\nconsole.log(`ğŸ“ Timing: ${timing.code} (hook: ${timing.hook_words}, segment: ${timing.segment_words}, cta: ${timing.cta_words})`);\nconsole.log(`ğŸ¨ Theme: ${themePack ? (themePack.theme_name || themePack.theme_seed) : 'none'}`);\n\nreturn [{\n  json: {\n    ...config,\n    timing,\n    theme_section: themeSection,\n    theme_pack: themePack\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1808,
          720
        ],
        "id": "43d9026d-8fad-41ac-a50a-a283cb30f122",
        "name": "Prepare Script Context"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "=SELECT code, name, hook_words, segment_words, cta_words, style\nFROM timing_defaults\nWHERE code = COALESCE('{{ $('Pass Config').first().json.script_length }}', 'standard')",
          "options": {}
        },
        "id": "fetch-timing-defaults-001",
        "name": "Fetch Timing Defaults",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          1136,
          720
        ],
        "credentials": {
          "postgres": {
            "id": "3XsWrPuEddwVYbGS",
            "name": "Railway Postgres"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "=SELECT\n  t.code as template_code,\n  t.name as template_name,\n  t.theme_mode,\n  t.data_requirements,\n  tm.code as theme_mode_code,\n  tm.name as theme_mode_name,\n  tm.rules as theme_mode_rules\nFROM templates t\nLEFT JOIN theme_modes tm ON tm.code = t.theme_mode\nWHERE t.code = UPPER(REPLACE(REPLACE('{{ $('Pass Config').first().json.template_id }}', 'ad-', ''), 'organic-', ''))",
          "options": {}
        },
        "id": "fetch-template-config-001",
        "name": "Fetch Template Config",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          1360,
          720
        ],
        "credentials": {
          "postgres": {
            "id": "3XsWrPuEddwVYbGS",
            "name": "Railway Postgres"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ENRICH VEHICLE FEATURES\n// Apply industry-specific feature enrichment from DB\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst config = $json;\nlet vehicles = config.vehicles || [];\n\n// Get industry feature enrichment config\nconst industryConfig = config.industry_config || {};\nconst featureEnrichment = industryConfig.feature_enrichment || {};\n\n// Parse if string (JSONB from Postgres)\nconst enrichmentConfig = typeof featureEnrichment === 'string'\n  ? JSON.parse(featureEnrichment)\n  : featureEnrichment;\n\n// Get reliable brands from industry config (or empty array)\nconst reliableBrands = enrichmentConfig.reliable_brands || [];\n\nconsole.log('ğŸ”§ Feature enrichment config:', JSON.stringify(enrichmentConfig));\nconsole.log('ğŸš— Reliable brands:', reliableBrands.join(', ') || 'none configured');\n\n// Enrich each vehicle\nvehicles = vehicles.map(vehicle => {\n  let features = [...(vehicle.features || [])];\n\n  const mileage = parseInt(vehicle.mileage) || 0;\n  const year = parseInt(vehicle.year) || 2020;\n  const currentYear = new Date().getFullYear();\n  const age = currentYear - year;\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // LOW MILEAGE (relative to age)\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const expectedMileage = age * 12000;\n  if (mileage > 0 && mileage < expectedMileage * 0.6) {\n    features.unshift('Low Mileage');\n  }\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // HYBRID/ELECTRIC POWER\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const engine = (vehicle.engine || '').toLowerCase();\n  if (engine.includes('hybrid') || engine.includes('electric')) {\n    features.unshift('Hybrid Power');\n  } else if (engine.includes('4-cyl') || engine.includes('turbo')) {\n    // Only add if not already there\n    if (!features.includes('Great Gas Mileage')) {\n      features.push('Great Gas Mileage');\n    }\n  }\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // AWD/4WD\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const drivetrain = (vehicle.drivetrain || '').toLowerCase();\n  if (drivetrain.includes('awd') || drivetrain.includes('4wd') || drivetrain.includes('4x4')) {\n    if (!features.includes('All-Wheel Drive')) {\n      features.push('All-Wheel Drive');\n    }\n  }\n\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // RELIABLE BRANDS (from industry.feature_enrichment.reliable_brands)\n  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const make = (vehicle.make || '').toLowerCase();\n  if (reliableBrands.length > 0 && reliableBrands.includes(make)) {\n    if (!features.includes('Reliable Brand')) {\n      features.push('Reliable Brand');\n    }\n  }\n\n  // Ensure at least one feature\n  if (features.length === 0) {\n    features.push('Great Condition');\n  }\n\n  return {\n    ...vehicle,\n    features: features\n  };\n});\n\nconsole.log('âœ… Enriched features for', vehicles.length, 'vehicles');\nvehicles.forEach((v, i) => {\n  console.log(`  ${i + 1}. ${v.year} ${v.make} ${v.model}: ${v.features.join(', ')}`);\n});\n\nreturn [{\n  json: {\n    ...config,\n    vehicles\n  }\n}];"
        },
        "id": "enrich-vehicle-features-001",
        "name": "Enrich Vehicle Features",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3152,
          384
        ]
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "generate-script-from-asset",
          "responseMode": "responseNode",
          "options": {}
        },
        "id": "asset-webhook-001",
        "name": "Webhook: Generate from Asset",
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          6064,
          1056
        ],
        "webhookId": "generate-from-asset-001"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "=SELECT\n  a.*,\n  t.code as template_code,\n  t.theme_mode,\n  tm.rules as theme_mode_rules,\n  c.id as client_id,\n  c.name as client_name\nFROM assets a\nJOIN templates t ON a.template_id = t.id\nLEFT JOIN theme_modes tm ON t.theme_mode = tm.code\nJOIN weekly_plans p ON a.plan_id = p.id\nJOIN clients c ON p.client_id = c.id\nWHERE a.id = '{{ $json.body.asset_id }}'",
          "options": {}
        },
        "id": "fetch-processed-asset-001",
        "name": "Fetch Processed Asset",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          6288,
          1056
        ],
        "credentials": {
          "postgres": {
            "id": "3XsWrPuEddwVYbGS",
            "name": "Railway Postgres"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "=SELECT * FROM timing_defaults\nWHERE code = '{{ $json.target_length }}'\nUNION ALL\nSELECT * FROM timing_defaults WHERE code = 'standard'\nLIMIT 1",
          "options": {}
        },
        "id": "fetch-timing-asset-001",
        "name": "Fetch Timing for Asset",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          6512,
          1056
        ],
        "credentials": {
          "postgres": {
            "id": "3XsWrPuEddwVYbGS",
            "name": "Railway Postgres"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PREPARE SCRIPT CONTEXT (FROM PROCESSED ASSET)\n// Pure data fetcher â€” asset already has processed_items + theme_pack\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst asset = $('Fetch Processed Asset').first().json;\nconst timingRow = $('Fetch Timing for Asset').first().json;\n\n// Parse JSONB fields if needed\nconst processedItems = typeof asset.processed_items === 'string'\n  ? JSON.parse(asset.processed_items)\n  : (asset.processed_items || []);\n\nconst themePack = typeof asset.theme_pack === 'string'\n  ? JSON.parse(asset.theme_pack)\n  : asset.theme_pack;\n\nconst themeModeRules = typeof asset.theme_mode_rules === 'string'\n  ? JSON.parse(asset.theme_mode_rules)\n  : asset.theme_mode_rules;\n\n// Build timing object\nconst timing = {\n  hook_words: timingRow?.hook_words || 12,\n  segment_words: timingRow?.segment_words || 15,\n  cta_words: timingRow?.cta_words || 12,\n  style: timingRow?.style || 'Standard timing',\n  code: timingRow?.code || 'standard'\n};\n\n// Build theme section (pure data, no instructions)\nlet themeSection = '';\nif (themePack) {\n  themeSection = `THEME PACK:\n- Theme: ${themePack.theme_name} ${themePack.emoji || ''}\n- Core tension: ${themePack.core_tension}\n- Ad angle: ${themePack.ad_angle}\n- Local micro-moments: ${JSON.stringify(themePack.local_micro_moments)}\n- Banned phrases: ${JSON.stringify(themePack.banned_phrases)}`;\n} else {\n  themeSection = 'THEME: None provided';\n}\n\n// Map processed_items to vehicles format (for compatibility with TEMP_001)\nconst vehicles = processedItems.map(item => ({\n  vin: item.vin,\n  year: item.year,\n  make: item.make,\n  model: item.model,\n  trim: item.trim,\n  mileage: item.mileage,\n  price: item.price,\n  image_url: item.photo_url,\n  features: item.equipment_highlights || [],\n  // Additional processed data\n  mileage_category: item.mileage_category,\n  equipment_summary: item.equipment_summary,\n  days_on_lot: item.days_on_lot\n}));\n\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('PREPARE SCRIPT CONTEXT (FROM ASSET)');\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log(`Asset ID: ${asset.id}`);\nconsole.log(`Template: ${asset.template_code}`);\nconsole.log(`Theme Mode: ${asset.theme_mode}`);\nconsole.log(`Items: ${processedItems.length}`);\nconsole.log(`Theme Pack: ${themePack ? themePack.theme_name : 'none'}`);\nconsole.log(`Timing: ${timing.code}`);\nconsole.log(`Client: ${asset.client_name}`);\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n\nreturn [{\n  json: {\n    // Asset info\n    asset_id: asset.id,\n    template_id: asset.template_id,\n    template_code: asset.template_code,\n    theme_mode: asset.theme_mode,\n\n    // Timing\n    timing,\n    script_length: asset.target_length || 'standard',\n\n    // Theme\n    theme_pack: themePack,\n    theme_section: themeSection,\n    theme_mode_rules: themeModeRules,\n\n    // Items (processed)\n    vehicles,\n    items: processedItems,\n    item_count: processedItems.length,\n\n    // Client info\n    client_id: asset.client_id,\n    client_name: asset.client_name,\n    client_location: asset.client_location || '',\n\n    // Other asset data\n    avatars: asset.avatars,\n    music_id: asset.music_id,\n    background_id: asset.background_id\n  }\n}];"
        },
        "id": "prepare-asset-context-001",
        "name": "Prepare Script Context (Asset)",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          6736,
          1056
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "multi-item",
                "leftValue": "={{ $json.template_code }}",
                "rightValue": "MULTI-ITEM",
                "operator": {
                  "type": "string",
                  "operation": "contains"
                }
              },
              {
                "id": "spotlight",
                "leftValue": "={{ $json.template_code }}",
                "rightValue": "SPOTLIGHT",
                "operator": {
                  "type": "string",
                  "operation": "contains"
                }
              }
            ],
            "combinator": "or"
          },
          "options": {}
        },
        "id": "asset-router-001",
        "name": "Route by Template (Asset)",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          6960,
          1056
        ]
      },
      {
        "parameters": {
          "respondWith": "allIncomingItems",
          "options": {}
        },
        "id": "respond-webhook-001",
        "name": "Respond to Webhook",
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.1,
        "position": [
          8528,
          192
        ]
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "=SELECT prompt_content\nFROM industry_prompts ip\nJOIN industries i ON ip.industry_id = i.id\nJOIN clients c ON c.industry_id = i.id\nWHERE c.id = '{{ $('Pass Config').first().json.client_id }}'\nAND ip.template_code = UPPER(REPLACE(REPLACE('{{ $('Pass Config').first().json.template_id }}', 'ad-', ''), 'organic-', ''))",
          "options": {}
        },
        "id": "fetch-industry-prompts-001",
        "name": "Fetch Industry Prompts",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          1584,
          720
        ],
        "credentials": {
          "postgres": {
            "id": "3XsWrPuEddwVYbGS",
            "name": "Railway Postgres"
          }
        }
      }
    ],
    "connections": {
      "Process Hero Photo for Animation": {
        "main": [
          [
            {
              "node": "If: Needs Background Removed",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Equipment & Build Categories": {
        "main": [
          [
            {
              "node": "Build Photo Categorizer Prompt",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Photo Categorizer Prompt": {
        "main": [
          [
            {
              "node": "If: Test, Skip Categorization",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Feature Identifier Prompts": {
        "main": [
          [
            {
              "node": "If: Test, Skip Feature Identification",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Script Prompt TEMP_001": {
        "main": [
          [
            {
              "node": "Aggregate: All Configs",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Script Prompt TEMP_002": {
        "main": [
          [
            {
              "node": "Aggregate: All Configs",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Script Prompt TEMP_003": {
        "main": [
          [
            {
              "node": "Aggregate: All Configs",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge: Config with Inventory": {
        "main": [
          [
            {
              "node": "Fetch Car Info from VINs",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "When Executed by Orchestrate Video Creation": {
        "main": [
          [
            {
              "node": "Pass Config",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Format Script Creation Errors": {
        "main": [
          [
            {
              "node": "Prep: Error Email",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If: Template ID": {
        "main": [
          [
            {
              "node": "API: Sheets, Fetch Inventory",
              "type": "main",
              "index": 0
            },
            {
              "node": "Merge: Config with Inventory",
              "type": "main",
              "index": 1
            }
          ],
          [
            {
              "node": "Build Script Prompt TEMP_003",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If: Feature Photos": {
        "main": [
          [
            {
              "node": "Parse Equipment & Build Categories",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Build Script Prompt TEMP_001",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If: Test, Skip Categorization": {
        "main": [
          [
            {
              "node": "Skip Categorization",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "API: Claude, Categorize Photos",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If: Test, Skip Feature Identification": {
        "main": [
          [
            {
              "node": "Skip Feature Identification",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "API: Claude, Feature Identification",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If: Needs Background Removed": {
        "main": [
          [
            {
              "node": "Prep: Remove BG",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Build Script Prompt TEMP_002",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Combine Spreadsheet Data": {
        "main": [
          [
            {
              "node": "Merge: Config with Inventory",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Car Info from VINs": {
        "main": [
          [
            {
              "node": "Enrich Vehicle Features",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Skip Categorization": {
        "main": [
          [
            {
              "node": "Parse Catagorization Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Catagorization Response": {
        "main": [
          [
            {
              "node": "Build Feature Identifier Prompts",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "API: Claude, Categorize Photos": {
        "main": [
          [
            {
              "node": "Parse Catagorization Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "API: Sheets, Fetch Inventory": {
        "main": [
          [
            {
              "node": "Combine Spreadsheet Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Skip Feature Identification": {
        "main": [
          [
            {
              "node": "Parse Feature Identification Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "API: Claude, Feature Identification": {
        "main": [
          [
            {
              "node": "Parse Feature Identification Response",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Format Script Creation Errors",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Rename Binary": {
        "main": [
          [
            {
              "node": "API: Coudinary, Upload",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "API: Coudinary, Upload": {
        "main": [
          [
            {
              "node": "Update Hero URL",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Format Script Creation Errors",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update Hero URL": {
        "main": [
          [
            {
              "node": "Build Script Prompt TEMP_002",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "API: Claude, Script Generation": {
        "main": [
          [
            {
              "node": "Parse Script Generation",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Format Script Creation Errors",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If: Test, Skip Script Generation": {
        "main": [
          [
            {
              "node": "Skip Script Generation",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "API: Claude, Script Generation",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Skip Script Generation": {
        "main": [
          [
            {
              "node": "Parse Script Generation",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Script Generation": {
        "main": [
          [
            {
              "node": "Respond to Webhook",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Aggregate: All Configs": {
        "main": [
          [
            {
              "node": "Post Agg Parse",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Feature Identification Response": {
        "main": [
          [
            {
              "node": "Process Hero Photo for Animation",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Post Agg Parse": {
        "main": [
          [
            {
              "node": "If: Test, Skip Script Generation",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Pass Config": {
        "main": [
          [
            {
              "node": "Fetch Client Prompts",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prep: Error Email": {
        "main": [
          [
            {
              "node": "Call: Email Error",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Call: Email Error": {
        "main": [
          [
            {
              "node": "Stop and Error",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prep: Remove BG": {
        "main": [
          [
            {
              "node": "Call: Remove Background",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Call: Remove Background": {
        "main": [
          [
            {
              "node": "Rename Binary",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Format Script Creation Errors",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Client Prompts": {
        "main": [
          [
            {
              "node": "Fetch Industry Config",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Assemble System Prompt": {
        "main": [
          [
            {
              "node": "Prepare Script Context",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Script Context": {
        "main": [
          [
            {
              "node": "If: Template ID",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Industry Config": {
        "main": [
          [
            {
              "node": "Fetch Timing Defaults",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Timing Defaults": {
        "main": [
          [
            {
              "node": "Fetch Template Config",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Template Config": {
        "main": [
          [
            {
              "node": "Fetch Industry Prompts",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Enrich Vehicle Features": {
        "main": [
          [
            {
              "node": "If: Feature Photos",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook: Generate from Asset": {
        "main": [
          [
            {
              "node": "Fetch Processed Asset",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Processed Asset": {
        "main": [
          [
            {
              "node": "Fetch Timing for Asset",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Timing for Asset": {
        "main": [
          [
            {
              "node": "Prepare Script Context (Asset)",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Script Context (Asset)": {
        "main": [
          [
            {
              "node": "Route by Template (Asset)",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Route by Template (Asset)": {
        "main": [
          [
            {
              "node": "Build Script Prompt TEMP_001",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Build Script Prompt TEMP_003",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Industry Prompts": {
        "main": [
          [
            {
              "node": "Assemble System Prompt",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Kelly Knight",
    "name": "Version 7ff2478c",
    "description": "",
    "autosaved": true
  },
  "tags": []
}