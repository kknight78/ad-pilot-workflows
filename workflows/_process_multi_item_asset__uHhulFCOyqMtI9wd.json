{
  "updatedAt": "2026-01-21T23:10:10.013Z",
  "createdAt": "2026-01-21T22:10:59.608Z",
  "id": "uHhulFCOyqMtI9wd",
  "name": "[Process Multi-Item Asset]",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "process-multi-item-asset",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-001",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        240,
        300
      ],
      "webhookId": "process-multi-item-001"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT\n  a.*,\n  p.theme_seed,\n  p.theme_emoji,\n  p.theme_direction,\n  p.local_override_text\nFROM assets a\nJOIN weekly_plans p ON a.plan_id = p.id\nWHERE a.id = '{{ $json.body.asset_id }}'",
        "options": {}
      },
      "id": "fetch-asset-001",
      "name": "Fetch Asset + Plan",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        460,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "3XsWrPuEddwVYbGS",
          "name": "Railway Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const asset = $input.first().json;\n\n// Parse inventory_items if it's a string\nlet inventoryItems = asset.inventory_items;\nif (typeof inventoryItems === 'string') {\n  inventoryItems = JSON.parse(inventoryItems);\n}\n\n// Extract item IDs\nconst itemIds = inventoryItems.map(item => item.id);\n\nconsole.log('Asset ID:', asset.id);\nconsole.log('Item IDs:', itemIds);\nconsole.log('Theme seed:', asset.theme_seed);\n\nreturn [{\n  json: {\n    asset,\n    itemIds,\n    inventoryItems\n  }\n}];"
      },
      "id": "extract-items-001",
      "name": "Extract Item IDs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        680,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  v.*,\n  (SELECT url FROM inventory_images i WHERE i.item_id = v.item_id AND i.is_primary = true LIMIT 1) as primary_image_url,\n  (SELECT url FROM inventory_images i WHERE i.item_id = v.item_id ORDER BY sort_order LIMIT 1) as first_image_url\nFROM inventory_vehicles v\nWHERE v.item_id = ANY(ARRAY[{{ $json.itemIds.map(id => `'${id}'`).join(',') }}]::uuid[])",
        "options": {}
      },
      "id": "fetch-vehicles-001",
      "name": "Fetch Vehicle Data",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        900,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "3XsWrPuEddwVYbGS",
          "name": "Railway Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $('Extract Item IDs').first().json;\nconst asset = input.asset;\nconst inventoryItems = input.inventoryItems;\nconst vehicles = $input.all().map(item => item.json);\n\n// Helper: Calculate mileage category\nfunction calculateMileageCategory(year, mileage) {\n  const currentYear = new Date().getFullYear();\n  const age = currentYear - year;\n  const avgMilesPerYear = 12000;\n  const expectedMiles = age * avgMilesPerYear;\n  \n  if (expectedMiles === 0) return 'new';\n  \n  const ratio = mileage / expectedMiles;\n  \n  if (ratio < 0.7) return 'low_for_age';\n  if (ratio > 1.3) return 'high_for_age';\n  return 'average';\n}\n\n// Helper: Summarize equipment into categories\nfunction summarizeEquipment(features) {\n  if (!features || !features[0]) return {};\n  \n  const featureList = typeof features[0] === 'string' \n    ? features[0].split('|').map(f => f.trim())\n    : features;\n  \n  const categories = {\n    powertrain: [],\n    comfort: [],\n    tech: [],\n    safety: [],\n    convenience: []\n  };\n  \n  featureList.forEach(f => {\n    const fLower = f.toLowerCase();\n    if (/v\\d|engine|4wd|awd|fwd|hybrid|turbo|ecoboost/i.test(f)) {\n      categories.powertrain.push(f);\n    } else if (/leather|heated|cooled|seat|sunroof|moonroof/i.test(f)) {\n      categories.comfort.push(f);\n    } else if (/nav|bluetooth|radio|sound|infotainment|carplay|android/i.test(f)) {\n      categories.tech.push(f);\n    } else if (/abs|air bag|safety|blind|lane|backup|camera/i.test(f)) {\n      categories.safety.push(f);\n    } else if (/remote|keyless|power window|power door|cruise/i.test(f)) {\n      categories.convenience.push(f);\n    }\n  });\n  \n  return categories;\n}\n\n// Helper: Pick highlight features\nfunction pickHighlights(features, count = 5) {\n  if (!features || !features[0]) return [];\n  \n  const priority = [\n    'leather', 'navigation', 'sunroof', 'moonroof', 'awd', '4wd', 'v8', 'v6',\n    'hybrid', 'heated seats', 'remote start', 'backup camera', 'camera',\n    'bose', 'premium sound', 'carplay', 'android auto', 'bluetooth',\n    'blind spot', 'lane', 'adaptive cruise'\n  ];\n  \n  const featureList = typeof features[0] === 'string'\n    ? features[0].split('|').map(f => f.trim())\n    : features;\n  \n  const highlights = [];\n  \n  for (const p of priority) {\n    if (highlights.length >= count) break;\n    const match = featureList.find(f => f.toLowerCase().includes(p));\n    if (match && !highlights.includes(match)) {\n      highlights.push(match);\n    }\n  }\n  \n  return highlights;\n}\n\n// Process each vehicle\nconst processedItems = vehicles.map(vehicle => {\n  // Find sort_order from inventory_items\n  const inventoryItem = inventoryItems.find(i => i.id === vehicle.item_id);\n  const sortOrder = inventoryItem?.sort_order ?? 0;\n  \n  return {\n    item_id: vehicle.item_id,\n    vin: vehicle.vin,\n    year: vehicle.year,\n    make: vehicle.make,\n    model: vehicle.model,\n    trim: vehicle.trim,\n    body_style: vehicle.body_style,\n    \n    // From inventory\n    days_on_lot: vehicle.days_on_lot || 0,\n    mileage: vehicle.mileage || 0,\n    price: vehicle.price,\n    \n    // PROCESSED: mileage_category\n    mileage_category: calculateMileageCategory(vehicle.year, vehicle.mileage || 0),\n    \n    // PROCESSED: equipment\n    equipment_summary: summarizeEquipment(vehicle.features),\n    equipment_highlights: pickHighlights(vehicle.features, 5),\n    \n    // Photo URL (skip bg removal for now)\n    photo_url: vehicle.primary_image_url || vehicle.first_image_url || null,\n    \n    // Sort order\n    sort_order: sortOrder\n  };\n});\n\n// Sort by sort_order\nprocessedItems.sort((a, b) => a.sort_order - b.sort_order);\n\nconsole.log('Processed', processedItems.length, 'vehicles');\nprocessedItems.forEach((item, i) => {\n  console.log(`  ${i + 1}. ${item.year} ${item.make} ${item.model} - ${item.mileage_category}, ${item.equipment_highlights.length} highlights`);\n});\n\nreturn [{\n  json: {\n    asset,\n    processedItems\n  }\n}];"
      },
      "id": "process-vehicles-001",
      "name": "Process Vehicles",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const { asset, processedItems } = $input.first().json;\n\n// Build item summary for theme pack\nfunction buildItemSummary(items) {\n  const lines = items.map(item => {\n    const highlights = item.equipment_highlights.slice(0, 3).join(', ');\n    const mileageNote = item.mileage_category === 'low_for_age' ? 'low miles' : \n                        item.mileage_category === 'high_for_age' ? 'higher miles' : '';\n    const daysNote = item.days_on_lot > 60 ? `${item.days_on_lot} days on lot` : '';\n    \n    const notes = [highlights, mileageNote, daysNote].filter(Boolean).join(', ');\n    return `- ${item.year} ${item.make} ${item.model}${notes ? ` (${notes})` : ''}`;\n  });\n  \n  // Add mix summary\n  const bodyTypes = [...new Set(items.map(i => i.body_style || 'vehicle').filter(Boolean))];\n  const avgDaysOnLot = Math.round(items.reduce((sum, i) => sum + (i.days_on_lot || 0), 0) / items.length);\n  \n  return `${items.length} vehicles this week:\\n${lines.join('\\n')}\\n\\nMix: ${bodyTypes.join(', ') || 'mixed'}.${avgDaysOnLot > 0 ? ` Avg ${avgDaysOnLot} days on lot.` : ''}`;\n}\n\nconst itemSummary = buildItemSummary(processedItems);\n\n// Get current date info\nconst now = new Date();\nconst monthNames = ['January', 'February', 'March', 'April', 'May', 'June', \n                    'July', 'August', 'September', 'October', 'November', 'December'];\n\nconsole.log('Item summary for theme pack:');\nconsole.log(itemSummary);\n\nreturn [{\n  json: {\n    asset,\n    processedItems,\n    themePackRequest: {\n      mode: 'pack',\n      theme_seed: asset.theme_seed,\n      emoji: asset.theme_emoji,\n      direction: asset.theme_direction,\n      local_override_text: asset.local_override_text || null,\n      location: 'Rantoul, Illinois',\n      current_date: now.toISOString().split('T')[0],\n      current_month: monthNames[now.getMonth()],\n      item_summary: itemSummary\n    }\n  }\n}];"
      },
      "id": "build-summary-001",
      "name": "Build Item Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1340,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ad-pilot-n8n-production.up.railway.app/webhook/thematic-pack-generate",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.themePackRequest }}",
        "options": {}
      },
      "id": "generate-theme-001",
      "name": "Generate Theme Pack",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1560,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const prevData = $('Build Item Summary').first().json;\nconst themePackResponse = $input.first().json;\n\nconsole.log('Theme pack response:', JSON.stringify(themePackResponse));\n\n// Extract theme pack from response\nlet themePack = null;\nif (themePackResponse.success && themePackResponse.theme_pack) {\n  themePack = themePackResponse.theme_pack;\n} else if (themePackResponse.theme_pack) {\n  themePack = themePackResponse.theme_pack;\n} else {\n  // The response might BE the theme pack\n  themePack = themePackResponse;\n}\n\nreturn [{\n  json: {\n    asset_id: prevData.asset.id,\n    processed_items: prevData.processedItems,\n    theme_pack: themePack\n  }\n}];"
      },
      "id": "prepare-save-001",
      "name": "Prepare Save Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1780,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE assets SET\n  processed_items = $${{ JSON.stringify($json.processed_items) }}$$::jsonb,\n  theme_pack = $${{ JSON.stringify($json.theme_pack) }}$$::jsonb,\n  processing_status = 'complete',\n  processed_at = NOW(),\n  updated_at = NOW()\nWHERE id = '{{ $json.asset_id }}'\nRETURNING id, processing_status",
        "options": {}
      },
      "id": "save-asset-001",
      "name": "Save to Asset",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        2000,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "3XsWrPuEddwVYbGS",
          "name": "Railway Postgres"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, asset_id: $('Prepare Save Data').first().json.asset_id, status: 'complete', items_processed: $('Prepare Save Data').first().json.processed_items.length, theme_pack_generated: $('Prepare Save Data').first().json.theme_pack !== null } }}"
      },
      "id": "respond-001",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        2220,
        300
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Fetch Asset + Plan",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Asset + Plan": {
      "main": [
        [
          {
            "node": "Extract Item IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Item IDs": {
      "main": [
        [
          {
            "node": "Fetch Vehicle Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Vehicle Data": {
      "main": [
        [
          {
            "node": "Process Vehicles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Vehicles": {
      "main": [
        [
          {
            "node": "Build Item Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Item Summary": {
      "main": [
        [
          {
            "node": "Generate Theme Pack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Theme Pack": {
      "main": [
        [
          {
            "node": "Prepare Save Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Save Data": {
      "main": [
        [
          {
            "node": "Save to Asset",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Asset": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": null,
  "versionId": "334b4e9a-6764-43d2-ae38-82c915838d68",
  "activeVersionId": "334b4e9a-6764-43d2-ae38-82c915838d68",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2026-01-21T22:10:59.608Z",
      "createdAt": "2026-01-21T22:10:59.608Z",
      "role": "workflow:owner",
      "workflowId": "uHhulFCOyqMtI9wd",
      "projectId": "VF66NQc9R74tCdyG"
    }
  ],
  "activeVersion": {
    "updatedAt": "2026-01-21T23:10:10.016Z",
    "createdAt": "2026-01-21T23:10:10.016Z",
    "versionId": "334b4e9a-6764-43d2-ae38-82c915838d68",
    "workflowId": "uHhulFCOyqMtI9wd",
    "nodes": [
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "process-multi-item-asset",
          "responseMode": "responseNode",
          "options": {}
        },
        "id": "webhook-001",
        "name": "Webhook",
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          240,
          300
        ],
        "webhookId": "process-multi-item-001"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "=SELECT\n  a.*,\n  p.theme_seed,\n  p.theme_emoji,\n  p.theme_direction,\n  p.local_override_text\nFROM assets a\nJOIN weekly_plans p ON a.plan_id = p.id\nWHERE a.id = '{{ $json.body.asset_id }}'",
          "options": {}
        },
        "id": "fetch-asset-001",
        "name": "Fetch Asset + Plan",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          460,
          300
        ],
        "credentials": {
          "postgres": {
            "id": "3XsWrPuEddwVYbGS",
            "name": "Railway Postgres"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const asset = $input.first().json;\n\n// Parse inventory_items if it's a string\nlet inventoryItems = asset.inventory_items;\nif (typeof inventoryItems === 'string') {\n  inventoryItems = JSON.parse(inventoryItems);\n}\n\n// Extract item IDs\nconst itemIds = inventoryItems.map(item => item.id);\n\nconsole.log('Asset ID:', asset.id);\nconsole.log('Item IDs:', itemIds);\nconsole.log('Theme seed:', asset.theme_seed);\n\nreturn [{\n  json: {\n    asset,\n    itemIds,\n    inventoryItems\n  }\n}];"
        },
        "id": "extract-items-001",
        "name": "Extract Item IDs",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          680,
          300
        ]
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "=SELECT \n  v.*,\n  (SELECT url FROM inventory_images i WHERE i.item_id = v.item_id AND i.is_primary = true LIMIT 1) as primary_image_url,\n  (SELECT url FROM inventory_images i WHERE i.item_id = v.item_id ORDER BY sort_order LIMIT 1) as first_image_url\nFROM inventory_vehicles v\nWHERE v.item_id = ANY(ARRAY[{{ $json.itemIds.map(id => `'${id}'`).join(',') }}]::uuid[])",
          "options": {}
        },
        "id": "fetch-vehicles-001",
        "name": "Fetch Vehicle Data",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          900,
          300
        ],
        "credentials": {
          "postgres": {
            "id": "3XsWrPuEddwVYbGS",
            "name": "Railway Postgres"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const input = $('Extract Item IDs').first().json;\nconst asset = input.asset;\nconst inventoryItems = input.inventoryItems;\nconst vehicles = $input.all().map(item => item.json);\n\n// Helper: Calculate mileage category\nfunction calculateMileageCategory(year, mileage) {\n  const currentYear = new Date().getFullYear();\n  const age = currentYear - year;\n  const avgMilesPerYear = 12000;\n  const expectedMiles = age * avgMilesPerYear;\n  \n  if (expectedMiles === 0) return 'new';\n  \n  const ratio = mileage / expectedMiles;\n  \n  if (ratio < 0.7) return 'low_for_age';\n  if (ratio > 1.3) return 'high_for_age';\n  return 'average';\n}\n\n// Helper: Summarize equipment into categories\nfunction summarizeEquipment(features) {\n  if (!features || !features[0]) return {};\n  \n  const featureList = typeof features[0] === 'string' \n    ? features[0].split('|').map(f => f.trim())\n    : features;\n  \n  const categories = {\n    powertrain: [],\n    comfort: [],\n    tech: [],\n    safety: [],\n    convenience: []\n  };\n  \n  featureList.forEach(f => {\n    const fLower = f.toLowerCase();\n    if (/v\\d|engine|4wd|awd|fwd|hybrid|turbo|ecoboost/i.test(f)) {\n      categories.powertrain.push(f);\n    } else if (/leather|heated|cooled|seat|sunroof|moonroof/i.test(f)) {\n      categories.comfort.push(f);\n    } else if (/nav|bluetooth|radio|sound|infotainment|carplay|android/i.test(f)) {\n      categories.tech.push(f);\n    } else if (/abs|air bag|safety|blind|lane|backup|camera/i.test(f)) {\n      categories.safety.push(f);\n    } else if (/remote|keyless|power window|power door|cruise/i.test(f)) {\n      categories.convenience.push(f);\n    }\n  });\n  \n  return categories;\n}\n\n// Helper: Pick highlight features\nfunction pickHighlights(features, count = 5) {\n  if (!features || !features[0]) return [];\n  \n  const priority = [\n    'leather', 'navigation', 'sunroof', 'moonroof', 'awd', '4wd', 'v8', 'v6',\n    'hybrid', 'heated seats', 'remote start', 'backup camera', 'camera',\n    'bose', 'premium sound', 'carplay', 'android auto', 'bluetooth',\n    'blind spot', 'lane', 'adaptive cruise'\n  ];\n  \n  const featureList = typeof features[0] === 'string'\n    ? features[0].split('|').map(f => f.trim())\n    : features;\n  \n  const highlights = [];\n  \n  for (const p of priority) {\n    if (highlights.length >= count) break;\n    const match = featureList.find(f => f.toLowerCase().includes(p));\n    if (match && !highlights.includes(match)) {\n      highlights.push(match);\n    }\n  }\n  \n  return highlights;\n}\n\n// Process each vehicle\nconst processedItems = vehicles.map(vehicle => {\n  // Find sort_order from inventory_items\n  const inventoryItem = inventoryItems.find(i => i.id === vehicle.item_id);\n  const sortOrder = inventoryItem?.sort_order ?? 0;\n  \n  return {\n    item_id: vehicle.item_id,\n    vin: vehicle.vin,\n    year: vehicle.year,\n    make: vehicle.make,\n    model: vehicle.model,\n    trim: vehicle.trim,\n    body_style: vehicle.body_style,\n    \n    // From inventory\n    days_on_lot: vehicle.days_on_lot || 0,\n    mileage: vehicle.mileage || 0,\n    price: vehicle.price,\n    \n    // PROCESSED: mileage_category\n    mileage_category: calculateMileageCategory(vehicle.year, vehicle.mileage || 0),\n    \n    // PROCESSED: equipment\n    equipment_summary: summarizeEquipment(vehicle.features),\n    equipment_highlights: pickHighlights(vehicle.features, 5),\n    \n    // Photo URL (skip bg removal for now)\n    photo_url: vehicle.primary_image_url || vehicle.first_image_url || null,\n    \n    // Sort order\n    sort_order: sortOrder\n  };\n});\n\n// Sort by sort_order\nprocessedItems.sort((a, b) => a.sort_order - b.sort_order);\n\nconsole.log('Processed', processedItems.length, 'vehicles');\nprocessedItems.forEach((item, i) => {\n  console.log(`  ${i + 1}. ${item.year} ${item.make} ${item.model} - ${item.mileage_category}, ${item.equipment_highlights.length} highlights`);\n});\n\nreturn [{\n  json: {\n    asset,\n    processedItems\n  }\n}];"
        },
        "id": "process-vehicles-001",
        "name": "Process Vehicles",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1120,
          300
        ]
      },
      {
        "parameters": {
          "jsCode": "const { asset, processedItems } = $input.first().json;\n\n// Build item summary for theme pack\nfunction buildItemSummary(items) {\n  const lines = items.map(item => {\n    const highlights = item.equipment_highlights.slice(0, 3).join(', ');\n    const mileageNote = item.mileage_category === 'low_for_age' ? 'low miles' : \n                        item.mileage_category === 'high_for_age' ? 'higher miles' : '';\n    const daysNote = item.days_on_lot > 60 ? `${item.days_on_lot} days on lot` : '';\n    \n    const notes = [highlights, mileageNote, daysNote].filter(Boolean).join(', ');\n    return `- ${item.year} ${item.make} ${item.model}${notes ? ` (${notes})` : ''}`;\n  });\n  \n  // Add mix summary\n  const bodyTypes = [...new Set(items.map(i => i.body_style || 'vehicle').filter(Boolean))];\n  const avgDaysOnLot = Math.round(items.reduce((sum, i) => sum + (i.days_on_lot || 0), 0) / items.length);\n  \n  return `${items.length} vehicles this week:\\n${lines.join('\\n')}\\n\\nMix: ${bodyTypes.join(', ') || 'mixed'}.${avgDaysOnLot > 0 ? ` Avg ${avgDaysOnLot} days on lot.` : ''}`;\n}\n\nconst itemSummary = buildItemSummary(processedItems);\n\n// Get current date info\nconst now = new Date();\nconst monthNames = ['January', 'February', 'March', 'April', 'May', 'June', \n                    'July', 'August', 'September', 'October', 'November', 'December'];\n\nconsole.log('Item summary for theme pack:');\nconsole.log(itemSummary);\n\nreturn [{\n  json: {\n    asset,\n    processedItems,\n    themePackRequest: {\n      mode: 'pack',\n      theme_seed: asset.theme_seed,\n      emoji: asset.theme_emoji,\n      direction: asset.theme_direction,\n      local_override_text: asset.local_override_text || null,\n      location: 'Rantoul, Illinois',\n      current_date: now.toISOString().split('T')[0],\n      current_month: monthNames[now.getMonth()],\n      item_summary: itemSummary\n    }\n  }\n}];"
        },
        "id": "build-summary-001",
        "name": "Build Item Summary",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1340,
          300
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://ad-pilot-n8n-production.up.railway.app/webhook/thematic-pack-generate",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ $json.themePackRequest }}",
          "options": {}
        },
        "id": "generate-theme-001",
        "name": "Generate Theme Pack",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          1560,
          300
        ]
      },
      {
        "parameters": {
          "jsCode": "const prevData = $('Build Item Summary').first().json;\nconst themePackResponse = $input.first().json;\n\nconsole.log('Theme pack response:', JSON.stringify(themePackResponse));\n\n// Extract theme pack from response\nlet themePack = null;\nif (themePackResponse.success && themePackResponse.theme_pack) {\n  themePack = themePackResponse.theme_pack;\n} else if (themePackResponse.theme_pack) {\n  themePack = themePackResponse.theme_pack;\n} else {\n  // The response might BE the theme pack\n  themePack = themePackResponse;\n}\n\nreturn [{\n  json: {\n    asset_id: prevData.asset.id,\n    processed_items: prevData.processedItems,\n    theme_pack: themePack\n  }\n}];"
        },
        "id": "prepare-save-001",
        "name": "Prepare Save Data",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1780,
          300
        ]
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "=UPDATE assets SET\n  processed_items = $${{ JSON.stringify($json.processed_items) }}$$::jsonb,\n  theme_pack = $${{ JSON.stringify($json.theme_pack) }}$$::jsonb,\n  processing_status = 'complete',\n  processed_at = NOW(),\n  updated_at = NOW()\nWHERE id = '{{ $json.asset_id }}'\nRETURNING id, processing_status",
          "options": {}
        },
        "id": "save-asset-001",
        "name": "Save to Asset",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.5,
        "position": [
          2000,
          300
        ],
        "credentials": {
          "postgres": {
            "id": "3XsWrPuEddwVYbGS",
            "name": "Railway Postgres"
          }
        }
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={{ { success: true, asset_id: $('Prepare Save Data').first().json.asset_id, status: 'complete', items_processed: $('Prepare Save Data').first().json.processed_items.length, theme_pack_generated: $('Prepare Save Data').first().json.theme_pack !== null } }}"
        },
        "id": "respond-001",
        "name": "Respond Success",
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.1,
        "position": [
          2220,
          300
        ]
      }
    ],
    "connections": {
      "Webhook": {
        "main": [
          [
            {
              "node": "Fetch Asset + Plan",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Asset + Plan": {
        "main": [
          [
            {
              "node": "Extract Item IDs",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract Item IDs": {
        "main": [
          [
            {
              "node": "Fetch Vehicle Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Vehicle Data": {
        "main": [
          [
            {
              "node": "Process Vehicles",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Process Vehicles": {
        "main": [
          [
            {
              "node": "Build Item Summary",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Item Summary": {
        "main": [
          [
            {
              "node": "Generate Theme Pack",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Generate Theme Pack": {
        "main": [
          [
            {
              "node": "Prepare Save Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Save Data": {
        "main": [
          [
            {
              "node": "Save to Asset",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Save to Asset": {
        "main": [
          [
            {
              "node": "Respond Success",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Kelly Knight",
    "name": null,
    "description": null,
    "autosaved": false
  },
  "tags": []
}