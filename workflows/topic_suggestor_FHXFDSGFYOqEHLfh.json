{
  "updatedAt": "2025-12-29T05:39:50.114Z",
  "createdAt": "2025-12-13T13:57:21.648Z",
  "id": "FHXFDSGFYOqEHLfh",
  "name": "Topic Suggestor",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "topic-suggest",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "https://demo.ad-pilot.ai"
        }
      },
      "id": "4d220ddd-3b81-4432-aceb-3399e20e279c",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        1456,
        144
      ],
      "webhookId": "topic-suggest"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "length_label",
              "name": "length_label",
              "value": "={{ $json.body.target_length === 'brief_15_30' ? 'Brief (15-30 seconds)' : $json.body.target_length === 'standard_30_45' ? 'Standard (30-45 seconds)' : 'Detailed (45-60 seconds)' }}",
              "type": "string"
            },
            {
              "id": "has_guidance",
              "name": "has_guidance",
              "value": "={{ $json.body.topic_guidance.trim().length > 0 }}",
              "type": "boolean"
            },
            {
              "id": "avatar_name",
              "name": "avatar_name",
              "value": "={{ $json.body.avatar_name || 'Shad' }}",
              "type": "string"
            },
            {
              "id": "random_seed",
              "name": "random_seed",
              "value": "={{ Math.random() }}",
              "type": "number"
            },
            {
              "id": "6e8cee15-ea70-4f20-b060-2403b70021b6",
              "name": "topic_guidance",
              "value": "={{ $json.body.topic_guidance.trim() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "ec008868-568e-42df-b856-5ba955cb8c95",
      "name": "Parse Request",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        1680,
        144
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prompt",
              "name": "prompt",
              "value": "=You are a short-form video content strategist for Capitol Car Credit, a used car dealership in Rantoul, Illinois.\n\nGenerate 3 educational video topic ideas for the \"Capitol Smarts\" series featuring {{ $json.avatar_name }}, presented in {{ $('Parse Request').item.json.length_label }} format.\n\nCurrent month: {{ $json.current_month }}\n\n**NON-NEGOTIABLES (read carefully):**\n- Must be genuinely helpful and educational (not salesy)\n- Should establish {{ $json.avatar_name }} as a trusted local expert WITH OPINIONS\n- DO NOT include \"Capitol Smarts:\" prefix in your topics\n- DO NOT include time durations like \"(45 seconds)\" in your topics\n- Make topics feel authentic, conversational, and confident (not corporate)\nDO NOT generate neutral, blog-style, or tutorial-style titles. Every topic must imply a mistake, myth, loss, or consequence if ignored.\n\n**CRITICAL: SCROLL-STOPPER FRAMING**\nYour topics must be phrased to STOP SCROLLING. Avoid neutral “how-to” titles.\nEach topic MUST include at least ONE of these scroll-stopper angles:\n- A costly mistake (“Most people ruin…”, “Stop doing…”, “This costs you…”)\n- A myth / misconception (“The biggest myth about…”, “You’ve been told…”)\n- A hidden risk / red flag (“Don’t miss this when…”, “If you see this, walk away…”)\n- A surprising rule / shortcut (“Do THIS first…”, “One quick check that saves you…”)\n- A clear payoff (“3 ways to boost your trade-in…”, “2 things that fix this fast…”)\n- Each topic must imply a consequence if the advice is ignored (money lost, safety risk, wasted time, regret).\n\n**WRITING STYLE RULES**\n- Short, punchy, high-clarity phrases\n- Prefer statements over questions\n- If you use a question, it must imply loss, regret, money, or risk\n- Avoid bland openers like “Quick Tip:” unless the rest is punchy\n- Avoid being “balanced”; take a stance\n- DO NOT start topics with “Quick Tip:”\n\n**Video length guidelines:**\n{{ $json.target_length === 'brief_15_30' ? '- Brief (15-30 sec): ONE bold claim + 1-2 supporting points, \"stop doing X, do Y\" style' : '' }}\n{{ $json.target_length === 'standard_30_45' ? '- Standard (30-45 sec): Top 3 lists, comparisons, process explanations WITH a mistake/myth framing' : '' }}\n{{ $json.target_length === 'detailed_45_60' ? '- Detailed (45-60 sec): Step-by-step how-to that starts with the common mistake people make' : '' }}\n\n{{ $json.has_guidance ? '**CRITICAL INSTRUCTION: FOLLOW USER GUIDANCE**\\n\\nThe user wants topics about: \"' + $json.topic_guidance + '\"\\n\\nYour 3 topics MUST be directly related to \"' + $json.topic_guidance + '\" AND must use the scroll-stopper framing above.\\n\\nExamples of following guidance correctly:\\n\\nExample 1:\\nUser guidance: \"first car\"\\nGOOD topics: [\"Most first-time buyers forget this one document\", \"First car financing myth that costs you money\", \"3 rookie mistakes that make you overpay on your first car\"]\\nBAD topics: [\"Extended warranties\", \"Trade-in values\"] ❌ Not about first cars\\n\\nExample 2:\\nUser guidance: \"holiday driving\"\\nGOOD topics: [\"Don’t start a road trip without checking this\", \"Winter road trip myth that leaves you stranded\", \"3 emergency kit items that actually matter\"]\\nBAD topics: [\"Credit scores\", \"Dashboard lights\"] ❌ Not about holiday driving\\n\\nExample 3:\\nUser guidance: \"vehicle maintenance\"\\nGOOD topics: [\"This maintenance delay gets expensive fast\", \"The oil change myth that ruins engines\", \"3 warning signs your brakes are done\"]\\nBAD topics: [\"Financing tips\", \"Negotiating prices\"] ❌ Not maintenance\\n\\n**NOW IT\\'S YOUR TURN:**\\nUser guidance: \"' + $json.topic_guidance + '\"\\nAll 3 topics must match that guidance and use mistake/myth/risk/payoff framing.\\nDo NOT generate unrelated categories.' : '**GENERATE DIVERSE TOPICS**\\n\\nSince no specific guidance was provided, create 3 VARIED topics covering DIFFERENT categories.\\n\\n**Diversity rule (required):**\\n- Topic 1: Money/value/cost (save money, avoid overpaying, boost trade-in, payment pitfalls)\\n- Topic 2: Safety/risk (family safety, red flags, what can go wrong, avoid getting stranded)\\n- Topic 3: Inspection/maintenance/troubleshooting (what to check, strange noises, quick tests)\\n\\nMaximum 1 seasonal topic tied to ' + $json.current_month + '.\\n\\nPossible categories:\\n- Car buying education (financing, trade-ins, negotiating)\\n- Used car inspection tips (red flags, test drive checks)\\n- Seasonal maintenance (timely for ' + $json.current_month + ')\\n- DIY troubleshooting (noises, won\\'t start, battery issues, fluid leaks)\\n- Expert opinions framed as myths/mistakes (warranties, new vs used)\\n- Safety & family concerns (car seats, reliability, safe features)\\n\\nIMPORTANT: The 3 topics must be clearly different from each other and all must use scroll-stopper framing.' }}\n\n**Output format:**\nReturn ONLY a valid JSON array of exactly 3 topic strings. No markdown, no explanations.\n\nExample: [\"Topic 1\", \"Topic 2\", \"Topic 3\"]\n\n{{ $json.has_guidance ? 'REMINDER: All 3 topics must relate to: \"' + $json.topic_guidance + '\" and must use mistake/myth/risk/payoff framing' : 'REMINDER: 3 different categories (money, safety, inspection/maintenance) and all must be scroll-stoppers' }}\n\nGenerate now:",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "3a6b36df-c983-4ceb-8861-9fb3343030ac",
      "name": "Build Prompt",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        1904,
        144
      ]
    },
    {
      "parameters": {
        "jsCode": "// Extract the response text from OpenAI\nconst geminiResponse = $input.item.json.candidates[0].content.parts[0].text\n\n// Try to parse as JSON array\nlet suggestions;\ntry {\n  // Remove any markdown code blocks if present\n  let cleanedResponse = geminiResponse.trim();\n  if (cleanedResponse.startsWith('```json')) {\n    cleanedResponse = cleanedResponse.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  } else if (cleanedResponse.startsWith('```')) {\n    cleanedResponse = cleanedResponse.replace(/```\\n?/g, '').trim();\n  }\n  \n  suggestions = JSON.parse(cleanedResponse);\n  \n  // Ensure it's an array of 3 strings\n  if (!Array.isArray(suggestions) || suggestions.length !== 3) {\n    throw new Error('Invalid response format');\n  }\n  \n  // Clean up suggestions: remove \"Capitol Smarts:\" prefix and time durations\n  suggestions = suggestions.map(topic => {\n    let cleaned = topic.trim();\n    // Remove \"Capitol Smarts:\" prefix (case insensitive)\n    cleaned = cleaned.replace(/^Capitol Smarts:\\s*/i, '');\n    // Remove time durations like \"(45 seconds)\" or \"(45-60 sec)\"\n    cleaned = cleaned.replace(/\\s*\\([\\d\\-]+\\s*(sec|seconds|min|minutes)\\)/gi, '');\n    return cleaned.trim();\n  });\n  \n} catch (error) {\n  // Fallback: try to extract topics manually\n  const lines = geminiResponse.split('\\n').filter(line => line.trim().length > 0);\n  suggestions = lines.slice(0, 3).map(line => {\n    // Remove leading numbers, bullets, quotes, \"Capitol Smarts:\"\n    let cleaned = line.replace(/^[\\d\\-\\*\\.\\\"\\']\\s*/, '').replace(/[\\\"\\']\\s*$/, '').trim();\n    cleaned = cleaned.replace(/^Capitol Smarts:\\s*/i, '');\n    cleaned = cleaned.replace(/\\s*\\([\\d\\-]+\\s*(sec|seconds|min|minutes)\\)/gi, '');\n    return cleaned.trim();\n  });\n  \n  // Ensure we have exactly 3\n  while (suggestions.length < 3) {\n    suggestions.push(`Topic suggestion ${suggestions.length + 1}`);\n  }\n  suggestions = suggestions.slice(0, 3);\n}\n\nreturn { suggestions };"
      },
      "id": "1c8153f6-3cf0-4035-88e7-7e26359749c6",
      "name": "Parse Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2352,
        144
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, suggestions: $json.suggestions } }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              },
              {
                "name": "Cache-Control",
                "value": "no-cache, no-store, must-revalidate"
              },
              {
                "name": "Pragma",
                "value": "no-cache"
              },
              {
                "name": "Expires",
                "value": "0"
              }
            ]
          }
        }
      },
      "id": "5ae8fe25-137a-4ef2-a8be-588c66687314",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        2576,
        144
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: false, error: 'Failed to generate suggestions', message: $json.error?.message || 'Unknown error' } }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Cache-Control",
                "value": "no-cache"
              }
            ]
          }
        }
      },
      "id": "96a077d8-6856-4c1c-b697-95ed0def4a76",
      "name": "Respond Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1456,
        368
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "=AIzaSyBFB8rHuBXVA3xPyWat-_vOoq30EP3-0io"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "contents[0].parts[0].text",
              "value": "={{ $json.prompt }}"
            },
            {
              "name": "generationConfig.temperature",
              "value": "0.95"
            },
            {
              "name": "generationConfig.topP",
              "value": "0.95"
            },
            {
              "name": "generationConfig.maxOutputTokens",
              "value": "500"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "62d3b69c-eb72-4591-91ad-047f3c6c8b78",
      "name": "Gemini API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2128,
        144
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "prVNksIVEgzVrhKB",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Parse Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Request": {
      "main": [
        [
          {
            "node": "Build Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Prompt": {
      "main": [
        [
          {
            "node": "Gemini API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Response": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini API": {
      "main": [
        [
          {
            "node": "Parse Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "a9dd2a54-c405-48da-83b9-154952573443",
  "activeVersionId": "a9dd2a54-c405-48da-83b9-154952573443",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-12-13T13:57:21.648Z",
      "createdAt": "2025-12-13T13:57:21.648Z",
      "role": "workflow:owner",
      "workflowId": "FHXFDSGFYOqEHLfh",
      "projectId": "VF66NQc9R74tCdyG"
    }
  ],
  "activeVersion": {
    "updatedAt": "2025-12-29T05:39:50.119Z",
    "createdAt": "2025-12-29T05:39:50.119Z",
    "versionId": "a9dd2a54-c405-48da-83b9-154952573443",
    "workflowId": "FHXFDSGFYOqEHLfh",
    "nodes": [
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "topic-suggest",
          "responseMode": "responseNode",
          "options": {
            "allowedOrigins": "https://demo.ad-pilot.ai"
          }
        },
        "id": "4d220ddd-3b81-4432-aceb-3399e20e279c",
        "name": "Webhook",
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 1.1,
        "position": [
          1456,
          144
        ],
        "webhookId": "topic-suggest"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "length_label",
                "name": "length_label",
                "value": "={{ $json.body.target_length === 'brief_15_30' ? 'Brief (15-30 seconds)' : $json.body.target_length === 'standard_30_45' ? 'Standard (30-45 seconds)' : 'Detailed (45-60 seconds)' }}",
                "type": "string"
              },
              {
                "id": "has_guidance",
                "name": "has_guidance",
                "value": "={{ $json.body.topic_guidance.trim().length > 0 }}",
                "type": "boolean"
              },
              {
                "id": "avatar_name",
                "name": "avatar_name",
                "value": "={{ $json.body.avatar_name || 'Shad' }}",
                "type": "string"
              },
              {
                "id": "random_seed",
                "name": "random_seed",
                "value": "={{ Math.random() }}",
                "type": "number"
              },
              {
                "id": "6e8cee15-ea70-4f20-b060-2403b70021b6",
                "name": "topic_guidance",
                "value": "={{ $json.body.topic_guidance.trim() }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "ec008868-568e-42df-b856-5ba955cb8c95",
        "name": "Parse Request",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          1680,
          144
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "prompt",
                "name": "prompt",
                "value": "=You are a short-form video content strategist for Capitol Car Credit, a used car dealership in Rantoul, Illinois.\n\nGenerate 3 educational video topic ideas for the \"Capitol Smarts\" series featuring {{ $json.avatar_name }}, presented in {{ $('Parse Request').item.json.length_label }} format.\n\nCurrent month: {{ $json.current_month }}\n\n**NON-NEGOTIABLES (read carefully):**\n- Must be genuinely helpful and educational (not salesy)\n- Should establish {{ $json.avatar_name }} as a trusted local expert WITH OPINIONS\n- DO NOT include \"Capitol Smarts:\" prefix in your topics\n- DO NOT include time durations like \"(45 seconds)\" in your topics\n- Make topics feel authentic, conversational, and confident (not corporate)\nDO NOT generate neutral, blog-style, or tutorial-style titles. Every topic must imply a mistake, myth, loss, or consequence if ignored.\n\n**CRITICAL: SCROLL-STOPPER FRAMING**\nYour topics must be phrased to STOP SCROLLING. Avoid neutral “how-to” titles.\nEach topic MUST include at least ONE of these scroll-stopper angles:\n- A costly mistake (“Most people ruin…”, “Stop doing…”, “This costs you…”)\n- A myth / misconception (“The biggest myth about…”, “You’ve been told…”)\n- A hidden risk / red flag (“Don’t miss this when…”, “If you see this, walk away…”)\n- A surprising rule / shortcut (“Do THIS first…”, “One quick check that saves you…”)\n- A clear payoff (“3 ways to boost your trade-in…”, “2 things that fix this fast…”)\n- Each topic must imply a consequence if the advice is ignored (money lost, safety risk, wasted time, regret).\n\n**WRITING STYLE RULES**\n- Short, punchy, high-clarity phrases\n- Prefer statements over questions\n- If you use a question, it must imply loss, regret, money, or risk\n- Avoid bland openers like “Quick Tip:” unless the rest is punchy\n- Avoid being “balanced”; take a stance\n- DO NOT start topics with “Quick Tip:”\n\n**Video length guidelines:**\n{{ $json.target_length === 'brief_15_30' ? '- Brief (15-30 sec): ONE bold claim + 1-2 supporting points, \"stop doing X, do Y\" style' : '' }}\n{{ $json.target_length === 'standard_30_45' ? '- Standard (30-45 sec): Top 3 lists, comparisons, process explanations WITH a mistake/myth framing' : '' }}\n{{ $json.target_length === 'detailed_45_60' ? '- Detailed (45-60 sec): Step-by-step how-to that starts with the common mistake people make' : '' }}\n\n{{ $json.has_guidance ? '**CRITICAL INSTRUCTION: FOLLOW USER GUIDANCE**\\n\\nThe user wants topics about: \"' + $json.topic_guidance + '\"\\n\\nYour 3 topics MUST be directly related to \"' + $json.topic_guidance + '\" AND must use the scroll-stopper framing above.\\n\\nExamples of following guidance correctly:\\n\\nExample 1:\\nUser guidance: \"first car\"\\nGOOD topics: [\"Most first-time buyers forget this one document\", \"First car financing myth that costs you money\", \"3 rookie mistakes that make you overpay on your first car\"]\\nBAD topics: [\"Extended warranties\", \"Trade-in values\"] ❌ Not about first cars\\n\\nExample 2:\\nUser guidance: \"holiday driving\"\\nGOOD topics: [\"Don’t start a road trip without checking this\", \"Winter road trip myth that leaves you stranded\", \"3 emergency kit items that actually matter\"]\\nBAD topics: [\"Credit scores\", \"Dashboard lights\"] ❌ Not about holiday driving\\n\\nExample 3:\\nUser guidance: \"vehicle maintenance\"\\nGOOD topics: [\"This maintenance delay gets expensive fast\", \"The oil change myth that ruins engines\", \"3 warning signs your brakes are done\"]\\nBAD topics: [\"Financing tips\", \"Negotiating prices\"] ❌ Not maintenance\\n\\n**NOW IT\\'S YOUR TURN:**\\nUser guidance: \"' + $json.topic_guidance + '\"\\nAll 3 topics must match that guidance and use mistake/myth/risk/payoff framing.\\nDo NOT generate unrelated categories.' : '**GENERATE DIVERSE TOPICS**\\n\\nSince no specific guidance was provided, create 3 VARIED topics covering DIFFERENT categories.\\n\\n**Diversity rule (required):**\\n- Topic 1: Money/value/cost (save money, avoid overpaying, boost trade-in, payment pitfalls)\\n- Topic 2: Safety/risk (family safety, red flags, what can go wrong, avoid getting stranded)\\n- Topic 3: Inspection/maintenance/troubleshooting (what to check, strange noises, quick tests)\\n\\nMaximum 1 seasonal topic tied to ' + $json.current_month + '.\\n\\nPossible categories:\\n- Car buying education (financing, trade-ins, negotiating)\\n- Used car inspection tips (red flags, test drive checks)\\n- Seasonal maintenance (timely for ' + $json.current_month + ')\\n- DIY troubleshooting (noises, won\\'t start, battery issues, fluid leaks)\\n- Expert opinions framed as myths/mistakes (warranties, new vs used)\\n- Safety & family concerns (car seats, reliability, safe features)\\n\\nIMPORTANT: The 3 topics must be clearly different from each other and all must use scroll-stopper framing.' }}\n\n**Output format:**\nReturn ONLY a valid JSON array of exactly 3 topic strings. No markdown, no explanations.\n\nExample: [\"Topic 1\", \"Topic 2\", \"Topic 3\"]\n\n{{ $json.has_guidance ? 'REMINDER: All 3 topics must relate to: \"' + $json.topic_guidance + '\" and must use mistake/myth/risk/payoff framing' : 'REMINDER: 3 different categories (money, safety, inspection/maintenance) and all must be scroll-stoppers' }}\n\nGenerate now:",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "3a6b36df-c983-4ceb-8861-9fb3343030ac",
        "name": "Build Prompt",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          1904,
          144
        ]
      },
      {
        "parameters": {
          "jsCode": "// Extract the response text from OpenAI\nconst geminiResponse = $input.item.json.candidates[0].content.parts[0].text\n\n// Try to parse as JSON array\nlet suggestions;\ntry {\n  // Remove any markdown code blocks if present\n  let cleanedResponse = geminiResponse.trim();\n  if (cleanedResponse.startsWith('```json')) {\n    cleanedResponse = cleanedResponse.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  } else if (cleanedResponse.startsWith('```')) {\n    cleanedResponse = cleanedResponse.replace(/```\\n?/g, '').trim();\n  }\n  \n  suggestions = JSON.parse(cleanedResponse);\n  \n  // Ensure it's an array of 3 strings\n  if (!Array.isArray(suggestions) || suggestions.length !== 3) {\n    throw new Error('Invalid response format');\n  }\n  \n  // Clean up suggestions: remove \"Capitol Smarts:\" prefix and time durations\n  suggestions = suggestions.map(topic => {\n    let cleaned = topic.trim();\n    // Remove \"Capitol Smarts:\" prefix (case insensitive)\n    cleaned = cleaned.replace(/^Capitol Smarts:\\s*/i, '');\n    // Remove time durations like \"(45 seconds)\" or \"(45-60 sec)\"\n    cleaned = cleaned.replace(/\\s*\\([\\d\\-]+\\s*(sec|seconds|min|minutes)\\)/gi, '');\n    return cleaned.trim();\n  });\n  \n} catch (error) {\n  // Fallback: try to extract topics manually\n  const lines = geminiResponse.split('\\n').filter(line => line.trim().length > 0);\n  suggestions = lines.slice(0, 3).map(line => {\n    // Remove leading numbers, bullets, quotes, \"Capitol Smarts:\"\n    let cleaned = line.replace(/^[\\d\\-\\*\\.\\\"\\']\\s*/, '').replace(/[\\\"\\']\\s*$/, '').trim();\n    cleaned = cleaned.replace(/^Capitol Smarts:\\s*/i, '');\n    cleaned = cleaned.replace(/\\s*\\([\\d\\-]+\\s*(sec|seconds|min|minutes)\\)/gi, '');\n    return cleaned.trim();\n  });\n  \n  // Ensure we have exactly 3\n  while (suggestions.length < 3) {\n    suggestions.push(`Topic suggestion ${suggestions.length + 1}`);\n  }\n  suggestions = suggestions.slice(0, 3);\n}\n\nreturn { suggestions };"
        },
        "id": "1c8153f6-3cf0-4035-88e7-7e26359749c6",
        "name": "Parse Response",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2352,
          144
        ]
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={{ { success: true, suggestions: $json.suggestions } }}",
          "options": {
            "responseHeaders": {
              "entries": [
                {
                  "name": "Access-Control-Allow-Origin",
                  "value": "*"
                },
                {
                  "name": "Access-Control-Allow-Methods",
                  "value": "GET, POST, OPTIONS"
                },
                {
                  "name": "Access-Control-Allow-Headers",
                  "value": "Content-Type"
                },
                {
                  "name": "Cache-Control",
                  "value": "no-cache, no-store, must-revalidate"
                },
                {
                  "name": "Pragma",
                  "value": "no-cache"
                },
                {
                  "name": "Expires",
                  "value": "0"
                }
              ]
            }
          }
        },
        "id": "5ae8fe25-137a-4ef2-a8be-588c66687314",
        "name": "Respond Success",
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.1,
        "position": [
          2576,
          144
        ]
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={{ { success: false, error: 'Failed to generate suggestions', message: $json.error?.message || 'Unknown error' } }}",
          "options": {
            "responseHeaders": {
              "entries": [
                {
                  "name": "Access-Control-Allow-Origin",
                  "value": "*"
                },
                {
                  "name": "Cache-Control",
                  "value": "no-cache"
                }
              ]
            }
          }
        },
        "id": "96a077d8-6856-4c1c-b697-95ed0def4a76",
        "name": "Respond Error",
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.1,
        "position": [
          1456,
          368
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "googlePalmApi",
          "sendQuery": true,
          "queryParameters": {
            "parameters": [
              {
                "name": "key",
                "value": "=AIzaSyBFB8rHuBXVA3xPyWat-_vOoq30EP3-0io"
              }
            ]
          },
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "contents[0].parts[0].text",
                "value": "={{ $json.prompt }}"
              },
              {
                "name": "generationConfig.temperature",
                "value": "0.95"
              },
              {
                "name": "generationConfig.topP",
                "value": "0.95"
              },
              {
                "name": "generationConfig.maxOutputTokens",
                "value": "500"
              }
            ]
          },
          "options": {
            "timeout": 30000
          }
        },
        "id": "62d3b69c-eb72-4591-91ad-047f3c6c8b78",
        "name": "Gemini API",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          2128,
          144
        ],
        "credentials": {
          "googlePalmApi": {
            "id": "prVNksIVEgzVrhKB",
            "name": "Google Gemini(PaLM) Api account"
          }
        }
      }
    ],
    "connections": {
      "Webhook": {
        "main": [
          [
            {
              "node": "Parse Request",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Request": {
        "main": [
          [
            {
              "node": "Build Prompt",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Prompt": {
        "main": [
          [
            {
              "node": "Gemini API",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Response": {
        "main": [
          [
            {
              "node": "Respond Success",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Gemini API": {
        "main": [
          [
            {
              "node": "Parse Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Kelly Knight",
    "name": null,
    "description": null
  },
  "tags": []
}