{
  "updatedAt": "2025-11-25T00:55:31.000Z",
  "createdAt": "2025-10-20T22:01:25.542Z",
  "id": "Z36Cd1XZSVbd1bC3",
  "name": "[04] Ad generation core",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -512,
        -128
      ],
      "id": "febf4365-88f4-4424-a9d1-ab1dafbe1e95",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "jsCode": "const config = $json;\nconst vehicles = config.vehicles || [];\nconst cachedVehicles = [];\nconst needsProcessing = [];\n\n// TEMP_003 skips this, no vehicles required\nfor (const vehicle of vehicles) {\n  const vin = vehicle.vin;\n  \n  if (!vin) {\n    console.log('Vehicle missing VIN, using original');\n    cachedVehicles.push(vehicle);\n    continue;\n  }\n  \n  // Check if bg-removed image exists\n  const bgRemovedUrl = `https://res.cloudinary.com/dtpqxuwby/image/upload/${vin}.png`;\n  \n  try {\n    const response = await this.helpers.httpRequest({\n      method: 'HEAD',\n      url: bgRemovedUrl,\n      returnFullResponse: true,\n      ignoreHttpStatusErrors: true,\n      timeout: 5000\n    });\n    \n    if (response.statusCode === 200) {\n      console.log(`‚úì VIN ${vin}: Found in cache`);\n      vehicle.photo_url = bgRemovedUrl;\n      cachedVehicles.push(vehicle);\n      continue;\n    }\n  } catch (error) {\n    // Not in cache\n  }\n  needsProcessing.push(vehicle);\n}\n\n// Return single item with arrays\nreturn [{\n  json: {\n    ...config,\n    vehicles: vehicles, // ‚Üê Now has updated URLs for cached vehicles\n    vehiclesToProcess: needsProcessing,\n    cachedVehicles: cachedVehicles\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        -128
      ],
      "id": "5ee1ed6d-b685-44f9-8e1f-400d0827b3ef",
      "name": "Process All Vehicles"
    },
    {
      "parameters": {
        "jsCode": "const vehiclesToProcess = $json.vehiclesToProcess || [];\n\nreturn vehiclesToProcess.map(vehicle => ({\n  json: vehicle\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        -144
      ],
      "id": "cabf3be1-d71f-4d05-a6fb-bd60c6480d77",
      "name": "send only vehicles to process"
    },
    {
      "parameters": {
        "jsCode": "const response = $json;\nconst config = $('Aggregate Configs').first().json;\n\nconst videoUrl = response.url;\nconst videoDuration = response.duration;\n\nif (!videoUrl) {\n  throw new Error('Creatomate did not return a video URL');\n}\nreturn [{\n  json: {\n    template_id: config.template_id,\n    theme: config.theme,\n    topic: config.topic,\n    platform: config.platform,\n    avatar_name: config.avatar_name,\n    email: config.email,\n    test_mode: config.test_mode,\n    script_length: config.script_length,\n    audio_cloudinary_id: config.audio_cloudinary_id,\n    \n    // new\n    final_video_url: videoUrl,\n    video_duration: videoDuration\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        976,
        96
      ],
      "id": "94a3f672-71bd-4b34-a989-262f4bef3c0e",
      "name": "Extract video url"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.creatomate.com/v1/renders",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 754b059fc6f045ea9f16cbbdacd691bec27dec04525ad3a8a0d7cdf74136980793efce4b8aafee5312b097973d74b0a4"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.creatomate }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        352,
        144
      ],
      "id": "3e365a4a-5fa9-4942-827f-6f51a60a38c7",
      "name": "Start Creatomate Render",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "amount": 15
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        528,
        144
      ],
      "id": "558fb222-cacc-4087-a229-4aa997b6777a",
      "name": "Wait for Render",
      "webhookId": "d49effb0-de50-4354-ac9b-59098b0af43f"
    },
    {
      "parameters": {
        "url": "=https://api.creatomate.com/v1/renders/{{ $json.id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 754b059fc6f045ea9f16cbbdacd691bec27dec04525ad3a8a0d7cdf74136980793efce4b8aafee5312b097973d74b0a4"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        672,
        144
      ],
      "id": "cfbd1219-c74c-4024-9f11-0aef6b6c211b",
      "name": "Check Creatomate Status",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.template_id || $json.body.template_id }}",
                    "rightValue": "TEMP_001",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "2d4d2e14-2180-4c16-a0b7-6d0967ef9e9c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "TEMP_001"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8d22ed5a-dbb7-4694-b7c7-b08c95f7e6d2",
                    "leftValue": "={{ $json.template_id || $json.body.template_id }}",
                    "rightValue": "TEMP_002",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "TEMP_002"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "905bb7fa-8bd1-4900-9d36-ebbd928f496e",
                    "leftValue": "={{ $json.template_id || $json.body.template_id }}",
                    "rightValue": "TEMP_003",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "TEMP_003"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -208,
        80
      ],
      "id": "f5f34283-a204-4fd9-998e-80580feaabbe",
      "name": "Switch on template"
    },
    {
      "parameters": {
        "jsCode": "const config = $json;\n\nconst platformTexts = {\n  'tiktok': 'Ask for SHAD and mention you saw this on TIKTOK!',\n  'youtube': 'Ask for SHAD and mention you saw this on YOUTUBE!',\n  'instagram': 'Ask for SHAD and mention you saw this on INSTAGRAM!',\n  'facebook': 'Ask for SHAD and mention you saw this on FACEBOOK!',\n  'none': 'Ask for SHAD for a great deal!'\n};\n\nconst platform = $json.platform || 'none';\nconst platformText = platformTexts[platform];\n\nconst avatarUrl = config.avatar_video_url;\nconst avatarDuration = config.avatar_video_duration;\nconst vehicles = config.vehicles;\nconst musicUrl = config.media?.music_url || \"https://res.cloudinary.com/dtpqxuwby/video/upload/v1760406868/uWu_Victory_-_Rod_Kim_dxpl7z.mp3\";\nconst chromakeyColor = config.chromakey_color;\nconst chromakeySensitivity = config.chromakey_sensitivity;\n\n// Theme animation (optional)\n// const hasTheme = config.theme && config.theme.trim() !== '' && config.theme !== 'none';\n// const includeAnimation = config.include_animation || false;\n// const themeAnimationUrl = config.theme_animation_url || null;\n\nif (!avatarUrl) throw new Error('Missing avatar video URL');\nif (vehicles.length === 0) throw new Error('No vehicles in config');\nif (vehicles.length > 5) throw new Error('Maximum 5 vehicles allowed');\n\n// Animation only shows if ALL conditions met\n//const showAnimation = false;\n  //hasTheme && includeAnimation && themeAnimationUrl !== null;\n//const TIME_OFFSET = showAnimation ? 2.25 : 0;\n\n// Get hook duration from audio sections\nconst hookSection = config._section_timings?.find(t => t.name === 'hook');\nconst hookDuration = hookSection.duration;\n\n// Contact-Info-intro spans hook\nconst contactInfoIntroDuration = hookDuration;\n\n// Calculate contact info outro timing\nconst lastCar = vehicles[vehicles.length - 1];\nconst lastCarEndTime = lastCar.end_time;\nconst contactOutroStart = lastCarEndTime;\n\n// Calculate platform text duration 0 to outro start\nconst platformTextDuration = contactOutroStart;\n\n// Build base modifications\nconst modifications = {\n  // Platform text\n  \"platform-text.text\": platformText,\n  \"platform-text.animations[0].duration\": platformTextDuration,\n  \"background-music.source\": musicUrl,\n  \"Avatar-video.source\": avatarUrl,\n  //\"Avatar-video.time\": TIME_OFFSET,  // Start at 0 or 2.25s\n  \"Avatar-video.chroma_key_color\": chromakeyColor,\n  \"Avatar-video.chroma_key_sensitivity\": chromakeySensitivity,\n  //\"Contact-Info-intro.time\": TIME_OFFSET,\n  \"Contact-Info-intro.duration\": contactInfoIntroDuration,\n  \"Contact-Info-outro.time\": contactOutroStart,\n  \"duration\": avatarDuration,\n  \n  // Theme animation - only visible if user wants it\n  //\"theme-animation.visible\": showAnimation,\n  //\"theme-animation.source\": themeAnimationUrl || \"\",\n  //\"theme-text.visible\": showAnimation,\n  //\"theme-text.text\": config.theme || \"\"\n};\n\n// Add car modifications\nvehicles.forEach((vehicle, index) => {\n  const carNum = index + 1;\n  const duration = (vehicle.end_time || 0) - (vehicle.start_time || 0);\n  \n  let priceText = vehicle.price;\n  if (typeof priceText === 'string' && priceText.includes('USD')) {\n    priceText = priceText.replace(' USD', '').replace('USD', '');\n    const priceNum = parseFloat(priceText);\n    if (!isNaN(priceNum)) {\n      priceText = '$' + priceNum.toLocaleString('en-US', {maximumFractionDigits: 0});\n    }\n  } else if (typeof priceText === 'number') {\n    priceText = '$' + priceText.toLocaleString('en-US', {maximumFractionDigits: 0});\n  }\n  \n  // Format mileage with comma\n  const mileageText = Number(vehicle.mileage || 0).toLocaleString('en-US') + ' mi';\n  \n  const title = `${vehicle.year} ${vehicle.make} ${vehicle.model}`;\n  \n  modifications[`Car${carNum}.time`] = vehicle.start_time;\n  modifications[`Car${carNum}.duration`] = duration;\n  modifications[`car-${carNum}.source`] = vehicle.photo_url;\n  modifications[`car-${carNum}-price.text`] = priceText;\n  modifications[`car-${carNum}-title.text`] = title;\n  modifications[`car-${carNum}-mileage.text`] = mileageText;\n});\n\n// Hide unused car slots (5 max)\nconst maxCars = 5;\nfor (let i = vehicles.length + 1; i <= maxCars; i++) {\n  modifications[`Car${i}.visible`] = false;\n}\n\nconst creatomateJson = {\n  \"template_id\": \"fa1c8b96-9d5d-4c93-9260-a2eb959220c5\",\n  \"modifications\": modifications\n};\n\nreturn [{\n  json: {\n    ...config,\n    creatomate: creatomateJson\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        32
      ],
      "id": "1cb25711-1d55-4039-97f3-15a7dc7bd007",
      "name": "Build TEMP_001 JSON"
    },
    {
      "parameters": {
        "jsCode": "return (async () => {\n\nconst config = $json;\n\nconst platformTexts = {\n  'tiktok': 'Ask for SHAD and mention you saw this on TIKTOK!',\n  'youtube': 'Ask for SHAD and mention you saw this on YOUTUBE!',\n  'instagram': 'Ask for SHAD and mention you saw this on INSTAGRAM!',\n  'facebook': 'Ask for SHAD and mention you saw this on FACEBOOK!',\n  'none': 'Ask for SHAD for a great deal!'\n};\n\nconst platform = $json.platform || 'none';\nconst platformText = platformTexts[platform];\n\n// Extract data from correct locations\nconst avatarUrl = config.outputs?.avatar_video_url || config.avatar_video_url;\nconst avatarDuration = config.outputs?.avatar_duration || config.avatar_duration || config.duration || 35;\nconst chromaKeyColor = $input.first().json.chromakey_color || \"#89be5a\";\nconst chromaKeySensitivity = $input.first().json.chromakey_sensitivity || \"20%\";\n\n// Get vehicle data from vehicles array\nconst vehicle = config.vehicles?.[0];\nif (!vehicle) {\n  throw new Error('No vehicle data found in config.vehicles');\n}\n\nconst heroCarUrl = vehicle.photo_url; // This is the background-removed hero image\nconst selected_photos = config.selected_photos || [];\nconst featurePhotos = selected_photos.slice(1, 6); // exclude hero\n\n// ========================================\n// PRE-FETCH ProMax IMAGES (warm up the server)\n// ========================================\nconsole.log('üî• Pre-fetching ProMax images to warm up server...');\n\nconst preFetchUrls = [\n  heroCarUrl,  // Hero car photo\n  ...featurePhotos.map(p => p.photo_url)  // All featured photos\n].filter(url => url && url.startsWith('http'));  // Only valid URLs\n\ntry {\n  await Promise.all(\n    preFetchUrls.map(async (url) => {\n      try {\n        const response = await fetch(url, { method: 'HEAD' });  // HEAD request is faster\n        console.log(`‚úÖ Pre-fetched: ${url.substring(0, 60)}...`);\n        return response;\n      } catch (err) {\n        console.log(`‚ö†Ô∏è Failed to pre-fetch: ${url} - ${err.message}`);\n        // Don't fail the whole process, just log it\n      }\n    })\n  );\n  console.log('‚úÖ All images pre-fetched!');\n} catch (err) {\n  console.log(`‚ö†Ô∏è Pre-fetch error (continuing anyway): ${err.message}`);\n}\n\n// Small delay to let ProMax server settle\nawait new Promise(resolve => setTimeout(resolve, 1000));\n\nconsole.log('üé¨ Images warmed up, continuing with Creatomate setup...');\n\nif (!avatarUrl) throw new Error('Missing avatar video URL');\nif (!heroCarUrl) throw new Error('Missing hero car image URL (vehicle.photo_url)');\nif (featurePhotos.length < 3 || featurePhotos.length > 5) {\n  throw new Error(`Need 3-5 feature photos, got ${featurePhotos.length}`);\n}\n\n// Get section timings from audio generation\nconst sectionTimings = config._section_timings || [];\nconst hookSection = sectionTimings.find(t => t.name === 'hook');\n\nconst hookDuration = hookSection?.duration || 4;\n// sum of hook and hero speaking segments after which avatar and hero scale down\nconst heroPlusHookDuration = hookDuration + sectionTimings[1].duration;\n\n// Outro timing (starts when feature 5 ends)\nconst contactOutroStart = sectionTimings[6].end_time;\nconst platformTextDuration = avatarDuration;\n\nconsole.log(`üìç Contact outro starts at: ${contactOutroStart}s`);\n\n// Format price - handle both vehicle.price and root level Price/internetPrice\nlet priceText = vehicle.price || config.Price || config.internetPrice || '0';\nif (typeof priceText === 'string' && priceText.includes('USD')) {\n  priceText = priceText.replace(' USD', '').replace('USD', '');\n}\nconst priceNum = parseFloat(priceText);\nif (!isNaN(priceNum)) {\n  priceText = '$' + priceNum.toLocaleString('en-US', {maximumFractionDigits: 0});\n}\n\n// Generate wiggle animations every 3 seconds\nconst priceWiggles = [];\nfor (let t = 3; t < avatarDuration; t += 3) {\n  priceWiggles.push({\n    \"time\": t,\n    \"duration\": 0.5,\n    \"easing\": \"linear\",\n    \"type\": \"wiggle\"\n  });\n}\n\n// Format vehicle title from vehicle object\nconst vehicleTitle = `${vehicle.year} ${vehicle.make} ${vehicle.model}`;\n\n// Build base modifications\nconst modifications = {\n  \n  // Platform text\n  \"platform-text.text\": platformText,\n  \"platform-text.duration\": platformTextDuration,\n  \"platform-text.animations\":[\n    {\n      \"time\": 0,\n      \"duration\": platformTextDuration,\n      \"easing\": \"linear\",\n      \"type\": \"shift\",\n      \"direction\": \"left\",\n      \"repetitions\": \"3\"\n    }\n  ],\n  \n  // Hero car title and price mods\n  \"hero-car.source\": heroCarUrl,\n  \"hero-car.animations\": [\n    {\n      \"time\": heroPlusHookDuration,\n      \"duration\": 1,\n      \"type\": \"scale\",\n      \"fade\": false,\n      \"scope\": \"element\",\n      \"x_anchor\": \"79%\",\n      \"y_anchor\": \"6%\",\n      \"end_scale\": \"70%\",\n      \"start_scale\": \"100%\"\n    }\n  ],\n  \"hero-car-title.text\": vehicleTitle,\n  \"hero-car-price.text\": priceText,\n  \"hero-car-price.animations\": priceWiggles,\n  \n  // Contact info outro (starts with CTA)\n  \"Contact-Info-outro.time\": contactOutroStart,\n  \n  // Total duration\n  \"duration\": avatarDuration,\n\n  // Avatar mods\n  \"Avatar-video.source\": avatarUrl,\n  \"Avatar-video.chroma_key_color\": chromaKeyColor,\n  \"Avatar-video.chroma_key_sensitivity\": chromaKeySensitivity,\n  \"Avatar-video.animations\": [\n    {\n      \"time\": heroPlusHookDuration,\n      \"duration\": 1.5,\n      \"type\": \"scale\",\n      \"fade\": false,\n      \"scope\": \"element\",\n      \"x_anchor\": \"12%\",\n      \"y_anchor\": \"100%\",\n      \"end_scale\": \"70%\",\n      \"start_scale\": \"100%\"\n    }\n  ]\n};\n\n// Add feature photos with timing (only for photos that exist)\nfeaturePhotos.forEach((photo, index) => {\n  const photoNum = index + 1; // featured-1 through featured-5\n  const timingSeg = sectionTimings[photoNum + 1]; // timing array includes hook at 0\n  \n  if (photo && photo.photo_url && timingSeg) {\n    modifications[`featured-${photoNum}-photo.source`] = photo.photo_url;\n    modifications[`featured-${photoNum}-photo.time`] = timingSeg.start_time;\n    modifications[`featured-${photoNum}-photo.duration`] = timingSeg.duration;\n  }\n});\n\n// Hide unused feature photo slots (if we have less than 5)\nfor (let i = featurePhotos.length + 1; i <= 5; i++) {\n  modifications[`featured-${i}-photo.visible`] = false;\n}\n\nconst creatomateJson = {\n  \"template_id\": \"e20c9d7e-8f64-4c28-ac0f-bad1847276c4\",\n  \"modifications\": modifications\n};\n\nconsole.log('‚úÖ Template 2 Creatomate JSON built');\nconsole.log(`üé¨ Hero car & avatar scale down at: ${hookDuration}s`);\nconsole.log(JSON.stringify(creatomateJson, null, 2));\n\nreturn [{\n  json: {\n    ...config,\n    creatomate: creatomateJson\n  }\n}];\n\n})();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        160
      ],
      "id": "2eee1014-eba2-495f-959f-92d117d45ec1",
      "name": "Build TEMP_002 JSON"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b0d1a7bf-ac65-4401-bf77-dc691de54791",
              "leftValue": "={{ $json.status }}",
              "rightValue": "succeeded",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        816,
        144
      ],
      "id": "cdc69818-5724-4f8c-ae10-d81bdabc5677",
      "name": "Succeeded?"
    },
    {
      "parameters": {
        "fromEmail": "errors@ad-pilot.ai",
        "toEmail": "kelly@ad-pilot.ai",
        "subject": "=üö® Ad Generation Failed - {{ $json.nodeName }}",
        "html": "={{ \"Ad Generation Core Workflow Error\\n\\n\" +\n\"Failed Node: \" + $json.nodeName + \"\\n\" +\n\"Error: \" + $json.errorMessage + \"\\n\\n\" +\n\"Time: \" + $json.timestamp + \"\\n\\n\" +\n\"Check n8n: https://kelly-ads.app.n8n.cloud/\" }}",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        896,
        -48
      ],
      "id": "bcffc68b-5f47-473e-90ac-26af6e7248b4",
      "name": "Alert: Gen Core Node Failed",
      "webhookId": "f80ac84f-028a-4203-8d71-de5543ba2cbd",
      "credentials": {
        "smtp": {
          "id": "5HPC3NyTgaxCbH6e",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "errorMessage": "Gen core errored out."
      },
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        1040,
        -48
      ],
      "id": "923bb706-0c19-45b1-a658-170d42b39318",
      "name": "Stop and Error"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\n\n// Get the HeyGen video URL from previous step\nconst avatarVideoUrl = input.avatar_video_url || input.video_url;\nconst chromaKeyColor = $input.first().json.chromakey_color || $input.first().json.body.chromakey_color || \"#89be5a\";\nconst chromaKeySensitivity = $input.first().json.chromakey_sensitivity || $input.first().json.body.chromakey_sensitivity || \"20%\";\nconst hook = input.script.hook;\n\n// Build the Creatomate API payload for Template 3\nconst creatomatePayload = {\n  template_id: \"e4549c14-fd68-46c1-ac1b-9cab48241981\",\n  modifications: {\n    \"Avatar.source\": avatarVideoUrl,\n    \"Avatar.chroma_key_color\": chromaKeyColor,\n    \"Avatar.chroma_key_sensitivity\": chromaKeySensitivity,\n    \"video-title\": hook\n  }\n};\n\nreturn {\n  json: {\n    ...input,\n    creatomate: creatomatePayload,\n    template_id: \"e4549c14-fd68-46c1-ac1b-9cab48241981\"\n    \n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        288
      ],
      "id": "5c66817c-9dbf-4ae8-870f-635c8eece4cf",
      "name": "Build TEMP_003 JSON"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "78c8847d-ded2-428b-b6d2-8b59e006a8aa",
              "leftValue": "={{ $json.vehiclesToProcess.length}}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "b1b5d794-4c2b-43d2-907a-421a575d74e6",
              "leftValue": "={{ $json.test_mode }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -80,
        -128
      ],
      "id": "d3c49706-9898-4e26-9cb1-65ebf9239b23",
      "name": "If has Vehicles"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "\n  {\n    \"_audio_sections\": [\n      {\n        \"section_name\": \"hook\",\n        \"section_index\": 0,\n        \"section_text\": \"Check out this deal at Capitol Car Credit!\"\n      },\n      {\n        \"section_name\": \"1N4BL4DV5RN378690\",\n        \"section_index\": 1,\n        \"section_text\": \"Twenty-twenty-four Neesawn Altima - just twenty-three thousand nine ninety-five with great gas mileage to save at the pump!\"\n      },\n      {\n        \"section_name\": \"cta\",\n        \"section_index\": 2,\n        \"section_text\": \"Call two one seven, eight nine three, eight two three two - financing available for qualified buyers!\"\n      }\n    ],\n    \"template_id\": \"TEMP_003\",\n    \"theme\": \"\",\n    \"topic\": \"How to change your oil\",\n    \"platform\": \"instagram\",\n    \"include_animation\": false,\n    \"avatar_id\": \"5b9c75a2f13e4d60b09bcfdafa7339dd\",\n    \"voice_id\": \"eezuv0zKVdVTS0jHdxFa\",\n    \"chromakey_color\": \"#6da264\",\n    \"chromakey_sensitivity\": \"8\",\n    \"avatar_name\": \"Kelly\",\n    \"script_length\": \"quick\",\n    \"email\": \"kelly@kellyrae.net\",\n    \"vins\": [\n      \"1N4BL4DV5RN378690\"\n    ],\n    \"test_mode\": true,\n    \"vehicles\": [\n      {\n        \"vin\": \"1N4BL4DV5RN378690\",\n        \"year\": 2024,\n        \"make\": \"Nissan\",\n        \"model\": \"Altima\",\n        \"price\": 23995,\n        \"mileage\": 40822,\n        \"image_url\": \"https://imageserver.promaxinventory.com/9199/image/6f5088fa57e4f9c9f5b8d1aaa752828d.jpg\",\n        \"url\": \"https://www.ccrantoul.com/VehicleDetails/9199/91242\",\n        \"features\": [\n          \"4-Cyl 2.5 Liter\",\n          \"FWD\",\n          \"BLACK\"\n        ],\n        \"start_time\": 2,\n        \"end_time\": 10\n      }\n    ],\n    \"timing_guidance\": {\n      \"target\": \"15-30 seconds\",\n      \"hook\": \"3-4 seconds\",\n      \"cta\": \"4-5 seconds\",\n      \"style\": \"Fast-paced, punchy, only the most critical selling points\"\n    },\n    \"target_duration\": \"15-18 seconds\",\n    \"script\": {\n      \"hook\": \"Check out this deal at Capitol Car Credit!\",\n      \"segments\": [\n        \"Twenty-twenty-four Neesawn Altima - just twenty-three thousand nine ninety-five with great gas mileage to save at the pump!\"\n      ],\n      \"cta\": \"Call two one seven, eight nine three, eight two three two - financing available for qualified buyers!\",\n      \"full_script\": \"Check out this deal at Capitol Car Credit! Twenty-twenty-four Neesawn Altima - just twenty-three thousand nine ninety-five with great gas mileage to save at the pump! Call two one seven, eight nine three, eight two three two - financing available for qualified buyers! [pause 1 second]\",\n      \"notes\": \"Fast-paced single vehicle highlight focusing on fuel efficiency (top buyer priority) with clear pricing and financing availability. Used proper Nissan pronunciation and emphasized value with gas savings.\"\n    },\n    \"_section_timings\": [\n      {\n        \"section_name\": \"hook\",\n        \"start_time\": 0,\n        \"end_time\": 2,\n        \"duration\": 2\n      },\n      {\n        \"section_name\": \"1N4BL4DV5RN378690\",\n        \"start_time\": 2,\n        \"end_time\": 10,\n        \"duration\": 8\n      },\n      {\n        \"section_name\": \"cta\",\n        \"start_time\": 10,\n        \"end_time\": 17,\n        \"duration\": 7\n      }\n    ],\n    \"audio_duration\": 17,\n    \"audio_url\": \"https://res.cloudinary.com/dtpqxuwby/video/upload/v1763992829/gtvsrefyq07lz7smjfqp.mp3\",\n    \"audio_cloudinary_id\": \"gtvsrefyq07lz7smjfqp\",\n    \"avatar_video_url\": \"https://files2.heygen.ai/aws_pacific/avatar_tmp/9d1d4cfe12b842308662754fabe57f18/72f4019463d34c5a89960c77d906c261.mp4?Expires=1764597712&Signature=UmvnODZ~fS-CI73wc4NZ57L7se-5ZhzxWj7FaDYnAtFviShrgNkQqg1RG9MQfgi5CAZX44~IfUWtfl6RWWIJeKYzDR7Bdg46W2~aGNw8m8-2lEZ6gtv71W3-qpv~OGAk~cjIFVmvL8fgcyk54IYZvz9J1k~okGWodiAkJTwyfsVKlp0N9tCrWoqtStbKgEw-s4A863JI59oq39eXuWa8buAcurez072cPZ5MAS-P0SBX9fbFo4WWt7djzAS4nczXr6BmgJjsFql1ugNK9j6Dd~NvM3uVdBpeLlkitALcnjys4QeKXrb95dhsZqELH2Rnc8f484xTO-VRk8BOLVJ3IQ__&Key-Pair-Id=K38HBHX5LX3X2H\",\n    \"avatar_video_duration\": 16.2537\n  }\n",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -368,
        -128
      ],
      "id": "60798cb7-eaed-47ea-9ce3-b59a10cb4c41",
      "name": "Edit Fields",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Get all items coming into aggregate\nconst allItems = $input.all();\n\n// Get base config from Process All Vehicles\nconst baseConfig = $('Process All Vehicles').first().json;\nconst cachedVehicles = baseConfig.cachedVehicles || [];\nconst originalVehicles = baseConfig.vehicles || [];\n\nconsole.log(`Aggregate: Processing ${allItems.length} items`);\n\n// Process items from removebg/cloudinary flow\nconst processedVehicles = allItems\n  .filter(item => item.json.public_id && item.json.secure_url)\n  .map(item => {\n    const vin = item.json.public_id;\n    \n    // Find the original vehicle data to merge with\n    const originalVehicle = originalVehicles.find(v => v.vin === vin);\n    \n    if (!originalVehicle) {\n      console.warn(`‚ö†Ô∏è No original vehicle found for VIN ${vin}`);\n      return null;\n    }\n    return {\n      ...originalVehicle,  // ‚Üê Keep all original vehicle data\n      photo_url: item.json.secure_url  // ‚Üê Add Cloudinary URL\n    };\n  })\n  .filter(Boolean); // Remove any nulls\n\n// Create lookup maps by VIN\nconst processedByVin = {};\nprocessedVehicles.forEach(v => {\n  processedByVin[v.vin] = v;\n});\n\nconst cachedByVin = {};\ncachedVehicles.forEach(v => {\n  cachedByVin[v.vin] = v;\n});\n\n// Rebuild vehicles array in ORIGINAL order\nconst finalVehicles = originalVehicles.map(originalVehicle => {\n  const vin = originalVehicle.vin;\n  \n  // Use processed or cached version if available, otherwise original\n  return processedByVin[vin] || cachedByVin[vin] || originalVehicle;\n});\n\nconsole.log(`‚úì Total: ${finalVehicles.length} vehicles in correct order`);\n\n// Clean config\nconst { vehiclesToProcess, cachedVehicles: _, ...cleanConfig } = baseConfig;\n\nreturn [{\n  json: {\n    ...cleanConfig,\n    vehicles: finalVehicles\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        96
      ],
      "id": "6be976a7-570a-494c-b41c-72e758ede38f",
      "name": "Aggregate Vehicles"
    },
    {
      "parameters": {
        "jsCode": "return $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -336,
        96
      ],
      "id": "5df931bc-a974-4b08-88f6-d6006b054fc2",
      "name": "Aggregate Configs"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "cc7c4fae-f404-4b50-b3e0-a86a35ad1403",
              "leftValue": "={{ $json.test_mode }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        176,
        32
      ],
      "id": "e31917be-d832-4f23-9f3a-8dfd718a570c",
      "name": "If Test, Skip Creatomate"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.remove.bg/v1.0/removebg",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "72rkEtm8QRzFpqEmjL42o89z"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"image_url\": \"{{ $json.photo_url || $json.image_url }}\",\n  \"size\": \"auto\",\n  \"format\": \"png\",\n  \"crop\": true,\n  \"crop_margin\": \"10%\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        240,
        -144
      ],
      "id": "d4ecef3b-4065-44b9-b76e-95c1be44b7ac",
      "name": "Remove.bg API",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Get the VIN from your JSON data\nconst vin = $json.vin;\n\n// Rename the binary file if it exists\nif ($binary.data) {\n  $binary.data.fileName = `${vin}.png`;\n}\n\n// Return everything - preserve ALL your JSON data\nreturn {\n  json: $json,  // This keeps ALL your fields intact\n  binary: $binary\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        384,
        -160
      ],
      "id": "dcdd5c0b-9198-468f-a2f2-d28e3341212e",
      "name": "Rename Binary"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cloudinary.com/v1_1/dtpqxuwby/image/upload",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            },
            {
              "name": "upload_preset",
              "value": "n8n_unsigned"
            },
            {
              "name": "public_id",
              "value": "={{ $json.vin }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        528,
        -160
      ],
      "id": "969b1d09-908b-449f-b35d-0404ea08d0dd",
      "name": "Upload to Cloudinary",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// Single error - format it for the email\nconst error = $input.first().json;\nconst nodeName = error.node?.name || 'Unknown node';\n\n// Handle different error formats from different APIs\nlet errorMsg = 'Unknown error';\n\n// Cloudinary error format: { \"error\": { \"message\": \"...\" } }\nif (error.error?.message) {\n  errorMsg = error.error.message;\n}\n// Remove.bg error format: { \"errors\": [{ \"code\": \"...\", \"title\": \"...\" }] }\nelse if (error.errors && Array.isArray(error.errors) && error.errors.length > 0) {\n  const firstError = error.errors[0];\n  // Include code if present, otherwise just title\n  errorMsg = firstError.code \n    ? `${firstError.code}: ${firstError.title}` \n    : firstError.title;\n}\n// Creatomate error format: { \"error_message\": \"...\" }\nelse if (error.error_message) {\n  errorMsg = error.error_message;\n}\n// Generic message fallback\nelse if (error.message) {\n  errorMsg = error.message;\n}\n\nreturn [{\n  json: {\n    nodeName: nodeName,\n    errorMessage: errorMsg,\n    timestamp: new Date().toISOString(),\n    rawError: JSON.stringify(error, null, 2) // Include full error for debugging\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        736,
        -48
      ],
      "id": "784d6524-d4b7-4640-b0f1-2467d38dcf9a",
      "name": "Format Node Error"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "\n{\n  \"url\": \"https://f002.backblazeb2.com/file/creatomate-c8xg3hsxdu/ce81a4ca-3008-4307-8b98-d728ad671024.mp4\",\n  \"duration\": 32.16\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        352,
        0
      ],
      "id": "f856a6ef-0e7d-484c-8f19-26f243b6a742",
      "name": "Creatomate Test Stubs"
    },
    {
      "parameters": {
        "content": "# #3 Generate Video",
        "height": 800,
        "width": 1776,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -560,
        -368
      ],
      "typeVersion": 1,
      "id": "cfb457e3-4e30-4045-916a-2c45b78a2cbf",
      "name": "Sticky Note"
    }
  ],
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process All Vehicles": {
      "main": [
        [
          {
            "node": "If has Vehicles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "send only vehicles to process": {
      "main": [
        [
          {
            "node": "Remove.bg API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Start Creatomate Render": {
      "main": [
        [
          {
            "node": "Wait for Render",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Node Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Render": {
      "main": [
        [
          {
            "node": "Check Creatomate Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Creatomate Status": {
      "main": [
        [
          {
            "node": "Succeeded?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Node Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch on template": {
      "main": [
        [
          {
            "node": "Build TEMP_001 JSON",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build TEMP_002 JSON",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build TEMP_003 JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build TEMP_001 JSON": {
      "main": [
        [
          {
            "node": "If Test, Skip Creatomate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build TEMP_002 JSON": {
      "main": [
        [
          {
            "node": "If Test, Skip Creatomate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract video url": {
      "main": [
        []
      ]
    },
    "Succeeded?": {
      "main": [
        [
          {
            "node": "Extract video url",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait for Render",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Alert: Gen Core Node Failed": {
      "main": [
        [
          {
            "node": "Stop and Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build TEMP_003 JSON": {
      "main": [
        [
          {
            "node": "If Test, Skip Creatomate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If has Vehicles": {
      "main": [
        [
          {
            "node": "send only vehicles to process",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Aggregate Configs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Process All Vehicles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Vehicles": {
      "main": [
        [
          {
            "node": "Aggregate Configs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Configs": {
      "main": [
        [
          {
            "node": "Switch on template",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Test, Skip Creatomate": {
      "main": [
        [
          {
            "node": "Creatomate Test Stubs",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Start Creatomate Render",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Remove.bg API": {
      "main": [
        [
          {
            "node": "Rename Binary",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Node Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rename Binary": {
      "main": [
        [
          {
            "node": "Upload to Cloudinary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload to Cloudinary": {
      "main": [
        [
          {
            "node": "Aggregate Vehicles",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Node Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Node Error": {
      "main": [
        [
          {
            "node": "Alert: Gen Core Node Failed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Creatomate Test Stubs": {
      "main": [
        [
          {
            "node": "Extract video url",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "0b4e6b7d-3b6d-4201-8cd9-d7dc20348b5d",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-10-20T22:01:25.545Z",
      "createdAt": "2025-10-20T22:01:25.545Z",
      "role": "workflow:owner",
      "workflowId": "Z36Cd1XZSVbd1bC3",
      "projectId": "bll44iFOa92qb20Q"
    }
  ],
  "tags": [
    {
      "updatedAt": "2025-10-20T22:01:51.760Z",
      "createdAt": "2025-10-20T22:01:51.760Z",
      "id": "4o01JEB63Qahv9wy",
      "name": "PROD"
    }
  ]
}