{
  "updatedAt": "2026-02-06T23:24:11.352Z",
  "createdAt": "2025-12-22T12:47:55.823Z",
  "id": "9Kgcwgba8uAY10JH",
  "name": "[TEMP] Dedupe and Add Constraint",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "dedupe-avatars",
        "responseMode": "lastNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        0,
        240
      ],
      "id": "webhook",
      "name": "Webhook",
      "webhookId": "dedupe-avatars"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Find and show duplicates\nSELECT group_id, style_name, COUNT(*) as cnt\nFROM avatars\nGROUP BY group_id, style_name\nHAVING COUNT(*) > 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        220,
        240
      ],
      "id": "find-dupes",
      "name": "Find Duplicates",
      "credentials": {
        "postgres": {
          "id": "3XsWrPuEddwVYbGS",
          "name": "Railway Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Delete duplicates keeping the one with motion (or most recent)\nDELETE FROM avatars a\nUSING avatars b\nWHERE a.group_id = b.group_id \n  AND a.style_name = b.style_name\n  AND a.id > b.id\n  AND (a.motion_avatar_id IS NULL OR b.motion_avatar_id IS NOT NULL);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        440,
        240
      ],
      "id": "delete-dupes",
      "name": "Delete Duplicates",
      "credentials": {
        "postgres": {
          "id": "3XsWrPuEddwVYbGS",
          "name": "Railway Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Check if constraint already exists, if not add it\nDO $$\nBEGIN\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_constraint WHERE conname = 'unique_style_per_group'\n  ) THEN\n    ALTER TABLE avatars ADD CONSTRAINT unique_style_per_group UNIQUE (group_id, style_name);\n  END IF;\nEND $$;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        660,
        240
      ],
      "id": "add-constraint",
      "name": "Add Constraint",
      "credentials": {
        "postgres": {
          "id": "3XsWrPuEddwVYbGS",
          "name": "Railway Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COUNT(*) as total_avatars FROM avatars;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        880,
        240
      ],
      "id": "count",
      "name": "Count Total",
      "credentials": {
        "postgres": {
          "id": "3XsWrPuEddwVYbGS",
          "name": "Railway Postgres"
        }
      }
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Find Duplicates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Duplicates": {
      "main": [
        [
          {
            "node": "Delete Duplicates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Duplicates": {
      "main": [
        [
          {
            "node": "Add Constraint",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Constraint": {
      "main": [
        [
          {
            "node": "Count Total",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": null,
  "versionId": "0914793f-6fab-482e-86bb-17e75861e221",
  "activeVersionId": null,
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-12-22T12:47:55.823Z",
      "createdAt": "2025-12-22T12:47:55.823Z",
      "role": "workflow:owner",
      "workflowId": "9Kgcwgba8uAY10JH",
      "projectId": "VF66NQc9R74tCdyG"
    }
  ],
  "activeVersion": null,
  "tags": []
}