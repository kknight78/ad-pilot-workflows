{
  "updatedAt": "2025-12-01T16:53:30.492Z",
  "createdAt": "2025-12-01T15:46:55.445Z",
  "id": "nkCIvIMN2fkJV66O",
  "name": "Guidance Rules API",
  "description": null,
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "guidance-rules",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "get-webhook",
      "name": "GET Guidance Rules",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        250,
        100
      ],
      "webhookId": "guidance-rules-get"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "guidance-rules",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "post-webhook",
      "name": "POST Guidance Rules",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        250,
        300
      ],
      "webhookId": "guidance-rules-post"
    },
    {
      "parameters": {
        "httpMethod": "DELETE",
        "path": "guidance-rules",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "delete-webhook",
      "name": "DELETE Guidance Rules",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        250,
        500
      ],
      "webhookId": "guidance-rules-delete"
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": {
          "__rl": true,
          "value": "1VQuJs5F_jR9cv-yobmkRoQLhUQmQJTnawFB5I29Hrs0",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "guidance_rules",
          "mode": "name"
        },
        "options": {}
      },
      "id": "read-all-rules",
      "name": "Read All Rules",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        500,
        100
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "g3qdIZMDD4wzQ69l",
          "name": "Google Sheets account"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, rules: $input.all().map(i => i.json) }) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, DELETE, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "respond-get",
      "name": "Respond GET",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        750,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body;\n\n// Check if this is an update (rule_id provided) or create (no rule_id)\nconst isUpdate = body.rule_id && body.rule_id.startsWith('rule_');\n\nlet rule_id, created_at;\n\nif (isUpdate) {\n  // Use existing rule_id for update\n  rule_id = body.rule_id;\n  created_at = body.created_at || new Date().toISOString();\n} else {\n  // Generate new rule_id with simple sequential format\n  const now = new Date();\n  const dateStr = now.toISOString().slice(0,10).replace(/-/g, '');\n  const timeStr = now.toISOString().slice(11,19).replace(/:/g, '');\n  rule_id = 'rule_' + dateStr + '_' + timeStr;\n  created_at = now.toISOString();\n}\n\nreturn [{\n  json: {\n    rule_id: rule_id,\n    client_id: body.client_id || 'ccc',\n    avatar_name: body.avatar_name || '*',\n    rule_text: body.rule_text || '',\n    category: body.category || 'facts',\n    active: body.active !== false ? 'TRUE' : 'FALSE',\n    created_at: created_at,\n    is_update: isUpdate\n  }\n}];\n"
      },
      "id": "prepare-new-rule",
      "name": "Prepare New Rule",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        500,
        300
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1VQuJs5F_jR9cv-yobmkRoQLhUQmQJTnawFB5I29Hrs0",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "guidance_rules",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {}
        },
        "options": {}
      },
      "id": "append-rule",
      "name": "Append Rule",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        950,
        400
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "g3qdIZMDD4wzQ69l",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, rule: $('Prepare New Rule').first().json }) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, DELETE, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "respond-post",
      "name": "Respond POST",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1000,
        300
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://sheets.googleapis.com/v4/spreadsheets/1VQuJs5F_jR9cv-yobmkRoQLhUQmQJTnawFB5I29Hrs0?fields=sheets.properties",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleSheetsOAuth2Api",
        "options": {}
      },
      "id": "get-sheet-info",
      "name": "Get Sheet Info",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        500,
        500
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "g3qdIZMDD4wzQ69l",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": {
          "__rl": true,
          "value": "1VQuJs5F_jR9cv-yobmkRoQLhUQmQJTnawFB5I29Hrs0",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "guidance_rules",
          "mode": "name"
        },
        "options": {}
      },
      "id": "read-for-delete",
      "name": "Read For Delete",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        750,
        500
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "g3qdIZMDD4wzQ69l",
          "name": "Google Sheets account"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const query = $('DELETE Guidance Rules').first().json.query;\nconst ruleIdToDelete = query.rule_id;\nconst allRules = $input.all().map(i => i.json);\n\n// Get sheet info from the HTTP request\nconst sheetInfo = $('Get Sheet Info').first().json;\nconst sheets = sheetInfo.sheets || [];\nconst guidanceSheet = sheets.find(s => s.properties.title === 'guidance_rules');\nconst sheetId = guidanceSheet ? guidanceSheet.properties.sheetId : 0;\n\n// Find the rule to delete by matching rule_id exactly\nconst ruleToDelete = allRules.find(r => r.rule_id === ruleIdToDelete);\n\nif (!ruleToDelete) {\n  return [{ json: { found: false, rule_id: ruleIdToDelete } }];\n}\n\n// Return the found rule with sheetId and row_number for deletion\nreturn [{ json: { found: true, rule_id: ruleToDelete.rule_id, row_number: ruleToDelete.row_number, sheet_id: sheetId } }];"
      },
      "id": "find-rule-row",
      "name": "Find Rule Row",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1000,
        500
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.found }}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-found",
      "name": "If Found",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1250,
        500
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://sheets.googleapis.com/v4/spreadsheets/1VQuJs5F_jR9cv-yobmkRoQLhUQmQJTnawFB5I29Hrs0:batchUpdate",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleSheetsOAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ requests: [{ deleteDimension: { range: { sheetId: $json.sheet_id, dimension: 'ROWS', startIndex: $json.row_number - 1, endIndex: $json.row_number } } }] }) }}",
        "options": {}
      },
      "id": "delete-rule-http",
      "name": "Delete Rule",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1500,
        400
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "g3qdIZMDD4wzQ69l",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, deleted: $('Find Rule Row').first().json.rule_id }) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, DELETE, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "respond-delete-success",
      "name": "Respond Delete Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1750,
        400
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: 'Rule not found', rule_id: $json.rule_id }) }}",
        "options": {
          "responseCode": "404",
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, DELETE, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "respond-delete-not-found",
      "name": "Respond Not Found",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1500,
        600
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.is_update }}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-update-node",
      "name": "If Update",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        700,
        300
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1VQuJs5F_jR9cv-yobmkRoQLhUQmQJTnawFB5I29Hrs0",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "guidance_rules",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "rule_id": "={{ $json.rule_id }}",
            "client_id": "={{ $json.client_id }}",
            "avatar_name": "={{ $json.avatar_name }}",
            "rule_text": "={{ $json.rule_text }}",
            "category": "={{ $json.category }}",
            "active": "={{ $json.active }}",
            "created_at": "={{ $json.created_at }}"
          },
          "matchingColumns": [
            "rule_id"
          ]
        },
        "options": {}
      },
      "id": "update-rule-node",
      "name": "Update Rule",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        950,
        200
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "g3qdIZMDD4wzQ69l",
          "name": "Google Sheets account"
        }
      }
    }
  ],
  "connections": {
    "GET Guidance Rules": {
      "main": [
        [
          {
            "node": "Read All Rules",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read All Rules": {
      "main": [
        [
          {
            "node": "Respond GET",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "POST Guidance Rules": {
      "main": [
        [
          {
            "node": "Prepare New Rule",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare New Rule": {
      "main": [
        [
          {
            "node": "If Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append Rule": {
      "main": [
        [
          {
            "node": "Respond POST",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DELETE Guidance Rules": {
      "main": [
        [
          {
            "node": "Get Sheet Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Sheet Info": {
      "main": [
        [
          {
            "node": "Read For Delete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read For Delete": {
      "main": [
        [
          {
            "node": "Find Rule Row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Rule Row": {
      "main": [
        [
          {
            "node": "If Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Found": {
      "main": [
        [
          {
            "node": "Delete Rule",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Not Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Rule": {
      "main": [
        [
          {
            "node": "Respond Delete Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Update": {
      "main": [
        [
          {
            "node": "Update Rule",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Append Rule",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Rule": {
      "main": [
        [
          {
            "node": "Respond POST",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": null,
  "versionId": "5a03102a-b001-48cc-b2da-f642bfce3ce7",
  "versionCounter": 9,
  "triggerCount": 3,
  "shared": [
    {
      "updatedAt": "2025-12-01T15:46:55.447Z",
      "createdAt": "2025-12-01T15:46:55.447Z",
      "role": "workflow:owner",
      "workflowId": "nkCIvIMN2fkJV66O",
      "projectId": "bll44iFOa92qb20Q",
      "project": {
        "updatedAt": "2025-09-08T16:29:41.547Z",
        "createdAt": "2025-09-08T16:29:38.593Z",
        "id": "bll44iFOa92qb20Q",
        "name": "Kelly Knight <kelly@kellyrae.net>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "updatedAt": "2025-09-08T16:29:38.593Z",
            "createdAt": "2025-09-08T16:29:38.593Z",
            "userId": "a30987fe-4321-46e3-affb-75459c3320fc",
            "projectId": "bll44iFOa92qb20Q",
            "user": {
              "updatedAt": "2025-12-10T08:00:00.000Z",
              "createdAt": "2025-09-08T16:29:36.989Z",
              "id": "a30987fe-4321-46e3-affb-75459c3320fc",
              "email": "kelly@kellyrae.net",
              "firstName": "Kelly",
              "lastName": "Knight",
              "personalizationAnswers": null,
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "DIT1A5BsEUock2GH",
                "userActivatedAt": 1758474039124,
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1759246180644
                },
                "dismissedCallouts": {
                  "preBuiltAgentsCalloutHttpRequest": true
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2025-12-10",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}