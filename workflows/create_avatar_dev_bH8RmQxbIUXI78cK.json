{
  "updatedAt": "2025-11-22T15:02:01.000Z",
  "createdAt": "2025-11-22T14:53:42.780Z",
  "id": "bH8RmQxbIUXI78cK",
  "name": "Create avatar DEV",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "url": "https://api.heygen.com/v1/video_status.get",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "video_id",
              "value": "={{$node[\"Create avatar video\"].json.data?.video_id || $node[\"Create avatar video\"].json.video_id}}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Api-Key",
              "value": "OWQxZDRjZmUxMmI4NDIzMDg2NjI3NTRmYWJlNTdmMTgtMTc1OTM0MjExNQ=="
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        560,
        1568
      ],
      "id": "b479ea68-6a3e-4ea2-8364-ae5cba17c22f",
      "name": "Check status",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7e530ea0-2545-43a0-a589-1b816442e116",
              "leftValue": "={{$json.data?.status}}",
              "rightValue": "completed",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1136,
        1552
      ],
      "id": "9846f443-1045-48d3-b62b-65605ad87abe",
      "name": "Is complete?"
    },
    {
      "parameters": {
        "amount": 20
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1296,
        1712
      ],
      "id": "6ca0f276-1654-44f8-baf9-b4f94ede4825",
      "name": "Wait",
      "webhookId": "a6450418-423b-411d-872d-223ca0619b51"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.videobgremover.com/v1/jobs",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"video_url\": \"{{ $node['Upload to Cloudinary'].item.json[0].secure_url }}\n  \n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1264,
        576
      ],
      "id": "8b7bdb68-9d0a-4971-b4f5-ede3f106d3ad",
      "name": "VBR - Create job",
      "credentials": {
        "httpHeaderAuth": {
          "id": "LQZygyOyKZ5tikRW",
          "name": "VideoBGRemover"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.videobgremover.com/v1/jobs/{{$node[\"VBR - Create job\"].json.id}}/start",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"background\": {\n    \"type\": \"transparent\",\n    \"transparent_format\": \"stacked_video\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1040,
        576
      ],
      "id": "dee8e8c0-ec79-422f-bead-239b29ba79ef",
      "name": "VBR - Start job",
      "credentials": {
        "httpHeaderAuth": {
          "id": "LQZygyOyKZ5tikRW",
          "name": "VideoBGRemover"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "url": "=https://api.videobgremover.com/v1/jobs/{{ $json.id }}/status",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -816,
        576
      ],
      "id": "fcfd67d9-40c5-47a8-9e88-2d9e3aa38325",
      "name": "VBR - Check job",
      "credentials": {
        "httpHeaderAuth": {
          "id": "LQZygyOyKZ5tikRW",
          "name": "VideoBGRemover"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "cf83b0e8-3358-4922-be97-f3b573e02b6e",
              "leftValue": "={{$json.status}}",
              "rightValue": "completed",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -592,
        496
      ],
      "id": "e8ad200f-39f0-454d-a1fe-742bb70d134d",
      "name": "VBR - Is done?",
      "disabled": true
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -368,
        576
      ],
      "id": "4d510ef2-17bc-45a7-aeb9-6ec61674efff",
      "name": "Wait - back to check job",
      "webhookId": "3d80dc4f-1477-4476-b3e5-3e7e65fc4a27",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cloudinary.com/v1_1/dtpqxuwby/video/upload",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "file",
              "value": "=data:audio/mpeg;base64,{{ $json.data[0].audio_base64 || $json.data[0].outputs.audio_base64 }}"
            },
            {
              "name": "upload_preset",
              "value": "n8n_unsigned"
            },
            {
              "name": "resource_type",
              "value": "auto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -32,
        1648
      ],
      "id": "62302e07-eec4-451b-9abf-9d1c2b8436dd",
      "name": "Upload audio to Cloudinary",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.heygen.com/v2/video/generate",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "OWQxZDRjZmUxMmI4NDIzMDg2NjI3NTRmYWJlNTdmMTgtMTc1OTM0MjExNQ=="
            },
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"title\": \"Shad ad draft\",\n  \"video_inputs\": [\n    {\n      \"character\": {\n        \"type\": \"talking_photo\",\n        \"talking_photo_id\": \"{{ $json.avatar_id || $json.body.avatar_id }}\"\n      },\n      \"voice\": {\n        \"type\": \"audio\",\n        \"audio_url\": \"{{ $json.audio_url }}\"\n      }\n    }\n  ],\n  \"dimension\": { \"width\": 720, \"height\": 1250 }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        384,
        1568
      ],
      "id": "41635a5e-64ee-4720-8a74-bd9e4ae27928",
      "name": "Create avatar video",
      "alwaysOutputData": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1008,
        1360
      ],
      "id": "71d541bd-13bd-48f5-8587-41e030ed86c4",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "jsCode": "// This node runs after Cloudinary upload with the avatar video\nconst videoUrl = $json.data.video_url;\nconst duration = Number($json.data.duration);\n\n// Get the original videoConfig that was passed in\nconst updatedConfig = $('Add audio to config').first().json;\n\nreturn [{\n  json: {\n    ...updatedConfig,  // Keep the entire videoConfig\n    \n    // Update the outputs section\n    outputs: {\n      ...updatedConfig.outputs,\n      avatar_video_url: videoUrl,\n      avatar_duration: duration\n    },\n    \n    // Also add these at root level for backward compatibility\n    video_url: videoUrl,\n    heygen_video_url: videoUrl,\n    duration: duration,\n    video_duration: duration\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1296,
        1536
      ],
      "id": "157b86f3-9999-4b3a-be9e-c299e3e278a6",
      "name": "Add video data to config"
    },
    {
      "parameters": {
        "jsCode": "// Get the Cloudinary upload response\nconst audioUrl = $json.secure_url;\nconst audioId = $json.public_id;\n\nconst configWithTimings = $('Aggregate Templates').first()?.json.data[0];\n\n// remove huge audio blob before passing config\nconfigWithTimings.audio_base64 = undefined;\n\nif (!configWithTimings) {\n  throw new Error('Could not find config from either Prepare TEMP_003 or Concatenate Audio Files');\n}\n\nreturn [{\n  json: {\n    ...configWithTimings,\n    // Update the outputs section\n    outputs: {\n      ...configWithTimings.outputs,\n      audio_url: audioUrl,\n      audio_cloudinary_id: audioId,\n      audio_base64: undefined,  // Remove the heavy base64 data\n    },\n    \n    // Also add these at root level for backward compatibility\n    audio_url: audioUrl,\n    audio_cloudinary_id: audioId,\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        192,
        1568
      ],
      "id": "3bfa26c8-2a22-467f-aabe-a00b3ac70cda",
      "name": "Add audio to config"
    },
    {
      "parameters": {
        "jsCode": "const config = $json;\nconst script = config.script;\nconst vehicles = config.vehicles;\nconst templateId = config.template_id;\n\n// TEMP_003: Educational videos - single section with full script\nif (templateId === 'TEMP_003') {\n  const fullScriptText = script.full_script;\n  \n  console.log('TEMP_003: Creating single audio section');\n  \n  return [{\n    json: {\n      name: 'full_script',\n      text: fullScriptText,\n      index: 0,\n      voice_id: config.voice_id\n    }\n  }];\n}\n\n// TEMP_001 & TEMP_002: Multi-section audio for vehicle features\nif (!script.hook || !script.segments || !script.cta) {\n  throw new Error('Script missing required sections');\n}\n\n// Build minimal sections array - ONLY what ElevenLabs needs\nconst sections = [\n  { \n    name: 'hook',\n    text: script.hook,\n    index: 0\n  },\n  ...script.segments.map((segmentText, index) => ({\n    name: (vehicles && vehicles[index]?.vin) || \"feature_\"+index,\n    text: segmentText,\n    index: index + 1\n  })),\n  { \n    name: 'cta',\n    text: script.cta,\n    index: script.segments.length + 1\n  }\n];\n\nconsole.log('Sections:', sections.map(s => s.name).join(', '));\n\n// Return JUST the section data - clean and simple\nreturn sections.map(section => ({\n  json: {\n    ...config,\n    name: section.name,\n    text: section.text,\n    index: section.index,\n    voice_id: config.voice_id\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -304,
        1184
      ],
      "id": "806831e4-7c4e-441f-a9c3-3fc2c37b39db",
      "name": "Prepare Sections"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -112,
        1184
      ],
      "id": "f2fe3bea-1c4b-48f4-ab12-a7704f6ced16",
      "name": "Split in Batches"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.elevenlabs.io/v1/text-to-speech/{{ $json.voice_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"text\": \"{{ $json.text}}\",\n  \"model_id\": \"eleven_v3\",\n  \"voice_settings\": {\n    \"stability\": 0.5,\n    \"similarity_boost\": 0.75,\n    \"style\": 0,\n    \"use_speaker_boost\": true\n  },\n  \"output_format\": \"mp3_44100_128\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        16,
        1232
      ],
      "id": "7e1d247c-f0ef-4807-b76d-abbc881fa6aa",
      "name": "Generate Section Audio",
      "credentials": {
        "httpHeaderAuth": {
          "id": "rF8Db64Xo3IjoeOL",
          "name": "ElevenLabs API"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "const config = $json;\nconst audioSections = config._audio_sections;\n\nif (!audioSections || audioSections.length === 0) {\n  throw new Error('No audio sections to concatenate!');\n}\n\nconsole.log(`Concatenating ${audioSections.length} audio sections...`);\n\n// Convert all base64 audio to buffers\nconst audioBuffers = audioSections.map(section => {\n  if (!section.audio_base64) {\n    throw new Error(`Section ${section.section_name} missing audio_base64!`);\n  }\n  return Buffer.from(section.audio_base64, 'base64');\n});\n\nconsole.log('Audio buffers created:', audioBuffers.map((buf, i) => \n  `${audioSections[i].section_name}: ${(buf.length / 1024).toFixed(2)}KB`\n).join(', '));\n\n// Simple concatenation: MP3 files can be concatenated by joining the data\n// This works because MP3 frames are self-contained\nconst concatenatedBuffer = Buffer.concat(audioBuffers);\n\n// Convert back to base64\nconst concatenatedBase64 = concatenatedBuffer.toString('base64');\n\nconst totalSize = concatenatedBuffer.length;\nconsole.log(`‚úÖ Concatenated audio size: ${(totalSize / 1024).toFixed(2)} KB`);\n\n// Remove huge individual base64 chunks\nconst cleanedAudioSections = (config._audio_sections || []).map(section => ({\n  section_name: section.section_name,\n  section_index: section.section_index,\n  section_text: section.section_text,\n  // audio_base64 intentionally omitted\n}));\n\nreturn [{\n  json: {\n    ...config,\n    // Replace with cleaned version (no base64)\n    _audio_sections: cleanedAudioSections,\n    outputs: {\n      ...(config.outputs || {}),\n      audio_base64: concatenatedBase64\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -336,
        1776
      ],
      "id": "2775401a-a400-4607-8904-0d9b0b616654",
      "name": "Concatenate Audio Files"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "includeUnpaired": true
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        272,
        1344
      ],
      "id": "71a24e29-5792-4731-900f-1f2661e31b51",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "const inputData = $json;\nconst binaryItems = inputData.items || [];\nconst audioSections = [];\n\nif (binaryItems.length === 1) {\n\n  const audioBase64 = binaryItems[0]?.audio_base64;\n  \n  return [{\n    json: {\n      _audio_sections: [], // Empty - not needed\n      audio_base64: audioBase64, // Pass through for Cloudinary!\n    }\n  }];\n}\n\n// TEMP_001 & TEMP_002: Extract durations for car timing synchronization\n\nfor (let i = 0; i < binaryItems.length; i++) {\n  const item = binaryItems[i];\n  \n  const name = item.name;\n  const text = item.text;\n  const index = item.index;\n  const audioBase64 = item.audio_base64; // Already provided by Combine!\n  \n  if (!audioBase64) {\n    console.warn(`No audio_base64 for ${name}`);\n    continue;\n  }\n  \n  // Parse file size from the file_size field\n  const fileSizeStr = item.file_size;\n  let fileSizeBytes;\n  \n  if (fileSizeStr && fileSizeStr.includes('kB')) {\n    const kb = parseFloat(fileSizeStr.replace(' kB', ''));\n    fileSizeBytes = Math.round(kb * 1024);\n  } else if (fileSizeStr && fileSizeStr.includes('MB')) {\n    const mb = parseFloat(fileSizeStr.replace(' MB', ''));\n    fileSizeBytes = Math.round(mb * 1024 * 1024);\n  } else {\n    // Calculate from base64 length as fallback\n    fileSizeBytes = Math.round((audioBase64.length * 3) / 4);\n  }\n  \n  const BITRATE_KBPS = 128;\n  const durationSeconds = (fileSizeBytes * 8) / (BITRATE_KBPS * 1000);\n  const roundedDuration = Math.round(durationSeconds * 100) / 100;\n  \n  console.log(`Section \"${name}\": ${fileSizeBytes} bytes = ${roundedDuration}s`);\n  \n  audioSections.push({\n    section_name: name,\n    section_index: index,\n    section_text: text,\n    audio_base64: audioBase64,\n    duration_seconds: roundedDuration,\n    file_size_bytes: fileSizeBytes\n  });\n}\n\naudioSections.sort((a, b) => a.section_index - b.section_index);\nconsole.log('Extracted durations for', audioSections.length, 'sections');\n\nreturn [{\n  json: {\n    _audio_sections: audioSections\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        1088
      ],
      "id": "190a8ada-d698-4317-8357-28ab9a644df3",
      "name": "Extract All Durations"
    },
    {
      "parameters": {
        "jsCode": "const allItems = $input.all();\n\n// TEMP_003: Only one audio file, no combining needed - just pass through\nif (allItems.length === 1) {\n  const item = allItems[0];\n  let binaryBuffer = null;\n  \n  try {\n    binaryBuffer = await this.helpers.getBinaryDataBuffer(0, 'data');\n    console.log(`‚úÖ Single audio file (${item.json.name}): ${binaryBuffer.length} bytes`);\n  } catch (error) {\n    console.warn('‚ùå Failed to get buffer:', error.message);\n  }\n  \n  const audioBase64 = binaryBuffer ? binaryBuffer.toString('base64') : null;\n  \n  return [{\n    json: {\n      items: [{\n        name: item.json.name,\n        text: item.json.text,\n        index: item.json.index,\n        audio_base64: audioBase64,\n        file_size: item.binary?.data?.fileSize\n      }]\n    }\n  }];\n}\n\n// TEMP_001 & TEMP_002: Multiple audio files - combine them\nconsole.log('Combining', allItems.length, 'binary items');\nconst binaryItems = [];\n\nfor (let i = 0; i < allItems.length; i++) {\n  const item = allItems[i];\n  \n  // Get the actual binary buffer while we still have access\n  let binaryBuffer = null;\n  \n  try {\n    binaryBuffer = await this.helpers.getBinaryDataBuffer(i, 'data');\n    console.log(`‚úÖ Got buffer ${i} (${item.json.name}): ${binaryBuffer.length} bytes`);\n  } catch (error) {\n    console.warn(`‚ùå Failed buffer ${i}:`, error.message);\n  }\n  \n  // Convert to base64 NOW while we have the buffer\n  const audioBase64 = binaryBuffer ? binaryBuffer.toString('base64') : null;\n  \n  binaryItems.push({\n    name: item.json.name,\n    text: item.json.text,\n    index: item.json.index,\n    audio_base64: audioBase64,\n    file_size: item.binary?.data?.fileSize\n  });\n}\n\nreturn [{\n  json: {\n    items: binaryItems\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        64,
        1088
      ],
      "id": "d3e91509-3916-4980-b13f-cccd9a473d4d",
      "name": "Combine Binary Items"
    },
    {
      "parameters": {
        "jsCode": "// Single error - format it for the email\nconst error = $input.first().json;\nconst nodeName = error.node?.name || 'Unknown node';\n\n// Handle different error formats from different APIs\nlet errorMsg = 'Unknown error';\n\n// HeyGen error format: { \"error\": { \"code\": \"...\", \"message\": \"...\", \"detail\": \"...\" } }\nif (error.error?.code && error.error?.message) {\n  errorMsg = `[${error.error.code}] ${error.error.message}`;\n  if (error.error.detail) {\n    errorMsg += ` - ${error.error.detail}`;\n  }\n}\n// Cloudinary error format: { \"error\": { \"message\": \"...\" } }\nelse if (error.error?.message) {\n  errorMsg = error.error.message;\n}\n// ElevenLabs error format: { \"error\": { \"code\": \"...\", \"message\": \"...\" } }\n// (Same structure as HeyGen but without detail field - handled by first condition)\n// Generic message fallback\nelse if (error.message) {\n  errorMsg = error.message;\n}\n\nreturn [{\n  json: {\n    nodeName: nodeName,\n    errorMessage: errorMsg,\n    timestamp: new Date().toISOString(),\n    rawError: JSON.stringify(error, null, 2) // Include full error for debugging\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        752,
        1664
      ],
      "id": "83a8f36d-0e32-4e47-a8b1-edf9a4cc0cde",
      "name": "Format Create Avatar Video Errors"
    },
    {
      "parameters": {
        "fromEmail": "errors@ad-pilot.ai",
        "toEmail": "kelly@ad-pilot.ai",
        "subject": "=üö® Avatar Generation Failed - {{ $json.nodeName }}",
        "html": "={{ \"‚ö†Ô∏è Create Avatar Video Workflow Error\\n\\n\" +\n\"Failed Node: \" + $json.nodeName + \"\\n\" +\n\"Error: \" + $json.errorMessage + \"\\n\\n\" +\n\"Time: \" + $json.timestamp + \"\\n\\n\" +\n\"Check n8n: https://kelly-ads.app.n8n.cloud/\" }}",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        880,
        1664
      ],
      "id": "388cb3e1-b5d4-408a-adff-25ac9da4c94b",
      "name": "Send email",
      "webhookId": "f0d4ff60-459c-4285-80e3-063a8a76c8da",
      "credentials": {
        "smtp": {
          "id": "5HPC3NyTgaxCbH6e",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "errorMessage": "Avatar video errored out."
      },
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        1008,
        1664
      ],
      "id": "45663354-74b7-458a-a21d-75d959756395",
      "name": "Stop and Error"
    },
    {
      "parameters": {
        "jsCode": "const config = $json;\nconst audioSections = config._audio_sections;\n\nif (!audioSections || audioSections.length === 0) {\n  throw new Error('No audio sections found!');\n}\n\nconsole.log('Calculating timings for', audioSections.length, 'sections');\n\n// Calculate cumulative timings\nlet currentTime = 0;\nconst timings = [];\n\nfor (const section of audioSections) {\n  const startTime = currentTime;\n  const endTime = currentTime + section.duration_seconds;\n  \n  timings.push({\n    section_name: section.section_name,\n    start_time: Math.round(startTime),\n    end_time: Math.round(endTime),\n    duration: Math.round(section.duration_seconds)\n  });\n  \n  currentTime = endTime;\n  \n  console.log(`${section.section_name}: ${Math.round(startTime)}s - ${Math.round(endTime)}s`);\n}\n\n// Extract car timings specifically (sections with VINs)\nconst carTimings = timings.filter(t => \n  t.section_name !== 'hook' && t.section_name !== 'cta'\n);\n\nconsole.log('Car sections found:', carTimings.length);\n\n// Update vehicles with accurate timings (only for Templates 1 & 2)\nconst updatedVehicles = config.vehicles ? config.vehicles.map((vehicle, index) => {\n  const carTiming = carTimings[index];\n  \n  if (!carTiming) {\n    console.warn(`No timing found for vehicle ${index + 1} (${vehicle.vin})`);\n    return vehicle;\n  }\n  \n  console.log(`Vehicle ${vehicle.vin}: ${carTiming.start_time}s - ${carTiming.end_time}s`);\n  \n  return {\n    ...vehicle,\n    start_time: carTiming.start_time,\n    end_time: carTiming.end_time\n  };\n}) : []; // Empty array for Template 3\n\nconst totalDuration = Math.round(currentTime);\n\nconsole.log(`‚úÖ Total audio duration: ${totalDuration}s`);\nconsole.log(`‚úÖ Updated ${updatedVehicles.length} vehicles with timings`);\n\nreturn [{\n  json: {\n    ...config,\n    vehicles: updatedVehicles,\n    _audio_sections: audioSections,\n    _section_timings: timings,\n    outputs: {\n      ...(config.outputs || {}),\n      audio_duration: totalDuration\n    }\n  }\n}];\n\n// ... existing code ...\n\nconst fileSizeBytes = binaryData.length;\nconst BITRATE_KBPS = 128;\nconst durationSeconds = (fileSizeBytes * 8) / (BITRATE_KBPS * 1000);\nconst roundedDuration = Math.round(durationSeconds * 100) / 100;\n\nconsole.log(`File size: ${fileSizeBytes} bytes`);\nconsole.log(`Calculated duration: ${durationSeconds}s`);\nconsole.log(`Rounded duration: ${roundedDuration}s`);\n\nif (roundedDuration === 0 || !roundedDuration) {\n  console.warn('‚ö†Ô∏è Duration is 0 or null! File might be too small.');\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -528,
        1776
      ],
      "id": "a9085321-e6d7-4522-ac65-856ed886b9b0",
      "name": "Calculate Car Timings from Durations"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "af701ba3-4a67-49f1-b9cd-f4f7e896317b",
              "leftValue": "={{ $json.items[0].template_id }}",
              "rightValue": "TEMP_003",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        736,
        608
      ],
      "id": "c47ccd06-cff0-4cf6-9a2b-fc9ec9e6d63c",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "const input = $json;\nconst audioBase64 = input.items[0].audio_base64; // First (only) item for TEMP_003\nconst fullScript = $input.first().json.items[0].full_script;\nconst templateID = $input.first().json.items[0].template_id;\n\n// Decode base64 to binary buffer\nconst audioBuffer = Buffer.from(audioBase64, 'base64');\n\nreturn [{\n  json: {\n    text: fullScript,\n    full_script: fullScript,\n    template_id: templateID\n  },\n  binary: {\n    audio: {\n      data: audioBuffer.toString('base64'),\n      mimeType: 'audio/mpeg',\n      fileName: 'full_script.mp3',\n      fileExtension: 'mp3'\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        512,
        512
      ],
      "id": "0c76457f-13ca-4f6f-8b84-ceb9c139c8b4",
      "name": "Prepare for Forced Alignment"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.elevenlabs.io/v1/forced-alignment",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "elevenLabsApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "={{ $json.text }}"
            },
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "=audio"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        160,
        528
      ],
      "id": "688352cf-4e22-45c6-9292-6e40e992973b",
      "name": "11Labs Forced Alignment API",
      "credentials": {
        "elevenLabsApi": {
          "id": "SlTH3r2FtzR0lpfq",
          "name": "ElevenLabs account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "const alignmentData = $json;\nconst audioBase = $('Combine Binary Items').first().json.items[0].audio_base64;\n\n// ElevenLabs already gives us words!\nconst words = alignmentData.words;\n\nconsole.log(`Got ${words.length} words with timings`);\n\n// Chunk words into subtitle segments - prioritize natural breaks\nconst subtitleChunks = [];\nconst wordsPerChunk = 7; // Increased from 4 to 7\nconst maxChunkDuration = 3.5; // Increased from 2.5 to 3.5 seconds\nconst minWordsPerChunk = 4; // Don't make chunks TOO small\n\nlet chunkWords = [];\nlet chunkStartTime = null;\n\nfor (let i = 0; i < words.length; i++) {\n  const word = words[i];\n  \n  if (chunkStartTime === null) {\n    chunkStartTime = word.start;\n  }\n  \n  chunkWords.push(word);\n  \n  const chunkDuration = word.end - chunkStartTime;\n  const nextWord = words[i + 1];\n  \n  // Check if we should break here\n  const isPunctuation = word.text.match(/[.,!?;:]$/); // Word ends with punctuation\n  const isLastWord = i === words.length - 1;\n  const hitMaxWords = chunkWords.length >= wordsPerChunk;\n  const hitMaxDuration = chunkDuration >= maxChunkDuration;\n  const hasMinWords = chunkWords.length >= minWordsPerChunk;\n  \n  // Break on punctuation if we have enough words, OR force break if too long\n  const shouldBreak = isLastWord || \n                      (hitMaxWords && isPunctuation) || \n                      (hasMinWords && isPunctuation && chunkDuration > 2.0) ||\n                      hitMaxDuration;\n  \n  if (shouldBreak) {\n    const chunkText = chunkWords.map(w => w.text).join(' ');\n    const chunkEndTime = chunkWords[chunkWords.length - 1].end;\n    \n    subtitleChunks.push({\n      section_name: `subtitle_${subtitleChunks.length + 1}`,\n      section_index: subtitleChunks.length + 1,\n      section_text: chunkText,\n      duration_seconds: parseFloat((chunkEndTime - chunkStartTime).toFixed(2)),\n      start_time: parseFloat(chunkStartTime.toFixed(2))\n    });\n    \n    chunkWords = [];\n    chunkStartTime = null;\n  }\n}\n\nconsole.log(`Created ${subtitleChunks.length} subtitle chunks`);\n\nreturn [{\n  json: {\n    _audio_sections: subtitleChunks,\n    audio_base64: audioBase\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1088,
        592
      ],
      "id": "ad53fa1e-84a0-4e38-9fd7-a6c5b43f00c1",
      "name": "Parse 11Labs response"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "b75618f6-93b4-4480-9a44-47fce4ded67b",
              "leftValue": "={{ $json.template_id || $json.body.template_id }}",
              "rightValue": "TEMP_003",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -592,
        1568
      ],
      "id": "d1f13233-60a5-4d44-a263-977f4e5b6efa",
      "name": "If 2"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst audioBase64 = input.audio_base64;\n\nif (!audioBase64) {\n  throw new Error('No audio_base64 found in input');\n}\n\nconsole.log('Preparing audio for Cloudinary upload');\n\n// Cloudinary wants the data URI format: data:audio/mpeg;base64,{base64data}\nconst audioDataUri = `data:audio/mpeg;base64,${audioBase64}`;\n\nreturn [{\n  json: {\n    ...input,\n    audio_base64: audioDataUri,\n    // Pass through other data that might be needed downstream\n    template_id: input.template_id,\n    _audio_sections: input._audio_sections,\n    full_script: input.full_script\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1120,
        1008
      ],
      "id": "50106c7a-752a-4fac-8607-afb2a88e5edd",
      "name": "Prepare TEMP_003 for Cloudinary"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -176,
        1648
      ],
      "id": "44e9af94-2ec9-43e3-b9ee-ad2c2de0079a",
      "name": "Aggregate Templates"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "\n  {\n    \"template_id\": \"TEMP_001\",\n    \"theme\": \"Black Friday\",\n    \"topic\": \"Holiday Road Trip Checklist: Don't Leave Home Without These!\",\n    \"platform\": \"facebook\",\n    \"include_animation\": false,\n    \"avatar_id\": \"229bfc03d4d24d5ab7a5c71ce4b10d4b\",\n    \"voice_id\": \"bWI0w7QVOZiBvlJQahML\",\n    \"chromakey_color\": \"#89be5a\",\n    \"chromakey_sensitivity\": \"22\",\n    \"avatar_name\": \"Shad\",\n    \"script_length\": \"quick\",\n    \"email\": \"kelly@kellyrae.net\",\n    \"vins\": [\n      \"KMHL64JA7PA272040\"\n    ],\n    \"test_mode\": null,\n    \"vehicles\": [\n      {\n        \"vin\": \"KMHL64JA7PA272040\",\n        \"year\": 2023,\n        \"make\": \"Hyundai\",\n        \"model\": \"Sonata\",\n        \"price\": 21995,\n        \"mileage\": 61401,\n        \"image_url\": \"https://imageserver.promaxinventory.com/9199/image/10bbee7273f6301c27336d0f0f004379.jpg\",\n        \"url\": \"https://www.ccrantoul.com/VehicleDetails/9199/91232\",\n        \"features\": [\n          \"4-Cyl 2.5 Liter\",\n          \"FWD\",\n          \"RED\"\n        ]\n      }\n    ],\n    \"shared_prompt_ready\": true,\n    \"timing_guidance\": {\n      \"target\": \"15-30 seconds\",\n      \"hook\": \"3-4 seconds\",\n      \"cta\": \"4-5 seconds\",\n      \"style\": \"Fast-paced, punchy, only the most critical selling points\"\n    },\n    \"metadata\": {\n      \"template_id\": \"TEMP_001\",\n      \"theme\": \"Black Friday\",\n      \"vehicle_count\": 1,\n      \"script_length\": \"quick\",\n      \"target_duration\": \"15-18 seconds\"\n    },\n    \"script\": {\n      \"hook\": \"Black Friday deals are here at Capitol Car Credit!\",\n      \"segments\": [\n        \"Twenty twenty-three Hunday Sonata - twenty-one thousand nine ninety-five with fuel-efficient four cylinder power!\"\n      ],\n      \"cta\": \"Call two one seven, eight nine three, eight two three two - financing available for qualified buyers!\",\n      \"full_script\": \"Black Friday deals are here at Capitol Car Credit! Twenty twenty-three Hunday Sonata - twenty-one thousand nine ninety-five with fuel-efficient four cylinder power! Call two one seven, eight nine three, eight two three two - financing available for qualified buyers! [pause 1 second]\",\n      \"notes\": \"Emphasized Black Friday theme in hook, highlighted fuel efficiency as top buyer priority, kept pricing clear with proper formatting, included financing mention in CTA for maximum appeal\"\n    },\n    \"_claude_notes\": \"\"\n  }\n",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -720,
        1360
      ],
      "id": "d8824a45-3b8a-4b63-b9dc-3edad23e7d41",
      "name": "Edit Fields"
    }
  ],
  "connections": {
    "Check status": {
      "main": [
        [
          {
            "node": "Is complete?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Create Avatar Video Errors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is complete?": {
      "main": [
        [
          {
            "node": "Add video data to config",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Check status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VBR - Create job": {
      "main": [
        [
          {
            "node": "VBR - Start job",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VBR - Start job": {
      "main": [
        [
          {
            "node": "VBR - Check job",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VBR - Check job": {
      "main": [
        [
          {
            "node": "VBR - Is done?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VBR - Is done?": {
      "main": [
        [],
        [
          {
            "node": "Wait - back to check job",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait - back to check job": {
      "main": [
        [
          {
            "node": "VBR - Check job",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload audio to Cloudinary": {
      "main": [
        [
          {
            "node": "Add audio to config",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Create Avatar Video Errors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create avatar video": {
      "main": [
        [
          {
            "node": "Check status",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Create Avatar Video Errors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        []
      ]
    },
    "Add video data to config": {
      "main": [
        []
      ]
    },
    "Add audio to config": {
      "main": [
        [
          {
            "node": "Create avatar video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Sections": {
      "main": [
        [
          {
            "node": "Split in Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split in Batches": {
      "main": [
        [
          {
            "node": "Combine Binary Items",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate Section Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Section Audio": {
      "main": [
        [
          {
            "node": "Split in Batches",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Create Avatar Video Errors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Concatenate Audio Files": {
      "main": [
        [
          {
            "node": "Aggregate Templates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "If 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract All Durations": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine Binary Items": {
      "main": [
        [
          {
            "node": "Extract All Durations",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Create Avatar Video Errors": {
      "main": [
        [
          {
            "node": "Send email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send email": {
      "main": [
        [
          {
            "node": "Stop and Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Car Timings from Durations": {
      "main": [
        [
          {
            "node": "Concatenate Audio Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Parse 11Labs response",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Prepare for Forced Alignment": {
      "main": [
        []
      ]
    },
    "11Labs Forced Alignment API": {
      "main": [
        [],
        []
      ]
    },
    "Parse 11Labs response": {
      "main": [
        []
      ]
    },
    "If 2": {
      "main": [
        [
          {
            "node": "Aggregate Templates",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Calculate Car Timings from Durations",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare TEMP_003 for Cloudinary": {
      "main": [
        []
      ]
    },
    "Aggregate Templates": {
      "main": [
        [
          {
            "node": "Upload audio to Cloudinary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Prepare Sections",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "6cfcf459-4962-42a0-bd6a-225d7dbdac56",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-11-22T14:53:42.784Z",
      "createdAt": "2025-11-22T14:53:42.784Z",
      "role": "workflow:owner",
      "workflowId": "bH8RmQxbIUXI78cK",
      "projectId": "bll44iFOa92qb20Q"
    }
  ],
  "tags": [
    {
      "updatedAt": "2025-10-20T21:59:42.768Z",
      "createdAt": "2025-10-20T21:59:42.768Z",
      "id": "3FhQWHjHLuIzIS3U",
      "name": "DEV"
    }
  ]
}