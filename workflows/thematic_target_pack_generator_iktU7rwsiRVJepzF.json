{
  "updatedAt": "2026-01-21T23:50:37.426Z",
  "createdAt": "2026-01-19T20:01:58.634Z",
  "id": "iktU7rwsiRVJepzF",
  "name": "Thematic Target Pack Generator",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "thematic-pack-generate",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "90b3c65b-14b3-46ec-85a9-64591da75f9f",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        200,
        300
      ],
      "webhookId": "thematic-pack-generate"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "mode",
              "name": "mode",
              "value": "={{ $json.body.mode || 'seed' }}",
              "type": "string"
            },
            {
              "id": "location",
              "name": "location",
              "value": "={{ $json.body.location || 'Rantoul, Illinois' }}",
              "type": "string"
            },
            {
              "id": "local_override_text",
              "name": "local_override_text",
              "value": "={{ $json.body.local_override_text || null }}",
              "type": "string"
            },
            {
              "id": "current_date",
              "name": "current_date",
              "value": "={{ $now.format('yyyy-MM-dd') }}",
              "type": "string"
            },
            {
              "id": "current_month",
              "name": "current_month",
              "value": "={{ $now.format('MMMM') }}",
              "type": "string"
            },
            {
              "id": "theme_seed",
              "name": "theme_seed",
              "value": "={{ $json.body.theme_seed || '' }}",
              "type": "string"
            },
            {
              "id": "emoji",
              "name": "emoji",
              "value": "={{ $json.body.emoji || '' }}",
              "type": "string"
            },
            {
              "id": "direction",
              "name": "direction",
              "value": "={{ $json.body.direction || '' }}",
              "type": "string"
            },
            {
              "id": "item_summary",
              "name": "item_summary",
              "value": "={{ $json.body.item_summary || '' }}",
              "type": "string"
            },
            {
              "id": "recent_themes",
              "name": "recent_themes",
              "value": "={{ $json.body.recent_themes || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "d60bd59c-d2c5-43d4-b61a-1e42bddb0cae",
      "name": "Parse Request",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        380,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "mode-check",
              "leftValue": "={{ $json.mode }}",
              "rightValue": "seed",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "mode-switch-001",
      "name": "Mode Switch",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        560,
        300
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prompt",
              "name": "prompt",
              "value": "=You are a creative strategist for an automotive video ad platform.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¯ YOUR TASK\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nGenerate a THEME SEED â€” a short, evocative theme direction for this week's video content.\n\nContext:\n- Location: {{ $json.location }}\n- Date: {{ $json.current_date }}\n- Month: {{ $json.current_month }}\n{{ $json.local_override_text ? '- CLIENT DIRECTION: ' + $json.local_override_text : '' }}\n\n{{ $json.recent_themes ? 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\nğŸš« RECENT THEMES (DO NOT REPEAT)\\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\nThese themes were used recently. Generate something DIFFERENT â€” avoid similar words, concepts, and angles:\\n' + $json.recent_themes + '\\n' : '' }}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ§  THEME PHILOSOPHY\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nGreat themes tap into ASPIRATION and IDENTITY, not anxiety.\n\nTarget viewer: Someone whose car is FINE, but who's been daydreaming about something better.\n\nGood theme energy:\n- \"Your future self is waiting\"\n- \"You deserve this upgrade\"\n- \"Imagine pulling up in...\"\n- \"Finally stop settling\"\n- \"Make them do a double-take\"\n\nAvoid theme energy:\n- \"Your car might fail you\"\n- \"Don't get stranded\"\n- \"Avoid embarrassment\"\n- \"Before it's too late\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¨ THEME DIVERSITY\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nThemes should rotate across different angles. Don't default to the obvious.\n\nLEAD with one of these (pick a DIFFERENT category than recent themes):\n- IDENTITY: Who you're becoming, how others see you, personal evolution\n- LIFESTYLE: Life moments, family, adventures, daily joy\n- ASPIRATION: Dreams, goals, treating yourself, leveling up\n- FINANCIAL: Smart money moves, lower payments, more freedom\n- COMMUNITY: Local pride, events, neighbors, belonging\n- MILESTONES: New job, kids growing up, fresh starts, celebrations\n\nSEASON/WEATHER should be SECONDARY flavor, not the primary hook.\nBad: \"Winter Upgrade\" (season IS the theme)\nGood: \"New Year, New Arrival\" (milestone primary, season flavor)\nGood: \"Make Them Look Twice\" (identity primary, no season needed)\n\n{{ $json.local_override_text ? 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\nğŸª CLIENT DIRECTION RULE\\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\nThe client provided specific direction. Build the seed around their input.\\nCapture their intent, but make it punchy and compelling.\\n' : '' }}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“¦ OUTPUT FORMAT (JSON ONLY)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nReturn ONLY valid JSON. No markdown, no extra text.\n\n{\n  \"theme_seed\": \"2â€“5 words, evocative, non-generic\",\n  \"emoji\": \"ONE emoji that fits\",\n  \"direction\": \"One sentence: the vibe and why it works this week\",\n  \"local_override_text\": \"Exact client input if provided, otherwise null\"\n}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "build-seed-prompt-001",
      "name": "Build Seed Prompt",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        760,
        200
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prompt",
              "name": "prompt",
              "value": "=You are a creative strategist for an automotive video ad platform.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¯ YOUR TASK\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nExpand this week's theme seed into a full THEME PACK that will guide script writing.\n\nTHEME SEED: {{ $json.theme_seed }} {{ $json.emoji }}\nDirection: {{ $json.direction }}\n{{ $json.local_override_text ? 'Client direction: ' + $json.local_override_text : '' }}\n\nContext:\n- Location: {{ $json.location }}\n- Date: {{ $json.current_date }}\n- Month: {{ $json.current_month }}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸš— THIS WEEK'S VEHICLE MIX\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n{{ $json.item_summary }}\n\nUse this information to make the theme pack RELEVANT to the actual inventory.\nThe script writers will use this pack to write compelling hooks and angles\nthat naturally connect to these specific vehicles.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ§  THEME PHILOSOPHY\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nGreat themes tap into ASPIRATION and IDENTITY, not anxiety.\n\nTarget viewer: Someone whose car is fine, but who's been daydreaming about something better.\n\nCore tension should evoke:\nâœ“ FOMO â€” \"Everyone else is upgrading, why not you?\"\nâœ“ Identity gap â€” \"Your car doesn't match who you've become\"\nâœ“ Permission â€” \"You've earned this\"\nâœ“ Possibility â€” \"Imagine if...\"\nâœ“ Pride â€” \"Make them notice\"\n\nAvoid tensions that evoke:\nâœ— Fear of breakdown\nâœ— Embarrassment about current car\nâœ— Anxiety about safety\nâœ— Desperation or urgency\n\nNote: Some viewers ARE in tough car situations â€” the theme can INCLUDE them,\nbut shouldn't be BUILT AROUND worst-case scenarios.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¬ LIFESTYLE MOMENTS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nGenerate 6-10 \"lifestyle moments\" â€” concrete scenes where your car\nmatters to your identity, status, convenience, or joy.\n\nGood examples:\n- Pulling up to your kid's school pickup line\n- Your coworkers seeing your new ride in the parking lot\n- Road trip playlist hitting just right with that upgraded sound system\n- Date night arrival at the restaurant\n- Finally having room for the dog AND the groceries\n- Remote start from your kitchen window on a cold morning\n- Surprising your spouse with the keys\n- Tailgating with the crew, trunk full of supplies\n- That first solo drive, windows down, no kids screaming\n\nThese should feel SPECIFIC and VISUAL, not generic.\nTie at least 2-3 to the actual vehicle features in this week's mix.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“ ITEM AFFINITIES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nBased on the theme and vehicle mix, identify which features and\nvehicle types this theme naturally highlights.\n\nExamples:\n- \"SUV-heavy week + family theme = cargo space, third row, road trips\"\n- \"Sporty vehicles + treat-yourself theme = V6, acceleration, styling\"\n- \"Budget-friendly mix + fresh start theme = low payments, reliability, value\"\n\nThis helps script writers know which cars to emphasize for which angles.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâš–ï¸ LEGAL COMPLIANCE (CRITICAL)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâŒ NEVER imply guaranteed financing approval\nâŒ NEVER promise specific payment amounts\nâŒ NEVER suggest \"anyone can qualify\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“¦ OUTPUT FORMAT (JSON ONLY)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nReturn ONLY valid JSON. No markdown, no extra text.\n\n{\n  \"theme_name\": \"Confirmed from seed, 2â€“5 words\",\n  \"emoji\": \"ONE emoji\",\n  \"why\": \"One sentence: why this theme works this week with this inventory\",\n  \"core_tension\": \"One sentence: the aspirational gap or FOMO this theme taps into\",\n  \"ad_angle\": \"One sentence: how this frames shopping/upgrading (non-salesy)\",\n  \"education_angle\": \"One sentence: what helpful advice connects to this theme\",\n  \"lifestyle_moments\": [\"6â€“10 specific, visual scenes\"],\n  \"item_affinities\": {\n    \"highlight_features\": [\"features from this week's mix that fit the theme\"],\n    \"highlight_categories\": [\"vehicle types that fit the theme\"],\n    \"natural_pairings\": [\"2-3 sentences connecting theme to specific inventory strengths\"]\n  },\n  \"banned_phrases\": [\"8â€“12 clichÃ©s, anxiety-triggers, and filler to avoid\"]\n}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "build-pack-prompt-001",
      "name": "Build Pack Prompt",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        760,
        400
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "contents[0].parts[0].text",
              "value": "={{ $json.prompt }}"
            },
            {
              "name": "generationConfig.temperature",
              "value": "0.9"
            },
            {
              "name": "generationConfig.maxOutputTokens",
              "value": "1024"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "gemini-seed-001",
      "name": "Gemini Seed",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        960,
        200
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "prVNksIVEgzVrhKB",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "contents[0].parts[0].text",
              "value": "={{ $json.prompt }}"
            },
            {
              "name": "generationConfig.temperature",
              "value": "0.8"
            },
            {
              "name": "generationConfig.maxOutputTokens",
              "value": "4096"
            }
          ]
        },
        "options": {
          "timeout": 45000
        }
      },
      "id": "gemini-pack-001",
      "name": "Gemini Pack",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        960,
        400
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "prVNksIVEgzVrhKB",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract the Gemini response\nconst geminiResponse = $input.item.json.candidates?.[0]?.content?.parts?.[0]?.text || '';\nconst finishReason = $input.item.json.candidates?.[0]?.finishReason || 'unknown';\n\nlet result;\nlet parseError = null;\n\ntry {\n  let cleaned = geminiResponse.trim();\n  \n  // Remove markdown code blocks if present\n  if (cleaned.startsWith('```json')) {\n    cleaned = cleaned.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  } else if (cleaned.startsWith('```')) {\n    cleaned = cleaned.replace(/```\\n?/g, '').trim();\n  }\n  \n  result = JSON.parse(cleaned);\n} catch (error) {\n  parseError = error.message;\n  \n  // Try to extract partial data\n  const seedMatch = geminiResponse.match(/\"theme_seed\"\\s*:\\s*\"([^\"]+)\"/);\n  const emojiMatch = geminiResponse.match(/\"emoji\"\\s*:\\s*\"([^\"]+)\"/);\n  const dirMatch = geminiResponse.match(/\"direction\"\\s*:\\s*\"([^\"]+)\"/);\n  \n  result = {\n    theme_seed: seedMatch ? seedMatch[1] : 'Weekly Theme',\n    emoji: emojiMatch ? emojiMatch[1] : 'ğŸš—',\n    direction: dirMatch ? dirMatch[1] : 'Connect with customers this week',\n    _warning: 'Partial parse - response may have been truncated',\n    _parse_error: parseError\n  };\n}\n\n// Get local_override_text from Parse Request\nconst localOverrideText = $('Parse Request').item.json.local_override_text;\n\nreturn {\n  success: !!result.theme_seed,\n  mode: 'seed',\n  theme_seed: result.theme_seed,\n  emoji: result.emoji,\n  direction: result.direction,\n  local_override_text: localOverrideText || null\n};"
      },
      "id": "parse-seed-001",
      "name": "Parse Seed Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1160,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Extract the Gemini response\nconst geminiResponse = $input.item.json.candidates?.[0]?.content?.parts?.[0]?.text || '';\nconst finishReason = $input.item.json.candidates?.[0]?.finishReason || 'unknown';\n\nlet themePack;\nlet parseError = null;\n\ntry {\n  let cleaned = geminiResponse.trim();\n  \n  // Remove markdown code blocks if present\n  if (cleaned.startsWith('```json')) {\n    cleaned = cleaned.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  } else if (cleaned.startsWith('```')) {\n    cleaned = cleaned.replace(/```\\n?/g, '').trim();\n  }\n  \n  themePack = JSON.parse(cleaned);\n} catch (error) {\n  parseError = error.message;\n  \n  // Try to extract partial data from truncated JSON\n  const themeMatch = geminiResponse.match(/\"theme_name\"\\s*:\\s*\"([^\"]+)\"/);\n  const emojiMatch = geminiResponse.match(/\"emoji\"\\s*:\\s*\"([^\"]+)\"/);\n  const whyMatch = geminiResponse.match(/\"why\"\\s*:\\s*\"([^\"]+)\"/);\n  const tensionMatch = geminiResponse.match(/\"core_tension\"\\s*:\\s*\"([^\"]+)\"/);\n  const adAngleMatch = geminiResponse.match(/\"ad_angle\"\\s*:\\s*\"([^\"]+)\"/);\n  const eduAngleMatch = geminiResponse.match(/\"education_angle\"\\s*:\\s*\"([^\"]+)\"/);\n  \n  themePack = {\n    theme_name: themeMatch ? themeMatch[1] : $('Parse Request').item.json.theme_seed,\n    emoji: emojiMatch ? emojiMatch[1] : $('Parse Request').item.json.emoji,\n    why: whyMatch ? whyMatch[1] : null,\n    core_tension: tensionMatch ? tensionMatch[1] : null,\n    ad_angle: adAngleMatch ? adAngleMatch[1] : null,\n    education_angle: eduAngleMatch ? eduAngleMatch[1] : null,\n    lifestyle_moments: [],\n    item_affinities: { highlight_features: [], highlight_categories: [], natural_pairings: [] },\n    banned_phrases: [],\n    _warning: 'Partial parse - response may have been truncated',\n    _finish_reason: finishReason,\n    _parse_error: parseError\n  };\n}\n\nreturn {\n  success: !!themePack.theme_name,\n  mode: 'pack',\n  ...themePack\n};"
      },
      "id": "parse-pack-001",
      "name": "Parse Pack Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1160,
        400
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              },
              {
                "name": "Cache-Control",
                "value": "no-cache, no-store, must-revalidate"
              }
            ]
          }
        }
      },
      "id": "respond-seed-001",
      "name": "Respond Seed",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1360,
        200
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              },
              {
                "name": "Cache-Control",
                "value": "no-cache, no-store, must-revalidate"
              }
            ]
          }
        }
      },
      "id": "respond-pack-001",
      "name": "Respond Pack",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1360,
        400
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Parse Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Request": {
      "main": [
        [
          {
            "node": "Mode Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mode Switch": {
      "main": [
        [
          {
            "node": "Build Seed Prompt",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Pack Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Seed Prompt": {
      "main": [
        [
          {
            "node": "Gemini Seed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Pack Prompt": {
      "main": [
        [
          {
            "node": "Gemini Pack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Seed": {
      "main": [
        [
          {
            "node": "Parse Seed Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Pack": {
      "main": [
        [
          {
            "node": "Parse Pack Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Seed Response": {
      "main": [
        [
          {
            "node": "Respond Seed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Pack Response": {
      "main": [
        [
          {
            "node": "Respond Pack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "0a1ba657-e10b-4f92-a0ea-ce0ed3622242",
  "activeVersionId": "0a1ba657-e10b-4f92-a0ea-ce0ed3622242",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2026-01-19T20:01:58.634Z",
      "createdAt": "2026-01-19T20:01:58.634Z",
      "role": "workflow:owner",
      "workflowId": "iktU7rwsiRVJepzF",
      "projectId": "VF66NQc9R74tCdyG"
    }
  ],
  "activeVersion": {
    "updatedAt": "2026-01-21T23:50:37.429Z",
    "createdAt": "2026-01-21T23:50:37.429Z",
    "versionId": "0a1ba657-e10b-4f92-a0ea-ce0ed3622242",
    "workflowId": "iktU7rwsiRVJepzF",
    "nodes": [
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "thematic-pack-generate",
          "responseMode": "responseNode",
          "options": {
            "allowedOrigins": "*",
            "responseHeaders": {
              "entries": [
                {
                  "name": "Access-Control-Allow-Origin",
                  "value": "*"
                },
                {
                  "name": "Access-Control-Allow-Methods",
                  "value": "POST, OPTIONS"
                },
                {
                  "name": "Access-Control-Allow-Headers",
                  "value": "Content-Type"
                }
              ]
            }
          }
        },
        "id": "90b3c65b-14b3-46ec-85a9-64591da75f9f",
        "name": "Webhook",
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 1.1,
        "position": [
          200,
          300
        ],
        "webhookId": "thematic-pack-generate"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "mode",
                "name": "mode",
                "value": "={{ $json.body.mode || 'seed' }}",
                "type": "string"
              },
              {
                "id": "location",
                "name": "location",
                "value": "={{ $json.body.location || 'Rantoul, Illinois' }}",
                "type": "string"
              },
              {
                "id": "local_override_text",
                "name": "local_override_text",
                "value": "={{ $json.body.local_override_text || null }}",
                "type": "string"
              },
              {
                "id": "current_date",
                "name": "current_date",
                "value": "={{ $now.format('yyyy-MM-dd') }}",
                "type": "string"
              },
              {
                "id": "current_month",
                "name": "current_month",
                "value": "={{ $now.format('MMMM') }}",
                "type": "string"
              },
              {
                "id": "theme_seed",
                "name": "theme_seed",
                "value": "={{ $json.body.theme_seed || '' }}",
                "type": "string"
              },
              {
                "id": "emoji",
                "name": "emoji",
                "value": "={{ $json.body.emoji || '' }}",
                "type": "string"
              },
              {
                "id": "direction",
                "name": "direction",
                "value": "={{ $json.body.direction || '' }}",
                "type": "string"
              },
              {
                "id": "item_summary",
                "name": "item_summary",
                "value": "={{ $json.body.item_summary || '' }}",
                "type": "string"
              },
              {
                "id": "recent_themes",
                "name": "recent_themes",
                "value": "={{ $json.body.recent_themes || '' }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "d60bd59c-d2c5-43d4-b61a-1e42bddb0cae",
        "name": "Parse Request",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          380,
          300
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "mode-check",
                "leftValue": "={{ $json.mode }}",
                "rightValue": "seed",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "mode-switch-001",
        "name": "Mode Switch",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          560,
          300
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "prompt",
                "name": "prompt",
                "value": "=You are a creative strategist for an automotive video ad platform.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¯ YOUR TASK\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nGenerate a THEME SEED â€” a short, evocative theme direction for this week's video content.\n\nContext:\n- Location: {{ $json.location }}\n- Date: {{ $json.current_date }}\n- Month: {{ $json.current_month }}\n{{ $json.local_override_text ? '- CLIENT DIRECTION: ' + $json.local_override_text : '' }}\n\n{{ $json.recent_themes ? 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\nğŸš« RECENT THEMES (DO NOT REPEAT)\\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\nThese themes were used recently. Generate something DIFFERENT â€” avoid similar words, concepts, and angles:\\n' + $json.recent_themes + '\\n' : '' }}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ§  THEME PHILOSOPHY\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nGreat themes tap into ASPIRATION and IDENTITY, not anxiety.\n\nTarget viewer: Someone whose car is FINE, but who's been daydreaming about something better.\n\nGood theme energy:\n- \"Your future self is waiting\"\n- \"You deserve this upgrade\"\n- \"Imagine pulling up in...\"\n- \"Finally stop settling\"\n- \"Make them do a double-take\"\n\nAvoid theme energy:\n- \"Your car might fail you\"\n- \"Don't get stranded\"\n- \"Avoid embarrassment\"\n- \"Before it's too late\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¨ THEME DIVERSITY\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nThemes should rotate across different angles. Don't default to the obvious.\n\nLEAD with one of these (pick a DIFFERENT category than recent themes):\n- IDENTITY: Who you're becoming, how others see you, personal evolution\n- LIFESTYLE: Life moments, family, adventures, daily joy\n- ASPIRATION: Dreams, goals, treating yourself, leveling up\n- FINANCIAL: Smart money moves, lower payments, more freedom\n- COMMUNITY: Local pride, events, neighbors, belonging\n- MILESTONES: New job, kids growing up, fresh starts, celebrations\n\nSEASON/WEATHER should be SECONDARY flavor, not the primary hook.\nBad: \"Winter Upgrade\" (season IS the theme)\nGood: \"New Year, New Arrival\" (milestone primary, season flavor)\nGood: \"Make Them Look Twice\" (identity primary, no season needed)\n\n{{ $json.local_override_text ? 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\nğŸª CLIENT DIRECTION RULE\\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\nThe client provided specific direction. Build the seed around their input.\\nCapture their intent, but make it punchy and compelling.\\n' : '' }}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“¦ OUTPUT FORMAT (JSON ONLY)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nReturn ONLY valid JSON. No markdown, no extra text.\n\n{\n  \"theme_seed\": \"2â€“5 words, evocative, non-generic\",\n  \"emoji\": \"ONE emoji that fits\",\n  \"direction\": \"One sentence: the vibe and why it works this week\",\n  \"local_override_text\": \"Exact client input if provided, otherwise null\"\n}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "build-seed-prompt-001",
        "name": "Build Seed Prompt",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          760,
          200
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "prompt",
                "name": "prompt",
                "value": "=You are a creative strategist for an automotive video ad platform.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¯ YOUR TASK\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nExpand this week's theme seed into a full THEME PACK that will guide script writing.\n\nTHEME SEED: {{ $json.theme_seed }} {{ $json.emoji }}\nDirection: {{ $json.direction }}\n{{ $json.local_override_text ? 'Client direction: ' + $json.local_override_text : '' }}\n\nContext:\n- Location: {{ $json.location }}\n- Date: {{ $json.current_date }}\n- Month: {{ $json.current_month }}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸš— THIS WEEK'S VEHICLE MIX\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n{{ $json.item_summary }}\n\nUse this information to make the theme pack RELEVANT to the actual inventory.\nThe script writers will use this pack to write compelling hooks and angles\nthat naturally connect to these specific vehicles.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ§  THEME PHILOSOPHY\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nGreat themes tap into ASPIRATION and IDENTITY, not anxiety.\n\nTarget viewer: Someone whose car is fine, but who's been daydreaming about something better.\n\nCore tension should evoke:\nâœ“ FOMO â€” \"Everyone else is upgrading, why not you?\"\nâœ“ Identity gap â€” \"Your car doesn't match who you've become\"\nâœ“ Permission â€” \"You've earned this\"\nâœ“ Possibility â€” \"Imagine if...\"\nâœ“ Pride â€” \"Make them notice\"\n\nAvoid tensions that evoke:\nâœ— Fear of breakdown\nâœ— Embarrassment about current car\nâœ— Anxiety about safety\nâœ— Desperation or urgency\n\nNote: Some viewers ARE in tough car situations â€” the theme can INCLUDE them,\nbut shouldn't be BUILT AROUND worst-case scenarios.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¬ LIFESTYLE MOMENTS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nGenerate 6-10 \"lifestyle moments\" â€” concrete scenes where your car\nmatters to your identity, status, convenience, or joy.\n\nGood examples:\n- Pulling up to your kid's school pickup line\n- Your coworkers seeing your new ride in the parking lot\n- Road trip playlist hitting just right with that upgraded sound system\n- Date night arrival at the restaurant\n- Finally having room for the dog AND the groceries\n- Remote start from your kitchen window on a cold morning\n- Surprising your spouse with the keys\n- Tailgating with the crew, trunk full of supplies\n- That first solo drive, windows down, no kids screaming\n\nThese should feel SPECIFIC and VISUAL, not generic.\nTie at least 2-3 to the actual vehicle features in this week's mix.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“ ITEM AFFINITIES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nBased on the theme and vehicle mix, identify which features and\nvehicle types this theme naturally highlights.\n\nExamples:\n- \"SUV-heavy week + family theme = cargo space, third row, road trips\"\n- \"Sporty vehicles + treat-yourself theme = V6, acceleration, styling\"\n- \"Budget-friendly mix + fresh start theme = low payments, reliability, value\"\n\nThis helps script writers know which cars to emphasize for which angles.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâš–ï¸ LEGAL COMPLIANCE (CRITICAL)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâŒ NEVER imply guaranteed financing approval\nâŒ NEVER promise specific payment amounts\nâŒ NEVER suggest \"anyone can qualify\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“¦ OUTPUT FORMAT (JSON ONLY)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nReturn ONLY valid JSON. No markdown, no extra text.\n\n{\n  \"theme_name\": \"Confirmed from seed, 2â€“5 words\",\n  \"emoji\": \"ONE emoji\",\n  \"why\": \"One sentence: why this theme works this week with this inventory\",\n  \"core_tension\": \"One sentence: the aspirational gap or FOMO this theme taps into\",\n  \"ad_angle\": \"One sentence: how this frames shopping/upgrading (non-salesy)\",\n  \"education_angle\": \"One sentence: what helpful advice connects to this theme\",\n  \"lifestyle_moments\": [\"6â€“10 specific, visual scenes\"],\n  \"item_affinities\": {\n    \"highlight_features\": [\"features from this week's mix that fit the theme\"],\n    \"highlight_categories\": [\"vehicle types that fit the theme\"],\n    \"natural_pairings\": [\"2-3 sentences connecting theme to specific inventory strengths\"]\n  },\n  \"banned_phrases\": [\"8â€“12 clichÃ©s, anxiety-triggers, and filler to avoid\"]\n}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "build-pack-prompt-001",
        "name": "Build Pack Prompt",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          760,
          400
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "googlePalmApi",
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "contents[0].parts[0].text",
                "value": "={{ $json.prompt }}"
              },
              {
                "name": "generationConfig.temperature",
                "value": "0.9"
              },
              {
                "name": "generationConfig.maxOutputTokens",
                "value": "1024"
              }
            ]
          },
          "options": {
            "timeout": 30000
          }
        },
        "id": "gemini-seed-001",
        "name": "Gemini Seed",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          960,
          200
        ],
        "credentials": {
          "googlePalmApi": {
            "id": "prVNksIVEgzVrhKB",
            "name": "Google Gemini(PaLM) Api account"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "googlePalmApi",
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "contents[0].parts[0].text",
                "value": "={{ $json.prompt }}"
              },
              {
                "name": "generationConfig.temperature",
                "value": "0.8"
              },
              {
                "name": "generationConfig.maxOutputTokens",
                "value": "4096"
              }
            ]
          },
          "options": {
            "timeout": 45000
          }
        },
        "id": "gemini-pack-001",
        "name": "Gemini Pack",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          960,
          400
        ],
        "credentials": {
          "googlePalmApi": {
            "id": "prVNksIVEgzVrhKB",
            "name": "Google Gemini(PaLM) Api account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Extract the Gemini response\nconst geminiResponse = $input.item.json.candidates?.[0]?.content?.parts?.[0]?.text || '';\nconst finishReason = $input.item.json.candidates?.[0]?.finishReason || 'unknown';\n\nlet result;\nlet parseError = null;\n\ntry {\n  let cleaned = geminiResponse.trim();\n  \n  // Remove markdown code blocks if present\n  if (cleaned.startsWith('```json')) {\n    cleaned = cleaned.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  } else if (cleaned.startsWith('```')) {\n    cleaned = cleaned.replace(/```\\n?/g, '').trim();\n  }\n  \n  result = JSON.parse(cleaned);\n} catch (error) {\n  parseError = error.message;\n  \n  // Try to extract partial data\n  const seedMatch = geminiResponse.match(/\"theme_seed\"\\s*:\\s*\"([^\"]+)\"/);\n  const emojiMatch = geminiResponse.match(/\"emoji\"\\s*:\\s*\"([^\"]+)\"/);\n  const dirMatch = geminiResponse.match(/\"direction\"\\s*:\\s*\"([^\"]+)\"/);\n  \n  result = {\n    theme_seed: seedMatch ? seedMatch[1] : 'Weekly Theme',\n    emoji: emojiMatch ? emojiMatch[1] : 'ğŸš—',\n    direction: dirMatch ? dirMatch[1] : 'Connect with customers this week',\n    _warning: 'Partial parse - response may have been truncated',\n    _parse_error: parseError\n  };\n}\n\n// Get local_override_text from Parse Request\nconst localOverrideText = $('Parse Request').item.json.local_override_text;\n\nreturn {\n  success: !!result.theme_seed,\n  mode: 'seed',\n  theme_seed: result.theme_seed,\n  emoji: result.emoji,\n  direction: result.direction,\n  local_override_text: localOverrideText || null\n};"
        },
        "id": "parse-seed-001",
        "name": "Parse Seed Response",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1160,
          200
        ]
      },
      {
        "parameters": {
          "jsCode": "// Extract the Gemini response\nconst geminiResponse = $input.item.json.candidates?.[0]?.content?.parts?.[0]?.text || '';\nconst finishReason = $input.item.json.candidates?.[0]?.finishReason || 'unknown';\n\nlet themePack;\nlet parseError = null;\n\ntry {\n  let cleaned = geminiResponse.trim();\n  \n  // Remove markdown code blocks if present\n  if (cleaned.startsWith('```json')) {\n    cleaned = cleaned.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  } else if (cleaned.startsWith('```')) {\n    cleaned = cleaned.replace(/```\\n?/g, '').trim();\n  }\n  \n  themePack = JSON.parse(cleaned);\n} catch (error) {\n  parseError = error.message;\n  \n  // Try to extract partial data from truncated JSON\n  const themeMatch = geminiResponse.match(/\"theme_name\"\\s*:\\s*\"([^\"]+)\"/);\n  const emojiMatch = geminiResponse.match(/\"emoji\"\\s*:\\s*\"([^\"]+)\"/);\n  const whyMatch = geminiResponse.match(/\"why\"\\s*:\\s*\"([^\"]+)\"/);\n  const tensionMatch = geminiResponse.match(/\"core_tension\"\\s*:\\s*\"([^\"]+)\"/);\n  const adAngleMatch = geminiResponse.match(/\"ad_angle\"\\s*:\\s*\"([^\"]+)\"/);\n  const eduAngleMatch = geminiResponse.match(/\"education_angle\"\\s*:\\s*\"([^\"]+)\"/);\n  \n  themePack = {\n    theme_name: themeMatch ? themeMatch[1] : $('Parse Request').item.json.theme_seed,\n    emoji: emojiMatch ? emojiMatch[1] : $('Parse Request').item.json.emoji,\n    why: whyMatch ? whyMatch[1] : null,\n    core_tension: tensionMatch ? tensionMatch[1] : null,\n    ad_angle: adAngleMatch ? adAngleMatch[1] : null,\n    education_angle: eduAngleMatch ? eduAngleMatch[1] : null,\n    lifestyle_moments: [],\n    item_affinities: { highlight_features: [], highlight_categories: [], natural_pairings: [] },\n    banned_phrases: [],\n    _warning: 'Partial parse - response may have been truncated',\n    _finish_reason: finishReason,\n    _parse_error: parseError\n  };\n}\n\nreturn {\n  success: !!themePack.theme_name,\n  mode: 'pack',\n  ...themePack\n};"
        },
        "id": "parse-pack-001",
        "name": "Parse Pack Response",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1160,
          400
        ]
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={{ $json }}",
          "options": {
            "responseHeaders": {
              "entries": [
                {
                  "name": "Access-Control-Allow-Origin",
                  "value": "*"
                },
                {
                  "name": "Access-Control-Allow-Methods",
                  "value": "GET, POST, OPTIONS"
                },
                {
                  "name": "Access-Control-Allow-Headers",
                  "value": "Content-Type"
                },
                {
                  "name": "Cache-Control",
                  "value": "no-cache, no-store, must-revalidate"
                }
              ]
            }
          }
        },
        "id": "respond-seed-001",
        "name": "Respond Seed",
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.1,
        "position": [
          1360,
          200
        ]
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={{ $json }}",
          "options": {
            "responseHeaders": {
              "entries": [
                {
                  "name": "Access-Control-Allow-Origin",
                  "value": "*"
                },
                {
                  "name": "Access-Control-Allow-Methods",
                  "value": "GET, POST, OPTIONS"
                },
                {
                  "name": "Access-Control-Allow-Headers",
                  "value": "Content-Type"
                },
                {
                  "name": "Cache-Control",
                  "value": "no-cache, no-store, must-revalidate"
                }
              ]
            }
          }
        },
        "id": "respond-pack-001",
        "name": "Respond Pack",
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.1,
        "position": [
          1360,
          400
        ]
      }
    ],
    "connections": {
      "Webhook": {
        "main": [
          [
            {
              "node": "Parse Request",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Request": {
        "main": [
          [
            {
              "node": "Mode Switch",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Mode Switch": {
        "main": [
          [
            {
              "node": "Build Seed Prompt",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Build Pack Prompt",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Seed Prompt": {
        "main": [
          [
            {
              "node": "Gemini Seed",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Pack Prompt": {
        "main": [
          [
            {
              "node": "Gemini Pack",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Gemini Seed": {
        "main": [
          [
            {
              "node": "Parse Seed Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Gemini Pack": {
        "main": [
          [
            {
              "node": "Parse Pack Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Seed Response": {
        "main": [
          [
            {
              "node": "Respond Seed",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Pack Response": {
        "main": [
          [
            {
              "node": "Respond Pack",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Kelly Knight",
    "name": null,
    "description": null,
    "autosaved": false
  },
  "tags": []
}