{
  "updatedAt": "2025-12-17T01:14:23.794Z",
  "createdAt": "2025-12-13T13:57:28.375Z",
  "id": "FOQ8foX33kSuaZEJ",
  "name": "[04] Generate Video",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "jsCode": "const config = $json;\nconst vehicles = config.vehicles || [];\nconst cachedVehicles = [];\nconst needsProcessing = [];\n\n// TEMP_003 skips this, no vehicles required\nfor (const vehicle of vehicles) {\n  const vin = vehicle.vin;\n  \n  if (!vin) {\n    console.log('Vehicle missing VIN, using original');\n    cachedVehicles.push(vehicle);\n    continue;\n  }\n  \n  // Check if bg-removed image exists\n  const bgRemovedUrl = `https://res.cloudinary.com/dtpqxuwby/image/upload/${vin}.png`;\n  \n  try {\n    const response = await this.helpers.httpRequest({\n      method: 'HEAD',\n      url: bgRemovedUrl,\n      returnFullResponse: true,\n      ignoreHttpStatusErrors: true,\n      timeout: 5000\n    });\n    \n    if (response.statusCode === 200) {\n      console.log(`‚úì VIN ${vin}: Found in cache`);\n      vehicle.photo_url = bgRemovedUrl;\n      cachedVehicles.push(vehicle);\n      continue;\n    }\n  } catch (error) {\n    // Not in cache\n  }\n  needsProcessing.push(vehicle);\n}\n\n// Return single item with arrays\nreturn [{\n  json: {\n    ...config,\n    vehicles: vehicles, // ‚Üê Now has updated URLs for cached vehicles\n    vehiclesToProcess: needsProcessing,\n    cachedVehicles: cachedVehicles\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        -128
      ],
      "id": "5ee1ed6d-b685-44f9-8e1f-400d0827b3ef",
      "name": "Process All Vehicles"
    },
    {
      "parameters": {
        "amount": 15
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        368,
        160
      ],
      "id": "558fb222-cacc-4087-a229-4aa997b6777a",
      "name": "Wait for Render",
      "webhookId": "d49effb0-de50-4354-ac9b-59098b0af43f"
    },
    {
      "parameters": {
        "errorMessage": "Gen core errored out."
      },
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        1120,
        -96
      ],
      "id": "923bb706-0c19-45b1-a658-170d42b39318",
      "name": "Stop and Error"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "\n  {\n    \"_audio_sections\": [\n      {\n        \"section_name\": \"hook\",\n        \"section_index\": 0,\n        \"section_text\": \"Check out this deal at Capitol Car Credit!\"\n      },\n      {\n        \"section_name\": \"1N4BL4DV5RN378690\",\n        \"section_index\": 1,\n        \"section_text\": \"Twenty-twenty-four Neesawn Altima - just twenty-three thousand nine ninety-five with great gas mileage to save at the pump!\"\n      },\n      {\n        \"section_name\": \"cta\",\n        \"section_index\": 2,\n        \"section_text\": \"Call two one seven, eight nine three, eight two three two - financing available for qualified buyers!\"\n      }\n    ],\n    \"template_id\": \"TEMP_003\",\n    \"theme\": \"\",\n    \"topic\": \"How to change your oil\",\n    \"platform\": \"instagram\",\n    \"include_animation\": false,\n    \"avatar_id\": \"5b9c75a2f13e4d60b09bcfdafa7339dd\",\n    \"voice_id\": \"eezuv0zKVdVTS0jHdxFa\",\n    \"chromakey_color\": \"#6da264\",\n    \"chromakey_sensitivity\": \"8\",\n    \"avatar_name\": \"Kelly\",\n    \"script_length\": \"quick\",\n    \"email\": \"kelly@kellyrae.net\",\n    \"vins\": [\n      \"1N4BL4DV5RN378690\"\n    ],\n    \"test_mode\": true,\n    \"vehicles\": [\n      {\n        \"vin\": \"1N4BL4DV5RN378690\",\n        \"year\": 2024,\n        \"make\": \"Nissan\",\n        \"model\": \"Altima\",\n        \"price\": 23995,\n        \"mileage\": 40822,\n        \"image_url\": \"https://imageserver.promaxinventory.com/9199/image/6f5088fa57e4f9c9f5b8d1aaa752828d.jpg\",\n        \"url\": \"https://www.ccrantoul.com/VehicleDetails/9199/91242\",\n        \"features\": [\n          \"4-Cyl 2.5 Liter\",\n          \"FWD\",\n          \"BLACK\"\n        ],\n        \"start_time\": 2,\n        \"end_time\": 10\n      }\n    ],\n    \"timing_guidance\": {\n      \"target\": \"15-30 seconds\",\n      \"hook\": \"3-4 seconds\",\n      \"cta\": \"4-5 seconds\",\n      \"style\": \"Fast-paced, punchy, only the most critical selling points\"\n    },\n    \"target_duration\": \"15-18 seconds\",\n    \"script\": {\n      \"hook\": \"Check out this deal at Capitol Car Credit!\",\n      \"segments\": [\n        \"Twenty-twenty-four Neesawn Altima - just twenty-three thousand nine ninety-five with great gas mileage to save at the pump!\"\n      ],\n      \"cta\": \"Call two one seven, eight nine three, eight two three two - financing available for qualified buyers!\",\n      \"full_script\": \"Check out this deal at Capitol Car Credit! Twenty-twenty-four Neesawn Altima - just twenty-three thousand nine ninety-five with great gas mileage to save at the pump! Call two one seven, eight nine three, eight two three two - financing available for qualified buyers! [pause 1 second]\",\n      \"notes\": \"Fast-paced single vehicle highlight focusing on fuel efficiency (top buyer priority) with clear pricing and financing availability. Used proper Nissan pronunciation and emphasized value with gas savings.\"\n    },\n    \"_section_timings\": [\n      {\n        \"section_name\": \"hook\",\n        \"start_time\": 0,\n        \"end_time\": 2,\n        \"duration\": 2\n      },\n      {\n        \"section_name\": \"1N4BL4DV5RN378690\",\n        \"start_time\": 2,\n        \"end_time\": 10,\n        \"duration\": 8\n      },\n      {\n        \"section_name\": \"cta\",\n        \"start_time\": 10,\n        \"end_time\": 17,\n        \"duration\": 7\n      }\n    ],\n    \"audio_duration\": 17,\n    \"audio_url\": \"https://res.cloudinary.com/dtpqxuwby/video/upload/v1763992829/gtvsrefyq07lz7smjfqp.mp3\",\n    \"audio_cloudinary_id\": \"gtvsrefyq07lz7smjfqp\",\n    \"avatar_video_url\": \"https://files2.heygen.ai/aws_pacific/avatar_tmp/9d1d4cfe12b842308662754fabe57f18/72f4019463d34c5a89960c77d906c261.mp4?Expires=1764597712&Signature=UmvnODZ~fS-CI73wc4NZ57L7se-5ZhzxWj7FaDYnAtFviShrgNkQqg1RG9MQfgi5CAZX44~IfUWtfl6RWWIJeKYzDR7Bdg46W2~aGNw8m8-2lEZ6gtv71W3-qpv~OGAk~cjIFVmvL8fgcyk54IYZvz9J1k~okGWodiAkJTwyfsVKlp0N9tCrWoqtStbKgEw-s4A863JI59oq39eXuWa8buAcurez072cPZ5MAS-P0SBX9fbFo4WWt7djzAS4nczXr6BmgJjsFql1ugNK9j6Dd~NvM3uVdBpeLlkitALcnjys4QeKXrb95dhsZqELH2Rnc8f484xTO-VRk8BOLVJ3IQ__&Key-Pair-Id=K38HBHX5LX3X2H\",\n    \"avatar_video_duration\": 16.2537\n  }\n",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -368,
        -128
      ],
      "id": "60798cb7-eaed-47ea-9ce3-b59a10cb4c41",
      "name": "Edit Fields",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Get all items coming into aggregate\nconst allItems = $input.all();\n\n// Get base config from Process All Vehicles\nconst baseConfig = $('Process All Vehicles').first().json;\nconst cachedVehicles = baseConfig.cachedVehicles || [];\nconst originalVehicles = baseConfig.vehicles || [];\n\nconsole.log(`Aggregate: Processing ${allItems.length} items`);\n\n// Process items from removebg/cloudinary flow\nconst processedVehicles = allItems\n  .filter(item => item.json.public_id && item.json.secure_url)\n  .map(item => {\n    const vin = item.json.public_id;\n    \n    // Find the original vehicle data to merge with\n    const originalVehicle = originalVehicles.find(v => v.vin === vin);\n    \n    if (!originalVehicle) {\n      console.warn(`‚ö†Ô∏è No original vehicle found for VIN ${vin}`);\n      return null;\n    }\n    return {\n      ...originalVehicle,  // ‚Üê Keep all original vehicle data\n      photo_url: item.json.secure_url  // ‚Üê Add Cloudinary URL\n    };\n  })\n  .filter(Boolean); // Remove any nulls\n\n// Create lookup maps by VIN\nconst processedByVin = {};\nprocessedVehicles.forEach(v => {\n  processedByVin[v.vin] = v;\n});\n\nconst cachedByVin = {};\ncachedVehicles.forEach(v => {\n  cachedByVin[v.vin] = v;\n});\n\n// Rebuild vehicles array in ORIGINAL order\nconst finalVehicles = originalVehicles.map(originalVehicle => {\n  const vin = originalVehicle.vin;\n  \n  // Use processed or cached version if available, otherwise original\n  return processedByVin[vin] || cachedByVin[vin] || originalVehicle;\n});\n\nconsole.log(`‚úì Total: ${finalVehicles.length} vehicles in correct order`);\n\n// Clean config\nconst { vehiclesToProcess, cachedVehicles: _, ...cleanConfig } = baseConfig;\n\nreturn [{\n  json: {\n    ...cleanConfig,\n    vehicles: finalVehicles\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        96
      ],
      "id": "6be976a7-570a-494c-b41c-72e758ede38f",
      "name": "Aggregate Vehicles"
    },
    {
      "parameters": {
        "jsCode": "return $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -336,
        96
      ],
      "id": "5df931bc-a974-4b08-88f6-d6006b054fc2",
      "name": "Aggregate Configs"
    },
    {
      "parameters": {
        "jsCode": "// Single error - format it for the email\nconst error = $input.first().json;\nconst nodeName = error.node?.name || 'Unknown node';\n\n// Handle different error formats from different APIs\nlet errorMsg = 'Unknown error';\n\n// Cloudinary error format: { \"error\": { \"message\": \"...\" } }\nif (error.error?.message) {\n  errorMsg = error.error.message;\n}\n// Remove.bg error format: { \"errors\": [{ \"code\": \"...\", \"title\": \"...\" }] }\nelse if (error.errors && Array.isArray(error.errors) && error.errors.length > 0) {\n  const firstError = error.errors[0];\n  // Include code if present, otherwise just title\n  errorMsg = firstError.code \n    ? `${firstError.code}: ${firstError.title}` \n    : firstError.title;\n}\n// Creatomate error format: { \"error_message\": \"...\" }\nelse if (error.error_message) {\n  errorMsg = error.error_message;\n}\n// Generic message fallback\nelse if (error.message) {\n  errorMsg = error.message;\n}\n\nreturn [{\n  json: {\n    nodeName: nodeName,\n    errorMessage: errorMsg,\n    timestamp: new Date().toISOString(),\n    rawError: JSON.stringify(error, null, 2) // Include full error for debugging\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        816,
        -96
      ],
      "id": "784d6524-d4b7-4640-b0f1-2467d38dcf9a",
      "name": "Format Node Error"
    },
    {
      "parameters": {
        "content": "# #3 Generate Video",
        "height": 720,
        "width": 1824,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -560,
        -272
      ],
      "typeVersion": 1,
      "id": "cfb457e3-4e30-4045-916a-2c45b78a2cbf",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -512,
        -128
      ],
      "id": "febf4365-88f4-4424-a9d1-ab1dafbe1e95",
      "name": "When Executed by Orchestrate Video Creation"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "78c8847d-ded2-428b-b6d2-8b59e006a8aa",
              "leftValue": "={{ $json.vehiclesToProcess.length}}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -80,
        -128
      ],
      "id": "d3c49706-9898-4e26-9cb1-65ebf9239b23",
      "name": "If: Has Vehicles"
    },
    {
      "parameters": {
        "jsCode": "const vehiclesToProcess = $json.vehiclesToProcess || [];\n\nreturn vehiclesToProcess.map(vehicle => ({\n  json: vehicle\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        -144
      ],
      "id": "cabf3be1-d71f-4d05-a6fb-bd60c6480d77",
      "name": "Send Only Vehicles to Process"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.remove.bg/v1.0/removebg",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "72rkEtm8QRzFpqEmjL42o89z"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"image_url\": \"{{ $json.photo_url || $json.image_url }}\",\n  \"size\": \"auto\",\n  \"format\": \"png\",\n  \"crop\": true,\n  \"crop_margin\": \"10%\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        240,
        -144
      ],
      "id": "d4ecef3b-4065-44b9-b76e-95c1be44b7ac",
      "name": "API: Remove.bg",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cloudinary.com/v1_1/dtpqxuwby/image/upload",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            },
            {
              "name": "upload_preset",
              "value": "n8n_unsigned"
            },
            {
              "name": "public_id",
              "value": "={{ $json.vin }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        544,
        -160
      ],
      "id": "969b1d09-908b-449f-b35d-0404ea08d0dd",
      "name": "API: Cloudinary, Upload",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "cc7c4fae-f404-4b50-b3e0-a86a35ad1403",
              "leftValue": "={{ $json.api_creatomate_create_video }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        32,
        96
      ],
      "id": "e31917be-d832-4f23-9f3a-8dfd718a570c",
      "name": "If: Test, Skip Video Creation"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: $json.api_creatomate_create_video\n}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        368,
        32
      ],
      "id": "aa6dce6f-6e60-452b-a4aa-4a90ebd7214d",
      "name": "Skip Video Creation"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b0d1a7bf-ac65-4401-bf77-dc691de54791",
              "leftValue": "={{ $json.status }}",
              "rightValue": "succeeded",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        720,
        128
      ],
      "id": "cdc69818-5724-4f8c-ae10-d81bdabc5677",
      "name": "If: Succeeded?"
    },
    {
      "parameters": {
        "jsCode": "const apiResponse = $json;\nconst config = $('Aggregate Configs').first().json;\nconst videoUrl = apiResponse.url;\nconst videoDuration = apiResponse.duration;\n\nif (!videoUrl) {\n  throw new Error('Creatomate did not return a video URL');\n}\n\nreturn [{\n  json: {\n    ...config,  // ‚Üê Preserves ALL previous api_* keys!\n    \n    // new\n    final_video_url: videoUrl,\n    video_duration: videoDuration,\n    \n    // Testing API Response\n    ...(config.test_mode && { api_creatomate_create_video: apiResponse })\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1104,
        112
      ],
      "id": "94a3f672-71bd-4b34-a989-262f4bef3c0e",
      "name": "Parse Video Creation Response"
    },
    {
      "parameters": {
        "url": "=https://api.creatomate.com/v1/renders/{{ $json.id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 754b059fc6f045ea9f16cbbdacd691bec27dec04525ad3a8a0d7cdf74136980793efce4b8aafee5312b097973d74b0a4"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        528,
        144
      ],
      "id": "cfbd1219-c74c-4024-9f11-0aef6b6c211b",
      "name": "API: Creatomate, Check Status",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.creatomate.com/v1/renders",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 754b059fc6f045ea9f16cbbdacd691bec27dec04525ad3a8a0d7cdf74136980793efce4b8aafee5312b097973d74b0a4"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.creatomate }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        176,
        176
      ],
      "id": "3e365a4a-5fa9-4942-827f-6f51a60a38c7",
      "name": "API: Creatomate, Create Video",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Get the VIN from your JSON data\nconst vin = $json.vin;\n\n// Get the binary item properly\nconst binaryData = $input.item.binary?.data;\n\nif (!binaryData) {\n  throw new Error('No binary data found');\n}\n\n// Return with renamed file - use $input.item.binary to preserve the actual data\nreturn {\n  json: $json,\n  binary: {\n    data: {\n      ...binaryData,\n      fileName: `${vin}.png`\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        384,
        -160
      ],
      "id": "dcdd5c0b-9198-468f-a2f2-d28e3341212e",
      "name": "Parse Remove.bg"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "return (async () => {\n\n// Unified Build Template JSON node\n// Fetches template by tag, modifies source in-place, returns full source for render\n\nconst config = $json;\n\n// ============================================\n// STEP 1: Determine Template Tag\n// ============================================\nconst clientId = (config.client || 'ccc').toUpperCase();\nconst templateId = config.template_id || 'ad-multi-item-1';\nconst ratio = config.ratio || '9:16';\n\n// Convert template_id to tag format\n// \"ad-multi-item-1\" ‚Üí \"AD_MULTI-ITEM-1\"\nconst templateTag = templateId.toUpperCase().replace(/-/, '_');\nconst uniqueTag = `${clientId}_${templateTag}_${ratio}`;\n\nconsole.log(`üè∑Ô∏è Fetching template with tag: ${uniqueTag}`);\n\n// ============================================\n// STEP 2: Fetch Template from Creatomate\n// ============================================\nconst apiKey = '754b059fc6f045ea9f16cbbdacd691bec27dec04525ad3a8a0d7cdf74136980793efce4b8aafee5312b097973d74b0a4';\n\n// Step 1: Find template by tag (returns id, name, tags - but NOT source)\nconst templateList = await this.helpers.httpRequest({\n  method: 'GET',\n  url: `https://api.creatomate.com/v1/templates?tags=${encodeURIComponent(uniqueTag)}`,\n  headers: {\n    'Authorization': `Bearer ${apiKey}`\n  },\n  json: true\n});\n\nif (!templateList || !Array.isArray(templateList) || templateList.length === 0) {\n  throw new Error(`No template found with tag: ${uniqueTag}`);\n}\n\nconst templateInfo = templateList[0];\nconsole.log(`üìç Found template: ${templateInfo.name} (ID: ${templateInfo.id})`);\n\n// Step 2: Fetch full template by ID (this returns the source)\nconst template = await this.helpers.httpRequest({\n  method: 'GET',\n  url: `https://api.creatomate.com/v1/templates/${templateInfo.id}`,\n  headers: {\n    'Authorization': `Bearer ${apiKey}`\n  },\n  json: true\n});\n\nif (!template.source) {\n  throw new Error(`Template ${template.id} has no source property`);\n}\n\n// Deep clone the source\nconst source = JSON.parse(JSON.stringify(template.source));\n\nconsole.log(`‚úÖ Loaded template source (${Object.keys(template.source).length} top-level keys)`);\n\n// ============================================\n// STEP 3: Build Swap Config from Incoming Data\n// ============================================\n\n// Platform info\nconst platformInput = (config.platform || 'tiktok').toLowerCase();\nconst basePlatform = platformInput.split('-')[0];\nconst avatarName = config.avatar_name || 'SHAD';\n\n// Platform banner text\nconst platformTexts = {\n  'tiktok': `Ask for ${avatarName} and mention you saw this on TIKTOK!`,\n  'youtube': `Ask for ${avatarName} and mention you saw this on YOUTUBE!`,\n  'instagram': `Ask for ${avatarName} and mention you saw this on INSTAGRAM!`,\n  'facebook': `Ask for ${avatarName} and mention you saw this on FACEBOOK!`,\n  'none': `Ask for ${avatarName} for a great deal!`\n};\nconst platformText = platformTexts[basePlatform] || platformTexts['none'];\n\n// Timing from _section_timings\nconst sectionTimings = config._section_timings || [];\nconst hookSection = sectionTimings.find(t => t.name === 'hook');\nconst ctaSection = sectionTimings.find(t => t.name === 'cta');\n\nconst hookEnd = hookSection?.end || 0;\nconst ctaStart = ctaSection?.start || 0;\nconst videoDuration = config.avatar_video_duration || ctaSection?.end || 30;\n\n// Vehicles\nconst vehicles = config.vehicles || [];\nconst heroVehicle = vehicles[0] || {};\n\n// Spotlight feature photos\nconst selectedPhotos = config.selected_photos || [];\nconst featurePhotos = selectedPhotos.slice(1, 6);\n\n// Price formatter\nfunction formatPrice(price) {\n  if (!price) return null;\n  let priceNum = price;\n  if (typeof price === 'string') {\n    priceNum = parseFloat(price.replace(/[^0-9.]/g, ''));\n  }\n  if (isNaN(priceNum)) return price;\n  return '$' + priceNum.toLocaleString('en-US', { maximumFractionDigits: 0 });\n}\n\n// Build swap config\nconst swapConfig = {\n  hookEnd,\n  ctaStart,\n  videoDuration,\n  platformText,\n  bgMusicSource: config.media?.music_url,\n  bgImageSource: config.background_image_url,\n  avatar1Source: config.avatar_video_url,\n  avatar1ChromaColor: config.chromakey_color || \"#7fc741\",\n  avatar1ChromaSensitivity: config.chromakey_sensitivity || \"29\",\n  avatar1MaskSource: config.avatar_mask_video_url,\n  item0Source: heroVehicle.photo_url,\n  item0Title: heroVehicle.year && heroVehicle.make && heroVehicle.model\n    ? `${heroVehicle.year} ${heroVehicle.make} ${heroVehicle.model}` : null,\n  item0Price: formatPrice(heroVehicle.price),\n  videoThumbnailText: config.script?.hook || config.topic || '',\n};\n\n// Spotlight features\nfeaturePhotos.forEach((photo, index) => {\n  const featureNum = index + 1;\n  const segmentTiming = sectionTimings.find(t => t.name === `segment_${featureNum}`);\n  swapConfig[`item0Feature${featureNum}Source`] = photo?.photo_url;\n  swapConfig[`item0Feature${featureNum}Time`] = segmentTiming?.start;\n  swapConfig[`item0Feature${featureNum}Duration`] = segmentTiming?.duration;\n});\n\n// Multi-item vehicles\nvehicles.forEach((vehicle, index) => {\n  const itemNum = index + 1;\n  if (itemNum > 5) return;\n  const segmentTiming = sectionTimings.find(t => t.name === `segment_${index}`);\n  swapConfig[`item${itemNum}Source`] = vehicle.photo_url;\n  swapConfig[`item${itemNum}Title`] = vehicle.year && vehicle.make && vehicle.model\n    ? `${vehicle.year} ${vehicle.make} ${vehicle.model}` : null;\n  swapConfig[`item${itemNum}Price`] = formatPrice(vehicle.price);\n  swapConfig[`item${itemNum}Mileage`] = vehicle.mileage\n    ? `${Number(vehicle.mileage).toLocaleString('en-US')} mi` : null;\n  swapConfig[`item${itemNum}Time`] = segmentTiming?.start;\n  swapConfig[`item${itemNum}Duration`] = segmentTiming?.duration;\n  swapConfig[`item${itemNum}Visible`] = true;\n});\n\n// Mark unused slots\nfor (let i = vehicles.length + 1; i <= 5; i++) {\n  swapConfig[`item${i}Visible`] = false;\n}\n\nconsole.log(`üìã Config built for: ${templateId}`);\n\n// ============================================\n// STEP 4: Apply Swaps to Source\n// ============================================\n\nfunction applyScaleAnimTiming(element, cfg) {\n  if (!element.animations) return;\n  const scaleAnims = element.animations.filter(a => a.type === 'scale');\n  if (scaleAnims.length === 1 && cfg.hookEnd !== undefined) {\n    scaleAnims[0].time = cfg.hookEnd;\n  } else if (scaleAnims.length === 2) {\n    if (cfg.hookEnd !== undefined) scaleAnims[0].time = cfg.hookEnd;\n    if (cfg.ctaStart !== undefined) scaleAnims[1].time = cfg.ctaStart;\n  }\n}\n\nfunction applySwaps(element, cfg, parent = null) {\n  const name = element.name;\n\n  // Avatar\n  if (name?.match(/^avatar-(\\d+)$/)) {\n    const n = RegExp.$1;\n    if (cfg[`avatar${n}Source`]) element.source = cfg[`avatar${n}Source`];\n    if (cfg[`avatar${n}ChromaColor`]) element.chroma_key_color = cfg[`avatar${n}ChromaColor`];\n    if (cfg[`avatar${n}ChromaSensitivity`]) element.chroma_key_sensitivity = cfg[`avatar${n}ChromaSensitivity`];\n    applyScaleAnimTiming(element, cfg);\n  }\n\n  // Avatar Mask Layer (for RVM alpha mask compositing)\n  if (name?.match(/^avatar-(\\d+)-mask$/)) {\n    const n = RegExp.$1;\n    if (cfg[`avatar${n}MaskSource`]) {\n      element.source = cfg[`avatar${n}MaskSource`];\n      console.log(`‚úì Applied mask video to avatar-${n}-mask`);\n    }\n  }\n\n  // Item-0 (hero) scale animation\n  if (name === 'Item-0') {\n    applyScaleAnimTiming(element, cfg);\n  }\n\n  // Item-0 nested elements\n  if (name === 'photo' && parent === 'Item-0') {\n    if (cfg.item0Source) element.source = cfg.item0Source;\n  }\n  if (name === 'title' && parent === 'Item-0') {\n    if (cfg.item0Title) element.text = cfg.item0Title;\n  }\n  if (name === 'price' && parent === 'Item-0') {\n    if (cfg.item0Price) element.text = cfg.item0Price;\n  }\n\n  // Features inside Item-0\n  const featureMatch = name?.match(/^feature-(\\d+)$/);\n  if (featureMatch && parent === 'Item-0') {\n    const n = featureMatch[1];\n    if (cfg[`item0Feature${n}Source`]) element.source = cfg[`item0Feature${n}Source`];\n    if (cfg[`item0Feature${n}Time`] !== undefined) element.time = cfg[`item0Feature${n}Time`];\n    if (cfg[`item0Feature${n}Duration`] !== undefined) element.duration = cfg[`item0Feature${n}Duration`];\n  }\n\n  // Multi-item Items (1-5)\n  const itemMatch = name?.match(/^Item-(\\d+)$/);\n  if (itemMatch && itemMatch[1] !== '0') {\n    const n = itemMatch[1];\n    if (cfg[`item${n}Time`] !== undefined) element.time = cfg[`item${n}Time`];\n    if (cfg[`item${n}Duration`] !== undefined) element.duration = cfg[`item${n}Duration`];\n    if (cfg[`item${n}Visible`] === false) element.visible = false;\n  }\n\n  // Multi-item nested elements\n  const parentItemMatch = parent?.match(/^Item-(\\d+)$/);\n  if (parentItemMatch && parentItemMatch[1] !== '0') {\n    const n = parentItemMatch[1];\n    if (name === 'photo' && cfg[`item${n}Source`]) element.source = cfg[`item${n}Source`];\n    if (name === 'title' && cfg[`item${n}Title`]) element.text = cfg[`item${n}Title`];\n    if (name === 'price' && cfg[`item${n}Price`]) element.text = cfg[`item${n}Price`];\n    if (name === 'mileage' && cfg[`item${n}Mileage`]) element.text = cfg[`item${n}Mileage`];\n  }\n\n  // Platform banner\n  if (name === 'platform-banner') {\n    if (cfg.platformText) element.text = cfg.platformText;\n    if (element.animations?.[0] && cfg.videoDuration) {\n      element.animations[0].duration = cfg.videoDuration;\n    }\n  }\n\n  // Company intro - duration matches hook\n  if (name === 'Company-Intro' || name === 'Contact-Info-intro') {\n    if (cfg.hookEnd !== undefined) element.duration = cfg.hookEnd;\n  }\n\n  // Company outro\n  if (name === 'Company-Outro') {\n    if (cfg.ctaStart !== undefined) element.time = cfg.ctaStart;\n  }\n\n  // Background music/image\n  if (name === 'background-music' && cfg.bgMusicSource) {\n    element.source = cfg.bgMusicSource;\n  }\n  if (name === 'background-image' && cfg.bgImageSource) {\n    element.source = cfg.bgImageSource;\n  }\n\n  // Educational video thumbnail\n  if (name === 'video-thumbnail' && cfg.videoThumbnailText) {\n    element.text = cfg.videoThumbnailText;\n  }\n\n  // Recurse\n  if (element.elements && Array.isArray(element.elements)) {\n    element.elements.forEach(child => applySwaps(child, cfg, name));\n  }\n}\n\n// Set top-level duration\nif (swapConfig.videoDuration) {\n  source.duration = swapConfig.videoDuration;\n}\n\n// Apply swaps recursively\nif (source.elements && Array.isArray(source.elements)) {\n  source.elements.forEach(element => applySwaps(element, swapConfig, null));\n}\n\nconsole.log(`‚úÖ Template modifications applied`);\n\n// ============================================\n// STEP 5: Return template_id + source for Creatomate\n// ============================================\n// Tested: Creatomate accepts both! This keeps template name in logs.\n\n// Clean swapConfig - remove undefined values for cleaner output\nconst cleanSwapConfig = Object.fromEntries(\n  Object.entries(swapConfig).filter(([_, v]) => v !== undefined)\n);\n\nconst output = {\n  ...config,\n  creatomate: {\n        source: source\n  },\n  _template_tag: uniqueTag,\n  _swap_config: cleanSwapConfig\n};\n\n// runOnceForEachItem mode: return single object, not array\nreturn {\n  json: JSON.parse(JSON.stringify(output))\n}\n\n})();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -176,
        96
      ],
      "id": "unified-build-template-json",
      "name": "Build Template JSON"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.resend.com/emails",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"from\": \"errors@ad-pilot.ai\",\n  \"to\": \"kelly@ad-pilot.ai\", \n  \"subject\": \"üö® Video Generation Failed - {{ $json.nodeName }}\",\n  \"html\": \"‚ö†Ô∏è Video Creation Workflow Error<br/><br/>Failed Node: {{ $json.nodeName }}<br/>Error: {{ $json.errorMessage }}<br/><br/>Time: {{ $json.timestamp }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        976,
        -96
      ],
      "id": "5806628c-bf99-4c78-b44e-e563d2f56a37",
      "name": "Email Errors",
      "credentials": {
        "httpBearerAuth": {
          "id": "vdxOfyrKMfWKSmAH",
          "name": "Resend"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "3f2511ab-5b89-4844-973a-9b615994e7b4",
              "leftValue": "={{$json.status}}",
              "rightValue": "failed",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        864,
        240
      ],
      "id": "236a86f6-9fb4-4fb5-aabd-3c81607721dd",
      "name": "If: Failed?"
    }
  ],
  "connections": {
    "Process All Vehicles": {
      "main": [
        [
          {
            "node": "If: Has Vehicles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Render": {
      "main": [
        [
          {
            "node": "API: Creatomate, Check Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Process All Vehicles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Vehicles": {
      "main": [
        [
          {
            "node": "Aggregate Configs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Configs": {
      "main": [
        [
          {
            "node": "Build Template JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Node Error": {
      "main": [
        [
          {
            "node": "Email Errors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Orchestrate Video Creation": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: Has Vehicles": {
      "main": [
        [
          {
            "node": "Send Only Vehicles to Process",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Aggregate Configs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Only Vehicles to Process": {
      "main": [
        [
          {
            "node": "API: Remove.bg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Remove.bg": {
      "main": [
        [
          {
            "node": "Parse Remove.bg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Node Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Cloudinary, Upload": {
      "main": [
        [
          {
            "node": "Aggregate Vehicles",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Node Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: Test, Skip Video Creation": {
      "main": [
        [
          {
            "node": "Skip Video Creation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API: Creatomate, Create Video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip Video Creation": {
      "main": [
        [
          {
            "node": "Parse Video Creation Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: Succeeded?": {
      "main": [
        [
          {
            "node": "Parse Video Creation Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If: Failed?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Video Creation Response": {
      "main": [
        []
      ]
    },
    "API: Creatomate, Check Status": {
      "main": [
        [
          {
            "node": "If: Succeeded?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Node Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Creatomate, Create Video": {
      "main": [
        [
          {
            "node": "Wait for Render",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Node Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Remove.bg": {
      "main": [
        [
          {
            "node": "API: Cloudinary, Upload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Template JSON": {
      "main": [
        [
          {
            "node": "If: Test, Skip Video Creation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Errors": {
      "main": [
        [
          {
            "node": "Stop and Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: Failed?": {
      "main": [
        [
          {
            "node": "Format Node Error",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait for Render",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "4bf79ea0-1142-4544-b210-2e6caed305c9",
  "activeVersionId": null,
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-12-13T13:57:28.375Z",
      "createdAt": "2025-12-13T13:57:28.375Z",
      "role": "workflow:owner",
      "workflowId": "FOQ8foX33kSuaZEJ",
      "projectId": "VF66NQc9R74tCdyG"
    }
  ],
  "activeVersion": null,
  "tags": []
}