{
  "updatedAt": "2026-01-09T19:57:11.502Z",
  "createdAt": "2025-12-13T13:57:28.375Z",
  "id": "FOQ8foX33kSuaZEJ",
  "name": "[04] Generate Video",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "jsCode": "const config = $json;\nconst vehicles = config.vehicles || [];\nconst cachedVehicles = [];\nconst needsProcessing = [];\n\n// TEMP_003 skips this, no vehicles required\nfor (const vehicle of vehicles) {\n  const vin = vehicle.vin;\n  \n  if (!vin) {\n    console.log('Vehicle missing VIN, using original');\n    cachedVehicles.push(vehicle);\n    continue;\n  }\n  \n  // Check if bg-removed image exists\n  const bgRemovedUrl = `https://res.cloudinary.com/dtpqxuwby/image/upload/${vin}.png`;\n  \n  try {\n    const response = await this.helpers.httpRequest({\n      method: 'HEAD',\n      url: bgRemovedUrl,\n      returnFullResponse: true,\n      ignoreHttpStatusErrors: true,\n      timeout: 5000\n    });\n    \n    if (response.statusCode === 200) {\n      console.log(`âœ“ VIN ${vin}: Found in cache`);\n      vehicle.photo_url = bgRemovedUrl;\n      cachedVehicles.push(vehicle);\n      continue;\n    }\n  } catch (error) {\n    // Not in cache\n  }\n  needsProcessing.push(vehicle);\n}\n\n// Return single item with arrays\nreturn [{\n  json: {\n    ...config,\n    vehicles: vehicles, // â† Now has updated URLs for cached vehicles\n    vehiclesToProcess: needsProcessing,\n    cachedVehicles: cachedVehicles\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        -128
      ],
      "id": "5ee1ed6d-b685-44f9-8e1f-400d0827b3ef",
      "name": "Process All Vehicles"
    },
    {
      "parameters": {
        "amount": 15
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        368,
        160
      ],
      "id": "558fb222-cacc-4087-a229-4aa997b6777a",
      "name": "Wait for Render",
      "webhookId": "d49effb0-de50-4354-ac9b-59098b0af43f"
    },
    {
      "parameters": {
        "errorMessage": "Gen core errored out."
      },
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        1120,
        -96
      ],
      "id": "923bb706-0c19-45b1-a658-170d42b39318",
      "name": "Stop and Error"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "\n  {\n    \"client\": \"ccc\",\n    \"template_id\": \"social-educational-1\",\n    \"ratio\": \"9:16\",\n    \"theme\": \"\",\n    \"topic\": \"Got a Chunk of Money Set Aside for a Car? Hereâ€™s How to Use It Smart.\",\n    \"platform\": \"facebook-reels\",\n    \"include_animation\": false,\n    \"avatar_id\": \"4d75066423634a8aa5adc148095323f1\",\n    \"voice_id\": \"f6d15141c0f74f99b855786e6c964b48\",\n    \"avatar_name\": \"Gary\",\n    \"script_length\": \"quick\",\n    \"email\": \"kelly@kellyrae.net\",\n    \"vins\": [],\n    \"test_mode\": false,\n    \"script\": {\n      \"hook\": \"If youâ€™ve saved up some money for your next car, thatâ€™s a great place to start.\",\n      \"segments\": [\n        \"A lot of people come in with a lump sum and ask how to use it wisely. One smart approach is putting part of that money down, and keeping some aside for the things that come with owning a car â€” like maintenance, registration, and insurance. That way, youâ€™re comfortable from day one and not stretched thin later. Itâ€™s all about finding the balance that works for your budget and your life.\"\n      ],\n      \"cta\": \"If youâ€™re planning a car purchase in Central Illinois, weâ€™re happy to help you think it through and find something reliable at Capitol Car Credit.\",\n      \"full_script\": \"If youâ€™ve saved up some money for your next car, thatâ€™s a great place to start. A lot of people come in with a lump sum and ask how to use it wisely. One smart approach is putting part of that money down, and keeping some aside for the things that come with owning a car â€” like maintenance, registration, and insurance. That way, youâ€™re comfortable from day one and not stretched thin later. Itâ€™s all about finding the balance that works for your budget and your life. If youâ€™re planning a car purchase in Central Illinois, weâ€™re happy to help you think it through and find something reliable at Capitol Car Credit.\",\n      \"notes\": \"ğŸ’¸ Blowing car money â€¢ âŒ Wrong priorities â€¢ ğŸš— Smart car math â€¢ ğŸ’° Keep buffer money â€¢ âš ï¸ Reality hits hard â€¢ ğŸ§  Smart buyers plan â€¢ ğŸ“ Central Illinois help\",\n      \"_claude_notes\": \"Hook works by immediately calling out a common financial mistake that sounds counterintuitive - people expect to spend their full budget. The 'wrong thing first' creates curiosity about what they should prioritize instead. Stakes are clear: financial stress and being stranded without backup funds.\",\n      \"body\": \"A lot of people come in with a lump sum and ask how to use it wisely. One smart approach is putting part of that money down, and keeping some aside for the things that come with owning a car â€” like maintenance, registration, and insurance. That way, youâ€™re comfortable from day one and not stretched thin later. Itâ€™s all about finding the balance that works for your budget and your life.\"\n    },\n    \"script_edited\": true,\n    \"job_id\": \"mk1pu30sl1q7olg\",\n    \"user_prompt\": \"\\nYou are writing a SHORT-FORM, SCROLL-STOPPING educational video script for Gary at Capitol Car Credit, a used car dealership in Rantoul, Illinois (125 North Century Boulevard).\\n\\nThis is NOT a sales video.\\nThis IS opinionated, high-energy education designed to stop scrolling, challenge assumptions, and teach ONE useful thing fast.\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nğŸ¯ CORE GOAL (CRITICAL)\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nMake the viewer feel:\\nâ€œI didnâ€™t know that â€” Iâ€™m glad I watched.â€\\n\\nIf the script sounds calm, neutral, or blog-like, it has FAILED.\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nğŸ“Œ TOPIC\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nGot a Chunk of Money Set Aside for a Car? Hereâ€™s How to Use It Smart.\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nğŸ‘¥ TARGET AUDIENCE\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nYoung, budget-conscious, first-time car buyers who worry about:\\n- wasting money\\n- making a bad decision\\n- getting taken advantage of\\n- putting their family at risk\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nâ±ï¸ STRUCTURE & TIMING (NON-NEGOTIABLE)\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nHook: 3 seconds  \\nValue: 25 seconds  \\nAuthority: 7 seconds  \\nCTA: 5 seconds  \\nTotal: ~40 seconds\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nğŸ”¥ HOOK RULES (VERY IMPORTANT)\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n- Start with a STRONG STATEMENT, not a polite question\\n- Imply a mistake, myth, danger, or cost\\n- Avoid â€œQuick tipâ€, â€œDid you knowâ€, or soft curiosity\\n- The hook should sound like something someone might argue with\\n\\nGOOD:\\n- â€œMost people mess this up.â€\\n- â€œThis mistake costs people money.â€\\n- â€œIf you hear this noise, pay attention.â€\\n\\nBAD:\\n- â€œAre you wonderingâ€¦â€\\n- â€œToday weâ€™re going to talk aboutâ€¦â€\\n- â€œHereâ€™s a quick tipâ€¦â€\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nâš¡ DELIVERY & ENERGY (CRITICAL)\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n- Short sentences (5â€“8 words max whenever possible)\\n- Punchy, confident phrasing\\n- Opinionated but trustworthy\\n- NO filler phrases (â€œa lot of people ask meâ€¦â€)\\n- Write for FAST speech, not reading\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nğŸ§  VALUE SECTION RULES\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n- Teach ONE core idea only\\n- Frame it as: what most people get wrong â†’ what to do instead\\n- Use concrete, easy-to-visualize examples\\n- Avoid long explanations or lists\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nğŸ† AUTHORITY SECTION RULES\\nâ”â”â”â”â”â”ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n- Tie advice to real-world experience\\n- Keep it SHORT and grounded\\n- Example framing:\\n  â€œIâ€™ve seen this for years.â€\\n  â€œThis comes up all the time.â€\\n  â€œIâ€™ve watched people make this mistake.â€\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nğŸ“£ CTA RULES (SOFT, NOT SALESY)\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n- Ask for engagement FIRST (comment, follow, save)\\n- Then a light Capitol Car Credit mention\\n- No urgency pressure\\n- No hype language\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nğŸš« TTS COMPATIBILITY (CRITICAL)\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nAll script text will be spoken by text-to-speech.\\n- NO emojis anywhere in hook, segments, cta, or full_script\\n- Emojis are allowed ONLY in the \\\"notes\\\" field (for on-screen text)\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nğŸ§¾ OUTPUT FORMAT (MUST MATCH EXACTLY)\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nReturn a JSON object with this EXACT structure:\\n\\n{\\n  \\\"hook\\\": \\\"3â€“4 second strong opening statement\\\",\\n  \\\"segments\\\": [\\n    \\\"Main value section (fast, punchy, mistake â†’ fix framing)\\\",\\n    \\\"Authority reinforcement (short, credibility-based)\\\"\\n  ],\\n  \\\"cta\\\": \\\"Engagement ask + soft Capitol Car Credit mention\\\",\\n  \\\"full_script\\\": \\\"Complete script flowing naturally from hook â†’ value â†’ authority â†’ CTA. Use <break time='0.5s' /> or <break time='1s' /> where it helps pacing. Total speaking time ~40 seconds.\\\",\\n  \\\"notes\\\": \\\"5â€“7 ultra-short punchy phrases (3â€“6 words each) suitable for optional on-screen text. Emphasize mistakes, risks, or consequences.\\\",\\n  \\\"_claude_notes\\\": \\\"Brief explanation of the hook angle and why it works\\\"\\n}\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nğŸš« HARD FAIL CONDITIONS\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n- Neutral, blog-style explanations\\n- Soft educational tone\\n- Overly long sentences\\n- Multiple tips instead of one core idea\\n- Generic advice without stakes\\n\\nWrite now.\\n\",\n    \"timing\": {\n      \"hook\": 3,\n      \"value\": 25,\n      \"authority\": 7,\n      \"cta\": 5,\n      \"total\": 40\n    },\n    \"text\": \"If youâ€™ve saved up some money for your next car, thatâ€™s a great place to start. A lot of people come in with a lump sum and ask how to use it wisely. One smart approach is putting part of that money down, and keeping some aside for the things that come with owning a car â€” like maintenance, registration, and insurance. That way, youâ€™re comfortable from day one and not stretched thin later. Itâ€™s all about finding the balance that works for your budget and your life. If youâ€™re planning a car purchase in Central Illinois, weâ€™re happy to help you think it through and find something reliable at Capitol Car Credit.\",\n    \"audio_url\": \"https://resource2.heygen.ai/text_to_speech/9d1d4cfe12b842308662754fabe57f18/f6d15141c0f74f99b855786e6c964b48/id=56135303-d188-4b59-9637-d6e302c6d8b5.wav\",\n    \"heygen_tts\": {\n      \"audio_url\": \"https://resource2.heygen.ai/text_to_speech/9d1d4cfe12b842308662754fabe57f18/f6d15141c0f74f99b855786e6c964b48/id=56135303-d188-4b59-9637-d6e302c6d8b5.wav\",\n      \"duration\": 33.985,\n      \"word_timestamps\": [\n        {\n          \"word\": \"<start>\",\n          \"start\": 0,\n          \"end\": 0\n        },\n        {\n          \"word\": \"If\",\n          \"start\": 0.239,\n          \"end\": 0.34\n        },\n        {\n          \"word\": \"youâ€™ve\",\n          \"start\": 0.399,\n          \"end\": 0.599\n        },\n        {\n          \"word\": \"saved\",\n          \"start\": 0.62,\n          \"end\": 0.879\n        },\n        {\n          \"word\": \"up\",\n          \"start\": 0.939,\n          \"end\": 1.019\n        },\n        {\n          \"word\": \"some\",\n          \"start\": 1.1,\n          \"end\": 1.24\n        },\n        {\n          \"word\": \"money\",\n          \"start\": 1.279,\n          \"end\": 1.539\n        },\n        {\n          \"word\": \"for\",\n          \"start\": 1.599,\n          \"end\": 1.659\n        },\n        {\n          \"word\": \"your\",\n          \"start\": 1.699,\n          \"end\": 1.799\n        },\n        {\n          \"word\": \"next\",\n          \"start\": 1.839,\n          \"end\": 2.039\n        },\n        {\n          \"word\": \"car,\",\n          \"start\": 2.139,\n          \"end\": 2.319\n        },\n        {\n          \"word\": \"thatâ€™s\",\n          \"start\": 2.399,\n          \"end\": 2.579\n        },\n        {\n          \"word\": \"a\",\n          \"start\": 2.619,\n          \"end\": 2.679\n        },\n        {\n          \"word\": \"great\",\n          \"start\": 2.72,\n          \"end\": 2.919\n        },\n        {\n          \"word\": \"place\",\n          \"start\": 2.98,\n          \"end\": 3.22\n        },\n        {\n          \"word\": \"to\",\n          \"start\": 3.279,\n          \"end\": 3.339\n        },\n        {\n          \"word\": \"start.\",\n          \"start\": 3.48,\n          \"end\": 3.779\n        },\n        {\n          \"word\": \"A\",\n          \"start\": 3.939,\n          \"end\": 4\n        },\n        {\n          \"word\": \"lot\",\n          \"start\": 4.059,\n          \"end\": 4.199\n        },\n        {\n          \"word\": \"of\",\n          \"start\": 4.239,\n          \"end\": 4.319\n        },\n        {\n          \"word\": \"people\",\n          \"start\": 4.36,\n          \"end\": 4.619\n        },\n        {\n          \"word\": \"come\",\n          \"start\": 4.679,\n          \"end\": 4.819\n        },\n        {\n          \"word\": \"in\",\n          \"start\": 4.859,\n          \"end\": 4.98\n        },\n        {\n          \"word\": \"with\",\n          \"start\": 5.019,\n          \"end\": 5.139\n        },\n        {\n          \"word\": \"a\",\n          \"start\": 5.179,\n          \"end\": 5.239\n        },\n        {\n          \"word\": \"lump\",\n          \"start\": 5.299,\n          \"end\": 5.48\n        },\n        {\n          \"word\": \"sum\",\n          \"start\": 5.579,\n          \"end\": 5.94\n        },\n        {\n          \"word\": \"and\",\n          \"start\": 6,\n          \"end\": 6.099\n        },\n        {\n          \"word\": \"ask\",\n          \"start\": 6.199,\n          \"end\": 6.379\n        },\n        {\n          \"word\": \"how\",\n          \"start\": 6.44,\n          \"end\": 6.519\n        },\n        {\n          \"word\": \"to\",\n          \"start\": 6.559,\n          \"end\": 6.639\n        },\n        {\n          \"word\": \"use\",\n          \"start\": 6.719,\n          \"end\": 6.839\n        },\n        {\n          \"word\": \"it\",\n          \"start\": 6.899,\n          \"end\": 7\n        },\n        {\n          \"word\": \"wisely.\",\n          \"start\": 7.059,\n          \"end\": 7.559\n        },\n        {\n          \"word\": \"One\",\n          \"start\": 8.079,\n          \"end\": 8.199\n        },\n        {\n          \"word\": \"smart\",\n          \"start\": 8.279,\n          \"end\": 8.539\n        },\n        {\n          \"word\": \"approach\",\n          \"start\": 8.639,\n          \"end\": 8.979\n        },\n        {\n          \"word\": \"is\",\n          \"start\": 9.039,\n          \"end\": 9.159\n        },\n        {\n          \"word\": \"putting\",\n          \"start\": 9.22,\n          \"end\": 9.439\n        },\n        {\n          \"word\": \"part\",\n          \"start\": 9.5,\n          \"end\": 9.639\n        },\n        {\n          \"word\": \"of\",\n          \"start\": 9.679,\n          \"end\": 9.739\n        },\n        {\n          \"word\": \"that\",\n          \"start\": 9.8,\n          \"end\": 9.939\n        },\n        {\n          \"word\": \"money\",\n          \"start\": 10.039,\n          \"end\": 10.239\n        },\n        {\n          \"word\": \"down,\",\n          \"start\": 10.34,\n          \"end\": 10.659\n        },\n        {\n          \"word\": \"and\",\n          \"start\": 10.8,\n          \"end\": 10.899\n        },\n        {\n          \"word\": \"keeping\",\n          \"start\": 10.96,\n          \"end\": 11.219\n        },\n        {\n          \"word\": \"some\",\n          \"start\": 11.319,\n          \"end\": 11.479\n        },\n        {\n          \"word\": \"aside\",\n          \"start\": 11.539,\n          \"end\": 11.979\n        },\n        {\n          \"word\": \"for\",\n          \"start\": 12.019,\n          \"end\": 12.119\n        },\n        {\n          \"word\": \"the\",\n          \"start\": 12.159,\n          \"end\": 12.279\n        },\n        {\n          \"word\": \"things\",\n          \"start\": 12.319,\n          \"end\": 12.559\n        },\n        {\n          \"word\": \"that\",\n          \"start\": 12.619,\n          \"end\": 12.739\n        },\n        {\n          \"word\": \"come\",\n          \"start\": 12.799,\n          \"end\": 12.96\n        },\n        {\n          \"word\": \"with\",\n          \"start\": 13,\n          \"end\": 13.139\n        },\n        {\n          \"word\": \"owning\",\n          \"start\": 13.179,\n          \"end\": 13.439\n        },\n        {\n          \"word\": \"a\",\n          \"start\": 13.519,\n          \"end\": 13.579\n        },\n        {\n          \"word\": \"car\",\n          \"start\": 13.679,\n          \"end\": 14.279\n        },\n        {\n          \"word\": \"â€”\",\n          \"start\": 14.279,\n          \"end\": 14.279\n        },\n        {\n          \"word\": \"like\",\n          \"start\": 14.359,\n          \"end\": 14.519\n        },\n        {\n          \"word\": \"maintenance,\",\n          \"start\": 14.619,\n          \"end\": 15.199\n        },\n        {\n          \"word\": \"registration,\",\n          \"start\": 15.479,\n          \"end\": 16.299\n        },\n        {\n          \"word\": \"and\",\n          \"start\": 16.68,\n          \"end\": 16.799\n        },\n        {\n          \"word\": \"insurance.\",\n          \"start\": 16.84,\n          \"end\": 17.459\n        },\n        {\n          \"word\": \"That\",\n          \"start\": 17.859,\n          \"end\": 18.02\n        },\n        {\n          \"word\": \"way,\",\n          \"start\": 18.1,\n          \"end\": 18.259\n        },\n        {\n          \"word\": \"youâ€™re\",\n          \"start\": 18.299,\n          \"end\": 18.459\n        },\n        {\n          \"word\": \"comfortable\",\n          \"start\": 18.52,\n          \"end\": 18.959\n        },\n        {\n          \"word\": \"from\",\n          \"start\": 19.059,\n          \"end\": 19.18\n        },\n        {\n          \"word\": \"day\",\n          \"start\": 19.26,\n          \"end\": 19.459\n        },\n        {\n          \"word\": \"one\",\n          \"start\": 19.6,\n          \"end\": 19.779\n        },\n        {\n          \"word\": \"and\",\n          \"start\": 19.819,\n          \"end\": 19.939\n        },\n        {\n          \"word\": \"not\",\n          \"start\": 20,\n          \"end\": 20.219\n        },\n        {\n          \"word\": \"stretched\",\n          \"start\": 20.26,\n          \"end\": 20.659\n        },\n        {\n          \"word\": \"thin\",\n          \"start\": 20.699,\n          \"end\": 20.959\n        },\n        {\n          \"word\": \"later.\",\n          \"start\": 21.059,\n          \"end\": 21.42\n        },\n        {\n          \"word\": \"Itâ€™s\",\n          \"start\": 21.859,\n          \"end\": 22\n        },\n        {\n          \"word\": \"all\",\n          \"start\": 22.059,\n          \"end\": 22.179\n        },\n        {\n          \"word\": \"about\",\n          \"start\": 22.26,\n          \"end\": 22.519\n        },\n        {\n          \"word\": \"finding\",\n          \"start\": 22.6,\n          \"end\": 22.939\n        },\n        {\n          \"word\": \"the\",\n          \"start\": 22.979,\n          \"end\": 23.079\n        },\n        {\n          \"word\": \"balance\",\n          \"start\": 23.159,\n          \"end\": 23.6\n        },\n        {\n          \"word\": \"that\",\n          \"start\": 23.659,\n          \"end\": 23.779\n        },\n        {\n          \"word\": \"works\",\n          \"start\": 23.84,\n          \"end\": 24.059\n        },\n        {\n          \"word\": \"for\",\n          \"start\": 24.139,\n          \"end\": 24.219\n        },\n        {\n          \"word\": \"your\",\n          \"start\": 24.26,\n          \"end\": 24.42\n        },\n        {\n          \"word\": \"budget\",\n          \"start\": 24.479,\n          \"end\": 25.099\n        },\n        {\n          \"word\": \"and\",\n          \"start\": 25.199,\n          \"end\": 25.379\n        },\n        {\n          \"word\": \"your\",\n          \"start\": 25.42,\n          \"end\": 25.539\n        },\n        {\n          \"word\": \"life.\",\n          \"start\": 25.599,\n          \"end\": 26.019\n        },\n        {\n          \"word\": \"If\",\n          \"start\": 26.5,\n          \"end\": 26.599\n        },\n        {\n          \"word\": \"youâ€™re\",\n          \"start\": 26.639,\n          \"end\": 26.779\n        },\n        {\n          \"word\": \"planning\",\n          \"start\": 26.819,\n          \"end\": 27.18\n        },\n        {\n          \"word\": \"a\",\n          \"start\": 27.219,\n          \"end\": 27.299\n        },\n        {\n          \"word\": \"car\",\n          \"start\": 27.359,\n          \"end\": 27.559\n        },\n        {\n          \"word\": \"purchase\",\n          \"start\": 27.619,\n          \"end\": 28\n        },\n        {\n          \"word\": \"in\",\n          \"start\": 28.039,\n          \"end\": 28.119\n        },\n        {\n          \"word\": \"Central\",\n          \"start\": 28.219,\n          \"end\": 28.519\n        },\n        {\n          \"word\": \"Illinois,\",\n          \"start\": 28.599,\n          \"end\": 29.079\n        },\n        {\n          \"word\": \"weâ€™re\",\n          \"start\": 29.479,\n          \"end\": 29.6\n        },\n        {\n          \"word\": \"happy\",\n          \"start\": 29.639,\n          \"end\": 29.879\n        },\n        {\n          \"word\": \"to\",\n          \"start\": 29.92,\n          \"end\": 29.979\n        },\n        {\n          \"word\": \"help\",\n          \"start\": 30.019,\n          \"end\": 30.179\n        },\n        {\n          \"word\": \"you\",\n          \"start\": 30.219,\n          \"end\": 30.319\n        },\n        {\n          \"word\": \"think\",\n          \"start\": 30.359,\n          \"end\": 30.539\n        },\n        {\n          \"word\": \"it\",\n          \"start\": 30.559,\n          \"end\": 30.679\n        },\n        {\n          \"word\": \"through\",\n          \"start\": 30.699,\n          \"end\": 31\n        },\n        {\n          \"word\": \"and\",\n          \"start\": 31.039,\n          \"end\": 31.179\n        },\n        {\n          \"word\": \"find\",\n          \"start\": 31.239,\n          \"end\": 31.459\n        },\n        {\n          \"word\": \"something\",\n          \"start\": 31.5,\n          \"end\": 31.779\n        },\n        {\n          \"word\": \"reliable\",\n          \"start\": 31.84,\n          \"end\": 32.399\n        },\n        {\n          \"word\": \"at\",\n          \"start\": 32.459,\n          \"end\": 32.559\n        },\n        {\n          \"word\": \"Capitol\",\n          \"start\": 32.619,\n          \"end\": 32.959\n        },\n        {\n          \"word\": \"Car\",\n          \"start\": 33.059,\n          \"end\": 33.239\n        },\n        {\n          \"word\": \"Credit.\",\n          \"start\": 33.36,\n          \"end\": 33.739\n        },\n        {\n          \"word\": \"<end>\",\n          \"start\": 34.0662358276644,\n          \"end\": 34.0662358276644\n        }\n      ],\n      \"avatar_video_url\": \"https://res.cloudinary.com/dtpqxuwby/video/upload/v1767656546/Tax_season_edu_jan_5_2026_ljcjgd.mp4\",\n    \"avatar_video_duration\": 33.985,\n    \"avatar_mask_video_url\": \"https://res.cloudinary.com/dtpqxuwby/video/upload/v1767656897/tax-season-edu_t4iemz.mp4\"\n    }\n  }\n\n",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -368,
        -128
      ],
      "id": "60798cb7-eaed-47ea-9ce3-b59a10cb4c41",
      "name": "Edit Fields",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Get all items coming into aggregate\nconst allItems = $input.all();\n\n// Get base config from Process All Vehicles\nconst baseConfig = $('Process All Vehicles').first().json;\nconst cachedVehicles = baseConfig.cachedVehicles || [];\nconst originalVehicles = baseConfig.vehicles || [];\n\nconsole.log(`Aggregate: Processing ${allItems.length} items`);\n\n// Process items from removebg/cloudinary flow\nconst processedVehicles = allItems\n  .filter(item => item.json.public_id && item.json.secure_url)\n  .map(item => {\n    const vin = item.json.public_id;\n    \n    // Find the original vehicle data to merge with\n    const originalVehicle = originalVehicles.find(v => v.vin === vin);\n    \n    if (!originalVehicle) {\n      console.warn(`âš ï¸ No original vehicle found for VIN ${vin}`);\n      return null;\n    }\n    return {\n      ...originalVehicle,  // â† Keep all original vehicle data\n      photo_url: item.json.secure_url  // â† Add Cloudinary URL\n    };\n  })\n  .filter(Boolean); // Remove any nulls\n\n// Create lookup maps by VIN\nconst processedByVin = {};\nprocessedVehicles.forEach(v => {\n  processedByVin[v.vin] = v;\n});\n\nconst cachedByVin = {};\ncachedVehicles.forEach(v => {\n  cachedByVin[v.vin] = v;\n});\n\n// Rebuild vehicles array in ORIGINAL order\nconst finalVehicles = originalVehicles.map(originalVehicle => {\n  const vin = originalVehicle.vin;\n  \n  // Use processed or cached version if available, otherwise original\n  return processedByVin[vin] || cachedByVin[vin] || originalVehicle;\n});\n\nconsole.log(`âœ“ Total: ${finalVehicles.length} vehicles in correct order`);\n\n// Clean config\nconst { vehiclesToProcess, cachedVehicles: _, ...cleanConfig } = baseConfig;\n\nreturn [{\n  json: {\n    ...cleanConfig,\n    vehicles: finalVehicles\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        96
      ],
      "id": "6be976a7-570a-494c-b41c-72e758ede38f",
      "name": "Aggregate Vehicles"
    },
    {
      "parameters": {
        "jsCode": "return $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -336,
        96
      ],
      "id": "5df931bc-a974-4b08-88f6-d6006b054fc2",
      "name": "Aggregate Configs"
    },
    {
      "parameters": {
        "jsCode": "// Single error - format it for the email\nconst error = $input.first().json;\nconst nodeName = error.node?.name || 'Unknown node';\n\n// Handle different error formats from different APIs\nlet errorMsg = 'Unknown error';\n\n// Cloudinary error format: { \"error\": { \"message\": \"...\" } }\nif (error.error?.message) {\n  errorMsg = error.error.message;\n}\n// Creatomate error format: { \"status\": \"failed\", \"error_message\": \"...\" }\nif (error.error_message) {\n  errorMsg = error.error_message;\n}\n  \n// Remove.bg error format: { \"errors\": [{ \"code\": \"...\", \"title\": \"...\" }] }\nelse if (error.errors && Array.isArray(error.errors) && error.errors.length > 0) {\n  const firstError = error.errors[0];\n  // Include code if present, otherwise just title\n  errorMsg = firstError.code \n    ? `${firstError.code}: ${firstError.title}` \n    : firstError.title;\n}\n// Creatomate error format: { \"error_message\": \"...\" }\nelse if (error.error_message) {\n  errorMsg = error.error_message;\n}\n// Generic message fallback\nelse if (error.message) {\n  errorMsg = error.message;\n}\n\nreturn [{\n  json: {\n    nodeName: nodeName,\n    errorMessage: errorMsg,\n    timestamp: new Date().toISOString(),\n    rawError: JSON.stringify(error, null, 2) // Include full error for debugging\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        816,
        -96
      ],
      "id": "784d6524-d4b7-4640-b0f1-2467d38dcf9a",
      "name": "Format Node Error"
    },
    {
      "parameters": {
        "content": "# #3 Generate Video",
        "height": 720,
        "width": 1824,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -560,
        -272
      ],
      "typeVersion": 1,
      "id": "cfb457e3-4e30-4045-916a-2c45b78a2cbf",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -544,
        -128
      ],
      "id": "febf4365-88f4-4424-a9d1-ab1dafbe1e95",
      "name": "When Executed by Orchestrate Video Creation"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "78c8847d-ded2-428b-b6d2-8b59e006a8aa",
              "leftValue": "={{ $json.vehiclesToProcess.length}}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -80,
        -128
      ],
      "id": "d3c49706-9898-4e26-9cb1-65ebf9239b23",
      "name": "If: Has Vehicles"
    },
    {
      "parameters": {
        "jsCode": "const vehiclesToProcess = $json.vehiclesToProcess || [];\n\nreturn vehiclesToProcess.map(vehicle => ({\n  json: vehicle\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        -144
      ],
      "id": "cabf3be1-d71f-4d05-a6fb-bd60c6480d77",
      "name": "Send Only Vehicles to Process"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.remove.bg/v1.0/removebg",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "72rkEtm8QRzFpqEmjL42o89z"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"image_url\": \"{{ $json.photo_url || $json.image_url }}\",\n  \"size\": \"auto\",\n  \"format\": \"png\",\n  \"crop\": true,\n  \"crop_margin\": \"10%\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        240,
        -144
      ],
      "id": "d4ecef3b-4065-44b9-b76e-95c1be44b7ac",
      "name": "API: Remove.bg",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cloudinary.com/v1_1/dtpqxuwby/image/upload",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            },
            {
              "name": "upload_preset",
              "value": "n8n_unsigned"
            },
            {
              "name": "public_id",
              "value": "={{ $json.vin }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        544,
        -160
      ],
      "id": "969b1d09-908b-449f-b35d-0404ea08d0dd",
      "name": "API: Cloudinary, Upload",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "cc7c4fae-f404-4b50-b3e0-a86a35ad1403",
              "leftValue": "={{ $json.api_creatomate_create_video }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        32,
        96
      ],
      "id": "e31917be-d832-4f23-9f3a-8dfd718a570c",
      "name": "If: Test, Skip Video Creation"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: $json.api_creatomate_create_video\n}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        368,
        32
      ],
      "id": "aa6dce6f-6e60-452b-a4aa-4a90ebd7214d",
      "name": "Skip Video Creation"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b0d1a7bf-ac65-4401-bf77-dc691de54791",
              "leftValue": "={{ $json.status }}",
              "rightValue": "succeeded",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        720,
        128
      ],
      "id": "cdc69818-5724-4f8c-ae10-d81bdabc5677",
      "name": "If: Succeeded?"
    },
    {
      "parameters": {
        "jsCode": "const apiResponse = $json;\nconst config = $('Aggregate Configs').first().json;\nconst videoUrl = apiResponse.url;\nconst videoDuration = apiResponse.duration;\n\nif (!videoUrl) {\n  throw new Error('Creatomate did not return a video URL');\n}\n\nreturn [{\n  json: {\n    ...config,  // â† Preserves ALL previous api_* keys!\n    \n    // new\n    final_video_url: videoUrl,\n    video_duration: videoDuration,\n    \n    // Testing API Response\n    ...(config.test_mode && { api_creatomate_create_video: apiResponse })\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1104,
        112
      ],
      "id": "94a3f672-71bd-4b34-a989-262f4bef3c0e",
      "name": "Parse Video Creation Response"
    },
    {
      "parameters": {
        "url": "=https://api.creatomate.com/v1/renders/{{ $json.id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 754b059fc6f045ea9f16cbbdacd691bec27dec04525ad3a8a0d7cdf74136980793efce4b8aafee5312b097973d74b0a4"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        528,
        144
      ],
      "id": "cfbd1219-c74c-4024-9f11-0aef6b6c211b",
      "name": "API: Creatomate, Check Status",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.creatomate.com/v1/renders",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 754b059fc6f045ea9f16cbbdacd691bec27dec04525ad3a8a0d7cdf74136980793efce4b8aafee5312b097973d74b0a4"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.creatomate }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        176,
        176
      ],
      "id": "3e365a4a-5fa9-4942-827f-6f51a60a38c7",
      "name": "API: Creatomate, Create Video",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Get the VIN from your JSON data\nconst vin = $json.vin;\n\n// Get the binary item properly\nconst binaryData = $input.item.binary?.data;\n\nif (!binaryData) {\n  throw new Error('No binary data found');\n}\n\n// Return with renamed file - use $input.item.binary to preserve the actual data\nreturn {\n  json: $json,\n  binary: {\n    data: {\n      ...binaryData,\n      fileName: `${vin}.png`\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        384,
        -160
      ],
      "id": "dcdd5c0b-9198-468f-a2f2-d28e3341212e",
      "name": "Parse Remove.bg"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Updated Build Template JSON node\n// Changes:\n// 1. Accepts single `ratio` from loop (not array)\n// 2. Hides platform-banner when `skipPlatformBanner: true`\n\nreturn (async () => {\n\nconst config = $json;\n\n// ============================================\n// STEP 1: Determine Template Tag\n// ============================================\nconst clientId = (config.client || 'ccc').toUpperCase();\nconst templateId = config.template_id || 'ad-multi-item-1';\nconst ratio = config.ratio || '9:16';\n\n// Convert template_id to tag format\n// \"ad-multi-item-1\" â†’ \"AD_MULTI-ITEM-1\"\n// \"organic-educational-1\" â†’ \"ORGANIC_EDUCATIONAL-1\"\nconst templateTag = templateId.toUpperCase().replace(/-/, '_');\nconst uniqueTag = `${clientId}_${templateTag}_${ratio}`;\n\nconsole.log(`ğŸ·ï¸ Fetching template with tag: ${uniqueTag}`);\n\n// ============================================\n// STEP 2: Fetch Template from Creatomate\n// ============================================\nconst apiKey = '754b059fc6f045ea9f16cbbdacd691bec27dec04525ad3a8a0d7cdf74136980793efce4b8aafee5312b097973d74b0a4';\n\n// Step 1: Find template by tag (returns id, name, tags - but NOT source)\nconst templateList = await this.helpers.httpRequest({\n  method: 'GET',\n  url: `https://api.creatomate.com/v1/templates?tags=${encodeURIComponent(uniqueTag)}`,\n  headers: {\n    'Authorization': `Bearer ${apiKey}`\n  },\n  json: true\n});\n\nif (!templateList || !Array.isArray(templateList) || templateList.length === 0) {\n  throw new Error(`No template found with tag: ${uniqueTag}`);\n}\n\nconst templateInfo = templateList[0];\nconsole.log(`ğŸ“ Found template: ${templateInfo.name} (ID: ${templateInfo.id})`);\n\n// Step 2: Fetch full template by ID (this returns the source)\nconst template = await this.helpers.httpRequest({\n  method: 'GET',\n  url: `https://api.creatomate.com/v1/templates/${templateInfo.id}`,\n  headers: {\n    'Authorization': `Bearer ${apiKey}`\n  },\n  json: true\n});\n\nif (!template.source) {\n  throw new Error(`Template ${template.id} has no source property`);\n}\n\n// Deep clone the source\nconst source = JSON.parse(JSON.stringify(template.source));\n\n// Get template dimensions for percentage calculations\nconst templateWidth = source.width || 720;\nconst templateHeight = source.height || 1280;\n\nconsole.log(`âœ… Loaded template source (${Object.keys(template.source).length} top-level keys)`);\n\n// ============================================\n// STEP 3: Build Swap Config from Incoming Data\n// ============================================\n\n// Check if we should skip platform banner (ffmpeg will add it)\nconst skipPlatformBanner = config.skipPlatformBanner || false;\nconst avatarName = config.avatar_name || 'SHAD';\n\n// For platform text (only used if NOT skipping)\nconst platformInput = (config.platform || 'none').toLowerCase();\nconst basePlatform = platformInput.split('-')[0];\nconst platformTexts = {\n  'tiktok': `Ask for ${avatarName} and mention you saw this on TIKTOK!`,\n  'youtube': `Ask for ${avatarName} and mention you saw this on YOUTUBE!`,\n  'instagram': `Ask for ${avatarName} and mention you saw this on INSTAGRAM!`,\n  'facebook': `Ask for ${avatarName} and mention you saw this on FACEBOOK!`,\n  'none': `Ask for ${avatarName} for a great deal!`\n};\nconst platformText = platformTexts[basePlatform] || platformTexts['none'];\n\n// Timing from _section_timings\nconst sectionTimings = config._section_timings || [];\nconst hookSection = sectionTimings.find(t => t.name === 'hook');\nconst ctaSection = sectionTimings.find(t => t.name === 'cta');\n\nconst hookEnd = hookSection?.end || 0;\nconst ctaStart = ctaSection?.start || 0;\nconst videoDuration = config.avatar_video_duration || ctaSection?.end || (sectionTimings.length > 0 ? sectionTimings[sectionTimings.length - 1].end : 30);\n\n// Vehicles\nconst vehicles = config.vehicles || [];\nconst heroVehicle = vehicles[0] || {};\n\n// Spotlight feature photos\nconst selectedPhotos = config.selected_photos || [];\nconst featurePhotos = selectedPhotos.slice(1, 6);\n\n// Price formatter\nfunction formatPrice(price) {\n  if (!price) return null;\n  let priceNum = price;\n  if (typeof price === 'string') {\n    priceNum = parseFloat(price.replace(/[^0-9.]/g, ''));\n  }\n  if (isNaN(priceNum)) return price;\n  return '$' + priceNum.toLocaleString('en-US', { maximumFractionDigits: 0 });\n}\n\n// Build swap config\nconst swapConfig = {\n  hookEnd,\n  ctaStart,\n  videoDuration,\n  skipPlatformBanner,  // NEW: flag to hide banner\n  platformText,\n  bgMusicSource: config.media?.music_url,\n  bgImageSource: config.background_image_url,\n  avatar1Source: config.avatar_video_url,\n  avatar1MaskSource: config.avatar_video_alpha_url || config.avatar_mask_video_url,\n  item0Source: heroVehicle.photo_url,\n  item0Title: heroVehicle.year && heroVehicle.make && heroVehicle.model\n    ? `${heroVehicle.year} ${heroVehicle.make} ${heroVehicle.model}` : null,\n  item0Price: formatPrice(heroVehicle.price),\n  videoThumbnailText: config.script?.hook || config.topic || '',\n};\n\n// Spotlight features\nfeaturePhotos.forEach((photo, index) => {\n  const featureNum = index + 1;\n  const segmentTiming = sectionTimings.find(t => t.name === 'segment_' + featureNum);\n  swapConfig[`item0Feature${featureNum}Source`] = photo?.photo_url;\n  swapConfig[`item0Feature${featureNum}Time`] = segmentTiming?.start;\n  swapConfig[`item0Feature${featureNum}Duration`] = segmentTiming?.duration;\n});\n\n// Multi-item vehicles\nvehicles.forEach((vehicle, index) => {\n  const itemNum = index + 1;\n  if (itemNum > 5) return;\n  const segmentTiming = sectionTimings.find(t => t.name === 'segment_' + index);\n  swapConfig[`item${itemNum}Source`] = vehicle.photo_url;\n  swapConfig[`item${itemNum}Title`] = vehicle.year && vehicle.make && vehicle.model\n    ? `${vehicle.year} ${vehicle.make} ${vehicle.model}` : null;\n  swapConfig[`item${itemNum}Price`] = formatPrice(vehicle.price);\n  swapConfig[`item${itemNum}Mileage`] = vehicle.mileage\n    ? `${Number(vehicle.mileage).toLocaleString('en-US')} mi` : null;\n  swapConfig[`item${itemNum}Time`] = segmentTiming?.start;\n  swapConfig[`item${itemNum}Duration`] = segmentTiming?.duration;\n  swapConfig[`item${itemNum}Visible`] = true;\n});\n\n// Mark unused slots\nfor (let i = vehicles.length + 1; i <= 5; i++) {\n  swapConfig[`item${i}Visible`] = false;\n}\n\nconsole.log(`ğŸ“‹ Config built for: ${templateId}`);\nconsole.log(`ğŸ·ï¸ Skip platform banner: ${skipPlatformBanner}`);\n\n// ============================================\n// STEP 4: Apply Swaps to Source\n// ============================================\n\n// NEW: Store extracted banner config\nlet bannerConfig = null;\n\nfunction applyScaleAnimTiming(element, cfg) {\n  if (!element.animations) return;\n  const scaleAnims = element.animations.filter(a => a.type === 'scale');\n  if (scaleAnims.length === 1 && cfg.hookEnd !== undefined) {\n    scaleAnims[0].time = cfg.hookEnd;\n  } else if (scaleAnims.length === 2) {\n    if (cfg.hookEnd !== undefined) scaleAnims[0].time = cfg.hookEnd;\n    if (cfg.ctaStart !== undefined) scaleAnims[1].time = cfg.ctaStart;\n  }\n}\n\nfunction applySwaps(element, cfg, parent = null) {\n  const name = element.name;\n\n  // Avatar\n  if (name?.match(/^avatar-(\\d+)$/) && element.type !== \"composition\") {\n    const n = RegExp.$1;\n    if (cfg[`avatar${n}Source`]) element.source = cfg[`avatar${n}Source`];\n    applyScaleAnimTiming(element, cfg);\n  }\n\n  // Avatar Mask Layer (for RVM alpha mask compositing)\n  if (name?.match(/^avatar-(\\d+)-mask$/)) {\n    const n = RegExp.$1;\n    if (cfg[`avatar${n}MaskSource`]) {\n      element.source = cfg[`avatar${n}MaskSource`];\n      console.log(`âœ“ Applied mask video to avatar-${n}-mask`);\n    }\n  }\n\n  // Item-0 (hero) scale animation\n  if (name === 'Item-0') {\n    applyScaleAnimTiming(element, cfg);\n  }\n\n  // Item-0 nested elements\n  if (name === 'photo' && parent === 'Item-0') {\n    if (cfg.item0Source) element.source = cfg.item0Source;\n  }\n  if (name === 'title' && parent === 'Item-0') {\n    if (cfg.item0Title) element.text = cfg.item0Title;\n  }\n  if (name === 'price' && parent === 'Item-0') {\n    if (cfg.item0Price) element.text = cfg.item0Price;\n  }\n\n  // Features inside Item-0\n  const featureMatch = name?.match(/^feature-(\\d+)$/);\n  if (featureMatch && parent === 'Item-0') {\n    const n = featureMatch[1];\n    if (cfg[`item0Feature${n}Source`]) element.source = cfg[`item0Feature${n}Source`];\n    if (cfg[`item0Feature${n}Time`] !== undefined) element.time = cfg[`item0Feature${n}Time`];\n    if (cfg[`item0Feature${n}Duration`] !== undefined) element.duration = cfg[`item0Feature${n}Duration`];\n  }\n\n  // Multi-item Items (1-5)\n  const itemMatch = name?.match(/^Item-(\\d+)$/);\n  if (itemMatch && itemMatch[1] !== '0') {\n    const n = itemMatch[1];\n    if (cfg[`item${n}Time`] !== undefined) element.time = cfg[`item${n}Time`];\n    if (cfg[`item${n}Duration`] !== undefined) element.duration = cfg[`item${n}Duration`];\n    if (cfg[`item${n}Visible`] === false) element.visible = false;\n  }\n\n  // Multi-item nested elements\n  const parentItemMatch = parent?.match(/^Item-(\\d+)$/);\n  if (parentItemMatch && parentItemMatch[1] !== '0') {\n    const n = parentItemMatch[1];\n    if (name === 'photo' && cfg[`item${n}Source`]) element.source = cfg[`item${n}Source`];\n    if (name === 'title' && cfg[`item${n}Title`]) element.text = cfg[`item${n}Title`];\n    if (name === 'price' && cfg[`item${n}Price`]) element.text = cfg[`item${n}Price`];\n    if (name === 'mileage' && cfg[`item${n}Mileage`]) element.text = cfg[`item${n}Mileage`];\n  }\n\n  // Platform banner - extract position BEFORE hiding\n  if (name === 'platform-banner' || name === 'platform-text') {\n    // NEW: Extract banner config from template before any modifications\n    if (!bannerConfig && element.y !== undefined) {\n      // Parse Y value - Creatomate uses strings like \"6.7%\" or pixel values\n      let yPercent = null;\n      const yVal = element.y;\n      if (typeof yVal === 'string' && yVal.endsWith('%')) {\n        yPercent = parseFloat(yVal) / 100; // \"6.7%\" -> 0.067\n      } else if (typeof yVal === 'number') {\n        yPercent = yVal / templateHeight;\n      }\n      \n      // Parse font_size - Creatomate uses strings like \"4 vmin\" or pixel values\n      let fontSizePercent = null;\n      const fontSize = element.font_size;\n      if (typeof fontSize === 'string' && fontSize.includes('vmin')) {\n        fontSizePercent = parseFloat(fontSize) / 100; // \"4 vmin\" -> 0.04\n      } else if (typeof fontSize === 'number') {\n        fontSizePercent = fontSize / Math.min(templateWidth, templateHeight);\n      }\n      \n      bannerConfig = {\n        y: element.y,\n        y_percent: yPercent,\n        font_size: element.font_size,\n        font_size_percent: fontSizePercent,\n        font_family: element.font_family,\n        font_weight: element.font_weight,\n        fill_color: element.fill_color,\n        template_width: templateWidth,\n        template_height: templateHeight\n      };\n      console.log(`ğŸ“ Extracted banner config: y=${bannerConfig.y} (${(bannerConfig.y_percent * 100).toFixed(2)}%), font_size=${bannerConfig.font_size}`);\n    }\n\n    if (cfg.skipPlatformBanner) {\n      // Hide the banner - ffmpeg will add it later\n      element.visible = false;\n      console.log(`âœ“ Hidden platform banner (ffmpeg will add)`);\n    } else {\n      // Keep banner visible and set text\n      if (cfg.platformText) element.text = cfg.platformText;\n      if (element.animations?.[0] && cfg.videoDuration) {\n        element.animations[0].duration = cfg.videoDuration;\n      }\n    }\n  }\n\n  // Company intro - duration matches hook\n  if (name === 'Company-Intro' || name === 'Contact-Info-intro') {\n    if (cfg.hookEnd !== undefined) element.duration = cfg.hookEnd;\n  }\n\n  // Company outro\n  if (name === 'Company-Outro') {\n    if (cfg.ctaStart !== undefined) element.time = cfg.ctaStart;\n  }\n\n  // Background music/image\n  if (name === 'background-music' && cfg.bgMusicSource) {\n    element.source = cfg.bgMusicSource;\n  }\n  if (name === 'background-image' && cfg.bgImageSource) {\n    element.source = cfg.bgImageSource;\n  }\n\n  // Educational video thumbnail\n  if (name === 'video-thumbnail' && cfg.videoThumbnailText) {\n    element.text = cfg.videoThumbnailText;\n  }\n\n  // Recurse\n  if (element.elements && Array.isArray(element.elements)) {\n    element.elements.forEach(child => applySwaps(child, cfg, name));\n  }\n}\n\n// Set top-level duration\nif (swapConfig.videoDuration) {\n  source.duration = swapConfig.videoDuration;\n}\n\n// Apply swaps recursively\nif (source.elements && Array.isArray(source.elements)) {\n  source.elements.forEach(element => applySwaps(element, swapConfig, null));\n}\n\nconsole.log(`âœ… Template modifications applied`);\n\n// ============================================\n// STEP 5: Return template_id + source for Creatomate\n// ============================================\n\n// Clean swapConfig - remove undefined values for cleaner output\nconst cleanSwapConfig = Object.fromEntries(\n  Object.entries(swapConfig).filter(([_, v]) => v !== undefined)\n);\n\nconst output = {\n  ...config,\n  creatomate: {\n        source: source\n  },\n  _template_tag: uniqueTag,\n  _swap_config: cleanSwapConfig,\n  // NEW: Include extracted banner config for ffmpeg\n  _banner_config: bannerConfig\n};\n\n// runOnceForEachItem mode: return single object, not array\nreturn {\n  json: JSON.parse(JSON.stringify(output))\n}\n\n})();\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -176,
        96
      ],
      "id": "unified-build-template-json",
      "name": "Build Template JSON"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.resend.com/emails",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n  {\n    \"from\": \"errors@ad-pilot.ai\",\n    \"to\": \"kelly@ad-pilot.ai\",\n    \"subject\": \"ğŸš¨ Video Generation Failed - \" + $json.nodeName,\n    \"html\": \"âš ï¸ Video Creation Workflow Error<br/><br/>Failed Node: \" + $json.nodeName + \"<br/>Error: \" + $json.errorMessage + \"<br/><br/>Time: \" + $json.timestamp\n  }\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        976,
        -96
      ],
      "id": "5806628c-bf99-4c78-b44e-e563d2f56a37",
      "name": "Email Errors",
      "credentials": {
        "httpBearerAuth": {
          "id": "vdxOfyrKMfWKSmAH",
          "name": "Resend"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "3f2511ab-5b89-4844-973a-9b615994e7b4",
              "leftValue": "={{$json.status}}",
              "rightValue": "failed",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        864,
        240
      ],
      "id": "236a86f6-9fb4-4fb5-aabd-3c81607721dd",
      "name": "If: Failed?"
    }
  ],
  "connections": {
    "Process All Vehicles": {
      "main": [
        [
          {
            "node": "If: Has Vehicles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Render": {
      "main": [
        [
          {
            "node": "API: Creatomate, Check Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Process All Vehicles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Vehicles": {
      "main": [
        [
          {
            "node": "Aggregate Configs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Configs": {
      "main": [
        [
          {
            "node": "Build Template JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Node Error": {
      "main": [
        [
          {
            "node": "Email Errors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Orchestrate Video Creation": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: Has Vehicles": {
      "main": [
        [
          {
            "node": "Send Only Vehicles to Process",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Aggregate Configs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Only Vehicles to Process": {
      "main": [
        [
          {
            "node": "API: Remove.bg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Remove.bg": {
      "main": [
        [
          {
            "node": "Parse Remove.bg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Node Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Cloudinary, Upload": {
      "main": [
        [
          {
            "node": "Aggregate Vehicles",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Node Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: Test, Skip Video Creation": {
      "main": [
        [
          {
            "node": "Skip Video Creation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "API: Creatomate, Create Video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip Video Creation": {
      "main": [
        [
          {
            "node": "Parse Video Creation Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: Succeeded?": {
      "main": [
        [
          {
            "node": "Parse Video Creation Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If: Failed?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Video Creation Response": {
      "main": [
        []
      ]
    },
    "API: Creatomate, Check Status": {
      "main": [
        [
          {
            "node": "If: Succeeded?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Node Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Creatomate, Create Video": {
      "main": [
        [
          {
            "node": "Wait for Render",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Node Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Remove.bg": {
      "main": [
        [
          {
            "node": "API: Cloudinary, Upload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Template JSON": {
      "main": [
        [
          {
            "node": "If: Test, Skip Video Creation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Errors": {
      "main": [
        [
          {
            "node": "Stop and Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: Failed?": {
      "main": [
        [
          {
            "node": "Format Node Error",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait for Render",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "8f359d04-2f51-457f-81c1-3fa830a98874",
  "activeVersionId": null,
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-12-13T13:57:28.375Z",
      "createdAt": "2025-12-13T13:57:28.375Z",
      "role": "workflow:owner",
      "workflowId": "FOQ8foX33kSuaZEJ",
      "projectId": "VF66NQc9R74tCdyG"
    }
  ],
  "activeVersion": null,
  "tags": []
}